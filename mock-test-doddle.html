<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IELTS Mahir - Mock Test</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter (for general text) and Anton (for headings) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Anton&family=Inter:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.lordicon.com/lordicon.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css"
    />
    <style id="mock-test-styles">
      /* Base styles for the entire application */
      body {
        font-family: "Inter", sans-serif;
        /* A very subtle, almost flat background */
        background-color: #f2f2f7; /* iOS light background color */
        color: #334155; /* Slate 700 for main text */
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        padding-bottom: 0; /* Default, adjusted by JS/media queries */
        overflow: hidden; /* Prevent horizontal scroll */
      }

      /* Custom font classes */
      .font-anton {
        font-family: "Anton", sans-serif;
      }
      .font-inter {
        font-family: "Inter", sans-serif;
      }

      /* Main layout for mock test content */
      .mock-test-layout {
        display: grid;
        grid-template-columns: 1fr; /* Single column for mobile */
        /* Consistent spacing */
        padding: 0rem; /* Reduced padding for mobile */
        flex-grow: 1; /* Allow content to take available space */
      }

      /* Responsive adjustments for tablet and desktop */
      @media (min-width: 768px) {
        /* md breakpoint */
        .mock-test-layout {
          padding: 0rem; /* Medium padding for tablet */
        }
      }

      /* Specific layout for Listening Test on larger screens */
      @media (min-width: 1024px) {
        /* lg breakpoint */
        .mock-test-layout.listening-layout {
          grid-template-columns: 3fr 1fr; /* Main content (3 parts), sidebar (1 part) */
          padding: 0rem; /* Larger padding for desktop */
        }
      }

      /* Specific layout for Reading Test on larger screens */
      @media (min-width: 1024px) {
        /* lg breakpoint */
        .mock-test-layout.reading-layout {
          grid-template-columns: 1fr 1fr; /* Passage on left, Questions on right */
          padding: 0rem; /* Larger padding for desktop */
        }
        /* New rule for main-test-content height in reading module on large screens */
        .mock-test-layout.reading-layout .main-test-content {
          height: 87vh; /* Set height to 87vh for reading module on computers */
        }
        .mock-test-layout.reading-layout .passage-content-area {
          height: 87vh; /* Set height to 87vh for reading module on computers */
        }
      }

      /* Styling for the main test content area (questions) */
      .main-test-content {
        background-color: #ffffff; /* Pure white background */
        /* More pronounced rounded corners */
        /* Removed deep shadow, using a very subtle border for separation */
        border: 1px solid #e0e0e0;
        padding: 1.5rem; /* Standard padding */
        overflow-y: auto; /* Enable scrolling for test content */
        transition: all 0.3s ease-in-out; /* Smooth transitions for layout changes */
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
        position: relative;
        /* height will be set by media queries */
      }
      #test-questions-container {
        overflow-y: scroll;
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
      }
      @media (min-width: 768px) {
        .main-test-content {
          padding: 2rem; /* Standard padding for tablet and desktop */
        }
      }

      /* Styling for the passage content area (for Reading Tests) */
      .passage-content-area {
        background-color: #ffffff; /* Pure white background */
        border-radius: 1.5rem;
        /* Removed deep shadow, using a very subtle border for separation */
        border: 1px solid #e0e0e0;
        padding: 1.5rem;
        overflow-y: auto; /* Enable scrolling for passage content */
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
        display: none; /* Hidden by default, shown by JS for reading */
        transition: all 0.3s ease-in-out;
        /* height will be set by media queries */
      }

      /* Styling for the sidebar (for Listening Tests) */
      .sidebar {
        background-color: #1e293b;
        border: 1px solid #1a202c;
        padding: 1.5rem;
        color: white;
        display: none;
        flex-direction: column;
        gap: 1.5rem;
        transition: all 0.3s ease-in-out;
        position: fixed;
        right: 0;
        width: 25vw;
        /* height will be set by media queries */
      }

      /* Show sidebar only on large screens for listening layout */
      @media (min-width: 1024px) {
        .mock-test-layout.listening-layout .sidebar {
          display: flex; /* Show sidebar on desktop for listening */
        }
      }

      .question-palette-grid {
        display: grid;
        grid-template-columns: repeat(
          auto-fill,
          minmax(48px, 1fr)
        ); /* Larger buttons */
        gap: 0.55rem; /* More space between buttons */
        overflow-y: scroll; /* Hide vertical scrollbar */
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
      }
      /* Individual question palette buttons */
      .question-palette-btn {
        width: 40px; /* Larger size */
        height: 40px; /* Larger size */
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 0.75rem; /* More rounded */
        font-weight: 700; /* Bolder text */
        font-size: 1.115rem; /* Larger number */
        transition: all 0.2s ease-in-out;
        cursor: pointer;
        border: 1px solid transparent; /* Default transparent border */
      }

      .question-palette-btn.answered {
        background-color: #34c759; /* Apple Green */
        color: white;
        /* Removed shadow */
      }

      .question-palette-btn.unanswered {
        background-color: #636366; /* Apple Gray */
        color: white;
        /* Removed shadow */
      }

      .question-palette-btn.current {
        background-color: #007aff; /* Apple Blue */
        transform: scale(1.05); /* Slightly larger */
        /* Removed shadow */
        border: 1px solid #007aff; /* Blue border */
      }

      .question-palette-btn:hover:not(.current) {
        transform: translateY(-2px); /* Lift effect on hover */
        /* Removed shadow */
      }

      /* Audio Player Wrapper (fixed position at top) */
      .audio-player-wrapper {
        position: sticky;
        top: 64px; /* Adjust based on header height */
        width: 100%;
        background-color: #f9f9f9; /* Lighter background */
        padding: 0.75rem 1rem;
        /* Removed shadow, using a subtle border */
        border-bottom: 1px solid #e0e0e0;
        z-index: 900; /* Below header, above main content */
        display: none; /* Hidden by default, shown by JS for listening */
        justify-content: center;
        align-items: center;
        height: 80px; /* Fixed height for consistency */
      }

      .audio-player-container {
        background-color: #ffffff; /* Pure white for the player itself */
        border-radius: 1.25rem; /* More rounded */
        padding: 0.75rem 1.5rem; /* Increased padding */
        display: flex;
        align-items: center;
        justify-content: center;
        /* Removed inset shadow */
        border: 1px solid #e0e0e0;
        width: 100%;
        max-width: 960px; /* Slightly wider max-width */
        height: 60px; /* Fixed height for consistency */
      }

      .audio-player-container audio {
        width: 100%;
        border-radius: 0.75rem; /* Rounded corners for audio element */
        filter: none; /* Removed filter for a cleaner look */
      }

      /* New: Sticky Test Info Bar */
      .test-info-bar {
        position: sticky;
        top: 64px; /* Below the header */
        width: 100%;
        background-color: #ffffff; /* White background */
        padding: 0.75rem 1.5rem; /* Padding */
        border-bottom: 1px solid #e0e0e0; /* Subtle border */
        z-index: 900; /* Same as audio player, below header */
        display: flex; /* Hidden by default, shown by JS */
        justify-content: space-between; /* Align timer and section info */
        align-items: center;
        height: 60px; /* Consistent height */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); /* Subtle shadow */
      }

      /* Mobile Question Palette Wrapper (fixed at bottom) */
      .mobile-question-palette-wrapper {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: #1e293b; /* Dark background like sidebar */
        color: white;
        /* Removed shadow */
        border-top: 1px solid #1a202c; /* Darker border */
        z-index: 950; /* Above main content, below header */
        display: none; /* Hidden by default, shown by media query for listening on mobile */
        flex-direction: column;
        border-top-left-radius: 1.5rem; /* More rounded top corners */
        border-top-right-radius: 1.5rem;
        overflow: hidden; /* For rounded corners and content hiding */
        transition: all 0.3s ease-out; /* Smooth expansion/collapse */
      }

      #mobile-palette-content {
        max-height: 0; /* Initially collapsed */
        opacity: 0;
        transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        overflow-y: hidden; /* Hide scrollbar when collapsed */
      }

      .mobile-question-palette-wrapper.expanded #mobile-palette-content {
        max-height: 50vh; /* Max height when expanded */
        opacity: 1;
        overflow-y: auto; /* Allow scrolling if content exceeds max-height */
        padding-top: 0.5rem; /* Add some padding when expanded */
      }

      .question-palette-grid-mobile {
        display: grid;
        grid-template-columns: repeat(
          auto-fill,
          minmax(48px, 1fr)
        ); /* Consistent button size */
        gap: 0.75rem;
        padding: 0 1.5rem 1.5rem 1.5rem; /* Increased padding inside */
      }

      /* Show mobile palette on screens smaller than lg (desktop) for listening */
      @media (max-width: 1023px) {
        .mobile-question-palette-wrapper.listening-mobile {
          display: flex; /* Show on mobile/tablet for listening */
        }
        /* Adjust body padding to account for the fixed mobile palette header */
        body.listening-body-padding {
          padding-bottom: 72px; /* Adjusted for mobile palette header height */
        }
        .mock-test-layout.listening-layout {
          padding-bottom: 2rem; /* Ensure content above mobile palette */
        }
        /* Adjust top for audio player on smaller screens if header height changes */
        .audio-player-wrapper {
          top: 56px; /* Adjust if header is smaller on mobile */
        }
      }

      /* Hide mobile palette on larger screens */
      @media (min-width: 1024px) {
        .mobile-question-palette-wrapper {
          display: none !important;
        }
        body.listening-body-padding {
          padding-bottom: 0 !important; /* Remove padding when mobile palette is hidden */
        }
      }

      /* Question section styling */
      .question-section {
        margin-bottom: 3rem; /* More vertical space */
        padding-bottom: 2rem; /* More padding */
        border-bottom: 1px solid #e0e0e0; /* Subtle solid separator */
      }

      .question-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }

      /* Enhanced Question Group Instructions */
      .question-group-instructions {
        margin-bottom: 2.5rem; /* More space below */
        padding: 1.75rem; /* Increased padding */
        background-color: #e5f1ff; /* Light blue, flat */
        border-left: 8px solid #007aff; /* Apple Blue */
        border-radius: 1.25rem; /* More rounded corners */
        /* Removed shadow */
        font-size: 1.15rem; /* Slightly larger text */
        line-height: 1.7;
        color: #1a202c; /* Darker text for contrast */
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease-in-out;
      }

      .question-group-instructions::before {
        content: "\f05a"; /* FontAwesome info-circle icon */
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        position: absolute;
        top: 0.75rem;
        right: 1.25rem;
        font-size: 2.5rem; /* Larger icon */
        color: rgba(0, 122, 255, 0.1); /* Very faded blue */
        z-index: 0;
      }

      .question-group-instructions p {
        margin-bottom: 0.8rem;
        line-height: 1.6;
        position: relative;
        z-index: 1;
      }

      .question-group-instructions p:last-child {
        margin-bottom: 0;
      }

      /* Individual question item styling */
      .question-item {
        margin-bottom: 2rem; /* More space between questions */
        padding: 1.5rem; /* Increased padding */
        background-color: #ffffff; /* Pure white background */
        border-left: 6px solid #007aff; /* Apple Blue */
        border-radius: 0.75rem; /* Nicely rounded */
        /* Removed shadow */
        border: 1px solid #e0e0e0; /* Subtle border */
        transition: all 0.2s ease-in-out;
      }

      .question-item:hover {
        /* Subtle hover effect, no shadow */
        background-color: #f9f9f9;
      }

      .question-item label {
        display: block;
        margin-bottom: 0.6rem;
        font-weight: 600; /* Bolder label */
        color: #1a202c; /* Dark text */
      }

      .question-item .inline-question-text {
        display: inline;
        font-size: 1.125rem; /* text-lg */
        font-weight: 600; /* font-semibold */
        color: #334155; /* Slate 700 */
      }

      .question-item .inline-input,
      .question-item .inline-select {
        display: inline-block;
        width: 170px; /* Default width */
        padding: 0.4rem 0.8rem; /* More padding */
        margin: 0 0.6rem; /* More horizontal margin */
        border: 1px solid #d1d1d6; /* iOS-like border */
        border-radius: 0.5rem; /* More rounded */
        font-size: 1.05rem; /* Slightly larger font */
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        vertical-align: middle;
        background-color: white;
      }
      /* Make inline inputs fluid on small screens */
      @media (max-width: 767px) {
        .question-item .inline-input,
        .question-item .inline-select {
          width: calc(100% - 1.2rem); /* Full width minus side margins */
          margin: 0.6rem 0.6rem 0.6rem 0; /* Adjust margins for stacking */
          display: block; /* Stack on mobile */
        }
      }

      .question-item .inline-input:focus,
      .question-item .inline-select:focus {
        outline: none;
        border-color: #007aff; /* Apple Blue on focus */
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.25); /* Subtle focus ring */
      }

      /* New style for inputs on a new line */
      .question-item .block-input {
        display: block;
        width: calc(100% - 1.5rem); /* Full width minus padding */
        margin: 0.75rem 0.75rem 0 0.75rem; /* Increased margins */
        padding: 0.6rem 1.2rem; /* Larger padding */
        border: 1px solid #d1d1d6;
        border-radius: 0.5rem;
        font-size: 1.05rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      .question-item .block-input:focus {
        outline: none;
        border-color: #007aff;
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.25);
      }

      /* Table specific styles */
      .table-responsive-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 0.75rem; /* Rounded corners for the wrapper */
        /* Removed shadow */
        border: 1px solid #e0e0e0; /* Subtle border */
      }

      .question-item .table-input {
        width: 100%;
        padding: 0.4rem 0.8rem;
        border: 1px solid #d1d1d6;
        border-radius: 0.375rem;
        font-size: 1rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      .question-item .table-input:focus {
        outline: none;
        border-color: #007aff;
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
      }

      .question-item table {
        width: 100%;
        min-width: 650px; /* Slightly wider min-width for tables */
        border-collapse: collapse;
        margin-top: 1.25rem; /* More space above table */
        background-color: white;
      }

      .question-item th,
      .question-item td {
        border: 1px solid #e0e0e0; /* Light border for table cells */
        padding: 1rem; /* More padding in cells */
        text-align: left;
        color: #334155; /* Slate 700 */
      }

      .question-item th {
        background-color: #f9f9f9; /* Light gray background for headers */
        font-weight: 700;
        color: #1e293b; /* Darker text */
        text-transform: uppercase;
        font-size: 0.9rem;
      }

      /* Radio button and checkbox styling */
      .question-item input[type="radio"],
      .question-item input[type="checkbox"] {
        margin-right: 0.8rem; /* More space */
        transform: scale(1.3); /* Larger size */
        accent-color: #007aff; /* Apple Blue accent color */
      }

      .question-item .radio-option,
      .question-item .checkbox-option {
        display: flex;
        align-items: center;
        margin-bottom: 0.8rem; /* More space */
        cursor: pointer;
        padding: 0.75rem 1rem; /* More padding */
        border-radius: 0.75rem; /* More rounded */
        transition: background-color 0.2s ease;
        border: 1px solid #e0e0e0; /* Subtle border */
      }

      .question-item .radio-option:hover,
      .question-item .checkbox-option:hover {
        background-color: #f0f8ff; /* Very light blue on hover */
        /* Removed shadow */
      }

      .question-item .radio-option input[type="radio"]:checked + span,
      .question-item .checkbox-option input[type="checkbox"]:checked + span {
        font-weight: 700; /* Bolder when checked */
        color: #007aff; /* Apple Blue when checked */
      }

      /* Map image container */
      .map-image-container {
        width: 100%;
        max-width: 650px; /* Slightly larger max-width */
        margin: 2rem auto; /* More margin */
        border-radius: 1.25rem; /* More rounded */
        overflow: hidden;
        /* Removed shadow */
        border: 1px solid #e0e0e0; /* Subtle border */
      }

      .map-image-container img {
        width: 100%;
        height: auto;
        display: block;
      }

      /* User ID display (if present) */
      .user-id-display {
        background-color: rgba(255, 255, 255, 0.9); /* Slightly more opaque */
        border: 1px solid #d1d1d6; /* iOS-like border */
        color: #475569; /* Slate 600 */
        /* Removed shadow */
        backdrop-filter: blur(8px); /* Stronger blur */
      }

      /* Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5); /* Lighter overlay */
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease; /* Faster transition */
      }

      .modal-overlay.visible {
        opacity: 1;
        visibility: visible;
      }

      .modal-content {
        background-color: #ffffff;
        padding: 2.5rem; /* More padding */
        border-radius: 1.5rem; /* More rounded */
        /* Removed shadow, using a subtle border */
        border: 1px solid #e0e0e0;
        max-width: 550px; /* Slightly wider */
        width: 90%;
        text-align: center;
        transform: translateY(-20px); /* Starts slightly higher */
        opacity: 0;
        transition: transform 0.3s ease-out, opacity 0.3s ease-out; /* Faster transition */
      }

      .modal-overlay.visible .modal-content {
        transform: translateY(0);
        opacity: 1;
      }

      .modal-header {
        font-size: 2rem; /* Larger title */
        font-weight: 800; /* Extra bold */
        color: #1e293b; /* Dark slate */
        margin-bottom: 1.25rem;
      }

      .modal-body {
        font-size: 1.1rem; /* Slightly larger body text */
        color: #475569; /* Slate 600 */
        margin-bottom: 2rem;
      }

      .modal-buttons {
        display: flex;
        justify-content: center;
        gap: 1.25rem; /* More space between buttons */
      }

      .modal-button {
        padding: 0.85rem 1.75rem; /* More padding */
        border-radius: 0.75rem; /* More rounded */
        font-weight: 700; /* Bolder text */
        transition: background-color 0.2s ease, transform 0.15s ease;
        /* Removed shadow */
      }

      .modal-button.primary {
        background-color: #007aff; /* Apple Blue */
        color: white;
      }

      .modal-button.primary:hover {
        background-color: #006ee6; /* Darker Apple Blue */
        transform: translateY(-1px); /* Subtle lift effect */
      }

      .modal-button.secondary {
        background-color: #e5e5ea; /* iOS light gray */
        color: #475569; /* Slate 600 */
      }

      .modal-button.secondary:hover {
        background-color: #d1d1d6; /* Darker iOS light gray */
        transform: translateY(-1px);
      }

      /* Header styling */
      #app-header {
        background-color: #ffffff; /* White background for header */
        /* Removed shadow, using a subtle border */
        border-bottom: 1px solid #e0e0e0; /* Subtle bottom border */
      }

      /* Styles for results page elements */
      .results-card {
        background-color: #ffffff; /* Flat white background */
        border: 1px solid #e0e0e0; /* Light border */
        border-radius: 1.75rem; /* Even more rounded corners */
        /* Removed shadow */
        transition: all 0.3s ease-in-out;
        /* min-height: 100vh; - Removed from here, handled by flexbox on parent */
        overflow-y: auto; /* Keep this for internal scrolling if content is long */
      }

      /* Adjust padding for results card on small screens */
      @media (max-width: 639px) {
        /* Tailwind's default sm breakpoint is 640px */
        .results-card {
          padding: 1rem; /* Reduce padding for very small screens */
          border-radius: 0; /* Make it full width on very small screens */
          margin-left: 0;
          margin-right: 0;
          width: 100%; /* Take full width */
          min-height: calc(100vh - 64px); /* Adjust for header height */
          padding-top: 2rem; /* Give some space from the top */
        }
        .results-card .modal-header {
          /* Adjust modal header size if it's too big */
          font-size: 1.5rem;
        }
        .results-card .modal-body {
          /* Adjust modal body size */
          font-size: 1rem;
        }
        .results-card .modal-button {
          /* Adjust modal button padding */
          padding: 0.6rem 1.2rem;
          font-size: 0.9rem;
        }
      }

      /* Keyframe animations for a smoother experience */
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px); /* Starts slightly lower */
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-fade-in {
        animation: fadeIn 0.5s ease-out forwards; /* Faster fade-in */
      }

      .animate-fade-in-up {
        animation: fadeInUp 0.6s ease-out forwards; /* Faster, less pronounced slide-up */
      }

      /* Custom scrollbar for better aesthetics */
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px; /* Thinner scrollbar */
        height: 8px;
      }

      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f9f9f9; /* Very light background */
        border-radius: 8px;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #c7c7cc; /* iOS gray */
        border-radius: 8px;
        border: 2px solid #f9f9f9; /* Border to make thumb thinner */
      }

      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #a7a7ab; /* Darker iOS gray on hover */
      }

      /* Feedback section specific styles */
      .feedback-section .correct-answer {
        color: #34c759; /* Apple Green */
        font-weight: bold;
      }

      .feedback-section .incorrect-answer {
        color: #ff3b30; /* Apple Red */
        font-weight: bold;
      }

      .feedback-section .explanation {
        background-color: #e5f1ff; /* Light blue, flat */
        border-left: 5px solid #007aff; /* Apple Blue */
        padding: 1rem 1.25rem; /* More padding */
        border-radius: 0.75rem; /* More rounded */
        margin-top: 0.75rem;
        font-style: italic;
        color: #475569; /* slate-600 */
        /* Removed shadow */
      }

      /* Leaderboard table styling */
      .leaderboard-table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 1rem; /* More rounded */
        /* Removed shadow */
        border: 1px solid #e0e0e0; /* Subtle border */
      }

      .leaderboard-table {
        min-width: 700px; /* Wider min-width for better display */
        width: 100%;
        border-collapse: collapse;
      }

      .leaderboard-table th,
      .leaderboard-table td {
        padding: 1.25rem 1.75rem; /* More padding */
        text-align: left;
        border-bottom: 1px solid #e0e0e0; /* Light border */
      }

      .leaderboard-table th {
        background-color: #f9f9f9; /* Very light gray */
        font-weight: 700;
        color: #475569;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.08em; /* More letter spacing */
      }

      .leaderboard-table tbody tr:last-child td {
        border-bottom: none;
      }

      .leaderboard-table tbody tr:hover {
        background-color: #f0f8ff; /* Light blue on hover */
      }

      .leaderboard-table tbody tr.current-user-row {
        background-color: #e5f1ff; /* Light Apple Blue */
        font-weight: 600;
        color: #007aff; /* Apple Blue */
        position: relative;
      }

      .leaderboard-table tbody tr.current-user-row:hover {
        background-color: #d1eaff; /* Slightly darker Apple Blue on hover */
      }

      /* Adjust leaderboard table cell padding for mobile */
      @media (max-width: 767px) {
        /* Adjust for mobile tables */
        .leaderboard-table th,
        .leaderboard-table td {
          padding: 0.75rem 0.5rem; /* Reduced padding */
          font-size: 0.75rem; /* Smaller font size */
        }
        .leaderboard-table {
          min-width: unset; /* Remove min-width to allow shrinking */
        }
        .rank-badge {
          width: 24px; /* Smaller badge */
          height: 24px; /* Smaller badge */
          font-size: 0.8rem; /* Smaller font */
        }
      }

      /* Rank badges */
      .rank-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px; /* Larger badge */
        height: 32px; /* Larger badge */
        border-radius: 50%;
        font-weight: bold;
        font-size: 0.95rem; /* Larger font */
        color: white;
        margin-right: 0.75rem; /* More space */
        /* Removed shadow */
      }

      .rank-1 {
        background: #ffcc00; /* Apple Yellow */
      }
      .rank-2 {
        background: #a7a7ad; /* Apple Silver */
      }
      .rank-3 {
        background: #a2845e; /* Apple Bronze */
      }
      .rank-common {
        background-color: #c7c7cc; /* iOS Gray */
      }

      /* Specific heights for different layouts and screen sizes */
      @media (max-width: 1023px) {
        /* Mobile and Tablet specific heights */
        .mock-test-layout.listening-layout .main-test-content {
          /* Header (64px) + Audio Player (80px) + Mobile Palette Header (72px) = 216px */
          height: calc(100vh - 102px);
          border-radius: 0vw;
        }
        .mock-test-layout.reading-layout {
          /* No grid on mobile, handled by flex column */
          display: flex;
          flex-direction: column;
          padding: 0; /* Remove padding from layout, add to inner elements */
          gap: 1.5px;
        }
        .mock-test-layout.reading-layout .main-test-content {
          /* Header (64px) + Tab bar (approx 56px) + Test Info Bar (60px) = 180px. Remaining height */
          height: calc(100vh - 220px);
          border-radius: 0; /* Full width, no rounded corners on mobile */
          border-top: none; /* No top border when part of tabbed view */
          /* Height of the sticky bar */
        }
        .mock-test-layout.reading-layout .passage-content-area {
          height: calc(100vh - 220px); /* Same height as questions */
          border-radius: 0; /* Full width, no rounded corners on mobile */
          border-top: none; /* No top border when part of tabbed view */
          resize: none; /* Disable resizing on mobile */
          /* Height of the sticky bar */
        }

        /* Mobile Reading Tabs */
        .reading-tabs-container {
          display: flex;
          width: 100%;
          background-color: #ffffff;
          border-bottom: 1px solid #e0e0e0;
          position: sticky;
          top: 64px; /* Below header */
          z-index: 900;
          justify-content: space-around;
          align-items: center;
          height: 56px; /* Fixed height for tab bar */
        }

        .reading-tab-button {
          flex: 1;
          display: flex;
          justify-content: center;
          align-items: center;
          padding: 0.75rem 0;
          font-size: 1.1rem;
          font-weight: 600;
          color: #636366; /* Apple Gray */
          border-bottom: 3px solid transparent;
          transition: all 0.2s ease-in-out;
          cursor: pointer;
        }

        .reading-tab-button.active {
          color: #007aff; /* Apple Blue */
          border-color: #007aff;
        }

        .reading-tab-content {
          flex-grow: 1; /* Allow content to fill remaining space */
          overflow-y: auto; /* Ensure content is scrollable */
          padding: 0.2rem; /* Reduced padding for mobile */
        }

        /* Hide desktop layout for reading on small screens */
        .mock-test-layout.reading-layout .passage-content-area.desktop-only {
          display: none;
        }
        .mock-test-layout.reading-layout .main-test-content.desktop-only {
          display: none;
        }
      }

      @media (min-width: 1024px) {
        /* Desktop specific heights */
        .mock-test-layout.listening-layout .main-test-content {
          height: 79.5vh;
        }
        .mock-test-layout.listening-layout .sidebar {
          height: 79.5vh;
        }
        .mock-test-layout.reading-layout .main-test-content,
        .mock-test-layout.reading-layout .passage-content-area {
          /* Header (64px) + Info Bar (60px) = 124px. Calc height: 100vh - 124px */
          height: calc(100vh - 124px); /* Adjusted height */
          border-radius: 0rem;
          /* Height of the sticky bar */
          border-top: none; /* Remove top border as it's below sticky bar */
        }

        /* Hide mobile-specific reading tabs on desktop */
        .reading-tabs-container {
          display: none !important;
        }
        /* Ensure desktop content is visible */
        .mock-test-layout.reading-layout .passage-content-area {
          display: block !important; /* Override mobile display:none */
        }
      }
      @media (max-width: 400px) {
        /* Large desktop specific heights */
        .mock-test-layout.listening-layout .main-test-content {
          padding-top: 40vw;
        }
      }
    </style>
  </head>
  <body class="py-0 px-0">
    <!-- Header / Navigation Bar -->
    <header
      id="app-header"
      class="site-header py-4 px-4 md:px-8 flex items-center justify-between transition-colors duration-300 sticky top-0 z-50"
    >
      <div class="flex items-center gap-2 sm:gap-4">
        <img
          src="assets/278115481_106536582034386_7446598694214552893_n-removebg-preview.png"
          alt="IELTS Mahir Logo"
          class="h-8 md:h-10 w-auto"
          onerror="this.onerror=null; this.src='https://placehold.co/100x40/E0E0E0/333333?text=Logo';"
        />
        <nav class="hidden md:flex gap-6 ml-8 font-inter">
          <a
            href="quiz-home.html"
            class="nav-link text-gray-700 hover:text-blue-600 transition-all font-medium text-lg"
            >Quiz System</a
          >
          <a
            href="mock-test-home.html"
            class="nav-link text-gray-700 hover:text-blue-600 transition-all font-medium text-lg"
            >Mock Tests</a
          >
          <a
            href="#"
            class="nav-link text-gray-700 hover:text-blue-600 transition-all font-medium text-lg"
            >Resources</a
          >
        </nav>
      </div>
      <div id="auth-buttons-container" class="flex items-center gap-2 sm:gap-4">
        <!-- Authentication status will be handled by auth.js -->
        <div class="animate-pulse flex space-x-4">
          <div class="rounded-full bg-gray-300 h-8 w-8 sm:h-10 sm:w-10"></div>
          <div class="flex-1 space-y-4 py-1 hidden sm:block">
            <div class="h-2 bg-gray-300 rounded"></div>
            <div class="space-y-2">
              <div class="grid grid-cols-3 gap-2">
                <div class="h-2 bg-gray-300 rounded col-span-2"></div>
                <div class="h-2 bg-gray-300 rounded col-span-1"></div>
              </div>
              <div class="h-2 bg-gray-300 rounded"></div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Audio Player (fixed/sticky at top) -->
    <div id="fixed-audio-player-wrapper" class="audio-player-wrapper">
      <div class="audio-player-container">
        <audio id="test-audio-player" controls preload="auto" class="w-full">
          <source src="" type="audio/mpeg" />
          <!-- Audio URL will be set by JS -->
          Your browser does not support the audio element.
        </audio>
      </div>
    </div>

    <!-- New: Sticky Test Info Bar (for Reading/Writing modules) -->
    <div id="test-info-bar" class="test-info-bar">
      <h2 class="text-xl font-anton text-gray-800">
        <span id="test-title-top-bar"></span>
        <span
          id="section-info-top-bar"
          class="ml-2 text-lg font-semibold text-gray-700"
        ></span>
      </h2>
      <div class="flex items-center gap-2 text-xl font-bold text-gray-700">
        <i class="fas fa-clock"></i>
        <span id="timer-display-top-bar">00:00</span>
      </div>
    </div>

    <!-- Main application content area -->
    <div id="app" class="flex-grow flex flex-col">
      <!-- Loading spinner for initial content load -->
      <div class="flex justify-center items-center h-full flex-grow">
        <div
          class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"
        ></div>
      </div>
    </div>

    <!-- Mobile Fixed Question Palette (fixed at bottom) -->
    <div
      id="mobile-question-palette-wrapper"
      class="mobile-question-palette-wrapper"
    >
      <div
        id="mobile-palette-header"
        class="flex justify-between items-center px-4 py-3 bg-slate-800 text-white rounded-t-2xl shadow-lg cursor-pointer"
      >
        <div class="flex items-center gap-2 text-xl font-bold">
          <i class="fas fa-th-large"></i>
          <span>Question Palette</span>
        </div>
        <div class="flex items-center gap-2 text-xl font-bold">
          <i class="fas fa-clock"></i>
          <span id="timer-display-mobile">00:00</span>
          <i
            id="palette-toggle-icon"
            class="ph ph-caret-down text-2xl ml-2 transition-transform duration-300"
          ></i>
        </div>
      </div>
      <div id="mobile-palette-content">
        <div
          class="question-palette-grid-mobile"
          id="question-palette-mobile"
        ></div>
      </div>
    </div>

    <!-- Toast Container for notifications -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-[100]"></div>

    <!-- Modal Container for confirmations/alerts -->
    <div id="modal-container" class="modal-overlay">
      <div class="modal-content">
        <h3 id="modal-title" class="modal-header"></h3>
        <p id="modal-message" class="modal-body"></p>
        <div id="modal-buttons" class="modal-buttons"></div>
      </div>
    </div>

    <script type="module">
      // Import authentication functions and state from the central auth.js file
      import {
        initFirebaseAuth,
        authAppState,
        showToast,
        Icons,
        signOutUser,
      } from "./auth.js"; // Adjust path as necessary

      // Import mock test data
      import {
        MockTestModules,
        allMockTests,
        MockTestIcons,
        formatTime,
      } from "./mock-test-data.js";

      // Firebase imports for Firestore
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        updateDoc,
        collection,
        addDoc,
        serverTimestamp,
        query,
        where,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // Firebase instances (will be populated by auth.js)
      let db;
      let auth;

      // Current module and test IDs from URL
      let currentModuleId = null;
      let currentTestId = null;
      let currentTest = null;
      let totalQuestions = 0; // This will now represent total answerable slots

      // Test state encapsulated in an object
      let testState = {
        userAnswers: {}, // { questionId: userAnswer } (e.g., "mcq1", "q26")
        timerInterval: null,
        timeLeft: 0, // In seconds
        currentQuestionIndex: 0, // 0-based index for the questionPaletteItems array
        currentSectionIndex: 0, // 0-based index for current test section (used for reading)
        testCompleted: false, // New state to control view
        userResultDoc: null, // Stores the fetched user result for display
        leaderboard: [], // Stores leaderboard data
        userRank: null, // User's rank on the leaderboard
        isLoadingResults: false, // For loading state of results section
        activeReadingTab: "questions", // New: 'passage' or 'questions' for mobile reading
      };

      // New: Array to map palette numbers to question IDs and their HTML element IDs
      let questionPaletteItems = []; // Stores { paletteNumber: N, questionId: "qX" or "mcqY", htmlElementId: "question-Z" }

      /**
       * Displays a custom modal.
       * @param {string} title - The title of the modal.
       * @param {string} message - The message content of the modal.
       * @param {boolean} showConfirmButton - Whether to show a confirm button.
       * @param {function} onConfirm - Callback function for confirm button.
       * @param {function} onCancel - Callback function for cancel button.
       */
      function showModal(
        title,
        message,
        showConfirmButton,
        onConfirm,
        onCancel
      ) {
        const modalOverlay = document.getElementById("modal-container");
        const modalTitle = document.getElementById("modal-title");
        const modalMessage = document.getElementById("modal-message");
        const modalButtons = document.getElementById("modal-buttons");

        if (!modalOverlay || !modalTitle || !modalMessage || !modalButtons) {
          console.error("Modal elements not found.");
          return;
        }

        modalTitle.innerHTML = title;
        modalMessage.innerHTML = message;
        modalButtons.innerHTML = ""; // Clear existing buttons

        if (showConfirmButton) {
          const confirmButton = document.createElement("button");
          confirmButton.textContent = "Confirm";
          confirmButton.classList.add("modal-button", "primary");
          confirmButton.addEventListener("click", () => {
            hideModal();
            if (onConfirm) onConfirm();
          });
          modalButtons.appendChild(confirmButton);

          const cancelButton = document.createElement("button");
          cancelButton.textContent = "Cancel";
          cancelButton.classList.add("modal-button", "secondary");
          cancelButton.addEventListener("click", () => {
            hideModal();
            if (onCancel) onCancel();
          });
          modalButtons.appendChild(cancelButton);
        } else {
          // For informational modals, just show an OK button or no buttons
          const okButton = document.createElement("button");
          okButton.textContent = "OK";
          okButton.classList.add("modal-button", "primary");
          okButton.addEventListener("click", () => {
            hideModal();
            if (onConfirm) onConfirm(); // Use onConfirm as a general callback for OK
          });
          modalButtons.appendChild(okButton);
        }

        modalOverlay.classList.add("visible");
      }

      /**
       * Hides the custom modal.
       */
      function hideModal() {
        const modalOverlay = document.getElementById("modal-container");
        if (modalOverlay) {
          modalOverlay.classList.remove("visible");
        }
      }

      /**
       * Updates the navigation bar and user ID display based on authentication status.
       * @param {object|null} user - The Firebase User object or null if signed out.
       */
      async function updateAuthUI(user) {
        const authButtonsContainer = document.getElementById(
          "auth-buttons-container"
        );
        if (authButtonsContainer) {
          if (user) {
            // User is signed in: Show profile dropdown
            authButtonsContainer.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="relative">
                                <button id="profile-icon-btn" class="flex items-center justify-center w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-blue-600 text-white text-lg sm:text-xl font-bold shadow-md hover:bg-blue-700 transition-colors">
                                    ${(
                                      authAppState.userProfile?.name ||
                                      user.email ||
                                      user.uid
                                    )
                                      .charAt(0)
                                      .toUpperCase()}
                                </button>
                                <div id="profile-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl py-2 z-50 hidden text-gray-800">
                                    <div class="px-4 py-2 text-sm border-b border-gray-200">Hello, ${
                                      authAppState.userProfile?.name ||
                                      user.email ||
                                      user.uid.substring(0, 8)
                                    }</div>
                                    <a href="dashboard.html" class="flex items-center gap-2 px-4 py-2 hover:bg-gray-100">
                                        ${Icons.Dashboard.replace(
                                          /stroke="currentColor"/g,
                                          'stroke="gray"'
                                        )} Dashboard
                                    </a>
                                    <a href="ielts-mahir-community-forum.html" class="flex items-center gap-2 px-4 py-2 hover:bg-gray-100">
                                        ${Icons.Forum.replace(
                                          /stroke="currentColor"/g,
                                          'stroke="gray"'
                                        )} Forum
                                    </a>
                                    <button id="sign-out-dropdown-btn" class="flex items-center gap-2 w-full text-left px-4 py-2 text-red-600 hover:bg-red-100 rounded-b-lg">
                                        ${Icons.SignOut.replace(
                                          /stroke="currentColor"/g,
                                          'stroke="red"'
                                        )} Sign Out
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;

            const profileIconBtn = document.getElementById("profile-icon-btn");
            const profileDropdown = document.getElementById("profile-dropdown");
            const signOutDropdownBtn = document.getElementById(
              "sign-out-dropdown-btn"
            );

            profileIconBtn.addEventListener("click", (event) => {
              event.stopPropagation();
              profileDropdown.classList.toggle("hidden");
            });

            document.addEventListener("click", (event) => {
              if (
                !profileDropdown.contains(event.target) &&
                !profileIconBtn.contains(event.target)
              ) {
                profileDropdown.classList.add("hidden");
              }
            });

            signOutDropdownBtn.addEventListener("click", async () => {
              await signOutUser();
              // Redirect will happen via onAuthStateChanged in auth.js
            });
          } else {
            // User is signed out: Show sign-in button
            authButtonsContainer.innerHTML = `
                        <a href="auth.html" id="sign-in-nav-btn" class="px-4 py-2 bg-blue-600 text-white rounded-full shadow-md hover:bg-blue-700 transition-all text-sm font-semibold transform active:scale-95">
                            Join beta user
                        </a>
                    `;
          }
        }
      }

      /**
       * Calculates the IELTS band score based on the number of correct answers.
       * This is a simplified mapping and may not perfectly reflect official IELTS scoring.
       * @param {number} correctAnswersCount - The number of correct answers.
       * @param {number} totalQuestions - The total number of answerable slots.
       * @returns {number|string} The calculated band score (e.g., 7.5) or "N/A" if totalQuestions is 0.
       */
      function calculateIELTSBandScore(correctAnswersCount, totalQuestions) {
        if (totalQuestions === 0) return "N/A";

        // This mapping is a simplified approximation for a 40-question test.
        // If your mock tests have a different number of total questions,
        // you might need to scale correctAnswersCount to a 40-question equivalent
        // or adjust the thresholds based on percentage.
        // For simplicity, let's assume this mapping is for a scaled score or direct 40-question count.
        // For varying totalQuestions, a percentage-based approach is more robust.
        const percentage = (correctAnswersCount / totalQuestions) * 100;

        if (percentage >= 90) return 9.0; // 36-40 correct (out of 40)
        if (percentage >= 85) return 8.5; // 34-35 correct
        if (percentage >= 80) return 8.0; // 32-33 correct
        if (percentage >= 75) return 7.5; // 30-31 correct
        if (percentage >= 70) return 7.0; // 28-29 correct
        if (percentage >= 65) return 6.5; // 26-27 correct
        if (percentage >= 60) return 6.0; // 24-25 correct
        if (percentage >= 55) return 5.5; // 22-23 correct
        if (percentage >= 50) return 5.0; // 20-21 correct
        if (percentage >= 45) return 4.5; // 18-19 correct
        if (percentage >= 40) return 4.0; // 16-17 correct
        if (percentage >= 35) return 3.5; // 14-15 correct
        if (percentage >= 30) return 3.0; // 12-13 correct
        if (percentage >= 25) return 2.5; // 10-11 correct
        if (percentage >= 20) return 2.0; // 8-9 correct
        if (percentage >= 15) return 1.5; // 6-7 correct
        if (percentage >= 10) return 1.0; // 4-5 correct
        return 0; // Less than 10% or 4 correct
      }

      /**
       * Handles user answer input for text fields and select dropdowns.
       * @param {string} questionId - The ID of the question (e.g., "mcq1", "q26").
       * @param {string} answer - The user's answer.
       */
      function handleAnswerInput(questionId, answer) {
        testState.userAnswers[questionId] = answer.trim();
        if (currentModuleId === "listening") {
          updateQuestionPalette(); // Only update palette for listening
        }
      }

      /**
       * Handles user answer input for multiple choice (checkboxes).
       * @param {string} questionId - The ID of the question.
       * @param {string} value - The value of the checkbox.
       * @param {boolean} isChecked - Whether the checkbox is checked.
       */
      window.handleMultipleChoiceInput = (questionId, value, isChecked) => {
        let currentAnswers = testState.userAnswers[questionId] || [];
        if (isChecked) {
          if (!currentAnswers.includes(value)) {
            currentAnswers.push(value);
          }
        } else {
          currentAnswers = currentAnswers.filter((item) => item !== value);
        }
        testState.userAnswers[questionId] = currentAnswers;
        if (currentModuleId === "listening") {
          updateQuestionPalette(); // Only update palette for listening
        }
      };

      /**
       * Updates the question palette to reflect answered/unanswered questions.
       */
      function updateQuestionPalette() {
        questionPaletteItems.forEach((item) => {
          // Update desktop palette
          const desktopButton = document.querySelector(
            `#question-palette-desktop .question-palette-btn[data-palette-number="${item.paletteNumber}"]`
          );
          if (desktopButton) {
            const userAnswer = testState.userAnswers[item.questionId];
            if (userAnswer && userAnswer !== "" && !Array.isArray(userAnswer)) {
              desktopButton.classList.remove("unanswered");
              desktopButton.classList.add("answered");
            } else if (Array.isArray(userAnswer) && userAnswer.length > 0) {
              desktopButton.classList.remove("unanswered");
              desktopButton.classList.add("answered");
            } else {
              desktopButton.classList.remove("answered");
              desktopButton.classList.add("unanswered");
            }
          }

          // Update mobile palette
          const mobileButton = document.querySelector(
            `#question-palette-mobile .question-palette-btn[data-palette-number="${item.paletteNumber}"]`
          );
          if (mobileButton) {
            const userAnswer = testState.userAnswers[item.questionId];
            if (userAnswer && userAnswer !== "" && !Array.isArray(userAnswer)) {
              mobileButton.classList.remove("unanswered");
              mobileButton.classList.add("answered");
            } else if (Array.isArray(userAnswer) && userAnswer.length > 0) {
              mobileButton.classList.remove("unanswered");
              mobileButton.classList.add("answered");
            } else {
              mobileButton.classList.remove("answered");
              mobileButton.classList.add("unanswered");
            }
          }
        });
        highlightCurrentQuestionInPalette();
      }

      /**
       * Highlights the current question in the palette.
       */
      function highlightCurrentQuestionInPalette() {
        const desktopPaletteButtons = document.querySelectorAll(
          "#question-palette-desktop .question-palette-btn"
        );
        desktopPaletteButtons.forEach((button) => {
          button.classList.remove("current");
        });

        const mobilePaletteButtons = document.querySelectorAll(
          "#question-palette-mobile .question-palette-btn"
        );
        mobilePaletteButtons.forEach((button) => {
          button.classList.remove("current");
        });

        if (questionPaletteItems.length > 0) {
          const currentPaletteNumber = testState.currentQuestionIndex + 1;
          const currentDesktopQBtn = document.querySelector(
            `#question-palette-desktop .question-palette-btn[data-palette-number="${currentPaletteNumber}"]`
          );
          if (currentDesktopQBtn) {
            currentDesktopQBtn.classList.add("current");
          }
          const currentMobileQBtn = document.querySelector(
            `#question-palette-mobile .question-palette-btn[data-palette-number="${currentPaletteNumber}"]`
          );
          if (currentMobileQBtn) {
            currentMobileQBtn.classList.add("current");
          }
        }
      }

      /**
       * Scrolls to a specific question based on its palette number.
       * @param {number} paletteNumber - The 1-based number of the question in the palette.
       */
      function scrollToQuestion(paletteNumber) {
        const item = questionPaletteItems.find(
          (i) => i.paletteNumber === paletteNumber
        );
        if (item) {
          const questionElement = document.getElementById(item.htmlElementId);
          if (questionElement) {
            questionElement.scrollIntoView({
              behavior: "smooth",
              block: "start",
            });
            testState.currentQuestionIndex = paletteNumber - 1; // Update current index (0-based)
            highlightCurrentQuestionInPalette();
          }
        }
      }

      /**
       * Starts the test timer.
       */
      function startTimer() {
        if (testState.timerInterval) clearInterval(testState.timerInterval); // Clear any existing timer

        const mobileTimerDisplay = document.getElementById(
          "timer-display-mobile"
        );
        const desktopTimerDisplaySidebar = document.getElementById(
          "timer-display-desktop-sidebar"
        ); // For sidebar timer
        const topBarTimerDisplay = document.getElementById(
          "timer-display-top-bar"
        ); // New: For the sticky top bar timer

        testState.timerInterval = setInterval(() => {
          testState.timeLeft--;
          if (testState.timeLeft >= 0) {
            const formattedTime = formatTime(testState.timeLeft);
            if (mobileTimerDisplay)
              mobileTimerDisplay.textContent = formattedTime;
            if (desktopTimerDisplaySidebar)
              desktopTimerDisplaySidebar.textContent = formattedTime; // Update sidebar timer
            if (topBarTimerDisplay)
              // Update new top bar timer
              topBarTimerDisplay.textContent = formattedTime;
          } else {
            clearInterval(testState.timerInterval);
            if (mobileTimerDisplay) mobileTimerDisplay.textContent = "00:00";
            if (desktopTimerDisplaySidebar)
              desktopTimerDisplaySidebar.textContent = "00:00"; // Update sidebar timer
            if (topBarTimerDisplay)
              // Update new top bar timer
              topBarTimerDisplay.textContent = "00:00";
            showToast("Time's up! Your test has been submitted.", "info");
            handleSubmitTest(); // Automatically submit when time runs out
          }
        }, 1000);
      }

      /**
       * Saves the mock test result to Firestore.
       * @param {number} correctAnswers - Number of correct answers.
       * @param {number} totalQuestions - Total number of questions/answerable slots.
       * @param {number|string} bandScore - Calculated IELTS band score.
       * @param {number} timeTakenSeconds - Time taken in seconds.
       */
      async function saveMockTestResultToFirestore(
        correctAnswers,
        totalQuestions,
        bandScore,
        timeTakenSeconds
      ) {
        if (!db || !authAppState.userId) {
          showToast(
            "Not logged in. Mock test results will not be saved.",
            "warning"
          );
          return;
        }

        const appId =
          typeof __app_id !== "undefined" ? __app_id : "default-app-id";
        const userId = authAppState.userId;
        const userEmail = authAppState.user?.email || "Anonymous";
        const userName =
          authAppState.userProfile?.name || userEmail.split("@")[0];

        const resultData = {
          userId: userId,
          userName: userName,
          userEmail: userEmail,
          moduleId: currentModuleId,
          testId: currentTestId,
          testTitle: currentTest.title,
          correctAnswers: correctAnswers,
          totalQuestions: totalQuestions,
          bandScore: bandScore,
          timeTakenSeconds: timeTakenSeconds,
          timestamp: serverTimestamp(),
          userAnswers: testState.userAnswers, // Save user answers for potential future review
        };

        try {
          // Save to private user results collection
          const privateDocRef = await addDoc(
            collection(
              db,
              `artifacts/${appId}/users/${userId}/mockTestResults`
            ),
            resultData
          );
          console.log("Mock test result saved to private collection.");
          testState.userResultDoc = { id: privateDocRef.id, ...resultData }; // Store the saved document

          // Save to public global results collection for leaderboard
          await addDoc(
            collection(
              db,
              `artifacts/${appId}/public/data/mockTestGlobalResults`
            ),
            resultData
          );
          console.log("Mock test result saved to public collection.");
          // Removed showToast here, will be shown as modal after rendering results
        } catch (error) {
          console.error("Error saving mock test result:", error);
          showToast("Failed to save mock test results.", "error");
        }
      }

      /**
       * Fetches the user's specific mock test result from Firestore.
       * @param {string} userId - The ID of the current user.
       * @param {string} testId - The ID of the test.
       * @returns {Promise<object|null>} The result document data or null if not found.
       */
      async function fetchUserMockTestResult(userId, testId) {
        if (!db || !userId || !testId) return null;
        const appId =
          typeof __app_id !== "undefined" ? __app_id : "default-app-id";
        const resultsRef = collection(
          db,
          `artifacts/${appId}/users/${userId}/mockTestResults`
        );
        const q = query(
          resultsRef,
          where("testId", "==", testId),
          where("userId", "==", userId)
        );

        try {
          const querySnapshot = await getDocs(q);
          if (!querySnapshot.empty) {
            let latestResult = null;
            let latestTimestamp = 0;
            querySnapshot.forEach((docSnap) => {
              const data = docSnap.data();
              const timestamp = data.timestamp ? data.timestamp.toMillis() : 0;
              if (timestamp > latestTimestamp) {
                latestTimestamp = timestamp;
                latestResult = { id: docSnap.id, ...data };
              }
            });
            return latestResult;
          }
          return null;
        } catch (error) {
          console.error("Error fetching user mock test result:", error);
          showToast("Failed to load your test results.", "error");
          return null;
        }
      }

      /**
       * Fetches and updates the leaderboard for the current mock test.
       */
      async function fetchLeaderboard() {
        if (!db || !currentTestId) return; // Use currentTestId from global scope
        const appId =
          typeof __app_id !== "undefined" ? __app_id : "default-app-id";
        const leaderboardRef = collection(
          db,
          `artifacts/${appId}/public/data/mockTestGlobalResults`
        );
        const q = query(leaderboardRef, where("testId", "==", currentTestId));

        try {
          const querySnapshot = await getDocs(q);
          let rawResults = [];
          querySnapshot.forEach((doc) => {
            rawResults.push(doc.data());
          });

          // Deduplicate results by userId, keeping the best score (highest band, then lowest time)
          const bestResultsMap = new Map(); // Map<userId, bestResult>
          rawResults.forEach((result) => {
            const currentBand = parseFloat(result.bandScore) || 0;
            const existingBest = bestResultsMap.get(result.userId);
            const existingBand = existingBest
              ? parseFloat(existingBest.bandScore) || 0
              : -1;

            if (
              !existingBest ||
              currentBand > existingBand ||
              (currentBand === existingBand &&
                result.timeTakenSeconds < (existingBest.timeTakenSeconds || 0))
            ) {
              bestResultsMap.set(result.userId, result);
            }
          });

          let leaderboard = Array.from(bestResultsMap.values());

          // Sort in memory: highest band score first, then lowest time taken
          leaderboard.sort((a, b) => {
            const aBand = parseFloat(a.bandScore) || 0;
            const bBand = parseFloat(b.bandScore) || 0;
            const aTime = parseFloat(a.timeTakenSeconds) || 0;
            const bTime = parseFloat(b.timeTakenSeconds) || 0;

            if (bBand !== aBand) {
              return bBand - aBand; // Higher band score first
            }
            return aTime - bTime; // Lower time taken first
          });

          testState.leaderboard = leaderboard.slice(0, 10); // Get top 10

          // Find user's rank
          if (authAppState.userId) {
            const userEntry = leaderboard.find(
              (entry) => entry.userId === authAppState.userId
            );
            if (userEntry) {
              testState.userRank = leaderboard.indexOf(userEntry) + 1;
            } else {
              testState.userRank = null; // User not on leaderboard
            }
          } else {
            testState.userRank = null;
          }

          console.log("Leaderboard fetched:", testState.leaderboard);
        } catch (error) {
          console.error("Error fetching leaderboard:", error);
          showToast("Failed to load leaderboard.", "error");
        }
      }

      /**
       * Calculates the score and updates user stats.
       */
      async function handleSubmitTest() {
        clearInterval(testState.timerInterval); // Stop the timer

        // Show a loading modal
        showModal("Submitting Test", "Calculating your score...", false);

        let correctAnswersCount = 0;

        currentTest.sections.forEach((section) => {
          section.questionGroups.forEach((qGroup) => {
            // Check qGroup.type first for types where 'type' is on the group
            if (
              qGroup.type === "matching_headings" ||
              qGroup.type === "matching_items" ||
              qGroup.type === "true_false_not_given" ||
              qGroup.type === "multiple_choice_multiple_answers" ||
              qGroup.type === "which_paragraph_contains" ||
              qGroup.type === "matching_sentence_endings"
            ) {
              if (qGroup.questions && qGroup.questions.length > 0) {
                qGroup.questions.forEach((question) => {
                  let userAnswer;
                  let correctAnswer;
                  let isCorrect = false;

                  if (qGroup.type === "multiple_choice_multiple_answers") {
                    userAnswer = testState.userAnswers[question.id] || [];
                    correctAnswer = question.correctAnswer || [];
                    isCorrect =
                      userAnswer.length === correctAnswer.length &&
                      userAnswer.every((ans) => correctAnswer.includes(ans));
                  } else {
                    userAnswer = testState.userAnswers[question.id];
                    correctAnswer = question.correctAnswer;
                    isCorrect = userAnswer === correctAnswer;
                  }

                  if (isCorrect) {
                    correctAnswersCount++;
                  }
                });
              }
            } else if (qGroup.type === "table_fill_in_the_blank") {
              // Special handling for table questions (already correct)
              if (
                qGroup.questions &&
                qGroup.questions.length > 0 &&
                qGroup.questions[0].correctAnswer
              ) {
                for (const subQuestionId in qGroup.questions[0].correctAnswer) {
                  const userAnswer = testState.userAnswers[subQuestionId];
                  const correctAnswer =
                    qGroup.questions[0].correctAnswer[subQuestionId];
                  if (
                    userAnswer &&
                    correctAnswer &&
                    userAnswer.toLowerCase() === correctAnswer.toLowerCase()
                  ) {
                    correctAnswersCount++;
                  }
                }
              }
            } else {
              // Default handling for types where 'type' is on the individual question (e.g., fill_in_the_blank, mcq)
              if (qGroup.questions && qGroup.questions.length > 0) {
                qGroup.questions.forEach((question) => {
                  if (question.type === "mcq") {
                    const userAnswer = testState.userAnswers[question.id];
                    const correctAnswer = question.correctAnswer;
                    if (userAnswer === correctAnswer) {
                      correctAnswersCount++;
                    }
                  } else if (
                    question.type === "fill_in_the_blank" ||
                    question.type === "map_labeling" ||
                    question.type === "fill_in_the_blank_passage" ||
                    question.type === "summary_completion"
                  ) {
                    const userAnswer = testState.userAnswers[question.id];
                    const correctAnswer = question.correctAnswer;
                    if (
                      userAnswer &&
                      correctAnswer &&
                      userAnswer.toLowerCase() === correctAnswer.toLowerCase()
                    ) {
                      correctAnswersCount++;
                    }
                  } else if (question.type === "table_fill_in_the_blank") {
                    // Handle table questions that might be in a generic qGroup
                    if (question.correctAnswer) {
                      for (const subQuestionId in question.correctAnswer) {
                        const userAnswer = testState.userAnswers[subQuestionId];
                        const correctAnswer =
                          question.correctAnswer[subQuestionId];
                        if (
                          userAnswer &&
                          correctAnswer &&
                          userAnswer.toLowerCase() ===
                            correctAnswer.toLowerCase()
                        ) {
                          correctAnswersCount++;
                        }
                      }
                    }
                  }
                });
              }
            }
          });
        });

        const bandScore = calculateIELTSBandScore(
          correctAnswersCount,
          totalQuestions
        );
        const timeTakenSeconds = currentTest.duration * 60 - testState.timeLeft;

        // Save result to Firestore and update testState.userResultDoc
        await saveMockTestResultToFirestore(
          correctAnswersCount,
          totalQuestions,
          bandScore,
          timeTakenSeconds
        );

        // Fetch leaderboard after saving the user's result
        await fetchLeaderboard();

        // Update test state to show results
        testState.testCompleted = true;
        testState.isLoadingResults = false; // Ensure loading is off

        hideModal(); // Hide the submission modal

        renderApp(); // Re-render the app to show results

        // Show success modal after results are rendered
        showModal("Success!", "Mock test results saved successfully!", false);
      }

      /**
       * Renders the mock test feedback section.
       * This function is now part of mock-test.html
       * @param {HTMLElement} parentDiv - The div to render the feedback into.
       */
      function renderMockTestFeedbackSection(parentDiv) {
        if (!currentTest || !testState.userResultDoc) {
          parentDiv.innerHTML =
            "<p class='text-center text-red-500'>No results data available. Please complete a mock test first.</p>";
          return;
        }

        const {
          testTitle,
          correctAnswers,
          totalQuestions,
          bandScore,
          timeTakenSeconds,
          userAnswers,
        } = testState.userResultDoc;

        const percentage =
          totalQuestions > 0
            ? ((correctAnswers / totalQuestions) * 100).toFixed(2)
            : 0;
        const formattedTimeTaken = formatTime(timeTakenSeconds);

        // Determine strengths and areas for improvement (simplified logic)
        const strengths = [];
        const areasForImprovement = [];
        if (bandScore >= 7.0) strengths.push("Excellent overall performance!");
        if (correctAnswers / totalQuestions > 0.7)
          strengths.push("Strong grasp of concepts.");
        if (correctAnswers / totalQuestions < 0.6)
          areasForImprovement.push("Review core concepts for improvement.");
        if (timeTakenSeconds > currentTest.duration * 60 * 0.8)
          areasForImprovement.push("Work on time management to finish faster.");

        parentDiv.innerHTML = `
                <div class="max-w-4xl mx-auto results-card p-6 sm:p-8 rounded-2xl animate-fade-in-up overflow-y-auto max-h-[100vh]">
                    <h2 class="text-3xl sm:text-4xl font-extrabold text-center text-blue-700 mb-6">
                        Mock Test Results: ${testTitle}
                    </h2>

                    <!-- Overall Performance Summary -->
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg mb-8">
                        <h3 class="text-xl sm:text-2xl font-bold text-blue-800 mb-3 flex items-center gap-2">
                            ${MockTestIcons.ChartBar.replace(
                              /width="24" height="24"/g,
                              'width="24" height="24" class="w-6 h-6 text-blue-600"'
                            )} Overall Performance
                        </h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-gray-700">
                            <p><strong>Correct Answers:</strong> ${correctAnswers} / ${totalQuestions}</p>
                            <p><strong>Percentage:</strong> ${percentage}%</p>
                            <p><strong>IELTS Band Score:</strong> <span class="font-bold text-green-600 text-2xl">${bandScore}</span></p>
                            <p><strong>Time Taken:</strong> ${formattedTimeTaken}</p>
                        </div>
                    </div>

                    <!-- Strengths and Areas for Improvement -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-lg">
                            <h3 class="text-xl font-bold text-green-800 mb-3 flex items-center gap-2">
                                ${MockTestIcons.ThumbsUp.replace(
                                  /width="24" height="24"/g,
                                  'width="24" height="24" class="w-6 h-6 text-green-600"'
                                )} Strengths
                            </h3>
                            <ul class="list-disc pl-5 text-gray-700">
                                ${
                                  strengths.length > 0
                                    ? strengths
                                        .map((s) => `<li>${s}</li>`)
                                        .join("")
                                    : "<li>No specific strengths identified for this test.</li>"
                                }
                            </ul>
                        </div>
                        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
                            <h3 class="text-xl font-bold text-red-800 mb-3 flex items-center gap-2">
                                ${MockTestIcons.Warning.replace(
                                  /width="24" height="24"/g,
                                  'width="24" height="24" class="w-6 h-6 text-red-600"'
                                )} Areas for Improvement
                            </h3>
                            <ul class="list-disc pl-5 text-gray-700">
                                ${
                                  areasForImprovement.length > 0
                                    ? areasForImprovement
                                        .map((a) => `<li>${a}</li>`)
                                        .join("")
                                    : "<li>Keep up the great work!</li>"
                                }
                            </ul>
                        </div>
                    </div>

                    <!-- Question-by-Question Review -->
                    <div class="mb-8">
                        <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            ${MockTestIcons.Review.replace(
                              /width="24" height="24"/g,
                              'width="24" height="24" class="w-6 h-6 text-gray-600"'
                            )} Question Review
                        </h3>
                        <div class="space-y-6 custom-scrollbar max-h-96 overflow-y-auto pr-2">
                            ${currentTest.sections
                              .map((section) =>
                                section.questionGroups
                                  .map((qGroup) => {
                                    let groupReviewHtml = "";
                                    if (
                                      qGroup.type === "matching_headings" ||
                                      qGroup.type ===
                                        "which_paragraph_contains" ||
                                      qGroup.type ===
                                        "matching_sentence_endings"
                                    ) {
                                      if (
                                        qGroup.questions &&
                                        qGroup.questions.length > 0
                                      ) {
                                        groupReviewHtml = qGroup.questions
                                          .map((question) => {
                                            const userAnswerDisplay =
                                              userAnswers[question.id] ||
                                              "Unattempted";
                                            const correctAnswerDisplay =
                                              question.correctAnswer;
                                            const isCorrect =
                                              userAnswerDisplay ===
                                              correctAnswerDisplay;
                                            return `
                                              <div class="p-4 rounded-lg border ${
                                                isCorrect
                                                  ? "border-green-300 bg-green-50"
                                                  : "border-red-300 bg-red-50"
                                              }">
                                                  <p class="font-semibold text-gray-900 mb-2">
                                                      Question ${
                                                        question.questionNumber
                                                      }: ${
                                              question.text ||
                                              question.statement ||
                                              `Paragraph ${question.paragraphId}`
                                            }
                                                  </p>
                                                  <p class="text-sm text-gray-700">
                                                      Your Answer: <span class="${
                                                        isCorrect
                                                          ? "correct-answer"
                                                          : "incorrect-answer"
                                                      }">${userAnswerDisplay}</span>
                                                  </p>
                                                  <p class="text-sm text-gray-700">
                                                      Correct Answer: <span class="correct-answer">${correctAnswerDisplay}</span>
                                                  </p>
                                              </div>
                                          `;
                                          })
                                          .join("");
                                      }
                                    } else if (
                                      qGroup.type === "true_false_not_given"
                                    ) {
                                      if (
                                        qGroup.questions &&
                                        qGroup.questions.length > 0
                                      ) {
                                        groupReviewHtml = qGroup.questions
                                          .map(
                                            (question) => `
                                              <div class="p-4 rounded-lg border ${
                                                userAnswers[question.id] ===
                                                question.correctAnswer
                                                  ? "border-green-300 bg-green-50"
                                                  : "border-red-300 bg-red-50"
                                              }">
                                                  <p class="font-semibold text-gray-900 mb-2">
                                                      Question ${
                                                        question.questionNumber
                                                      }: ${question.text}
                                                  </p>
                                                  <p class="text-sm text-gray-700">
                                                      Your Answer: <span class="${
                                                        userAnswers[
                                                          question.id
                                                        ] ===
                                                        question.correctAnswer
                                                          ? "correct-answer"
                                                          : "incorrect-answer"
                                                      }">${
                                              userAnswers[question.id] ||
                                              "Unattempted"
                                            }</span>
                                                  </p>
                                                  <p class="text-sm text-gray-700">
                                                      Correct Answer: <span class="correct-answer">${
                                                        question.correctAnswer
                                                      }</span>
                                                  </p>
                                              </div>
                                          `
                                          )
                                          .join("");
                                      }
                                    } else if (
                                      qGroup.type ===
                                      "multiple_choice_multiple_answers"
                                    ) {
                                      if (
                                        qGroup.questions &&
                                        qGroup.questions.length > 0
                                      ) {
                                        const question = qGroup.questions[0]; // Assuming one question object for this type
                                        const userAnsArr =
                                          userAnswers[question.id] || [];
                                        const correctAnsArr =
                                          question.correctAnswer || [];
                                        const userAnswerDisplay =
                                          userAnsArr.length > 0
                                            ? userAnsArr.join(", ")
                                            : "Unattempted";
                                        const correctAnswerDisplay = correctAnsArr.join(
                                          ", "
                                        );
                                        const isCorrect =
                                          userAnsArr.length ===
                                            correctAnsArr.length &&
                                          userAnsArr.every((ans) =>
                                            correctAnsArr.includes(ans)
                                          );
                                        groupReviewHtml = `
                                              <div class="p-4 rounded-lg border ${
                                                isCorrect
                                                  ? "border-green-300 bg-green-50"
                                                  : "border-red-300 bg-red-50"
                                              }">
                                                  <p class="font-semibold text-gray-900 mb-2">
                                                      Question ${
                                                        question.questionNumber
                                                      }: ${question.text}
                                                  </p>
                                                  <p class="text-sm text-gray-700">
                                                      Your Answer: <span class="${
                                                        isCorrect
                                                          ? "correct-answer"
                                                          : "incorrect-answer"
                                                      }">${userAnswerDisplay}</span>
                                                  </p>
                                                  <p class="text-sm text-gray-700">
                                                      Correct Answer: <span class="correct-answer">${correctAnswerDisplay}</span>
                                                  </p>
                                              </div>
                                          `;
                                      }
                                    } else if (
                                      qGroup.type === "matching_items"
                                    ) {
                                      if (
                                        qGroup.questions &&
                                        qGroup.questions.length > 0
                                      ) {
                                        groupReviewHtml = qGroup.questions
                                          .map((question) => {
                                            const userAnswerDisplay =
                                              userAnswers[question.id] ||
                                              "Unattempted";
                                            const correctAnswerDisplay =
                                              question.correctAnswer;
                                            const isCorrect =
                                              userAnswerDisplay ===
                                              correctAnswerDisplay;
                                            return `
                                              <div class="p-4 rounded-lg border ${
                                                isCorrect
                                                  ? "border-green-300 bg-green-50"
                                                  : "border-red-300 bg-red-50"
                                              }">
                                                  <p class="font-semibold text-gray-900 mb-2">
                                                      Question ${
                                                        question.questionNumber
                                                      }: ${question.statement}
                                                  </p>
                                                  <p class="text-sm text-gray-700">
                                                      Your Answer: <span class="${
                                                        isCorrect
                                                          ? "correct-answer"
                                                          : "incorrect-answer"
                                                      }">${userAnswerDisplay}</span>
                                                  </p>
                                                  <p class="text-sm text-gray-700">
                                                      Correct Answer: <span class="correct-answer">${correctAnswerDisplay}</span>
                                                  </p>
                                              </div>
                                          `;
                                          })
                                          .join("");
                                      }
                                    } else if (
                                      qGroup.type === "table_fill_in_the_blank"
                                    ) {
                                      // Special handling for table questions to iterate sub-questions
                                      if (
                                        qGroup.questions &&
                                        qGroup.questions.length > 0 &&
                                        qGroup.questions[0].correctAnswer
                                      ) {
                                        groupReviewHtml = Object.keys(
                                          qGroup.questions[0].correctAnswer
                                        )
                                          .map((subQuestionId) => {
                                            const subUserAnswer =
                                              userAnswers[subQuestionId] ||
                                              "Unattempted";
                                            const subCorrectAnswer =
                                              qGroup.questions[0].correctAnswer[
                                                subQuestionId
                                              ];
                                            const subIsCorrect =
                                              subUserAnswer.toLowerCase() ===
                                              subCorrectAnswer.toLowerCase();

                                            const displayQuestionNumber = subQuestionId.replace(
                                              "q",
                                              ""
                                            );
                                            let originalCellContent = "";
                                            qGroup.questions[0].tableData.forEach(
                                              (row) => {
                                                row.forEach((cell) => {
                                                  if (
                                                    cell.includes(
                                                      `${displayQuestionNumber}. [INPUT]`
                                                    )
                                                  ) {
                                                    originalCellContent = cell.replace(
                                                      /\[INPUT\]/,
                                                      "..."
                                                    );
                                                  }
                                                });
                                              }
                                            );

                                            return `
                                                  <div class="p-4 rounded-lg border ${
                                                    subIsCorrect
                                                      ? "border-green-300 bg-green-50"
                                                      : "border-red-300 bg-red-50"
                                                  }">
                                                      <p class="font-semibold text-gray-900 mb-2">
                                                          Question ${displayQuestionNumber}: ${originalCellContent}
                                                      </p>
                                                      <p class="text-sm text-gray-700">
                                                          Your Answer: <span class="${
                                                            subIsCorrect
                                                              ? "correct-answer"
                                                              : "incorrect-answer"
                                                          }">${subUserAnswer}</span>
                                                      </p>
                                                      <p class="text-sm text-gray-700">
                                                          Correct Answer: <span class="correct-answer">${subCorrectAnswer}</span>
                                                      </p>
                                                      ${
                                                        qGroup.questions[0]
                                                          .explanation
                                                          ? `<div class="explanation">
                                                              <strong>Explanation:</strong> ${qGroup.questions[0].explanation}
                                                          </div>`
                                                          : ""
                                                      }
                                                  </div>
                                              `;
                                          })
                                          .join("");
                                      }
                                    } else {
                                      // Default handling for types where 'type' is on the individual question (e.g., fill_in_the_blank, mcq)
                                      if (
                                        qGroup.questions &&
                                        qGroup.questions.length > 0
                                      ) {
                                        groupReviewHtml = qGroup.questions
                                          .map((question) => {
                                            let questionTextForDisplay = "";
                                            let userAnswerDisplay = "N/A";
                                            let correctAnswerDisplay = "N/A";
                                            let isCorrect = false;

                                            if (question.type === "mcq") {
                                              questionTextForDisplay =
                                                question.text;
                                              userAnswerDisplay =
                                                userAnswers[question.id] ||
                                                "Unattempted";
                                              correctAnswerDisplay =
                                                question.correctAnswer;
                                              isCorrect =
                                                userAnswerDisplay ===
                                                correctAnswerDisplay;
                                            } else if (
                                              question.type ===
                                                "fill_in_the_blank" ||
                                              question.type ===
                                                "map_labeling" ||
                                              question.type ===
                                                "fill_in_the_blank_passage" ||
                                              question.type ===
                                                "summary_completion"
                                            ) {
                                              questionTextForDisplay = question.text.replace(
                                                /\[GAP\]/g,
                                                "________"
                                              );
                                              userAnswerDisplay =
                                                userAnswers[question.id] ||
                                                "Unattempted";
                                              correctAnswerDisplay =
                                                question.correctAnswer;
                                              isCorrect =
                                                userAnswerDisplay.toLowerCase() ===
                                                correctAnswerDisplay.toLowerCase();
                                            } else if (
                                              question.type ===
                                              "table_fill_in_the_blank"
                                            ) {
                                              // Handle table questions that might be in a generic qGroup for feedback display
                                              if (question.correctAnswer) {
                                                return Object.keys(
                                                  question.correctAnswer
                                                )
                                                  .map((subQuestionId) => {
                                                    const subUserAnswer =
                                                      userAnswers[
                                                        subQuestionId
                                                      ] || "Unattempted";
                                                    const subCorrectAnswer =
                                                      question.correctAnswer[
                                                        subQuestionId
                                                      ];
                                                    const subIsCorrect =
                                                      subUserAnswer.toLowerCase() ===
                                                      subCorrectAnswer.toLowerCase();

                                                    const displayQuestionNumber = subQuestionId.replace(
                                                      "q",
                                                      ""
                                                    );
                                                    let originalCellContent =
                                                      "";
                                                    // Attempt to reconstruct original cell content for display
                                                    if (question.tableData) {
                                                      question.tableData.forEach(
                                                        (row) => {
                                                          row.forEach(
                                                            (cell) => {
                                                              if (
                                                                cell.includes(
                                                                  `${displayQuestionNumber}. [INPUT]`
                                                                )
                                                              ) {
                                                                originalCellContent = cell.replace(
                                                                  /\[INPUT\]/,
                                                                  "..."
                                                                );
                                                              }
                                                            }
                                                          );
                                                        }
                                                      );
                                                    }

                                                    return `
                                                            <div class="p-4 rounded-lg border ${
                                                              subIsCorrect
                                                                ? "border-green-300 bg-green-50"
                                                                : "border-red-300 bg-red-50"
                                                            }">
                                                                <p class="font-semibold text-gray-900 mb-2">
                                                                    Question ${displayQuestionNumber}: ${
                                                      originalCellContent ||
                                                      `Table Question ${displayQuestionNumber}`
                                                    }
                                                                </p>
                                                                <p class="text-sm text-gray-700">
                                                                    Your Answer: <span class="${
                                                                      subIsCorrect
                                                                        ? "correct-answer"
                                                                        : "incorrect-answer"
                                                                    }">${subUserAnswer}</span>
                                                                </p>
                                                                <p class="text-sm text-gray-700">
                                                                    Correct Answer: <span class="correct-answer">${subCorrectAnswer}</span>
                                                                </p>
                                                                ${
                                                                  question.explanation
                                                                    ? `<div class="explanation"><strong>Explanation:</strong> ${question.explanation}</div>`
                                                                    : ""
                                                                }
                                                            </div>
                                                        `;
                                                  })
                                                  .join("");
                                              }
                                            } else {
                                              // Fallback for any truly unhandled question types
                                              console.warn(
                                                "Unhandled question type in feedback rendering:",
                                                question.type,
                                                question
                                              );
                                              questionTextForDisplay = `Question ${
                                                question.questionNumber || "N/A"
                                              }: (Type: ${
                                                question.type || "unknown"
                                              })`;
                                            }

                                            return `
                                              <div class="p-4 rounded-lg border ${
                                                isCorrect
                                                  ? "border-green-300 bg-green-50"
                                                  : "border-red-300 bg-red-50"
                                              }">
                                                  <p class="font-semibold text-gray-900 mb-2">
                                                      Question ${
                                                        question.questionNumber
                                                      }: ${questionTextForDisplay}
                                                  </p>
                                                  <p class="text-sm text-gray-700">
                                                      Your Answer: <span class="${
                                                        isCorrect
                                                          ? "correct-answer"
                                                          : "incorrect-answer"
                                                      }">${userAnswerDisplay}</span>
                                                  </p>
                                                  <p class="text-sm text-gray-700">
                                                      Correct Answer: <span class="correct-answer">${correctAnswerDisplay}</span>
                                                  </p>
                                                  ${
                                                    question.explanation
                                                      ? `<div class="explanation">
                                                          <strong>Explanation:</strong> ${question.explanation}
                                                      </div>`
                                                      : ""
                                                  }
                                              </div>
                                          `;
                                          })
                                          .join("");
                                      }
                                    }
                                    return groupReviewHtml;
                                  })
                                  .join("")
                              )
                              .join("")}
                        </div>
                    </div>

                    <!-- Leaderboard Section -->
                    <div class="mb-8">
                        <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            ${MockTestIcons.Leaderboard.replace(
                              /width="24" height="24"/g,
                              'width="24" height="24" class="w-6 h-6 text-gray-600"'
                            )} Leaderboard for This Test
                        </h3>
                        <div class="leaderboard-table-container">
                            <table class="leaderboard-table">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Player</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Band Score</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${
                                      testState.leaderboard.length > 0
                                        ? testState.leaderboard
                                            .map(
                                              (entry, index) => `
                                            <tr class="${
                                              authAppState.userId &&
                                              entry.userId ===
                                                authAppState.userId
                                                ? "current-user-row"
                                                : ""
                                            }">
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                    ${
                                                      index === 0
                                                        ? `<span class="rank-badge rank-1">${
                                                            index + 1
                                                          }</span>`
                                                        : index === 1
                                                        ? `<span class="rank-badge rank-2">${
                                                            index + 1
                                                          }</span>`
                                                        : index === 2
                                                        ? `<span class="rank-badge rank-3">${
                                                            index + 1
                                                          }</span>`
                                                        : `<span class="rank-badge rank-common">${
                                                            index + 1
                                                          }</span>` // Applied common badge for ranks 4+
                                                    }
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${
                                                  entry.userName ||
                                                  entry.userEmail.split("@")[0]
                                                }</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${
                                                  entry.bandScore
                                                }</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatTime(
                                                  entry.timeTakenSeconds
                                                )}</td>
                                            </tr>
                                        `
                                            )
                                            .join("")
                                        : `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No results yet. Be the first!</td></tr>`
                                    }
                                    ${
                                      testState.userRank &&
                                      testState.userRank > 10 &&
                                      authAppState.userId
                                        ? `
                                        <tr>
                                            <td colspan="4" class="px-6 py-4 text-center text-gray-600 italic">... Your Rank: ${testState.userRank} ...</td>
                                        </tr>
                                        `
                                        : ""
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="flex justify-center mt-8 gap-3 flex-wrap">
                        <a href="mock-test-home.html" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 font-semibold text-base transform active:scale-95">
                        <i class="fas fa-home w-5 h-5"></i> Back to Mock Tests
                        </a>
                         <a href="daily-leaderboard.html" class="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition-colors duration-200 font-semibold text-base transform active:scale-95">
                         <i class="fas fa-list-ol w-5 h-5"></i> Daily Leaderboard
                         </a>
                    </div>
                </div>
            `;
      }

      /**
       * Navigates to the next section of the test (for Reading).
       */
      function goToNextSection() {
        if (testState.currentSectionIndex < currentTest.sections.length - 1) {
          testState.currentSectionIndex++;
          renderApp();
          // Scroll to the top of the main content area for the new section
          document.querySelector(".main-test-content").scrollTop = 0;
          document.querySelector(".passage-content-area").scrollTop = 0;
        }
      }

      /**
       * Navigates to the previous section of the test (for Reading).
       */
      function goToPreviousSection() {
        if (testState.currentSectionIndex > 0) {
          testState.currentSectionIndex--;
          renderApp();
          // Scroll to the top of the main content area for the new section
          document.querySelector(".main-test-content").scrollTop = 0;
          document.querySelector(".passage-content-area").scrollTop = 0;
        }
      }

      /**
       * Sets the active tab for the Reading module on mobile.
       * @param {string} tabName - 'passage' or 'questions'.
       */
      function setActiveReadingTab(tabName) {
        testState.activeReadingTab = tabName;
        renderApp(); // Re-render to apply tab changes
      }

      /**
       * Renders the main application content for the mock test page.
       */
      async function renderApp() {
        const appDiv = document.getElementById("app");
        const body = document.body;
        const audioPlayerWrapper = document.getElementById(
          "fixed-audio-player-wrapper"
        );
        const mobilePaletteWrapper = document.getElementById(
          "mobile-question-palette-wrapper"
        );
        const testInfoBar = document.getElementById("test-info-bar"); // New: Get reference to the info bar
        const topBarTimerDisplay = document.getElementById(
          "timer-display-top-bar"
        );
        const topBarSectionInfo = document.getElementById(
          "section-info-top-bar"
        );
        const topBarTestTitle = document.getElementById("test-title-top-bar");

        if (!appDiv) return;

        if (testState.isLoadingResults) {
          appDiv.innerHTML = `
            <div class="flex justify-center items-center h-full min-h-[50vh]">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
                <p class="ml-4 text-lg text-gray-600">Loading results...</p>
            </div>
          `;
          audioPlayerWrapper.style.display = "none";
          if (testInfoBar) testInfoBar.style.display = "none"; // Hide info bar on results page
          if (mobilePaletteWrapper) mobilePaletteWrapper.style.display = "none"; // Hide mobile palette
          body.classList.remove("listening-body-padding");
        } else if (testState.testCompleted) {
          renderMockTestFeedbackSection(appDiv);
          // Hide audio player and mobile palette header when results are shown
          audioPlayerWrapper.style.display = "none";
          if (testInfoBar) testInfoBar.style.display = "none"; // Hide info bar on results page
          if (mobilePaletteWrapper) mobilePaletteWrapper.style.display = "none"; // Hide mobile palette
          body.classList.remove("listening-body-padding");
        } else {
          // Define navigationButtonsHtml based on the module and section
          let navigationButtonsHtml = "";
          if (currentModuleId === "reading") {
            const isFirstSection = testState.currentSectionIndex === 0;
            const isLastSection =
              testState.currentSectionIndex === currentTest.sections.length - 1;

            navigationButtonsHtml = `
                <button id="prev-section-btn"
                        class="px-5 py-2 bg-gray-200 text-gray-700 rounded-lg shadow-md hover:bg-gray-300 transition-colors duration-200 font-semibold text-base transform active:scale-95 ${
                          isFirstSection ? "opacity-50 cursor-not-allowed" : ""
                        }"
                        ${isFirstSection ? "disabled" : ""}>
                    <i class="fas fa-arrow-left mr-2"></i> Previous
                </button>
                ${
                  isLastSection
                    ? `<button id="submit-test-btn"
                               class="px-5 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 font-semibold text-base transform active:scale-95">
                               <i class="fas fa-check-circle mr-2"></i> Submit
                           </button>`
                    : `<button id="next-section-btn"
                               class="px-5 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 font-semibold text-base transform active:scale-95">
                               Next <i class="fas fa-arrow-right ml-2"></i>
                           </button>`
                }
            `;
          } else {
            // For Listening and other modules, just a submit button
            navigationButtonsHtml = `
                <button id="submit-test-btn"
                        class="px-5 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 font-semibold text-base transform active:scale-95 mx-auto">
                    <i class="fas fa-check-circle mr-2"></i> Submit Test
                </button>
            `;
          }

          // Render the test questions
          let mockTestLayoutClass = "";
          let audioPlayerDisplay = "none";
          let testInfoBarDisplay = "none"; // Default to hidden

          if (currentModuleId === "reading") {
            mockTestLayoutClass = "reading-layout";
            audioPlayerDisplay = "none"; // Hide audio for reading
            body.classList.remove("listening-body-padding"); // Ensure no extra padding
            testInfoBarDisplay = "flex"; // Show info bar for reading
            if (mobilePaletteWrapper)
              mobilePaletteWrapper.style.display = "none"; // Hide mobile palette for reading
          } else if (currentModuleId === "listening") {
            mockTestLayoutClass = "listening-layout";
            audioPlayerDisplay = "flex"; // Show audio for listening
            body.classList.add("listening-body-padding"); // Add padding for mobile palette
            testInfoBarDisplay = "none"; // Hide info bar for listening (sidebar handles timer)
            if (mobilePaletteWrapper)
              mobilePaletteWrapper.style.display = "flex"; // Show mobile palette for listening
          }

          audioPlayerWrapper.style.display = audioPlayerDisplay;
          if (testInfoBar) testInfoBar.style.display = testInfoBarDisplay; // Apply display style
          // mobilePaletteWrapper.classList.toggle("listening-mobile", currentModuleId === "listening"); // This is now handled by direct display style above

          const currentSection =
            currentTest.sections[testState.currentSectionIndex];

          // Determine content visibility based on activeReadingTab for mobile
          const isPassageActive = testState.activeReadingTab === "passage";
          const isQuestionsActive = testState.activeReadingTab === "questions";

          // Update timer and section info in the new top bar
          if (topBarTimerDisplay) {
            topBarTimerDisplay.textContent = formatTime(testState.timeLeft);
          }
          if (topBarTestTitle) {
            topBarTestTitle.textContent = currentTest.title;
          }
          if (topBarSectionInfo && currentModuleId === "reading") {
            topBarSectionInfo.textContent = `- Section ${
              testState.currentSectionIndex + 1
            } of ${currentTest.sections.length}`;
          } else if (topBarSectionInfo) {
            topBarSectionInfo.textContent = ""; // Clear for other modules
          }

          appDiv.innerHTML = `
                <div class="mock-test-layout ${mockTestLayoutClass}">
                    <!-- Mobile Reading Tabs (visible only on mobile/tablet for reading module) -->
                    ${
                      currentModuleId === "reading"
                        ? `
                    <div id="reading-tabs" class="reading-tabs-container lg:hidden">
                        <button id="passage-tab-btn" class="reading-tab-button ${
                          isPassageActive ? "active" : ""
                        }">
                            <i class="fas fa-book-open mr-2"></i> Passage
                        </button>
                        <button id="questions-tab-btn" class="reading-tab-button ${
                          isQuestionsActive ? "active" : ""
                        }">
                            <i class="fas fa-question-circle mr-2"></i> Questions
                        </button>
                    </div>
                    `
                        : ""
                    }

                    <!-- Passage Content Area (Only for Reading) -->
                    <div class="passage-content-area custom-scrollbar ${
                      currentModuleId === "reading" ? "" : "hidden"
                    }" style="${
            currentModuleId === "reading" && isPassageActive
              ? "display: block;"
              : "display: none;"
          }">
                        <h2 class="text-2xl font-anton text-gray-800 mb-4">Passage</h2>
                        <div class="prose max-w-none text-gray-700 leading-relaxed">
                            ${
                              currentModuleId === "reading" &&
                              currentSection.passageContent
                                ? currentSection.passageContent
                                : "<p class='text-gray-500'>No passage available for this section/module.</p>"
                            }
                        </div>
                    </div>

                    <!-- Main Test Content Area (Questions) -->
                    <div class="main-test-content custom-scrollbar ${
                      currentModuleId === "reading" ? "" : ""
                    }" style="${
            currentModuleId === "reading" && isQuestionsActive
              ? "display: block;"
              : currentModuleId === "listening"
              ? "display: block;"
              : "display: none;"
          }">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-3xl font-anton text-gray-800">${
                              currentTest.title
                            } - Section ${
            currentModuleId === "reading"
              ? testState.currentSectionIndex + 1
              : ""
          }</h2>
                            <!-- Timer moved to sticky top bar for Reading/Writing -->
                        </div>


                        <!-- Test Sections and Questions -->
                        <div id="test-questions-container">
                            ${
                              currentModuleId === "reading"
                                ? // For Reading, render only the current section
                                  `<div class="question-section" id="section-${
                                    currentSection.id
                                  }">
                                    <h3 class="text-2xl font-bold text-gray-700 mb-3 font-anton">${
                                      currentSection.title
                                    }</h3>
                                    ${
                                      currentSection.image
                                        ? `<div class="map-image-container">
                                                <img src="${currentSection.image}" alt="Test Section Image" class="rounded-lg">
                                           </div>`
                                        : ""
                                    }
                                    <div class="questions-list">
                                        ${qGroupRenderer(currentSection)}
                                    </div>
                                </div>`
                                : // For Listening, render all sections
                                  currentTest.sections
                                    .map(
                                      (section) => `
                                <div class="question-section" id="section-${
                                  section.id
                                }">
                                    <h3 class="text-2xl font-bold text-gray-700 mb-3 font-anton">${
                                      section.title
                                    }</h3>
                                    ${
                                      section.image
                                        ? `<div class="map-image-container">
                                                <img src="${section.image}" alt="Test Section Image" class="rounded-lg">
                                           </div>`
                                        : ""
                                    }
                                    <div class="questions-list">
                                        ${qGroupRenderer(section)}
                                    </div>
                                </div>
                            `
                                    )
                                    .join("")
                            }
                        </div>

                        <div class="flex justify-between mt-8">
                            ${navigationButtonsHtml}
                        </div>
                    </div>

                    <!-- Sidebar: Question Palette & Timer (for desktop/tablet) -->
                    <div class="sidebar">
                        <div class="text-center mb-4">
                            <h3 class="text-2xl font-anton text-white mb-2">Question Palette</h3>
                            <div class="flex items-center justify-center gap-2 text-xl font-bold text-white">
                                <i class="fas fa-clock"></i>
                                <span id="timer-display-desktop-sidebar">${formatTime(
                                  testState.timeLeft
                                )}</span>
                            </div>
                        </div>

                        <div class="question-palette-grid" id="question-palette-desktop">
                            <!-- Question buttons will be injected here -->
                        </div>

                        <div class="flex flex-row gap-3 mt-6">
                            <div class="flex items-center gap-2">
                                <span class="question-palette-btn answered w-6 h-6 rounded-full text-xs"></span>
                                <span class="text-sm">Answered</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="question-palette-btn unanswered w-6 h-6 rounded-full text-xs"></span>
                                <span class="text-sm">Unanswered</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="question-palette-btn current w-6 h-6 rounded-full text-xs"></span>
                                <span class="text-sm">Current</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper function to render question groups
        function qGroupRenderer(section) {
          return section.questionGroups
            .map((qGroup) => {
              let questionsHtml = "";
              if (qGroup.type === "matching_headings") {
                if (qGroup.questions && qGroup.questions.length > 0) {
                  questionsHtml = `
                      <div class="question-item" id="question-${
                        qGroup.questions[0].questionNumber
                      }">
                          <p class="text-lg font-semibold mb-2">List of Headings:</p>
                          <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 space-y-2 mb-4">
                              ${(qGroup.listHeadings || []) // Ensure it's an array before map
                                .map(
                                  (heading) =>
                                    `<div class="flex items-center p-3 bg-white rounded-lg border border-gray-200">
                                        <span class="font-bold text-blue-600 text-lg w-8 flex-shrink-0">${heading.id}.</span>
                                        <span class="ml-2 text-gray-800">${heading.text}</span>
                                    </div>`
                                )
                                .join("")}
                          </div>
                          ${qGroup.questions
                            .map(
                              (question) => `
                              <div class="mb-3">
                                  <label class="block text-gray-700 text-sm font-bold mb-1" for="q-${
                                    question.id
                                  }">
                                      ${question.questionNumber}. ${
                                question.text ||
                                `Paragraph ${question.paragraphId}`
                              }:
                                  </label>
                                  <select id="q-${
                                    question.id
                                  }" onchange="handleAnswerInput('${
                                question.id
                              }', this.value)"
                                          class="inline-select w-64">
                                      <option value="">Select a heading</option>
                                      ${(qGroup.listHeadings || []) // Ensure it's an array before map
                                        .map(
                                          (heading) => `
                                          <option value="${heading.id}" ${
                                            testState.userAnswers[
                                              question.id
                                            ] === heading.id
                                              ? "selected"
                                              : ""
                                          }>
                                              ${heading.id}
                                          </option>
                                      `
                                        )
                                        .join("")}
                                  </select>
                              </div>
                          `
                            )
                            .join("")}
                      </div>
                  `;
                }
              } else if (qGroup.type === "which_paragraph_contains") {
                // This type should have its own rendering logic, as it doesn't use listHeadings
                // For now, let's assume options are A, B, C, D...
                const paragraphOptions = [
                  "A",
                  "B",
                  "C",
                  "D",
                  "E",
                  "F",
                  "G",
                  "H",
                  "I",
                  "J",
                  "K",
                  "L",
                  "M",
                  "N",
                  "O",
                  "P",
                  "Q",
                  "R",
                  "S",
                  "T",
                  "U",
                  "V",
                  "W",
                  "X",
                  "Y",
                  "Z",
                ]; // Example options
                if (qGroup.questions && qGroup.questions.length > 0) {
                  questionsHtml = `
                      <div class="question-item" id="question-${
                        qGroup.questions[0].questionNumber
                      }">
                          <p class="text-lg font-semibold mb-2">Choose the correct paragraph:</p>
                          ${qGroup.questions
                            .map(
                              (question) => `
                              <div class="mb-3">
                                  <label class="block text-gray-700 text-sm font-bold mb-1" for="q-${
                                    question.id
                                  }">
                                      ${question.questionNumber}. ${
                                question.text
                              }:
                                  </label>
                                  <select id="q-${
                                    question.id
                                  }" onchange="handleAnswerInput('${
                                question.id
                              }', this.value)"
                                          class="inline-select w-48">
                                      <option value="">Select a paragraph</option>
                                      ${paragraphOptions
                                        .map(
                                          (option) => `
                                          <option value="${option}" ${
                                            testState.userAnswers[
                                              question.id
                                            ] === option
                                              ? "selected"
                                              : ""
                                          }>
                                              ${option}
                                          </option>
                                      `
                                        )
                                        .join("")}
                                  </select>
                              </div>
                          `
                            )
                            .join("")}
                      </div>
                  `;
                }
              } else if (qGroup.type === "true_false_not_given") {
                if (qGroup.questions && qGroup.questions.length > 0) {
                  questionsHtml = qGroup.questions
                    .map(
                      (question) => `
                      <div class="question-item" id="question-${
                        question.questionNumber
                      }">
                          <p class="text-lg font-semibold mb-2">${
                            question.questionNumber
                          }. ${question.text}</p>
                          <div class="flex flex-wrap gap-4">
                              <label class="radio-option">
                                  <input type="radio" name="q-${
                                    question.id
                                  }" value="TRUE"
                                         onchange="handleAnswerInput('${
                                           question.id
                                         }', this.value)"
                                         ${
                                           testState.userAnswers[
                                             question.id
                                           ] === "TRUE"
                                             ? "checked"
                                             : ""
                                         }>
                                  <span class="ml-2 text-gray-700">TRUE</span>
                              </label>
                              <label class="radio-option">
                                  <input type="radio" name="q-${
                                    question.id
                                  }" value="FALSE"
                                         onchange="handleAnswerInput('${
                                           question.id
                                         }', this.value)"
                                         ${
                                           testState.userAnswers[
                                             question.id
                                           ] === "FALSE"
                                             ? "checked"
                                             : ""
                                         }>
                                  <span class="ml-2 text-gray-700">FALSE</span>
                              </label>
                              <label class="radio-option">
                                  <input type="radio" name="q-${
                                    question.id
                                  }" value="NOT GIVEN"
                                         onchange="handleAnswerInput('${
                                           question.id
                                         }', this.value)"
                                         ${
                                           testState.userAnswers[
                                             question.id
                                           ] === "NOT GIVEN"
                                             ? "checked"
                                             : ""
                                         }>
                                  <span class="ml-2 text-gray-700">NOT GIVEN</span>
                              </label>
                          </div>
                      </div>
                  `
                    )
                    .join("");
                }
              } else if (qGroup.type === "multiple_choice_multiple_answers") {
                // Assuming there's only one question object in this type of group
                if (qGroup.questions && qGroup.questions.length > 0) {
                  const question = qGroup.questions[0];
                  questionsHtml = `
                      <div class="question-item" id="question-${
                        question.questionNumber
                      }">
                          <p class="text-lg font-semibold mb-2">${
                            question.questionNumber
                          }. ${question.text}</p>
                          <div class="flex flex-col gap-2">
                              ${qGroup.options
                                .map(
                                  (option) => `
                                  <label class="checkbox-option flex items-center cursor-pointer p-2 rounded-md hover:bg-blue-50">
                                      <input type="checkbox" name="q-${
                                        question.id
                                      }" value="${option.id}"
                                             onchange="handleMultipleChoiceInput('${
                                               question.id
                                             }', this.value, this.checked)"
                                             ${
                                               testState.userAnswers[
                                                 question.id
                                               ]?.includes(option.id)
                                                 ? "checked"
                                                 : ""
                                             }
                                             class="mr-2 transform scale-125">
                                      <span class="text-gray-700">${
                                        option.text
                                      }</span>
                                  </label>
                              `
                                )
                                .join("")}
                          </div>
                      </div>
                  `;
                }
              } else if (qGroup.type === "matching_items") {
                if (qGroup.questions && qGroup.questions.length > 0) {
                  questionsHtml = `
                      <div class="question-item" id="question-${
                        qGroup.questions[0].questionNumber
                      }">
                          <p class="text-lg font-semibold mb-2">List of Items:</p>
                          <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 space-y-2 mb-4">
                              ${qGroup.listItems
                                .map(
                                  (item) =>
                                    `<div class="flex items-center p-3 bg-white rounded-lg border border-gray-200">
                                        <span class="font-bold text-blue-600 text-lg w-8 flex-shrink-0">${item.id}.</span>
                                        <span class="ml-2 text-gray-800">${item.text}</span>
                                    </div>`
                                )
                                .join("")}
                          </div>
                          ${qGroup.questions
                            .map(
                              (question) => `
                              <div class="mb-3">
                                  <label class="block text-gray-700 text-sm font-bold mb-1" for="q-${
                                    question.id
                                  }">
                                      ${question.questionNumber}. ${
                                question.statement
                              }
                                  </label>
                                  <select id="q-${
                                    question.id
                                  }" onchange="handleAnswerInput('${
                                question.id
                              }', this.value)"
                                          class="inline-select w-48">
                                      <option value="">Select an item</option>
                                      ${qGroup.listItems
                                        .map(
                                          (item) => `
                                          <option value="${item.id}" ${
                                            testState.userAnswers[
                                              question.id
                                            ] === item.id
                                              ? "selected"
                                              : ""
                                          }>
                                              ${item.id}
                                          </option>
                                      `
                                        )
                                        .join("")}
                                  </select>
                              </div>
                          `
                            )
                            .join("")}
                      </div>
                  `;
                }
              } else if (qGroup.type === "matching_sentence_endings") {
                if (qGroup.questions && qGroup.questions.length > 0) {
                  questionsHtml = `
                      <div class="question-item" id="question-${
                        qGroup.questions[0].questionNumber
                      }">
                          <p class="text-lg font-semibold mb-2">Complete each sentence with the correct ending:</p>
                          <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 space-y-2 mb-4">
                              ${(qGroup.listItems || []) // Use listItems for the endings
                                .map(
                                  (item) =>
                                    `<div class="flex items-center p-3 bg-white rounded-lg border border-gray-200">
                                        <span class="font-bold text-blue-600 text-lg w-8 flex-shrink-0">${item.id}.</span>
                                        <span class="ml-2 text-gray-800">${item.text}</span>
                                    </div>`
                                )
                                .join("")}
                          </div>
                          ${qGroup.questions
                            .map(
                              (question) => `
                              <div class="mb-3">
                                  <label class="block text-gray-700 text-sm font-bold mb-1" for="q-${
                                    question.id
                                  }">
                                      ${question.questionNumber}. ${
                                question.statement
                              }
                                  </label>
                                  <select id="q-${
                                    question.id
                                  }" onchange="handleAnswerInput('${
                                question.id
                              }', this.value)"
                                          class="inline-select w-64">
                                      <option value="">Select an ending</option>
                                      ${(qGroup.listItems || [])
                                        .map(
                                          (item) => `
                                          <option value="${item.id}" ${
                                            testState.userAnswers[
                                              question.id
                                            ] === item.id
                                              ? "selected"
                                              : ""
                                          }>
                                              ${item.id}
                                          </option>
                                      `
                                        )
                                        .join("")}
                                  </select>
                              </div>
                          `
                            )
                            .join("")}
                      </div>
                  `;
                }
              } else {
                // Existing rendering for other question types (mcq, fill_in_the_blank, table_fill_in_the_blank)
                if (qGroup.questions && qGroup.questions.length > 0) {
                  questionsHtml = qGroup.questions
                    .map((question) => {
                      let questionHtml = "";
                      if (question.type === "mcq") {
                        questionHtml = `
                                <div class="question-item" id="question-${
                                  question.questionNumber
                                }">
                                    <p class="text-lg font-semibold mb-2">${
                                      question.questionNumber
                                    }. ${question.text}</p>
                                    ${question.options
                                      .map(
                                        (option) => `
                                        <label class="radio-option">
                                            <input type="radio" name="q-${
                                              question.id
                                            }" value="${option}"
                                                   onchange="handleAnswerInput('${
                                                     question.id
                                                   }', this.value)"
                                                   ${
                                                     testState.userAnswers[
                                                       question.id
                                                     ] === option
                                                       ? "checked"
                                                       : ""
                                                   }>
                                            <span class="ml-2 text-gray-700">${option}</span>
                                        </label>
                                    `
                                      )
                                      .join("")}
                                </div>
                            `;
                      } else if (
                        question.type === "fill_in_the_blank" ||
                        question.type === "map_labeling" ||
                        question.type === "fill_in_the_blank_passage" ||
                        question.type === "summary_completion"
                      ) {
                        const inputClass =
                          question.inputPlacement === "newline"
                            ? "block-input"
                            : "inline-input";
                        const inputField = `<input type="text" id="q-${
                          question.id
                        }" placeholder="Answer"
                                                           oninput="handleAnswerInput('${
                                                             question.id
                                                           }', this.value)"
                                                           value="${
                                                             testState
                                                               .userAnswers[
                                                               question.id
                                                             ] || ""
                                                           }" class="${inputClass}">`;

                        let questionTextContent = "";
                        let inputElementHtml = "";

                        if (question.inputPlacement === "newline") {
                          questionTextContent = "";
                          inputElementHtml = inputField;
                        } else {
                          // For inline inputs within text (like summary completion)
                          // Replace [GAP] with the input field
                          questionTextContent = question.text.includes("[GAP]")
                            ? question.text.replace(/\[GAP\]/g, inputField)
                            : `${question.text} ${inputField}`; // Fallback if [GAP] isn't present
                          inputElementHtml = "";
                        }

                        questionHtml = `
                                <div class="question-item" id="question-${question.questionNumber}">
                                    <p class="inline-question-text">
                                        <span class="font-semibold text-lg text-gray-800">${question.questionNumber}.</span>
                                        ${questionTextContent}
                                    </p>
                                    ${inputElementHtml}
                                </div>
                              `;
                      } else if (question.type === "table_fill_in_the_blank") {
                        if (
                          question.tableData &&
                          question.tableData.length > 0
                        ) {
                          questionHtml = `
                                <div class="question-item" id="question-${
                                  question.questionNumber
                                }">
                                    <div class="table-responsive-wrapper">
                                        <table class="w-full text-left border-collapse mt-4">
                                            <thead>
                                                ${
                                                  question.tableData[0]
                                                    ? `<tr>${question.tableData[0]
                                                        .map(
                                                          (header) =>
                                                            `<th class="py-2 px-4 border border-gray-300 bg-gray-100">${header}</th>`
                                                        )
                                                        .join("")}</tr>`
                                                    : ""
                                                }
                                            </thead>
                                            <tbody>
                                                ${question.tableData
                                                  .slice(1)
                                                  .map(
                                                    (row) => `
                                                    <tr>
                                                        ${row
                                                          .map(
                                                            (cellContent) => {
                                                              const inputPattern = /(\d+)\.\s*\[INPUT\]/;
                                                              let displayContent = cellContent;
                                                              let inputId = "";
                                                              const match = cellContent.match(
                                                                inputPattern
                                                              );

                                                              if (match) {
                                                                const qNum =
                                                                  match[1];
                                                                inputId = `q${qNum}`; // This is the ID used in userAnswers
                                                                const inputFieldHtml = `<input type="text" id="${inputId}" placeholder="Answer"
                                                                                                 oninput="handleAnswerInput('${inputId}', this.value)"
                                                                                                 value="${
                                                                                                   testState
                                                                                                     .userAnswers[
                                                                                                     inputId
                                                                                                   ] ||
                                                                                                   ""
                                                                                                 }"
                                                                                                 class="table-input">`;
                                                                displayContent = cellContent.replace(
                                                                  /\[INPUT\]/,
                                                                  inputFieldHtml
                                                                );
                                                              }
                                                              return `
                                                                <td class="py-2 px-4 border border-gray-300">
                                                                    ${displayContent}
                                                                </td>
                                                            `;
                                                            }
                                                          )
                                                          .join("")}
                                                    </tr>
                                                `
                                                  )
                                                  .join("")}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                              `;
                        }
                      }
                      return questionHtml;
                    })
                    .join("");
                }
              }

              return `
                  ${
                    qGroup.instructions
                      ? `<div class="question-group-instructions mb-6 text-gray-600 font-inter">${qGroup.instructions}</div>`
                      : ""
                  }
                  ${questionsHtml}
              `;
            })
            .join("");
        }

        // Attach event listeners for question inputs only if test is not completed
        if (!testState.testCompleted) {
          const testQuestionsContainer = document.getElementById(
            "test-questions-container"
          );
          if (testQuestionsContainer) {
            testQuestionsContainer.addEventListener("input", (event) => {
              // For text inputs (fill-in-the-blank, map labeling, table inputs)
              if (
                event.target.tagName === "INPUT" &&
                event.target.type === "text" &&
                event.target.id.startsWith("q")
              ) {
                const questionId = event.target.id;
                handleAnswerInput(questionId, event.target.value);
              }
            });
            testQuestionsContainer.addEventListener("change", (event) => {
              // For radio buttons (MCQ, True/False/Not Given)
              if (
                event.target.tagName === "INPUT" &&
                event.target.type === "radio" &&
                event.target.name.startsWith("q-")
              ) {
                const questionId = event.target.name.substring(2); // Remove "q-" prefix
                handleAnswerInput(questionId, event.target.value);
              }
              // For checkboxes (Multiple Choice Multiple Answers)
              if (
                event.target.tagName === "INPUT" &&
                event.target.type === "checkbox" &&
                event.target.name.startsWith("q-")
              ) {
                const questionId = event.target.name.substring(2);
                handleMultipleChoiceInput(
                  questionId,
                  event.target.value,
                  event.target.checked
                );
              }
              // For select dropdowns (Matching Headings, Matching Items, Which Paragraph Contains, Matching Sentence Endings)
              if (
                event.target.tagName === "SELECT" &&
                event.target.id.startsWith("q-")
              ) {
                const questionId = event.target.id.substring(2);
                handleAnswerInput(questionId, event.target.value);
              }
            });
          }

          // Populate question palette (both desktop and mobile) if listening test
          if (currentModuleId === "listening") {
            const questionPaletteDesktop = document.getElementById(
              "question-palette-desktop"
            );
            const questionPaletteMobile = document.getElementById(
              "question-palette-mobile"
            );
            const desktopTimerDisplaySidebar = document.getElementById(
              "timer-display-desktop-sidebar"
            );

            // Update sidebar timer display
            if (desktopTimerDisplaySidebar) {
              desktopTimerDisplaySidebar.textContent = formatTime(
                testState.timeLeft
              );
            }

            const paletteHtml = questionPaletteItems
              .map((item) => {
                return `<button class="question-palette-btn unanswered" data-palette-number="${item.paletteNumber}">${item.paletteNumber}</button>`;
              })
              .join("");

            if (questionPaletteDesktop) {
              questionPaletteDesktop.innerHTML = paletteHtml;
              questionPaletteDesktop.addEventListener("click", (event) => {
                if (event.target.classList.contains("question-palette-btn")) {
                  const paletteNum = parseInt(
                    event.target.dataset.paletteNumber
                  );
                  scrollToQuestion(paletteNum);
                }
              });
            }
            if (questionPaletteMobile) {
              questionPaletteMobile.innerHTML = paletteHtml;
              questionPaletteMobile.addEventListener("click", (event) => {
                if (event.target.classList.contains("question-palette-btn")) {
                  const paletteNum = parseInt(
                    event.target.dataset.paletteNumber
                  );
                  scrollToQuestion(paletteNum);
                  // Collapse the palette after clicking a question on mobile
                  const mobilePaletteWrapper = document.getElementById(
                    "mobile-question-palette-wrapper"
                  );
                  const paletteToggleIcon = document.getElementById(
                    "palette-toggle-icon"
                  );

                  if (mobilePaletteWrapper.classList.contains("expanded")) {
                    mobilePaletteWrapper.classList.remove("expanded");
                    paletteToggleIcon.classList.remove("ph-caret-up");
                    paletteToggleIcon.classList.add("ph-caret-down");
                  }
                }
              });
            }

            // Mobile palette dropdown logic
            const mobilePaletteHeader = document.getElementById(
              "mobile-palette-header"
            );
            const mobilePaletteContent = document.getElementById(
              "mobile-palette-content"
            );
            const paletteToggleIcon = document.getElementById(
              "palette-toggle-icon"
            );

            if (
              mobilePaletteHeader &&
              mobilePaletteContent &&
              paletteToggleIcon &&
              mobilePaletteWrapper
            ) {
              mobilePaletteHeader.addEventListener("click", () => {
                const isExpanded = mobilePaletteWrapper.classList.toggle(
                  "expanded"
                ); // Corrected: toggle on wrapper
                if (isExpanded) {
                  paletteToggleIcon.classList.remove("ph-caret-down");
                  paletteToggleIcon.classList.add("ph-caret-up");
                } else {
                  paletteToggleIcon.classList.remove("ph-caret-up");
                  paletteToggleIcon.classList.add("ph-caret-down");
                }
              });
            }

            updateQuestionPalette(); // Initial update of palette state
            if (totalQuestions > 0) {
              scrollToQuestion(testState.currentQuestionIndex + 1); // Scroll to current question
            }
          } else if (currentModuleId === "reading") {
            // Navigation buttons for reading
            const prevSectionBtn = document.getElementById("prev-section-btn");
            const nextSectionBtn = document.getElementById("next-section-btn");

            if (prevSectionBtn) {
              prevSectionBtn.onclick = goToPreviousSection;
            }
            if (nextSectionBtn) {
              nextSectionBtn.onclick = goToNextSection;
            }

            // Mobile reading tabs event listeners
            const passageTabBtn = document.getElementById("passage-tab-btn");
            const questionsTabBtn = document.getElementById(
              "questions-tab-btn"
            );

            if (passageTabBtn) {
              passageTabBtn.onclick = () => setActiveReadingTab("passage");
            }
            if (questionsTabBtn) {
              questionsTabBtn.onclick = () => setActiveReadingTab("questions");
            }
          }

          // Submit button common logic
          const submitBtn = document.getElementById("submit-test-btn");
          if (submitBtn) {
            submitBtn.addEventListener("click", () => {
              let unansweredCount = 0;
              // Iterate through questionPaletteItems to accurately count unanswered questions
              questionPaletteItems.forEach((item) => {
                const userAnswer = testState.userAnswers[item.questionId];
                if (
                  userAnswer === undefined ||
                  userAnswer === null ||
                  userAnswer === "" ||
                  (Array.isArray(userAnswer) && userAnswer.length === 0)
                ) {
                  unansweredCount++;
                }
              });

              console.log("Calculated unanswered questions:", unansweredCount); // Debugging line

              showModal(
                "Confirm Submission",
                `Are you sure you want to submit the test? You have ${unansweredCount} unanswered questions.`,
                true,
                () => handleSubmitTest(), // On confirm
                () => hideModal() // On cancel
              );
            });
          }

          // Start the timer
          startTimer();
        }
      }

      // Expose functions to global scope for oninput/onchange attributes
      window.handleAnswerInput = handleAnswerInput;
      window.setActiveReadingTab = setActiveReadingTab; // Expose for tab buttons

      // Initialization Logic
      window.onload = async function () {
        // Initialize Firebase Auth and listen for state changes
        initFirebaseAuth(updateAuthUI)
          .then(async ({ db: firestoreDb, auth: firebaseAuth }) => {
            db = firestoreDb;
            auth = firebaseAuth;
            console.log("Firebase initialized in mock-test.html:", {
              db,
              auth,
            });

            // Parse URL parameters for initial load (e.g., if user refreshes results page)
            const urlParams = new URLSearchParams(window.location.search);
            currentModuleId = urlParams.get("module");
            currentTestId = urlParams.get("test");

            if (currentModuleId && currentTestId) {
              currentTest = allMockTests.find(
                (test) =>
                  test.moduleId === currentModuleId && test.id === currentTestId
              );

              if (currentTest) {
                const scoreParam = urlParams.get("score");
                const totalParam = urlParams.get("total");
                const bandParam = urlParams.get("band");
                const timeParam = urlParams.get("time");

                if (
                  scoreParam !== null &&
                  totalParam !== null &&
                  bandParam !== null &&
                  timeParam !== null
                ) {
                  // This means we are loading a completed test's results directly
                  testState.testCompleted = true;
                  testState.isLoadingResults = true; // Set loading state for results
                  // Fetch the actual user result document to get userAnswers
                  auth.onAuthStateChanged(async (user) => {
                    if (authAppState.userId) {
                      testState.userResultDoc = await fetchUserMockTestResult(
                        authAppState.userId,
                        currentTestId
                      );
                    } else {
                      console.warn(
                        "User not authenticated, cannot fetch specific user result for display."
                      );
                      testState.userResultDoc = {
                        testTitle: currentTest.title,
                        correctAnswers: parseInt(scoreParam),
                        totalQuestions: parseInt(totalParam),
                        bandScore: parseFloat(bandParam),
                        timeTakenSeconds: parseInt(timeParam),
                        userAnswers: {}, // Fallback empty answers
                      };
                    }
                    await fetchLeaderboard();
                    testState.isLoadingResults = false;
                    renderApp(); // Render results UI
                  });
                } else {
                  // Not a completed test, initialize for a new test
                  testState.testCompleted = false;
                  testState.userAnswers = {}; // Reset user answers
                  questionPaletteItems = []; // Reset palette items
                  testState.currentQuestionIndex = 0; // Reset for listening
                  testState.currentSectionIndex = 0; // Reset for reading
                  testState.activeReadingTab = "questions"; // Default to questions tab for reading

                  let currentPaletteNumber = 1;

                  currentTest.sections.forEach((section) => {
                    section.questionGroups.forEach((qGroup) => {
                      if (qGroup.questions && qGroup.questions.length > 0) {
                        if (
                          qGroup.type === "matching_headings" ||
                          qGroup.type === "true_false_not_given" ||
                          qGroup.type === "matching_items" ||
                          qGroup.type === "which_paragraph_contains" ||
                          qGroup.type === "multiple_choice_multiple_answers" ||
                          qGroup.type === "matching_sentence_endings"
                        ) {
                          qGroup.questions.forEach((question) => {
                            testState.userAnswers[question.id] = "";
                            questionPaletteItems.push({
                              paletteNumber: currentPaletteNumber,
                              questionId: question.id,
                              htmlElementId: `question-${question.questionNumber}`,
                            });
                            currentPaletteNumber++;
                          });
                        } else if (qGroup.type === "table_fill_in_the_blank") {
                          if (qGroup.questions[0].correctAnswer) {
                            for (const subQuestionId in qGroup.questions[0]
                              .correctAnswer) {
                              testState.userAnswers[subQuestionId] = "";
                              questionPaletteItems.push({
                                paletteNumber: currentPaletteNumber,
                                questionId: subQuestionId,
                                htmlElementId: `question-${qGroup.questions[0].questionNumber}`,
                              });
                              currentPaletteNumber++;
                            }
                          }
                        } else {
                          qGroup.questions.forEach((question) => {
                            if (question.type === "table_fill_in_the_blank") {
                              if (question.correctAnswer) {
                                for (const subQuestionId in question.correctAnswer) {
                                  testState.userAnswers[subQuestionId] = "";
                                  questionPaletteItems.push({
                                    paletteNumber: currentPaletteNumber,
                                    questionId: subQuestionId,
                                    htmlElementId: `question-${question.questionNumber}`,
                                  });
                                  currentPaletteNumber++;
                                }
                              }
                            } else {
                              testState.userAnswers[question.id] = "";
                              questionPaletteItems.push({
                                paletteNumber: currentPaletteNumber,
                                questionId: question.id,
                                htmlElementId: `question-${question.questionNumber}`,
                              });
                              currentPaletteNumber++;
                            }
                          });
                        }
                      }
                    });
                  });

                  // After populating questionPaletteItems from the test data:
                  // Ensure totalQuestions is always 40 for Listening and Reading,
                  // and pad questionPaletteItems if necessary.
                  if (
                    currentModuleId === "listening" ||
                    currentModuleId === "reading"
                  ) {
                    const expectedTotalQuestions = 40;
                    const actualParsedQuestions = questionPaletteItems.length;

                    if (actualParsedQuestions < expectedTotalQuestions) {
                      console.warn(
                        `Warning: ${currentModuleId} test '${currentTestId}' has ${actualParsedQuestions} answerable questions in data. Padding to ${expectedTotalQuestions} for IELTS standard.`
                      );
                      for (
                        let i = actualParsedQuestions;
                        i < expectedTotalQuestions;
                        i++
                      ) {
                        const dummyQuestionId = `dummy_q_${i + 1}`;
                        testState.userAnswers[dummyQuestionId] = ""; // Initialize dummy answer as unanswered
                        questionPaletteItems.push({
                          paletteNumber: i + 1,
                          questionId: dummyQuestionId,
                          htmlElementId: `dummy-question-${i + 1}`, // Dummy ID, won't be scrolled to
                        });
                      }
                    } else if (actualParsedQuestions > expectedTotalQuestions) {
                      console.warn(
                        `Warning: ${currentModuleId} test '${currentTestId}' has ${actualParsedQuestions} answerable questions in data, which is more than the standard 40. This might affect scoring accuracy.`
                      );
                      // If there are more than 40 actual questions, we'll still score out of 40,
                      // but the unanswered count will reflect the actual number of input fields.
                    }
                    totalQuestions = expectedTotalQuestions; // Force totalQuestions to 40 for scoring
                  } else {
                    // For other modules, totalQuestions is just the count of parsed questions
                    totalQuestions = questionPaletteItems.length;
                  }

                  console.log(
                    "Final total questions (for scoring):",
                    totalQuestions
                  );
                  console.log(
                    "Question Palette Items (for UI/unanswered count):",
                    questionPaletteItems.length
                  );

                  testState.timeLeft = currentTest.duration * 60;
                  const audioPlayer = document.getElementById(
                    "test-audio-player"
                  );
                  if (audioPlayer) {
                    audioPlayer.src = currentTest.audioUrl;
                  }
                  renderApp(); // Render test UI
                }
              } else {
                // Test not found
                appDiv.innerHTML = `
                        <div class="text-center text-red-500 text-xl mt-12">
                            Error: Mock test not found.
                            <br><a href="mock-test-home.html" class="text-blue-600 hover:underline mt-4 inline-block">Go back to mock tests</a>
                        </div>
                    `;
              }
            } else {
              // No module or test specified, redirect to home or show error
              appDiv.innerHTML = `
                    <div class="text-center text-red-500 text-xl mt-12">
                        Error: No module or test specified in the URL.
                        <br><a href="mock-test-home.html" class="text-blue-600 hover:underline mt-4 inline-block">Go back to mock tests</a>
                    </div>
                `;
            }
          })
          .catch((error) => {
            console.error(
              "Failed to initialize Firebase in mock-test.html:",
              error
            );
            showToast(
              "Failed to initialize Firebase. Some features may not work.",
              "error"
            );
            // Even if Firebase fails, try to render the app, but features might be limited
            testState.isLoadingResults = false; // Ensure loading is off
            renderApp();
          });
      };
    </script>
  </body>
</html>
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IELTS Mahir - Mock Test Category</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter (for general text) and Anton (for headings) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Anton&family=Inter:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.lordicon.com/lordicon.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css"
    />
    <style id="mock-test-category-styles">
      /* Distinct styles for the Mock Test system */
      body {
        font-family: "Inter", sans-serif;
        background: linear-gradient(
          135deg,
          #f0f4f8 0%,
          #d9e2ec 100%
        ); /* A subtle, professional blue-gray gradient */
        color: #2d3748; /* Darker text for readability */
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .font-anton {
        font-family: "Anton", sans-serif;
      }
      .font-inter {
        font-family: "Inter", sans-serif;
      }

      .test-card {
        background: #ffffff; /* Clean white background */
        border: 1px solid #e2e8f0; /* Light border */
        border-radius: 1.5rem; /* Rounded corners */
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08),
          0 4px 10px rgba(0, 0, 0, 0.05); /* Enhanced soft shadow */
        transition: all 0.3s ease-in-out;
      }

      .test-card:hover {
        transform: translateY(-8px); /* More pronounced lift on hover */
        box-shadow: 0 16px 35px rgba(0, 0, 0, 0.15),
          0 8px 18px rgba(0, 0, 0, 0.1); /* Deeper shadow on hover */
        border-color: #90cdf4; /* Subtle blue border on hover */
      }

      .test-card-thumbnail-area {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 160px;
        border-top-left-radius: 1.5rem;
        border-top-right-radius: 1.5rem;
        font-size: 4rem;
        color: white;
        box-shadow: inset 0 -8px 15px rgba(0, 0, 0, 0.25);
        position: relative;
        overflow: hidden;
      }

      .test-card-thumbnail-area::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0.15) 0%,
          rgba(0, 0, 0, 0.3) 100%
        );
        z-index: 1;
      }

      .test-card-thumbnail-area i {
        position: relative;
        z-index: 2;
      }

      /* Animations */
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes pulse-slow {
        0%,
        100% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.05);
          opacity: 0.8;
        }
      }

      .animate-fade-in {
        animation: fadeIn 0.5s ease-out forwards;
      }

      .animate-fade-in-up {
        animation: fadeInUp 0.6s ease-out forwards;
      }

      .animate-pulse-slow {
        animation: pulse-slow 3s infinite ease-in-out;
      }

      /* Styles for the header section (can be shared or distinct) */
      .site-header {
        background-color: #ffffff;
        border-bottom: 1px solid #e0e0e0;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .site-header .nav-link {
        font-weight: 500;
        color: #555555;
      }

      .site-header .nav-link:hover {
        color: #1d4ed8;
        transform: translateY(-1px);
      }

      .user-id-display {
        background-color: rgba(255, 255, 255, 0.7);
        border: 1px solid #d1d5db;
        color: #4b5563;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        backdrop-filter: blur(3px);
      }

      /* Hero section styles */
      .hero-section-mock-category {
        min-height: 300px; /* Slightly smaller than home hero */
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: left;
        background-image: url("https://images.pexels.com/photos/5428830/pexels-photo-5428830.jpeg"); /* Reusing existing image for now */
        background-size: cover;
        background-position: center;
        position: relative;
        overflow: hidden;
        border-radius: 1.5rem;
      }

      .hero-section-mock-category::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          to right,
          rgba(66, 153, 225, 0.8) 0%,
          rgba(56, 178, 172, 0.6) 100%
        ); /* A distinct blue-green gradient */
        z-index: 0;
      }

      .hero-section-mock-category .content {
        position: relative;
        z-index: 1;
        text-align: center;
        color: white;
      }

      .text-shadow-lg-custom {
        text-shadow: 3px 3px 8px rgba(0, 0, 0, 0.6);
      }

      .points-display {
        background: linear-gradient(
          45deg,
          #84cc16,
          #22c55e
        ); /* Lime to green gradient */
        color: white;
        padding: 0.35rem 0.9rem;
        border-radius: 9999px;
        font-weight: bold;
        font-size: 0.875rem; /* text-sm */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
    </style>
  </head>
  <body class="py-0 px-0">
    <!-- Header / Navigation Bar (Can be shared with quiz system) -->
    <header
      id="app-header"
      class="site-header py-4 px-4 md:px-8 flex items-center justify-between transition-colors duration-300 sticky top-0 z-50"
    >
      <div class="flex items-center gap-2 sm:gap-4">
        <img
          src="assets/278115481_106536582034386_7446598694214552893_n-removebg-preview.png"
          alt="IELTS Mahir Logo"
          class="h-8 md:h-10 w-auto"
          onerror="this.onerror=null; this.src='https://placehold.co/100x40/E0E0E0/333333?text=Logo';"
        />
        <nav class="hidden md:flex gap-6 ml-8 font-inter">
          <a href="quiz-home.html" class="nav-link transition-all"
            >Quiz System</a
          >
          <a href="mock-test-home.html" class="nav-link transition-all"
            >Mock Tests</a
          >
          <a href="#" class="nav-link transition-all">Resources</a>
        </nav>
      </div>
      <div id="auth-buttons-container" class="flex items-center gap-2 sm:gap-4">
        <!-- Authentication status will be handled by auth.js -->
        <div class="animate-pulse flex space-x-4">
          <div class="rounded-full bg-gray-300 h-8 w-8 sm:h-10 sm:w-10"></div>
          <div class="flex-1 space-y-4 py-1 hidden sm:block">
            <div class="h-2 bg-gray-300 rounded"></div>
            <div class="space-y-2">
              <div class="grid grid-cols-3 gap-2">
                <div class="h-2 bg-gray-300 rounded col-span-2"></div>
                <div class="h-2 bg-gray-300 rounded col-span-1"></div>
              </div>
              <div class="h-2 bg-gray-300 rounded"></div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div id="app" class="container mx-auto px-4 sm:px-6 lg:px-8 flex-grow">
      <!-- Application content will be rendered here by JavaScript -->
      <div class="flex justify-center items-center h-full">
        <div
          class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"
        ></div>
      </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-[100]"></div>

    <!-- Modal Container -->
    <div id="modal-container"></div>

    <script type="module">
      // Import authentication functions and state from the central auth.js file
      import {
        initFirebaseAuth,
        authAppState,
        showToast,
        Icons,
        signOutUser,
      } from "./auth.js"; // Adjust path as necessary

      // Import mock test data
      import {
        MockTestModules,
        allMockTests,
        MockTestIcons,
        formatTime,
      } from "./mock-test-data.js";

      // Firebase imports for Firestore
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc, // Added setDoc for initializing userGameStats if not exists
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // Firebase instances (will be populated by auth.js)
      let db;
      let auth;

      // Current module ID from URL
      let currentModuleId = null;

      // User game stats (will be fetched from Firestore)
      let userGameStats = {
        totalPoints: 0,
        level: 1,
        completedTests: [], // Array of test IDs
      };

      // Inline SVG icons for Clock and Question Mark
      const ClockIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`;
      const QuestionMarkIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-help"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>`;

      /**
       * Fetches user's game stats from Firestore.
       * @param {string} userId - The ID of the current user.
       */
      async function fetchUserGameStats(userId) {
        if (!db || !userId) return;
        const appId =
          typeof __app_id !== "undefined" ? __app_id : "default-app-id";
        const userStatsDocRef = doc(
          db,
          `artifacts/${appId}/users/${userId}/gameStats/summary`
        );

        try {
          const docSnap = await getDoc(userStatsDocRef);
          if (docSnap.exists()) {
            userGameStats = { ...userGameStats, ...docSnap.data() };
            console.log("Fetched user game stats:", userGameStats);
          } else {
            console.log(
              "No game stats found for user, initializing defaults in Firestore."
            );
            // Initialize game stats in Firestore if they don't exist
            await setDoc(userStatsDocRef, userGameStats);
          }
        } catch (error) {
          console.error("Error fetching user game stats:", error);
          showToast("Failed to load your game progress.", "error");
        }
      }

      /**
       * Updates the navigation bar and user ID display based on authentication status.
       * @param {object|null} user - The Firebase User object or null if signed out.
       */
      async function updateAuthUI(user) {
        const authButtonsContainer = document.getElementById(
          "auth-buttons-container"
        );
        if (authButtonsContainer) {
          if (user) {
            // Fetch game stats if user is logged in and db is available
            if (db && user.uid) {
              await fetchUserGameStats(user.uid); // Await this to ensure userGameStats is updated
            }

            // User is signed in: Show profile dropdown and game stats
            authButtonsContainer.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="points-display">
                                ${
                                  MockTestIcons.Trophy ||
                                  '<i class="fas fa-trophy"></i>'
                                }
                                <span class="text-sm font-semibold">${
                                  userGameStats.totalPoints
                                } Pts</span>
                                <span class="text-xs text-green-200">|</span>
                                <span class="text-sm font-semibold">Lvl ${
                                  userGameStats.level
                                }</span>
                            </div>
                            <div class="relative">
                                <button id="profile-icon-btn" class="flex items-center justify-center w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-blue-600 text-white text-lg sm:text-xl font-bold shadow-md hover:bg-blue-700 transition-colors">
                                    ${(
                                      authAppState.userProfile?.name ||
                                      user.email ||
                                      user.uid
                                    )
                                      .charAt(0)
                                      .toUpperCase()}
                                </button>
                                <div id="profile-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl py-2 z-50 hidden text-gray-800">
                                    <div class="px-4 py-2 text-sm border-b border-gray-200">Hello, ${
                                      authAppState.userProfile?.name ||
                                      user.email ||
                                      user.uid.substring(0, 8)
                                    }</div>
                                    <div class="px-4 py-2 text-xs text-gray-500 border-b border-gray-200">Level: ${
                                      userGameStats.level
                                    }</div>
                                    <a href="dashboard.html" class="flex items-center gap-2 px-4 py-2 hover:bg-gray-100">
                                        ${Icons.Dashboard.replace(
                                          /stroke="currentColor"/g,
                                          'stroke="gray"'
                                        )} Dashboard
                                    </a>
                                    <a href="ielts-mahir-community-forum.html" class="flex items-center gap-2 px-4 py-2 hover:bg-gray-100">
                                        ${Icons.Forum.replace(
                                          /stroke="currentColor"/g,
                                          'stroke="gray"'
                                        )} Forum
                                    </a>
                                    <button id="sign-out-dropdown-btn" class="flex items-center gap-2 w-full text-left px-4 py-2 text-red-600 hover:bg-red-100 rounded-b-lg">
                                        ${Icons.SignOut.replace(
                                          /stroke="currentColor"/g,
                                          'stroke="red"'
                                        )} Sign Out
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;

            const profileIconBtn = document.getElementById("profile-icon-btn");
            const profileDropdown = document.getElementById("profile-dropdown");
            const signOutDropdownBtn = document.getElementById(
              "sign-out-dropdown-btn"
            );

            profileIconBtn.addEventListener("click", (event) => {
              event.stopPropagation();
              profileDropdown.classList.toggle("hidden");
            });

            document.addEventListener("click", (event) => {
              if (
                !profileDropdown.contains(event.target) &&
                !profileIconBtn.contains(event.target)
              ) {
                profileDropdown.classList.add("hidden");
              }
            });

            signOutDropdownBtn.addEventListener("click", async () => {
              await signOutUser();
              // Redirect will happen via onAuthStateChanged in auth.js
            });
          } else {
            // User is signed out: Show sign-in button
            authButtonsContainer.innerHTML = `
                        <a href="auth.html" id="sign-in-nav-btn" class="px-4 py-2 bg-blue-600 text-white rounded-full shadow-md hover:bg-blue-700 transition-all text-sm font-semibold transform active:scale-95">
                            Join beta user
                        </a>
                    `;
          }
        }
      }

      /**
       * Renders the main application content for the mock test category page.
       */
      function renderApp() {
        const appDiv = document.getElementById("app");
        if (!appDiv) return;

        const urlParams = new URLSearchParams(window.location.search);
        currentModuleId = urlParams.get("module");

        if (!currentModuleId) {
          appDiv.innerHTML = `
                        <div class="text-center text-red-500 text-xl mt-12">
                            Error: No module specified in the URL.
                            <br><a href="mock-test-home.html" class="text-blue-600 hover:underline mt-4 inline-block">Go back to modules</a>
                        </div>
                    `;
          return;
        }

        const module = MockTestModules.find(
          (mod) => mod.id === currentModuleId
        );
        if (!module) {
          appDiv.innerHTML = `
                        <div class="text-center text-red-500 text-xl mt-12">
                            Error: Module not found.
                            <br><a href="mock-test-home.html" class="text-blue-600 hover:underline mt-4 inline-block">Go back to modules</a>
                        </div>
                    `;
          return;
        }

        const testsInThisModule = allMockTests.filter(
          (test) => test.moduleId === currentModuleId
        );

        appDiv.innerHTML = `
                <!-- Hero Section for Mock Test Category -->
                <section class="hero-section-mock-category max-w-6xl mx-auto my-8 relative overflow-hidden">
                    <div class="content p-8 md:p-12 lg:p-16">
                        <p class="font-inter text-xl sm:text-2xl font-medium mb-2 text-shadow-lg-custom">Mock Tests</p>
                        <h1 class="font-anton text-5xl sm:text-6xl md:text-7xl lg:text-8xl leading-tight font-bold text-shadow-lg-custom">
                            ${module.name} Module
                        </h1>
                        <p class="font-inter text-lg sm:text-xl lg:text-2xl text-white text-opacity-90 mt-4 max-w-2xl mx-auto text-shadow-lg-custom">
                            ${module.description}
                        </p>
                        ${
                          authAppState.isAuthReady && authAppState.userId
                            ? `
                        <p class="mt-8 text-sm sm:text-lg font-mono user-id-display inline-block px-3 py-1 sm:px-4 sm:py-2 rounded-xl animate-fade-in">
                            User ID: <span class="font-semibold text-gray-800">${authAppState.userId}</span>
                        </p>
                        `
                            : ""
                        }
                    </div>
                </section>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-8 lg:gap-10 max-w-6xl mx-auto py-8">
                    ${
                      testsInThisModule.length > 0
                        ? testsInThisModule
                            .map((test) => {
                              // For now, no locking mechanism based on level for mock tests,
                              // but can be added later if gamification extends to mock tests.
                              const isLocked = false; // Placeholder for future logic
                              const lockOverlay = isLocked
                                ? `
                                        <div class="absolute inset-0 bg-gradient-to-br from-gray-900/80 to-gray-700/80 backdrop-blur-sm flex flex-col items-center justify-center rounded-3xl z-40 p-4">
                                            <div class="relative mb-4">
                                                <i class="fas fa-lock text-6xl text-yellow-400 drop-shadow-lg animate-pulse-slow"></i>
                                            </div>
                                            <span class="text-white text-3xl font-extrabold text-shadow-lg mb-2 font-anton">
                                                Test Locked!
                                            </span>
                                            <span class="text-blue-200 text-xl font-semibold text-shadow-md font-inter">
                                                Unlock at Level X
                                            </span>
                                            <p class="text-gray-300 text-sm mt-2 text-center max-w-xs font-inter">
                                                Complete more mock tests to gain points and level up!
                                            </p>
                                        </div>
                                    `
                                : "";

                              // Corrected logic to count questions, handling writing_task and other types
                              const totalQuestions = test.sections.reduce(
                                (totalAcc, sec) => {
                                  // If it's a writing task, it doesn't have questionGroups
                                  if (sec.type === "writing_task") {
                                    // You can decide how to count writing tasks.
                                    // For now, let's not count them as "questions" in the same way.
                                    // If you want to count each writing task as 1, change 0 to 1.
                                    return totalAcc;
                                  }

                                  // For other types, proceed with counting questions within questionGroups
                                  if (sec.questionGroups) {
                                    return (
                                      totalAcc +
                                      sec.questionGroups.reduce(
                                        (groupAcc, group) => {
                                          if (group.questions) {
                                            return (
                                              groupAcc +
                                              group.questions.reduce(
                                                (qAcc, question) => {
                                                  if (
                                                    question.type ===
                                                      "table_fill_in_the_blank" &&
                                                    question.correctAnswer
                                                  ) {
                                                    // Count individual answers for table fill-in-the-blank
                                                    return (
                                                      qAcc +
                                                      Object.keys(
                                                        question.correctAnswer
                                                      ).length
                                                    );
                                                  } else if (
                                                    group.type ===
                                                      "multiple_choice_multiple_answers" &&
                                                    question.correctAnswer
                                                  ) {
                                                    // For MCAA, count the number of correct options
                                                    return (
                                                      qAcc +
                                                      question.correctAnswer
                                                        .length
                                                    );
                                                  } else {
                                                    // For all other types, count as 1 question
                                                    return qAcc + 1;
                                                  }
                                                },
                                                0
                                              )
                                            );
                                          } else {
                                            return groupAcc;
                                          }
                                        },
                                        0
                                      )
                                    );
                                  } else {
                                    return totalAcc; // No questionGroups, add 0
                                  }
                                },
                                0
                              );

                              return `
                                <a href="${
                                  isLocked
                                    ? "#"
                                    : `mock-test.html?module=${currentModuleId}&test=${test.id}`
                                }"
                                   class="test-card relative block overflow-hidden rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 animate-fade-in p-0 flex flex-col items-center text-center ${
                                     isLocked
                                       ? "cursor-not-allowed opacity-70"
                                       : ""
                                   }">
                                    ${lockOverlay}
                                    <div class="test-card-thumbnail-area ${
                                      module.color || "bg-gray-600"
                                    }">
                                        ${
                                          module.icon ||
                                          '<i class="fas fa-question-circle"></i>'
                                        }
                                    </div>
                                    <div class="p-6 sm:p-8 flex-grow flex flex-col justify-between w-full">
                                        <h2 class="text-2xl sm:text-3xl font-bold lg:font-extrabold mb-2 leading-tight text-gray-800 font-anton">${
                                          test.title
                                        }</h2>
                                        <p class="text-sm sm:text-base text-gray-600 mb-4 flex-grow font-inter">${
                                          test.description
                                        }</p>
                                        <div class="flex justify-between items-center text-gray-600 text-sm font-inter">
                                            <span class="flex items-center gap-1">
                                                ${ClockIconSVG}
                                                ${test.duration} mins
                                            </span>
                                            <span class="flex items-center gap-1">
                                                ${QuestionMarkIconSVG}
                                                ${totalQuestions} Qs
                                            </span>
                                        </div>
                                    </div>
                                </a>
                            `;
                            })
                            .join("")
                        : `
                        <div class="md:col-span-3 text-center text-gray-600 py-8 font-inter">
                            <p class="text-lg sm:text-xl">No mock tests available for this module yet.</p>
                        </div>
                    `
                    }
                </div>
            `;
      }

      // Initialization Logic
      window.onload = async function () {
        // Initialize Firebase Auth and listen for state changes
        initFirebaseAuth(updateAuthUI)
          .then(async ({ db: firestoreDb, auth: firebaseAuth }) => {
            db = firestoreDb;
            auth = firebaseAuth;
            console.log("Firebase initialized in mock-test-category.html:", {
              db,
              auth,
            });

            // Fetch user game stats after Firebase is initialized and user is authenticated
            auth.onAuthStateChanged(async (user) => {
              if (user) {
                // Ensure userGameStats is fetched/initialized before rendering the main app content
                await fetchUserGameStats(user.uid);
              }
              renderApp(); // Render the app after auth state and game stats are known
            });
          })
          .catch((error) => {
            console.error(
              "Failed to initialize Firebase in mock-test-category.html:",
              error
            );
            showToast(
              "Failed to initialize Firebase. Some features may not work.",
              "error"
            );
            renderApp(); // Still render app even if Firebase fails, but features might be limited
          });
      };
    </script>
  </body>
</html>
