<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IELTS Speaking Pro</title>
    <!-- Tailwind CSS CDN for stupendous design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Anton for headings, Montserrat for body text -->
    <link
      href="https://fonts.googleapis.com/css2?family=Anton&family=Montserrat:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Montserrat", sans-serif; /* Default body font */
        background-color: #f8fafc; /* Light gray background */
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 1.5rem; /* Responsive padding */
      }
      h1,
      h2,
      h3 {
        font-family: "Anton", sans-serif; /* Anton for headings */
      }
      .container {
        max-width: 1024px; /* Max width for larger screens */
        width: 100%;
        background-color: #ffffff; /* White background for the app */
        padding: 2.5rem 2rem; /* Responsive padding */
        border-radius: 2rem; /* Rounded corners */
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); /* Stronger shadow */
        border: 1px solid #bfdbfe; /* Light blue border */
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 600px; /* Minimum height for consistent layout */
      }
      .text-shadow-lg {
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      }
      /* Custom scrollbar for modal content */
      .modal-content::-webkit-scrollbar {
        width: 8px;
      }
      .modal-content::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }
      .modal-content::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
      }
      .modal-content::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
    </style>
  </head>
  <body>
    <div id="app-container" class="container">
      <!-- Title and Description -->
      <h1
        class="text-4xl sm:text-5xl font-extrabold text-blue-800 mb-6 sm:mb-8 text-shadow-lg"
      >
        IELTS Speaking Pro
      </h1>
      <p class="text-md sm:text-lg text-gray-600 mb-8 sm:mb-10 max-w-2xl">
        Your world-class AI-powered IELTS Speaking Test simulation system.
        Practice with confidence and get actionable feedback.
      </p>

      <!-- Main Content Area -->
      <div
        id="content-area"
        class="w-full flex-grow flex flex-col items-center justify-center min-h-[400px]"
      >
        <!-- Content will be rendered here by JavaScript -->
      </div>

      <!-- Feedback Modal -->
      <div
        id="feedback-modal"
        class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 overflow-y-auto hidden"
      >
        <div
          class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl max-w-3xl w-full mx-auto transform transition-all duration-300 scale-100 opacity-100 border border-blue-200"
        >
          <h2 class="text-3xl font-bold text-center text-emerald-700 mb-5">
            Your Performance Feedback
          </h2>
          <div
            class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 rounded-lg"
            role="alert"
          >
            <p class="font-bold">Important Note:</p>
            <p class="text-sm">
              This system provides **simulated** feedback and an **estimated
              band score**. For truly exact results (e.g., real-time
              speech-to-text, deep linguistic analysis, and precise
              pronunciation assessment), you would need a professional IELTS
              examiner or a comprehensive AI speech analysis service with a
              **robust backend**. This tool is designed for **practice and
              improvement**, helping you identify areas for development based on
              IELTS criteria.
            </p>
          </div>
          <p
            id="modal-overall-band"
            class="text-xl font-bold text-center text-blue-700 mb-4"
          ></p>
          <p
            id="modal-general-comment"
            class="text-md text-gray-700 mb-6 text-center"
          ></p>

          <div
            id="modal-criteria"
            class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"
          >
            <!-- Criteria feedback will be injected here -->
          </div>

          <h3 class="text-xl font-bold text-gray-800 mb-3 text-center">
            Simulated Transcript:
          </h3>
          <div
            class="bg-gray-100 p-4 rounded-lg border border-gray-200 text-gray-700 text-sm italic mb-6"
          >
            <p id="modal-transcript"></p>
          </div>

          <div class="flex justify-center space-x-4">
            <button
              id="modal-continue-btn"
              class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-2 rounded-xl shadow-lg hover:from-blue-600 hover:to-blue-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300"
            >
              Continue Test
            </button>
            <button
              id="modal-end-test-btn"
              class="bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-2 rounded-xl shadow-lg hover:from-red-600 hover:to-red-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-300"
            >
              End Test
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Global state variables
      let currentPart = 0; // 0: Intro, 1: Part 1, 2: Part 2, 3: Part 3, 4: Results
      let question = ""; // Current question displayed
      let isRecording = false; // Recording status
      let audioBlob = null; // Stores the recorded audio
      let recordingTime = 0; // Current recording time
      let timerId = null; // Interval ID for recording timer (for Part 1/3 response time or Part 2 prep/speaking)
      let mediaRecorder = null; // MediaRecorder instance
      let audioChunks = []; // Chunks of audio data
      let feedback = null; // Stores AI-generated feedback
      let isLoadingAI = false; // Loading state for AI processing
      let cueCard = null; // Stores cue card details for Part 2
      let prepTime = 60; // Preparation time for Part 2
      let speakingTime = 120; // Speaking time for Part 2
      let part2ActiveTimer = "prep"; // 'prep' or 'speaking' for Part 2
      let totalTestTime = 0; // Tracks total test time
      let totalTestTimerId = null; // ID for total test timer
      let currentPartQuestionCount = 0; // Tracks questions asked in Part 1 and Part 3 for dynamic progression

      // Constants
      const MAX_PART1_QUESTIONS = 4; // Number of questions in Part 1 before moving on
      const MAX_PART3_QUESTIONS = 3; // Number of questions in Part 3 before moving on
      const MIN_RESPONSE_LENGTH_SECONDS = 5; // Minimum recording time required for simulated feedback for Part 1 & 3

      const API_KEY = "AIzaSyCsdeFOJrU43BZmnRP5WD1pm80fZH1cxN4"; // Your Gemini API key

      // DOM elements references
      const contentArea = document.getElementById("content-area");
      const feedbackModal = document.getElementById("feedback-modal");
      const modalOverallBand = document.getElementById("modal-overall-band");
      const modalGeneralComment = document.getElementById(
        "modal-general-comment"
      );
      const modalCriteria = document.getElementById("modal-criteria");
      const modalTranscript = document.getElementById("modal-transcript");
      const modalContinueBtn = document.getElementById("modal-continue-btn");
      const modalEndTestBtn = document.getElementById("modal-end-test-btn");

      // IELTS Speaking Test Structure and Questions
      const testParts = [
        {
          name: "Introduction",
          description:
            "Welcome to the IELTS Speaking Test. I am your examiner. Let's begin by checking your identity.",
          instructions: "Please tell me your full name.",
          duration: 0,
          isExaminerPromptOnly: true,
        },
        {
          name: "Part 1: Introduction & Interview",
          instructions:
            "In this part, I'd like to ask you some general questions about yourself.",
          topics: [
            "Home and Accommodation",
            "Work or Study",
            "Hobbies and Interests",
            "Hometown",
            "Travel",
            "Food",
            "Weather",
          ],
          duration: 4 * 60 + 30,
          minResponseTime: 10,
          maxResponseTime: 45,
        },
        {
          name: "Part 2: Long Turn",
          instructions:
            "Now, I'm going to give you a topic and I'd like you to talk about it for 1 to 2 minutes. You'll have 1 minute to prepare and make some notes.",
          duration: 3 * 60 + 30,
          cueCards: [
            {
              topic: "Describe a successful person you know.",
              points: [
                "who this person is",
                "how you know them",
                "what they have achieved",
                "and explain why you consider them successful.",
              ],
            },
            {
              topic: "Describe a place you would like to visit in the future.",
              points: [
                "where it is",
                "how you would get there",
                "what you would do there",
                "and explain why you want to visit this place.",
              ],
            },
            {
              topic: "Describe an important historical event in your country.",
              points: [
                "what the event was",
                "when it happened",
                "what happened during the event",
                "and explain why it was important.",
              ],
            },
            {
              topic: "Describe a piece of technology you find useful.",
              points: [
                "what it is",
                "how long you have had it",
                "what you use it for",
                "and explain why you find it useful.",
              ],
            },
            {
              topic: "Describe a difficult decision you once made.",
              points: [
                "what the decision was",
                "when you made it",
                "how you made the decision",
                "and explain why it was a difficult decision.",
              ],
            },
          ],
        },
        {
          name: "Part 3: Discussion",
          instructions:
            "We've been talking about [Part 2 topic]. Now I'd like to ask you some more general questions related to this topic.",
          duration: 4 * 60 + 30,
        },
      ];

      /**
       * Converts seconds into a formatted MM:SS string.
       * @param {number} seconds - The number of seconds to format.
       * @returns {string} Formatted time string (MM:SS).
       */
      function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${minutes
          .toString()
          .padStart(2, "0")}:${remainingSeconds.toString().padStart(2, "0")}`;
      }

      /**
       * Speaks a given text using the Web Speech API.
       * @param {string} text - The text to speak.
       */
      function speakText(text) {
        if ("speechSynthesis" in window) {
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = "en-US"; // Set language for better pronunciation
          utterance.rate = 0.9; // Slightly slower for clarity
          utterance.pitch = 1.0;
          window.speechSynthesis.speak(utterance);
        } else {
          console.warn("Speech Synthesis API not supported in this browser.");
        }
      }

      /**
       * Generates an examiner question using the Gemini API.
       * Updates the global `question` variable and speaks the question.
       * @param {string} prompt - The prompt for the Gemini API.
       */
      async function generateExaminerQuestion(prompt) {
        isLoadingAI = true;
        renderContent(); // Update UI to show loading spinner
        try {
          let chatHistory = [];
          chatHistory.push({ role: "user", parts: [{ text: prompt }] });
          const payload = { contents: chatHistory };

          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;

          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            // Check if the HTTP status is not 2xx
            const errorDetails = await response.text(); // Get raw response text for debugging
            console.error(
              `Gemini API request failed: ${response.status} ${response.statusText}`,
              errorDetails
            );
            question = `Error from API: ${response.status} ${response.statusText}. Please ensure your API key is correct and try again.`;
            speakText(question);
            return; // Exit the function early
          }

          const result = await response.json(); // Attempt to parse JSON

          if (
            result.candidates &&
            result.candidates.length > 0 &&
            result.candidates[0].content &&
            result.candidates[0].content.parts &&
            result.candidates[0].content.parts.length > 0
          ) {
            const text = result.candidates[0].content.parts[0].text;
            if (text) {
              // Ensure text is not empty
              question = text.trim();
              speakText(question);
            } else {
              console.error("Gemini API returned empty text content:", result);
              question =
                "The examiner couldn't formulate a question at this moment. Please try again.";
              speakText(question);
            }
          } else {
            console.error(
              "Gemini API returned an unexpected response structure or no candidates:",
              result
            );
            question =
              "I'm sorry, I couldn't generate a question at this moment. The API response was not as expected. Please try again.";
            speakText(question);
          }
        } catch (error) {
          console.error("Error generating question with Gemini API:", error);
          // More specific error message for common issues like network problems or malformed JSON
          if (
            error instanceof SyntaxError &&
            error.message.includes("JSON.parse")
          ) {
            question =
              "Failed to parse API response. This might indicate an invalid API key or a service issue. Please check your API key.";
          } else if (error.message.includes("Failed to fetch")) {
            question =
              "Network error: Could not connect to the API. Please check your internet connection.";
          } else {
            question =
              "An unexpected error occurred while communicating with the question generator. Please try again.";
          }
          speakText(question);
        } finally {
          isLoadingAI = false;
          renderContent(); // Re-render UI after loading
        }
      }

      /**
       * Starts the audio recording.
       */
      async function startRecording() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          const recorder = new MediaRecorder(stream);
          mediaRecorder = recorder; // Store mediaRecorder instance

          audioChunks = []; // Clear previous chunks
          recorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
          };

          recorder.onstop = () => {
            audioBlob = new Blob(audioChunks, { type: "audio/webm" });
            // Stop microphone access
            stream.getTracks().forEach((track) => track.stop());

            // Conditional logic for Part 1/3 auto-advance or feedback after stopping
            if (currentPart === 1 || currentPart === 3) {
              if (recordingTime >= MIN_RESPONSE_LENGTH_SECONDS) {
                currentPartQuestionCount++;
                if (
                  currentPart === 1 &&
                  currentPartQuestionCount < MAX_PART1_QUESTIONS
                ) {
                  handleNextQuestion(); // Ask next question in Part 1
                } else if (
                  currentPart === 3 &&
                  currentPartQuestionCount < MAX_PART3_QUESTIONS
                ) {
                  handleNextQuestion(); // Ask next question in Part 3
                } else {
                  // End of part, show feedback
                  speakText(
                    currentPart === 1
                      ? "That's the end of Part 1."
                      : "That concludes Part 3 and the speaking test. Thank you."
                  );
                  isLoadingAI = true;
                  renderContent();
                  setTimeout(() => {
                    feedback = generateSimulatedFeedback();
                    showResultsModal();
                    isLoadingAI = false;
                    renderContent(); // Update UI after loading
                  }, 2000);
                }
              } else {
                // User stopped too early, prompt to speak more
                showMessageBox(
                  "Response Too Short",
                  `Please speak for at least ${MIN_RESPONSE_LENGTH_SECONDS} seconds to get meaningful feedback or proceed to the next question.`
                );
                isRecording = false; // Reset recording state so they can try again
                audioBlob = null; // Clear invalid audio
                recordingTime = 0; // Reset timer
                renderContent();
              }
            } else {
              // Part 2 or manual stop
              isLoadingAI = true;
              renderContent(); // Update UI to show AI processing
              setTimeout(() => {
                feedback = generateSimulatedFeedback();
                showResultsModal();
                isLoadingAI = false;
                renderContent(); // Re-render to update controls
              }, 2000); // 2-second delay for AI simulation
            }
            isRecording = false; // Set this after other conditional blocks, to ensure consistency
            renderContent(); // Re-render to update UI with final recording state
          };

          recorder.start();
          isRecording = true;
          recordingTime = 0;
          clearInterval(timerId); // Clear any previous timer
          timerId = setInterval(() => {
            recordingTime++;
            renderContent(); // Update UI with new time
          }, 1000);
          renderContent(); // Initial render to show recording state
        } catch (err) {
          console.error("Error accessing microphone:", err);
          showMessageBox(
            "Microphone Access Error",
            "Could not access microphone. Please ensure it's connected and permissions are granted in your browser settings. You might need to refresh the page after granting permission."
          );
          isRecording = false;
          renderContent(); // Re-render to reflect non-recording state
        }
      }

      /**
       * Stops the audio recording.
       */
      function stopRecording() {
        if (mediaRecorder && isRecording) {
          mediaRecorder.stop();
          clearInterval(timerId);
          timerId = null;
          isRecording = false;
          renderContent(); // Update UI
        }
      }

      /**
       * Plays the recorded audio.
       */
      function playAudio() {
        if (audioBlob) {
          const audioUrl = URL.createObjectURL(audioBlob);
          const audioEl = document.getElementById("audio-playback");
          if (audioEl) {
            audioEl.src = audioUrl;
            audioEl.play();
          }
        }
      }

      /**
       * Rounds a score to the nearest 0.5 increment for IELTS banding.
       * @param {number} score - The raw score.
       * @returns {string} The score rounded to the nearest 0.5, as a string.
       */
      function roundToHalf(score) {
        const rounded = Math.round(score * 2) / 2;
        return rounded.toFixed(1);
      }

      /**
       * Simulates AI feedback generation based on recording time and IELTS criteria.
       * This is a sophisticated simulation. For *actual* precision, real AI APIs are needed.
       * @returns {object} Simulated feedback object.
       */
      function generateSimulatedFeedback() {
        let currentRecordingTime = recordingTime; // Use the latest state
        let fluencyScore = 0.0;
        let lexicalScore = 0.0;
        let grammarScore = 0.0;
        let pronunciationScore = 0.0;

        let simulatedTranscript = `Your response (lasting ${currentRecordingTime} seconds) was: [Simulated AI Transcript Placeholder] `;
        let generalComment =
          "Please speak for a longer duration to demonstrate your English proficiency across all criteria.";

        let fluencyDetails =
          "Insufficient response to assess fluency and coherence effectively. Lack of development.";
        let lexicalDetails =
          "Insufficient language produced to demonstrate a range or accuracy of vocabulary.";
        let grammarDetails =
          "Minimal or no grammatical structures present for assessment. Lack of range and accuracy.";
        let pronunciationDetails =
          "Limited spoken output, making it difficult to assess clarity or pronunciation features.";

        let fluencySuggestions =
          "You need to develop your answers more fully. Aim to speak for a longer duration for each question.";
        let lexicalSuggestions =
          "Focus on expanding your vocabulary and using it to express ideas on various topics.";
        let grammarSuggestions =
          "Practice constructing complete sentences and using different grammatical structures.";
        let pronunciationSuggestions =
          "Practice speaking English regularly to improve overall intelligibility and clarity.";

        // Adjust scores and feedback based on recordingTime and current part
        if (currentRecordingTime >= MIN_RESPONSE_LENGTH_SECONDS) {
          // Base scores start from a more 'realistic' mid-range for a minimum valid response
          fluencyScore = Math.random() * 1.5 + 4.0; // 4.0 - 5.5
          lexicalScore = Math.random() * 1.5 + 4.0; // 4.0 - 5.5
          grammarScore = Math.random() * 1.5 + 4.0; // 4.0 - 5.5
          pronunciationScore = Math.random() * 1.5 + 4.5; // 4.5 - 6.0

          generalComment = `You provided a response. Your estimated band score for this response is [OVERALL_BAND].`;

          // General feedback for having some content
          fluencyDetails =
            "Spoke with some hesitation and repetition, but managed to convey basic ideas.";
          lexicalDetails =
            "Used a basic range of vocabulary, with some repetition of simple words.";
          grammarDetails =
            "Attempted simple sentences, but with frequent grammatical errors that sometimes obscured meaning.";
          pronunciationDetails =
            "Partially intelligible; some sounds were unclear, requiring effort from the listener.";

          fluencySuggestions =
            "Focus on speaking more smoothly with fewer hesitations. Try to connect your ideas more logically using linking words.";
          lexicalSuggestions =
            "Work on expanding your active vocabulary and using more precise words for different contexts.";
          grammarSuggestions =
            "Review fundamental grammar rules (e.g., subject-verb agreement, common tenses) to reduce errors and increase accuracy.";
          pronunciationSuggestions =
            "Pay attention to individual sounds and word stress. Practice listening to native speakers and imitating their pronunciation.";

          if (currentPart === 1 || currentPart === 3) {
            // Part 1/3 specific adjustments based on response length
            if (currentRecordingTime >= 10 && currentRecordingTime < 20) {
              fluencyScore = Math.min(9.0, fluencyScore + 1.0); // Boost for hitting min time
              lexicalScore = Math.min(9.0, lexicalScore + 0.5);
              grammarScore = Math.min(9.0, grammarScore + 0.5);
              simulatedTranscript +=
                "You gave a concise answer, which is good for direct questions. ";
              fluencyDetails =
                "Maintained a reasonable pace with some hesitation, but developed ideas sufficiently for the short answer format.";
            } else if (
              currentRecordingTime >= 20 &&
              currentRecordingTime <= 45
            ) {
              // Optimal length for Part 1/3
              fluencyScore = Math.min(
                9.0,
                fluencyScore + 2.0 + Math.random() * 0.5
              ); // More significant boost
              lexicalScore = Math.min(
                9.0,
                lexicalScore + 1.5 + Math.random() * 0.5
              );
              grammarScore = Math.min(
                9.0,
                grammarScore + 1.5 + Math.random() * 0.5
              );
              pronunciationScore = Math.min(
                9.0,
                pronunciationScore + 1.0 + Math.random() * 0.5
              );
              simulatedTranscript +=
                "Your response was well-developed and of an appropriate length. ";
              fluencyDetails =
                "Spoke fluently with minimal hesitation, effectively connecting ideas and extending responses where appropriate.";
              lexicalDetails =
                "Used a good range of vocabulary with flexibility, demonstrating some awareness of less common terms and paraphrasing.";
              grammarDetails =
                "Demonstrated a mix of simple and complex structures with reasonable control and few errors.";
              pronunciationDetails =
                "Generally clear and intelligible, with appropriate use of intonation and stress patterns.";
              generalComment = `Excellent! Your estimated band score for this response is [OVERALL_BAND]. You demonstrated strong control across the criteria.`;
            } else if (currentRecordingTime > 45) {
              // Too long for Part 1/3
              fluencyScore = Math.max(5.0, fluencyScore - 0.5); // Slight penalty for rambling
              simulatedTranscript +=
                "Your response was a bit longer than typically expected for these questions, occasionally losing focus. ";
              fluencyDetails =
                "Spoke at length, though occasionally struggled with conciseness or maintaining focus, which affected coherence.";
              fluencySuggestions =
                "Work on being more concise and directly answering the question without extraneous details for Part 1. In Part 3, ensure extensions are relevant.";
            }
          } else if (currentPart === 2) {
            // Part 2 specific adjustments (1-2 minutes speaking)
            if (currentRecordingTime < 60) {
              // Too short for Part 2
              fluencyScore = Math.max(
                3.0,
                fluencyScore - (60 - currentRecordingTime) * 0.15
              ); // Stronger penalty
              lexicalScore = Math.max(3.0, lexicalScore - 1.0);
              grammarScore = Math.max(3.0, grammarScore - 1.0);
              pronunciationScore = Math.max(3.0, pronunciationScore - 0.5);
              simulatedTranscript +=
                "Your response in Part 2 was significantly shorter than required, which limited the depth of your content.";
              fluencyDetails =
                "Struggled to speak for the required length (1-2 minutes), leading to significant hesitation, repetition, and underdeveloped ideas.";
              fluencySuggestions =
                "Practice developing topics at length for 1-2 minutes without significant pauses. Use your 1-minute preparation time effectively to brainstorm and structure your points.";
              generalComment = `Your response in Part 2 was too brief. Your estimated band score for this response is [OVERALL_BAND]. Focus on extending your answers.`;
            } else if (
              currentRecordingTime >= 60 &&
              currentRecordingTime < 90
            ) {
              // Acceptable but not optimal for Part 2
              fluencyScore = Math.min(9.0, fluencyScore + 1.0);
              lexicalScore = Math.min(9.0, lexicalScore + 0.8);
              grammarScore = Math.min(9.0, grammarScore + 0.8);
              simulatedTranscript +=
                "You spoke for an adequate time in Part 2, covering the main points. ";
              fluencyDetails =
                "Maintained a good pace throughout, with some minor hesitation. Ideas were generally clear and cohesive.";
              generalComment = `Good effort in Part 2! Your estimated band score is [OVERALL_BAND]. Aim to extend your talk closer to 2 minutes.`;
            } else if (
              currentRecordingTime >= 90 &&
              currentRecordingTime <= 120
            ) {
              // Ideal range for Part 2
              fluencyScore = Math.min(
                9.0,
                fluencyScore + 2.0 + Math.random() * 0.5
              );
              lexicalScore = Math.min(
                9.0,
                lexicalScore + 1.5 + Math.random() * 0.5
              );
              grammarScore = Math.min(
                9.0,
                grammarScore + 1.5 + Math.random() * 0.5
              );
              pronunciationScore = Math.min(
                9.0,
                pronunciationScore + 1.0 + Math.random() * 0.5
              );
              simulatedTranscript +=
                "You provided a well-developed response within the required time frame, demonstrating strong speaking ability.";
              fluencyDetails =
                "Spoke fluently and coherently for the full 1-2 minutes with natural pauses. Ideas were fully developed and well-organized, using a wide range of cohesive features.";
              lexicalDetails =
                "Used a wide range of vocabulary with naturalness and precision, including idiomatic expressions and effective paraphrasing.";
              grammarDetails =
                "Utilized a full range of complex grammatical structures with a high degree of accuracy and flexibility.";
              pronunciationDetails =
                "Consistently clear and intelligible, with excellent control of intonation, stress, and rhythm.";
              generalComment = `Outstanding! Your estimated band score for this response is [OVERALL_BAND]. You demonstrated excellent control across all IELTS criteria.`;
            } else if (currentRecordingTime > 120) {
              // Too long for Part 2
              fluencyScore = Math.max(
                5.0,
                fluencyScore - (currentRecordingTime - 120) * 0.05
              ); // Minor penalty for going too long
              simulatedTranscript +=
                "Your response extended beyond the 2-minute mark, suggesting some difficulty with managing time effectively.";
              fluencyDetails =
                "Spoke at length, though occasionally struggled with self-correction or maintaining focus, sometimes exceeding the time limit. Coherence could be improved by staying within the time frame.";
              fluencySuggestions =
                "Work on concise expression and effective time management within the 1-2 minute timeframe. Practice summarizing your points to conclude within the time limit.";
              generalComment = `Your response in Part 2 was a bit too long. Your estimated band score is [OVERALL_BAND]. Focus on concise expression.`;
            }
          }
        } else {
          // currentRecordingTime < MIN_RESPONSE_LENGTH_SECONDS - CRITICAL: No meaningful response
          fluencyScore = 0.0;
          lexicalScore = 0.0;
          grammarScore = 0.0;
          pronunciationScore = 0.0;
          generalComment =
            "You did not provide a sufficient response for assessment. Please speak into the microphone when prompted and aim to answer the question fully.";
          simulatedTranscript =
            "No discernible speech or response was recorded for this question.";
        }

        // Ensure scores are within 0-9 band and formatted to .5 increments (IELTS style)
        fluencyScore = roundToHalf(Math.min(9.0, Math.max(0.0, fluencyScore)));
        lexicalScore = roundToHalf(Math.min(9.0, Math.max(0.0, lexicalScore)));
        grammarScore = roundToHalf(Math.min(9.0, Math.max(0.0, grammarScore)));
        pronunciationScore = roundToHalf(
          Math.min(9.0, Math.max(0.0, pronunciationScore))
        );

        const overallScore =
          (parseFloat(fluencyScore) +
            parseFloat(lexicalScore) +
            parseFloat(grammarScore) +
            parseFloat(pronunciationScore)) /
          4;
        const finalOverallBand = roundToHalf(overallScore);

        // Replace placeholder in generalComment
        generalComment = generalComment.replace(
          "[OVERALL_BAND]",
          finalOverallBand
        );

        return {
          overallBand: parseFloat(finalOverallBand),
          criteria: {
            fluencyCoherence: {
              score: fluencyScore,
              details: fluencyDetails,
              suggestions: fluencySuggestions,
            },
            lexicalResource: {
              score: lexicalScore,
              details: lexicalDetails,
              suggestions: lexicalSuggestions,
            },
            grammaticalRangeAccuracy: {
              score: grammarScore,
              details: grammarDetails,
              suggestions: grammarSuggestions,
            },
            pronunciation: {
              score: pronunciationScore,
              details: pronunciationDetails,
              suggestions: pronunciationSuggestions,
            },
          },
          generalComment: generalComment,
          transcript: simulatedTranscript,
        };
      }

      /**
       * Resets all test-related state variables.
       */
      function resetTest() {
        question = "";
        isRecording = false;
        audioBlob = null;
        recordingTime = 0;
        clearInterval(timerId);
        timerId = null;
        if (mediaRecorder) {
          mediaRecorder.stream.getTracks().forEach((track) => track.stop());
        }
        mediaRecorder = null;
        audioChunks = [];
        feedback = null;
        isLoadingAI = false;
        hideResultsModal();
        cueCard = null;
        prepTime = 60;
        speakingTime = 120;
        part2ActiveTimer = "prep";
        currentPartQuestionCount = 0; // Reset question count for new part
        // Only reset totalTestTime if starting a brand new test from Intro
        if (currentPart === 0) {
          totalTestTime = 0;
          clearInterval(totalTestTimerId);
          totalTestTimerId = null;
        }
        renderContent(); // Re-render after state reset
      }

      /**
       * Custom message box function (replaces alert).
       * @param {string} title - The title of the message box.
       * @param {string} message - The message to display.
       */
      function showMessageBox(title, message) {
        const messageBoxHtml = `
                <div id="custom-message-box" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[999] overflow-y-auto">
                    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl max-w-sm w-full mx-auto transform transition-all duration-300 scale-100 opacity-100 border border-blue-200 text-center">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">${title}</h3>
                        <p class="text-md text-gray-700 mb-6">${message}</p>
                        <button id="message-box-ok-btn" class="bg-blue-500 text-white px-6 py-2 rounded-xl shadow-lg hover:bg-blue-600 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                            OK
                        </button>
                    </div>
                </div>
            `;
        document.body.insertAdjacentHTML("beforeend", messageBoxHtml);
        document.getElementById("message-box-ok-btn").onclick = () => {
          document.getElementById("custom-message-box").remove();
        };
      }

      /**
       * Handles advancing to the next part of the test.
       */
      async function handleNextPart() {
        if (currentPart < testParts.length - 1) {
          currentPart++;
          resetTest(); // Reset state for the new part, also calls renderContent
          renderContent(); // Ensure UI is updated immediately

          if (currentPart === 1) {
            // Part 1
            speakText("All right. Let's start with Part 1.");
            setTimeout(() => {
              const topic =
                testParts[currentPart].topics[
                  Math.floor(
                    Math.random() * testParts[currentPart].topics.length
                  )
                ];
              const initialQuestionPrompt = `As an IELTS examiner, ask a general question about "${topic}" suitable for IELTS Speaking Part 1. The question should be friendly and open-ended.`;
              generateExaminerQuestion(initialQuestionPrompt);
              startRecording(); // Start recording automatically for the response
            }, 1000); // Delay for examiner's intro
          } else if (currentPart === 2) {
            // Part 2
            speakText(testParts[currentPart].instructions);
            const randomIndex = Math.floor(
              Math.random() * testParts[currentPart].cueCards.length
            );
            cueCard = testParts[currentPart].cueCards[randomIndex];
            part2ActiveTimer = "prep";
            prepTime = 60; // Reset prep time
            renderContent(); // Show cue card and prep timer

            // Examiner reads cue card after instructions
            setTimeout(() => {
              speakText(
                `Here is your cue card. You have one minute to prepare. Your topic is: ${
                  cueCard.topic
                }. Please include: ${cueCard.points.join(
                  ", "
                )}. You can make some notes.`
              );
              const prepTimerInterval = setInterval(() => {
                prepTime--;
                renderContent();
                if (prepTime <= 0) {
                  clearInterval(prepTimerInterval);
                  // Start speaking time automatically after prep
                  part2ActiveTimer = "speaking";
                  speakingTime = 120; // Reset speaking time
                  renderContent();
                  speakText(
                    "Now, you have 1 to 2 minutes to talk about this topic. You can start speaking now."
                  );
                  startRecording(); // Start recording automatically
                  const speakingTimerInterval = setInterval(() => {
                    speakingTime--;
                    renderContent();
                    if (speakingTime <= 0) {
                      clearInterval(speakingTimerInterval);
                      stopRecording(); // Stop recording when speaking time is up
                      speakText("Thank you. That's the end of Part 2.");
                    }
                  }, 1000);
                  timerId = speakingTimerInterval; // Store speaking timer ID
                }
              }, 1000);
              timerId = prepTimerInterval; // Store prep timer ID
            }, 4000); // Delay after initial instructions
          } else if (currentPart === 3) {
            // Part 3
            speakText(
              testParts[currentPart].instructions.replace(
                "[Part 2 topic]",
                cueCard ? cueCard.topic : "the previous topic"
              )
            );
            setTimeout(() => {
              const initialQuestionPrompt = `As an IELTS examiner, ask a general discussion question related to "${
                cueCard ? cueCard.topic : "the previous topic"
              }". Make it abstract and encourage deeper discussion suitable for IELTS Speaking Part 3.`;
              generateExaminerQuestion(initialQuestionPrompt);
              startRecording(); // Start recording automatically for the response
            }, 2000);
          }
        } else {
          currentPart = 4; // Move to results/end screen
          stopRecording(); // Ensure recording is stopped if still active
          speakText("That concludes the speaking test. Thank you.");
          clearInterval(totalTestTimerId); // Stop overall test timer
          renderContent(); // Render final results
        }
      }

      /**
       * Handles advancing to the next question in Part 1 or Part 3.
       */
      async function handleNextQuestion() {
        stopRecording(); // Stop current recording before new question

        // Ensure there was sufficient speech before allowing next question
        if (recordingTime < MIN_RESPONSE_LENGTH_SECONDS) {
          showMessageBox(
            "Response Too Short",
            `Please speak for at least ${MIN_RESPONSE_LENGTH_SECONDS} seconds before moving to the next question.`
          );
          return; // Prevent advancing if response is too short
        }

        // Give some time for "AI processing" of the just-recorded answer
        isLoadingAI = true;
        renderContent();
        setTimeout(async () => {
          isLoadingAI = false;
          audioBlob = null; // Clear previous audio
          recordingTime = 0;

          if (currentPart === 1) {
            const topic =
              testParts[currentPart].topics[
                Math.floor(Math.random() * testParts[currentPart].topics.length)
              ];
            const prompt = `As an IELTS examiner, ask another general question about "${topic}" suitable for IELTS Speaking Part 1. Keep it concise.`;
            await generateExaminerQuestion(prompt);
            startRecording(); // Start recording automatically for the next question
          } else if (currentPart === 3) {
            const prompt = `As an IELTS examiner, ask another discussion question related to "${
              cueCard ? cueCard.topic : "the previous topic"
            }" for IELTS Speaking Part 3. It should prompt deeper analysis.`;
            await generateExaminerQuestion(prompt);
            startRecording(); // Start recording automatically for the next question
          }
          renderContent(); // Re-render with new question and recording state
        }, 1500); // Simulate processing time for previous answer
      }

      /**
       * Shows the feedback modal with the current feedback data.
       */
      function showResultsModal() {
        if (!feedback) {
          // If feedback is null, it means there wasn't enough recorded time
          showMessageBox(
            "No Feedback Available",
            "Please record a sufficient response before requesting feedback."
          );
          return;
        }
        feedbackModal.classList.remove("hidden");

        modalOverallBand.textContent = `Estimated Overall Band: ${feedback.overallBand}`;
        modalGeneralComment.textContent = feedback.generalComment;
        modalTranscript.textContent = feedback.transcript;

        // Clear previous criteria
        modalCriteria.innerHTML = "";
        // Populate criteria feedback
        for (const key in feedback.criteria) {
          const value = feedback.criteria[key];
          const div = document.createElement("div");
          div.className =
            "p-4 border border-gray-200 rounded-xl bg-gray-50 shadow-sm";
          const capitalizedKey = key.replace(/([A-Z])/g, " $1").trim();
          div.innerHTML = `
                    <p class="text-lg font-semibold text-gray-800 mb-1 capitalize">${capitalizedKey}: <span class="font-bold text-xl text-emerald-600">${value.score}</span></p>
                    <p class="text-sm text-gray-600 mb-1">Details: ${value.details}</p>
                    <p class="text-sm text-blue-600 italic">${value.suggestions}</p>
                `;
          modalCriteria.appendChild(div);
        }
      }

      /**
       * Hides the feedback modal.
       */
      function hideResultsModal() {
        feedbackModal.classList.add("hidden");
      }

      /**
       * Renders the current content based on `currentPart`.
       * This function acts like React's render function, dynamically updating the DOM.
       */
      function renderContent() {
        let htmlContent = "";
        switch (currentPart) {
          case 0: // Introduction
            htmlContent = `
                        <div class="text-center text-gray-700">
                            <p class="text-xl md:text-2xl font-semibold mb-4">${testParts[0].description}</p>
                            <p class="text-lg md:text-xl font-medium mb-8">${testParts[0].instructions}</p>
                            <button id="start-test-btn" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-8 py-3 rounded-xl shadow-lg hover:from-blue-600 hover:to-blue-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                                Start Test
                            </button>
                        </div>
                    `;
            break;
          case 1: // Part 1
          case 3: // Part 3
            const partName = testParts[currentPart].name;
            const isMinSpeechRequired = currentPart === 1 || currentPart === 3;
            const isNextQuestionDisabled =
              isLoadingAI ||
              isRecording ||
              (isMinSpeechRequired &&
                recordingTime < MIN_RESPONSE_LENGTH_SECONDS);
            const isEndFeedbackDisabled =
              !audioBlob ||
              isLoadingAI ||
              isRecording ||
              (isMinSpeechRequired &&
                recordingTime < MIN_RESPONSE_LENGTH_SECONDS);

            htmlContent = `
                        <div class="flex flex-col items-center w-full">
                            <p class="text-sm md:text-base text-blue-600 font-semibold mb-2">${partName}</p>
                            ${
                              isLoadingAI
                                ? `
                                <div class="flex items-center space-x-2 text-blue-500 mb-4 animate-pulse">
                                    <svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <span>Examiner thinking...</span>
                                </div>
                            `
                                : ""
                            }
                            <p class="text-xl md:text-2xl font-bold text-gray-800 mb-6 text-center">${question}</p>
                            ${
                              isRecording && isMinSpeechRequired
                                ? `
                                <p class="text-sm text-gray-500 mb-2">Speak for at least ${MIN_RESPONSE_LENGTH_SECONDS} seconds.</p>
                            `
                                : ""
                            }
                            <div class="flex items-center space-x-4 mb-8">
                                <button id="record-btn" class="flex items-center justify-center p-4 rounded-full shadow-lg transition-all duration-300
                                    ${
                                      isRecording
                                        ? "bg-red-500 hover:bg-red-600"
                                        : "bg-green-500 hover:bg-green-600"
                                    }">
                                    ${
                                      isRecording
                                        ? `
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7V5h4v2H8zm-1 3H7v3h6v-3h-1.5V7H8v3z" clip-rule="evenodd" />
                                        </svg>
                                    `
                                        : `
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" />
                                        </svg>
                                    `
                                    }
                                </button>
                                <span class="text-3xl font-mono text-gray-800">${formatTime(
                                  recordingTime
                                )}</span>
                            </div>

                            ${
                              audioBlob
                                ? `
                                <div class="flex items-center space-x-4 mb-8">
                                    <audio id="audio-playback" controls class="w-full max-w-sm rounded-lg shadow-inner"></audio>
                                    <button id="play-audio-btn" class="bg-blue-500 text-white p-2 rounded-full shadow-md hover:bg-blue-600 transition duration-300">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                </div>
                            `
                                : ""
                            }

                            <div class="flex space-x-4">
                                <button id="next-question-btn" class="bg-gradient-to-r from-purple-500 to-purple-600 text-white px-6 py-2 rounded-xl shadow-lg hover:from-purple-600 hover:to-purple-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-purple-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                    ${isNextQuestionDisabled ? "disabled" : ""}>
                                    Next Question
                                </button>
                                <button id="end-part${currentPart}-feedback-btn" class="bg-gradient-to-r from-indigo-500 to-indigo-600 text-white px-6 py-2 rounded-xl shadow-lg hover:from-indigo-600 hover:to-indigo-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                    ${isEndFeedbackDisabled ? "disabled" : ""}>
                                    End Part ${currentPart} & Get Feedback
                                </button>
                            </div>
                        </div>
                    `;
            break;
          case 2: // Part 2
            const isPart2FeedbackDisabled =
              speakingTime > 0 || isLoadingAI || isRecording;
            htmlContent = `
                        <div class="flex flex-col items-center w-full">
                            <p class="text-sm md:text-base text-blue-600 font-semibold mb-2">Part 2: Long Turn</p>
                            <p class="text-lg md:text-xl font-medium text-gray-700 mb-4">${
                              testParts[2].instructions
                            }</p>

                            ${
                              cueCard
                                ? `
                                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-6 max-w-lg w-full">
                                    <p class="text-xl font-semibold text-center text-gray-800 mb-3">${
                                      cueCard.topic
                                    }</p>
                                    <hr class="border-gray-200 my-3" />
                                    <p class="text-sm text-gray-600 mb-2">You should say:</p>
                                    <ul class="list-disc list-inside text-gray-700 mb-4">
                                        ${cueCard.points
                                          .map((point) => `<li>${point}</li>`)
                                          .join("")}
                                    </ul>
                                    <p class="text-sm text-gray-600 italic">And explain why...</p>
                                </div>
                            `
                                : ""
                            }

                            ${
                              part2ActiveTimer === "prep"
                                ? `
                                <>
                                    <p class="text-lg text-gray-700 mb-2">Preparation Time:</p>
                                    <span class="text-4xl font-mono text-blue-600 mb-6">${formatTime(
                                      prepTime
                                    )}</span>
                                    <p class="text-md text-gray-500">Make notes for 1 minute.</p>
                                </>
                            `
                                : `
                                <>
                                    <p class="text-lg text-gray-700 mb-2">Speaking Time:</p>
                                    <span class="text-4xl font-mono text-green-600 mb-6">${formatTime(
                                      speakingTime
                                    )}</span>
                                    ${
                                      isRecording
                                        ? `
                                        <div class="flex items-center space-x-2 text-green-500 mb-4 animate-pulse">
                                            <div class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div>
                                            <span>Recording...</span>
                                        </div>
                                    `
                                        : ""
                                    }
                                    <p class="text-md text-gray-500">Talk for 1 to 2 minutes.</p>
                                    ${
                                      audioBlob
                                        ? `
                                        <div class="flex items-center space-x-4 mt-6">
                                            <audio id="audio-playback" controls class="w-full max-w-sm rounded-lg shadow-inner"></audio>
                                            <button id="play-audio-btn" class="bg-blue-500 text-white p-2 rounded-full shadow-md hover:bg-blue-600 transition duration-300">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                                                </svg>
                                            </button>
                                        </div>
                                    `
                                        : ""
                                    }
                                </>
                            `
                            }
                            <button id="end-part2-feedback-btn" class="bg-gradient-to-r from-indigo-500 to-indigo-600 text-white px-6 py-2 rounded-xl shadow-lg hover:from-indigo-600 hover:to-indigo-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-300 mt-8 disabled:opacity-50 disabled:cursor-not-allowed"
                                ${isPart2FeedbackDisabled ? "disabled" : ""}>
                                End Part 2 & Get Feedback
                            </button>
                        </div>
                    `;
            break;
          case 4: // Results/End Screen
            htmlContent = `
                        <div class="text-center text-gray-700 w-full">
                            <p class="text-3xl font-bold mb-4 text-emerald-700">Test Completed!</p>
                            <p class="text-xl md:text-2xl font-semibold mb-6">Thank you for completing the IELTS Speaking Test simulation.</p>
                            <p class="text-lg md:text-xl font-medium mb-8">Total Test Duration: <span class="font-bold text-blue-700">${formatTime(
                              totalTestTime
                            )}</span></p>
                            ${
                              feedback
                                ? `
                                <div class="flex flex-col items-center">
                                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Overall Feedback:</h3>
                                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 max-w-2xl w-full text-left">
                                        <p class="text-xl font-bold text-center text-blue-700 mb-4">Estimated Overall Band: ${
                                          feedback.overallBand
                                        }</p>
                                        <p class="text-md text-gray-700 mb-4">${
                                          feedback.generalComment
                                        }</p>
                                        <h4 class="text-lg font-bold text-gray-700 mb-2">Detailed Breakdown:</h4>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                            ${Object.entries(feedback.criteria)
                                              .map(
                                                ([key, value]) => `
                                                <div class="p-3 border border-gray-100 rounded-lg bg-gray-50">
                                                    <p class="text-md font-semibold text-gray-800 capitalize">${key
                                                      .replace(
                                                        /([A-Z])/g,
                                                        " $1"
                                                      )
                                                      .trim()}: <span class="font-bold text-lg text-emerald-600">${
                                                  value.score
                                                }</span></p>
                                                    <p class="text-sm text-gray-600">Details: ${
                                                      value.details
                                                    }</p>
                                                    <p class="text-sm text-blue-600 italic">Suggestions: ${
                                                      value.suggestions
                                                    }</p>
                                                </div>
                                            `
                                              )
                                              .join("")}
                                        </div>
                                        <h4 class="text-lg font-bold text-gray-700 mb-2 mt-4">Simulated Transcript:</h4>
                                        <p class="text-sm text-gray-600 italic border p-3 rounded-lg bg-gray-50">${
                                          feedback.transcript
                                        }</p>
                                    </div>
                                </div>
                            `
                                : ""
                            }
                            <button id="restart-test-btn" class="bg-gradient-to-r from-emerald-500 to-emerald-600 text-white px-8 py-3 rounded-xl shadow-lg hover:from-emerald-600 hover:to-emerald-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-emerald-300 mt-10">
                                Restart Test
                            </button>
                        </div>
                    `;
            break;
        }
        contentArea.innerHTML = htmlContent;
        attachEventListeners(); // Re-attach event listeners after content updates
      }

      /**
       * Attaches event listeners to dynamically created elements.
       * This must be called after each `renderContent()` call.
       */
      function attachEventListeners() {
        const startTestBtn = document.getElementById("start-test-btn");
        if (startTestBtn) {
          startTestBtn.onclick = handleNextPart;
        }

        const recordBtn = document.getElementById("record-btn");
        if (recordBtn) {
          recordBtn.onclick = isRecording ? stopRecording : startRecording;
        }

        const playAudioBtn = document.getElementById("play-audio-btn");
        if (playAudioBtn) {
          playAudioBtn.onclick = playAudio;
        }

        const nextQuestionBtn = document.getElementById("next-question-btn");
        if (nextQuestionBtn) {
          // Disabled state is managed in renderContent HTML for direct control
          nextQuestionBtn.onclick = handleNextQuestion;
        }

        const endPartFeedbackBtn1 = document.getElementById(
          "end-part1-feedback-btn"
        );
        if (endPartFeedbackBtn1) {
          endPartFeedbackBtn1.onclick = () => {
            // Stop recording, then generate and show feedback
            stopRecording();
            setTimeout(() => {
              feedback = generateSimulatedFeedback(); // Ensure feedback is calculated
              showResultsModal();
            }, 500); // Small delay to allow stopRecording to complete
          };
        }
        const endPartFeedbackBtn2 = document.getElementById(
          "end-part2-feedback-btn"
        );
        if (endPartFeedbackBtn2) {
          endPartFeedbackBtn2.onclick = () => {
            stopRecording();
            setTimeout(() => {
              feedback = generateSimulatedFeedback();
              showResultsModal();
            }, 500);
          };
        }
        const endPartFeedbackBtn3 = document.getElementById(
          "end-part3-feedback-btn"
        );
        if (endPartFeedbackBtn3) {
          endPartFeedbackBtn3.onclick = () => {
            stopRecording();
            setTimeout(() => {
              feedback = generateSimulatedFeedback();
              showResultsModal();
            }, 500);
          };
        }

        const restartTestBtn = document.getElementById("restart-test-btn");
        if (restartTestBtn) {
          restartTestBtn.onclick = () => {
            currentPart = 0;
            resetTest(); // This calls renderContent internally
            // Re-initialize total test timer for a fresh start
            if (!totalTestTimerId) {
              totalTestTimerId = setInterval(() => {
                totalTestTime++;
                // No need to render total test time continuously, only when displayed
              }, 1000);
            }
            speakText(testParts[0].description);
            setTimeout(() => {
              speakText(testParts[0].instructions);
            }, 4000);
          };
        }

        // Modal buttons
        if (modalContinueBtn) {
          modalContinueBtn.onclick = () => {
            hideResultsModal();
            // Logic to advance based on current part
            if (currentPart === 1) {
              // After Part 1 feedback, move to Part 2
              handleNextPart();
            } else if (currentPart === 2) {
              // After Part 2 feedback, move to Part 3
              handleNextPart();
            } else if (currentPart === 3) {
              // After Part 3 feedback, move to final results
              handleNextPart();
            }
          };
        }
        if (modalEndTestBtn) {
          modalEndTestBtn.onclick = () => {
            hideResultsModal();
            currentPart = 4; // Force move to end screen
            stopRecording(); // Ensure recording is stopped
            clearInterval(totalTestTimerId); // Stop overall test timer
            renderContent(); // Render final results
            speakText("Test ended. Thank you for practicing!");
          };
        }
      }

      // --- Initial Setup on Window Load ---
      window.onload = () => {
        renderContent(); // Render the initial introduction screen

        // Start the total test time counter
        totalTestTimerId = setInterval(() => {
          totalTestTime++;
          // Auto-advance safeguards
          if (currentPart === 1 && totalTestTime >= testParts[1].duration) {
            stopRecording(); // Ensure recording is stopped if still active
            speakText(
              "That's the end of Part 1. Now, let's move on to Part 2."
            );
            isLoadingAI = true;
            renderContent();
            setTimeout(() => {
              feedback = generateSimulatedFeedback();
              showResultsModal();
              isLoadingAI = false;
              renderContent();
            }, 2000);
          } else if (
            currentPart === 3 &&
            totalTestTime >=
              testParts[3].duration +
                testParts[1].duration +
                testParts[2].duration
          ) {
            stopRecording(); // Ensure recording is stopped if still active
            speakText(
              "That concludes Part 3 and the speaking test. Thank you."
            );
            isLoadingAI = true;
            renderContent();
            setTimeout(() => {
              feedback = generateSimulatedFeedback();
              showResultsModal();
              isLoadingAI = false;
              renderContent();
            }, 2000);
          }
        }, 1000);

        // Initial examiner introduction speech
        speakText(testParts[0].description);
        setTimeout(() => {
          speakText(testParts[0].instructions);
        }, 4000);
      };
    </script>
  </body>
</html>
