<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upgrade to Pro - IELTS Mahir</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      #toast-container {
        position: fixed;
        top: 1.5rem;
        right: 1.5rem;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      .toast {
        display: flex;
        align-items: center;
        padding: 1rem 1.25rem;
        background-color: #2c3e50;
        color: white;
        border-radius: 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      }
      .toast.show {
        opacity: 1;
        transform: translateX(0);
      }
      .toast.success {
        background-color: #16a34a;
      }
      .toast.error {
        background-color: #dc2626;
      }
      .toast.info {
        background-color: #2563eb;
      }
      .toast i {
        margin-right: 0.75rem;
        font-size: 1.25rem;
      }
      .loader {
        border: 4px solid #e5e7eb;
        border-top: 4px solid #ef4444;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .payment-tab.active {
        border-color: #ef4444;
        background-color: #fee2e2;
        color: #b91c1c;
      }
      .faq-item[open] .faq-arrow {
        transform: rotate(180deg);
      }
    </style>
  </head>
  <body class="h-full antialiased">
    <div id="toast-container"></div>

    <div
      id="loader-container"
      class="flex flex-col items-center justify-center text-center"
    >
      <div class="loader"></div>
      <p class="mt-4 text-lg font-medium text-gray-600">
        Initializing your experience...
      </p>
    </div>

    <div
      id="login-required-container"
      class="hidden text-center max-w-lg p-10 bg-white shadow-xl rounded-2xl border border-gray-100"
    >
      <i class="fas fa-lock text-5xl text-red-500 mb-6"></i>
      <h1 class="text-3xl font-bold text-gray-800 mb-3">
        Authentication Required
      </h1>
      <p class="text-gray-600 mb-8">
        Please log in or create an account to view our pricing and upgrade to
        the Pro plan.
      </p>
      <div class="flex justify-center gap-4">
        <a
          href="/auth.html"
          class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-md"
        >
          Login or Sign Up
        </a>
      </div>
    </div>

    <main
      id="pricing-container"
      class="hidden w-full max-w-6xl mx-auto p-4 sm:p-6 lg:p-8"
    >
      <div class="text-center mb-16">
        <h1
          class="text-4xl font-extrabold text-gray-900 sm:text-5xl tracking-tight"
        >
          Unlock Your Full Potential
        </h1>
        <p class="mt-5 max-w-2xl mx-auto text-xl text-gray-600">
          Choose the Pro Plan for unlimited access to all AI features and
          accelerate your IELTS preparation.
        </p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 lg:gap-12 items-start">
        <!-- Left Column -->
        <div class="lg:col-span-2 space-y-8">
          <!-- Pro Plan Card -->
          <div
            class="bg-white p-8 rounded-2xl shadow-lg border border-gray-200 h-full flex flex-col"
          >
            <div class="flex justify-between items-center">
              <h2 class="text-3xl font-bold text-gray-900">Pro Plan</h2>
              <span
                class="bg-red-100 text-red-800 text-xs font-semibold px-3 py-1 rounded-full uppercase"
                >Lifetime</span
              >
            </div>
            <p class="mt-2 text-gray-500">Everything you need to succeed.</p>
            <p class="mt-6">
              <span class="text-5xl font-extrabold text-gray-900">৳500</span>
              <span class="text-base font-medium text-gray-500"
                >one-time payment</span
              >
            </p>
            <ul class="mt-8 space-y-4 text-gray-700 text-lg flex-grow">
              <li class="flex items-start">
                <i
                  class="fas fa-check-circle text-green-500 mr-3 mt-1.5 flex-shrink-0"
                ></i
                ><span>Unlimited Grammar Checks</span>
              </li>
              <li class="flex items-start">
                <i
                  class="fas fa-check-circle text-green-500 mr-3 mt-1.5 flex-shrink-0"
                ></i
                ><span>Unlimited Writing Assessments</span>
              </li>
              <li class="flex items-start">
                <i
                  class="fas fa-check-circle text-green-500 mr-3 mt-1.5 flex-shrink-0"
                ></i
                ><span>Unlimited Speaking Evaluations</span>
              </li>
              <li class="flex items-start">
                <i
                  class="fas fa-check-circle text-green-500 mr-3 mt-1.5 flex-shrink-0"
                ></i
                ><span>Priority Customer Support</span>
              </li>
              <li class="flex items-start">
                <i
                  class="fas fa-check-circle text-green-500 mr-3 mt-1.5 flex-shrink-0"
                ></i
                ><span>Access to All Future AI Tools</span>
              </li>
            </ul>
          </div>
          <!-- FAQ Section -->
          <div
            class="bg-white p-8 rounded-2xl shadow-lg border border-gray-200"
          >
            <h3 class="text-2xl font-bold text-gray-900 mb-6">
              Frequently Asked Questions
            </h3>
            <div class="space-y-4">
              <details class="faq-item group">
                <summary
                  class="flex justify-between items-center font-medium cursor-pointer list-none"
                >
                  <span>Is this a one-time payment?</span>
                  <span class="transition-transform duration-300 faq-arrow"
                    ><i class="fas fa-chevron-down"></i
                  ></span>
                </summary>
                <p class="text-gray-600 mt-3 group-open:animate-fadeIn">
                  Yes, the Pro Plan is a one-time payment that grants you
                  lifetime access to all current and future pro features. No
                  subscriptions, no hidden fees.
                </p>
              </details>
              <hr />
              <details class="faq-item group">
                <summary
                  class="flex justify-between items-center font-medium cursor-pointer list-none"
                >
                  <span>How long does verification take?</span>
                  <span class="transition-transform duration-300 faq-arrow"
                    ><i class="fas fa-chevron-down"></i
                  ></span>
                </summary>
                <p class="text-gray-600 mt-3 group-open:animate-fadeIn">
                  Our team manually verifies each transaction. Verification is
                  typically completed within 12-24 hours. You'll be notified
                  once your account is upgraded.
                </p>
              </details>
              <hr />
              <details class="faq-item group">
                <summary
                  class="flex justify-between items-center font-medium cursor-pointer list-none"
                >
                  <span>What if I enter the wrong Transaction ID?</span>
                  <span class="transition-transform duration-300 faq-arrow"
                    ><i class="fas fa-chevron-down"></i
                  ></span>
                </summary>
                <p class="text-gray-600 mt-3 group-open:animate-fadeIn">
                  Please double-check your Transaction ID before submitting. If
                  you make a mistake, please contact our support team through
                  the main website with your correct details.
                </p>
              </details>
            </div>
          </div>
        </div>

        <!-- Right Column -->
        <div class="lg:col-span-3">
          <!-- Payment Interface -->
          <div
            id="payment-section"
            class="bg-white p-8 rounded-2xl shadow-lg border border-gray-200"
          >
            <h3 class="text-2xl font-bold text-gray-900 mb-2">
              Complete Your Purchase
            </h3>
            <p class="text-gray-600 mb-6">
              Select a payment method and follow the steps.
            </p>

            <div id="payment-tabs" class="grid grid-cols-3 gap-2 mb-6">
              <button
                data-method="bKash"
                class="payment-tab active flex flex-col items-center p-3 border-2 rounded-lg transition-all duration-200"
              >
                <img
                  src="https://placehold.co/100x40/E2136E/white?text=bKash"
                  alt="bKash Logo"
                  class="h-8 mb-1"
                />
              </button>
              <button
                data-method="Nagad"
                class="payment-tab flex flex-col items-center p-3 border-2 rounded-lg transition-all duration-200"
              >
                <img
                  src="https://placehold.co/100x40/F6921E/white?text=Nagad"
                  alt="Nagad Logo"
                  class="h-8 mb-1"
                />
              </button>
              <button
                data-method="Rocket"
                class="payment-tab flex flex-col items-center p-3 border-2 rounded-lg transition-all duration-200"
              >
                <img
                  src="https://placehold.co/100x40/8A2BE2/white?text=Rocket"
                  alt="Rocket Logo"
                  class="h-8 mb-1"
                />
              </button>
            </div>

            <div id="payment-content">
              <!-- Content will be dynamically inserted here -->
            </div>
          </div>

          <!-- Status Messages -->
          <div id="status-message-section" class="hidden">
            <div
              id="pro-member-message"
              class="hidden bg-white p-8 rounded-2xl shadow-lg border-2 border-green-500 text-center"
            >
              <i
                class="fas fa-star text-6xl text-yellow-400 mb-5 animate-pulse"
              ></i>
              <h3 class="text-3xl font-bold text-gray-900">
                You are a Pro Member!
              </h3>
              <p class="mt-3 text-lg text-gray-600">
                You have unlimited access to all features. Thank you for your
                support and happy learning!
              </p>
            </div>
            <div
              id="pending-verification-message"
              class="hidden bg-white p-8 rounded-2xl shadow-lg border-2 border-blue-500 text-center"
            >
              <i
                class="fas fa-hourglass-half text-6xl text-blue-500 mb-5 animate-spin"
                style="animation-duration: 2s;"
              ></i>
              <h3 class="text-3xl font-bold text-gray-900">
                Verification Pending
              </h3>
              <p class="mt-3 text-lg text-gray-600">
                Your request is under review. This usually takes less than 24
                hours. We appreciate your patience!
              </p>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script type="module">
      import {
        getFirestore,
        doc,
        setDoc,
        serverTimestamp,
        getDocs,
        collection,
        query,
        where,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      import { initFirebaseAuth, authAppState, showToast } from "./auth.js";

      const paymentMethods = {
        bKash: {
          number: "01700000000",
          icon: "fas fa-mobile-alt text-pink-500",
        },
        Nagad: {
          number: "01800000000",
          icon: "fas fa-mobile-alt text-orange-500",
        },
        Rocket: {
          number: "01900000000",
          icon: "fas fa-rocket text-purple-500",
        },
      };

      function renderPaymentContent(method) {
        const contentContainer = document.getElementById("payment-content");
        const data = paymentMethods[method];
        if (!data) return;

        contentContainer.innerHTML = `
                <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                    <h4 class="font-bold text-lg text-gray-800 mb-4">Step 1: Send Money</h4>
                    <p class="text-gray-600 mb-4">Use the "Send Money" option in your ${method} app to send <strong>৳500</strong> to the following number:</p>
                    <div class="bg-white p-4 rounded-lg flex items-center justify-center text-center border">
                        <i class="${data.icon} text-2xl mr-4"></i>
                        <span class="text-2xl font-bold font-mono tracking-widest text-gray-800">${data.number}</span>
                    </div>
                     <p class="text-center text-sm text-gray-500 mt-2">Personal Account</p>
                </div>
                <div class="mt-6">
                    <h4 class="font-bold text-lg text-gray-800 mb-4">Step 2: Submit Verification</h4>
                     <p class="text-gray-600 mb-4">After payment, enter the <strong>Transaction ID</strong> from the confirmation message below and submit.</p>
                     <form id="payment-verification-form">
                        <input type="hidden" id="payment-method" value="${method}">
                        <div>
                            <label for="transaction-id" class="block text-sm font-medium text-gray-700">Transaction ID</label>
                            <input type="text" name="transaction-id" id="transaction-id" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 sm:text-lg" placeholder="e.g., 9A4B8C1D3E">
                        </div>
                        <button type="submit" id="submit-payment-btn" class="mt-6 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 flex items-center justify-center text-lg transform hover:scale-105 shadow-md">
                            <span id="submit-btn-text">Submit for Verification</span>
                            <div id="submit-btn-loader" class="loader hidden" style="height: 24px; width: 24px; border-width: 3px;"></div>
                        </button>
                    </form>
                </div>
            `;
        // Re-attach form listener after rendering new content
        attachFormListener();
      }

      function attachFormListener() {
        const paymentForm = document.getElementById(
          "payment-verification-form"
        );
        if (paymentForm) {
          paymentForm.addEventListener("submit", handleFormSubmit);
        }
      }

      function setupTabs() {
        const tabs = document.querySelectorAll(".payment-tab");
        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            tabs.forEach((t) => t.classList.remove("active"));
            tab.classList.add("active");
            renderPaymentContent(tab.dataset.method);
          });
        });
        // Initial render
        renderPaymentContent("bKash");
      }

      document.addEventListener("DOMContentLoaded", () => {
        initFirebaseAuth(handleAuthStateChange);
        setupTabs();
      });

      async function handleAuthStateChange(user) {
        const loaderContainer = document.getElementById("loader-container");
        const loginRequiredContainer = document.getElementById(
          "login-required-container"
        );
        const pricingContainer = document.getElementById("pricing-container");

        if (user) {
          pricingContainer.classList.remove("hidden");
          loginRequiredContainer.classList.add("hidden");
          await checkUserStatus();
        } else {
          loginRequiredContainer.classList.remove("hidden");
          pricingContainer.classList.add("hidden");
        }
        loaderContainer.classList.add("hidden");
      }

      async function checkUserStatus() {
        if (!authAppState.isAuthReady || !authAppState.userProfile) {
          console.log(
            "Auth not ready or profile not loaded. Will retry shortly."
          );
          setTimeout(checkUserStatus, 500); // Retry after a short delay
          return;
        }

        const paymentSection = document.getElementById("payment-section");
        const statusSection = document.getElementById("status-message-section");
        const proMessage = document.getElementById("pro-member-message");
        const pendingMessage = document.getElementById(
          "pending-verification-message"
        );

        if (authAppState.userProfile.role === "pro") {
          paymentSection.classList.add("hidden");
          statusSection.classList.remove("hidden");
          proMessage.classList.remove("hidden");
          pendingMessage.classList.add("hidden");
          return;
        }

        // NOTE: The following query requires Firestore security rules to allow a user to read their own verification documents.
        // If it fails, check that your rules for 'paymentVerifications' allow a `get` or `list` where request.auth.uid == resource.data.userId.
        const db = authAppState.db;
        const appId =
          typeof __app_id !== "undefined"
            ? __app_id
            : "ielts-mahir-community-forum";
        const verificationsRef = collection(
          db,
          `artifacts/${appId}/public/data/paymentVerifications`
        );
        const q = query(
          verificationsRef,
          where("userId", "==", authAppState.userId),
          where("status", "==", "pending")
        );

        try {
          const querySnapshot = await getDocs(q);
          if (!querySnapshot.empty) {
            paymentSection.classList.add("hidden");
            statusSection.classList.remove("hidden");
            pendingMessage.classList.remove("hidden");
            proMessage.classList.add("hidden");
          } else {
            paymentSection.classList.remove("hidden");
            statusSection.classList.add("hidden");
          }
        } catch (error) {
          console.error("Error checking for pending verifications:", error);
          showToast(
            `Could not check payment status. Please try again later.`,
            "error"
          );
          // Fallback to showing payment form if status check fails
          paymentSection.classList.remove("hidden");
          statusSection.classList.add("hidden");
        }
      }

      async function handleFormSubmit(e) {
        e.preventDefault();

        const submitBtn = document.getElementById("submit-payment-btn");
        const btnText = document.getElementById("submit-btn-text");
        const btnLoader = document.getElementById("submit-btn-loader");

        submitBtn.disabled = true;
        btnText.classList.add("hidden");
        btnLoader.classList.remove("hidden");

        const paymentMethod = document.getElementById("payment-method").value;
        const transactionId = document
          .getElementById("transaction-id")
          .value.trim();

        if (!transactionId) {
          showToast("Transaction ID cannot be empty.", "error");
          submitBtn.disabled = false;
          btnText.classList.remove("hidden");
          btnLoader.classList.add("hidden");
          return;
        }

        const db = authAppState.db;
        const appId =
          typeof __app_id !== "undefined"
            ? __app_id
            : "ielts-mahir-community-forum";

        try {
          const verificationRef = doc(
            collection(
              db,
              `artifacts/${appId}/public/data/paymentVerifications`
            )
          );

          await setDoc(verificationRef, {
            userId: authAppState.userId,
            userEmail: authAppState.userProfile.email,
            paymentMethod: paymentMethod,
            transactionId: transactionId,
            status: "pending",
            timestamp: serverTimestamp(),
          });

          showToast("Your request has been submitted successfully!", "success");
          e.target.reset();
          await checkUserStatus();
        } catch (error) {
          console.error("Error submitting verification:", error);
          showToast(`Submission failed: ${error.message}`, "error");
        } finally {
          submitBtn.disabled = false;
          btnText.classList.remove("hidden");
          btnLoader.classList.add("hidden");
        }
      }
    </script>
  </body>
</html>
