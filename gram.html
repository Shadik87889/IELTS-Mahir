<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IELTS Mahir - Advanced AI Assistant (Dark)</title>
    <!-- Inter Font - For a professional look -->
    <link rel="stylesheet" href="navigation-dark.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- Tailwind CSS Script - Always include this for Tailwind to work -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Custom styles for the scrollbar, to maintain consistency in dark theme */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #1f2937; /* A dark gray background for the scrollbar track */
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb {
        background: #4b5563; /* A medium gray for the scrollbar thumb */
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #6b7280; /* Lighter gray on hover */
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: #0c0d12; /* A slightly darker, richer background */
        color: #e2e8f0;
        position: relative;
        overflow-x: hidden;
      }

      /* Animated grid overlay for a high-tech feel */
      body::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: linear-gradient(
            rgba(141, 148, 163, 0.05) 1px,
            transparent 1px
          ),
          linear-gradient(90deg, rgba(141, 148, 163, 0.05) 1px, transparent 1px);
        background-size: 50px 50px;
        z-index: -1;
        opacity: 0.8;
        animation: move-grid 20s linear infinite;
      }

      @keyframes move-grid {
        from {
          background-position: 0 0;
        }
        to {
          background-position: 50px 50px;
        }
      }

      /* Specific styles for grammar highlighting on a dark background */
      .grammar-diff del {
        background-color: #450a0a; /* A dark red */
        color: #fca5a5; /* A light red */
        text-decoration: line-through;
        border-radius: 0.125rem; /* rounded-sm */
        padding: 0 0.125rem; /* px-0.5 */
      }
      .grammar-diff ins {
        background-color: #064e3b; /* A dark green */
        color: #a7f3d0; /* A light green */
        text-decoration: none; /* remove default underline */
        font-weight: 600; /* semi-bold to stand out */
        border-radius: 0.125rem; /* rounded-sm */
        padding: 0 0.125rem; /* px-0.5 */
      }
      .grammar-diff span {
        /* For unchanged text, ensure it doesn't get weird styling */
        color: inherit;
      }
      /* When mobile menu is active, prevent body scroll */
      body.menu-open {
        overflow: hidden;
      }
      body.menu-open .moving-products-text {
        display: none; /* Hide the element when the menu is open */
      }
      .hamburger-menu {
        margin-right: 5vw !important;
      }
      /* Toast Notifications */
      #toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .toast {
        background-color: #2d3748;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 10px;
        opacity: 0;
        transform: translateX(100%);
        transition: opacity 0.3s ease, transform 0.3s ease;
      }
      .toast.show {
        opacity: 1;
        transform: translateX(0);
      }
      .toast.success {
        border-left: 5px solid #48bb78;
      }
      .toast.error {
        border-left: 5px solid #f56565;
      }
      .toast.info {
        border-left: 5px solid #4299e1;
      }
      .toast i {
        font-size: 1.25rem;
      }

      @keyframes fade-in-scale {
        from {
          transform: scale(0.95);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
      .animate-fade-in-scale {
        animation: fade-in-scale 0.3s ease-out forwards;
      }
    </style>
  </head>
  <body class="font-inter">
    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- Initial Page Loader -->
    <div
      id="initial-loader"
      class="fixed inset-0 bg-gray-900 bg-opacity-80 flex flex-col items-center justify-center z-50"
    >
      <svg
        class="animate-spin h-14 w-14 text-indigo-400 mb-4"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"
        ></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
        ></path>
      </svg>
      <span class="text-xl text-gray-400 font-semibold"
        >Loading Your Profile...</span
      >
    </div>

    <!-- Upgrade Modal -->
    <div
      id="upgrade-modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-gray-800 rounded-2xl shadow-xl p-8 max-w-md w-full border border-gray-700 transform transition-all duration-300 animate-fade-in-scale"
      >
        <div class="text-center">
          <svg
            class="mx-auto h-16 w-16 text-yellow-400"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-3.355a.563.563 0 00-.586 0L6.982 21.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z"
            />
          </svg>
          <h3 class="mt-4 text-2xl font-bold text-white">
            Out of Free Credits
          </h3>
          <p class="mt-2 text-gray-400">
            You've used all your free credits. Upgrade to a Pro plan for
            unlimited access to all AI features!
          </p>
        </div>
        <div class="mt-8 flex justify-center gap-4">
          <button
            id="close-modal-btn"
            class="px-6 py-2.5 bg-gray-700 text-white font-semibold rounded-lg hover:bg-gray-600 transition-colors"
          >
            Maybe Later
          </button>
          <a
            href="pricing.html"
            class="px-6 py-2.5 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors shadow-lg"
            >Upgrade to Pro</a
          >
        </div>
      </div>
    </div>

    <nav>
      <div class="logo-ai-parent">
        <a href="home.html" class="logo">
          <img
            src="assets/278115481_106536582034386_7446598694214552893_n-removebg-preview.png"
            alt="Ielts mahir logo"
          />
        </a>
      </div>
      <div
        id="auth-buttons-container"
        class="auth-container flex items-center gap-4"
      >
        <!-- Credit status will be prepended here by ai-credit-system.js -->
        <!-- Profile Dropdown -->
        <div id="user-profile-container" class="relative hidden">
          <button
            id="user-profile-button"
            class="flex items-center gap-2 text-sm font-medium text-gray-300 hover:text-white transition"
          >
            <span id="user-profile-name">User Name</span>
            <svg
              class="w-4 h-4 text-gray-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"
              ></path>
            </svg>
          </button>
          <div
            id="user-profile-dropdown"
            class="absolute right-0 mt-2 w-48 bg-gray-800 border border-gray-700 rounded-lg shadow-lg z-20 hidden animate-fade-in-scale"
          >
            <div class="py-1">
              <a
                href="profile.html"
                class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white transition-colors"
                >My Profile</a
              >
              <div class="border-t border-gray-700 my-1"></div>
              <a
                href="#"
                id="sign-out-btn"
                class="block w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-red-500/10 hover:text-red-300 transition-colors"
                >Sign Out</a
              >
            </div>
          </div>
        </div>
      </div>
    </nav>
    <div
      id="main-container"
      class="min-h-screen mt-[-1.5vw] text-gray-200 flex flex-col items-center mt-[22vw] md:mt-[16vw] lg:mt-20 p-4 py-6 lg:py-4 hidden"
    >
      <!-- Main Content Area: Sidebar and Editor/Results -->
      <div
        class="flex flex-col lg:flex-row flex-grow w-full gap-6 md:gap-8 bg-gray-800 rounded-3xl overflow-hidden lg:py-[0] py-[0]"
      >
        <!-- Left Section: Sidebar for Feature Cards -->
        <aside
          class="w-full lg:w-[20vw] flex-shrink-0 bg-gray-800 rounded-tl-3xl rounded-bl-3xl p-6 md:p-8 lg:mt-3"
        >
          <h2
            class="text-2xl md:text-3xl font-bold text-gray-100 mb-5 text-center lg:text-left"
          >
            Features
          </h2>

          <!-- Feature Cards Grid inside Sidebar -->
          <div
            class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-1 xl:grid-cols-2 gap-3"
          >
            <!-- Grammar Card -->
            <button
              id="checkGrammarButton"
              class="feature-card flex flex-col items-center justify-center p-3 sm:p-4 bg-gray-900 text-gray-200 rounded-xl border border-gray-700 shadow-sm hover:bg-gray-700 hover:border-gray-600 transform hover:-translate-y-0.5 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-300 active:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
              data-feature="grammar"
              aria-live="polite"
            >
              <!-- Feather icon: File text -->
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="30"
                height="30"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="text-purple-400 mb-2"
              >
                <path
                  d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"
                ></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <line x1="10" y1="9" x2="8" y2="9"></line>
              </svg>
              <span
                class="text-sm sm:text-base font-semibold text-gray-200 text-center"
                >Grammar & Spell</span
              >
            </button>

            <!-- Summarize Card -->
            <button
              id="summarizeButton"
              class="feature-card flex flex-col items-center justify-center p-3 sm:p-4 bg-gray-900 text-gray-200 rounded-xl border border-gray-700 shadow-sm hover:bg-gray-700 hover:border-gray-600 transform hover:-translate-y-0.5 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-300 active:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
              data-feature="summarize"
              aria-live="polite"
            >
              <!-- Feather icon: Compress -->
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="30"
                height="30"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="text-indigo-400 mb-2"
              >
                <path d="M8 3H4a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h4"></path>
                <path d="M16 21h4a2 2 0 0 0 2-2v-4a2 2 0 0 0-2-2h-4"></path>
                <line x1="12" y1="12" x2="18" y2="18"></line>
                <line x1="6" y1="6" x2="12" y2="12"></line>
              </svg>
              <span
                class="text-sm sm:text-base font-semibold text-gray-200 text-center"
                >Summarize Text</span
              >
            </button>

            <!-- Tone Analysis Card -->
            <button
              id="analyzeToneButton"
              class="feature-card flex flex-col items-center justify-center p-3 sm:p-4 bg-gray-900 text-gray-200 rounded-xl border border-gray-700 shadow-sm hover:bg-gray-700 hover:border-gray-600 transform hover:-translate-y-0.5 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-300 active:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
              data-feature="tone"
              aria-live="polite"
            >
              <!-- Feather icon: Heart / Mood -->
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="30"
                height="30"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="text-green-400 mb-2"
              >
                <path
                  d="M12 21.35l-1.45-1.32C5.4 14.07 2 10.15 2 7.5A4.5 4.5 0 0 1 6.5 3a4.5 4.5 0 0 1 4.5 4.5c0 .32-.03.62-.09.91L12 9.07l.09-.91c-.06-.29-.09-.59-.09-.91A4.5 4.5 0 0 1 17.5 3a4.5 4.5 0 0 1 4.5 4.5c0 2.65-3.4 6.57-8.55 11.53L12 21.35z"
                ></path>
              </svg>
              <span
                class="text-sm sm:text-base font-semibold text-gray-200 text-center"
                >Analyze Tone</span
              >
            </button>

            <!-- Paraphrase Card -->
            <button
              id="paraphraseButton"
              class="feature-card flex flex-col items-center justify-center p-3 sm:p-4 bg-gray-900 text-gray-200 rounded-xl border border-gray-700 shadow-sm hover:bg-gray-700 hover:border-gray-600 transform hover:-translate-y-0.5 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-300 active:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
              data-feature="paraphrase"
              aria-live="polite"
            >
              <!-- Feather icon: Repeat -->
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="30"
                height="30"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="text-purple-400 mb-2"
              >
                <polyline points="17 1 21 5 17 9"></polyline>
                <path d="M21 5H3a2 2 0 0 0-2 2v2"></path>
                <polyline points="7 23 3 19 7 15"></polyline>
                <path d="M3 19h18a2 2 0 0 0 2-2v-2"></path>
              </svg>
              <span
                class="text-sm sm:text-base font-semibold text-gray-200 text-center"
                >Paraphrase</span
              >
            </button>

            <!-- Keywords Card -->
            <button
              id="keywordsButton"
              class="feature-card flex flex-col items-center justify-center p-3 sm:p-4 bg-gray-900 text-gray-200 rounded-xl border border-gray-700 shadow-sm hover:bg-gray-700 hover:border-gray-600 transform hover:-translate-y-0.5 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-300 active:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
              data-feature="keywords"
              aria-live="polite"
            >
              <!-- Feather icon: Tag -->
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="30"
                height="30"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="text-blue-400 mb-2"
              >
                <path
                  d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"
                ></path>
                <line x1="7" y1="7" x2="7.01" y2="7"></line>
              </svg>
              <span
                class="text-sm sm:text-base font-semibold text-gray-200 text-center"
                >Extract Keywords</span
              >
            </button>

            <!-- Readability Card -->
            <button
              id="readabilityButton"
              class="feature-card flex flex-col items-center justify-center p-3 sm:p-4 bg-gray-900 text-gray-200 rounded-xl border border-gray-700 shadow-sm hover:bg-gray-700 hover:border-gray-600 transform hover:-translate-y-0.5 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-300 active:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
              data-feature="readability"
              aria-live="polite"
            >
              <!-- Feather icon: Book Open -->
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="30"
                height="30"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="text-orange-400 mb-2"
              >
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
              </svg>
              <span
                class="text-sm sm:text-base font-semibold text-gray-200 text-center"
                >Readability</span
              >
            </button>

            <!-- Conciseness Card -->
            <button
              style="display: ;"
              id="concisenessButton"
              class="feature-card flex flex-col items-center justify-center p-3 sm:p-4 bg-gray-900 text-gray-200 rounded-xl border border-gray-700 shadow-sm hover:bg-gray-700 hover:border-gray-600 transform hover:-translate-y-0.5 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-300 active:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
              data-feature="conciseness"
              aria-live="polite"
            >
              <!-- Feather icon: Scissors -->
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="30"
                height="30"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="text-red-400 mb-2"
              >
                <circle cx="6" cy="7" r="3"></circle>
                <circle cx="6" cy="17" r="3"></circle>
                <line x1="10" y1="12" x2="18" y2="12"></line>
                <line x1="21" y1="7" x2="18" y2="10"></line>
                <line x1="21" y1="17" x2="18" y2="14"></line>
              </svg>
              <span
                class="text-sm sm:text-base font-semibold text-gray-200 text-center"
                >Conciseness</span
              >
            </button>

            <!-- Clear All Button (as a distinct card) -->
            <button
              id="clearAllButton"
              class="col-span-full feature-card flex flex-col items-center justify-center p-3 sm:p-4 bg-gray-700 text-gray-200 rounded-xl border border-gray-600 shadow-sm hover:bg-gray-600 transform hover:-translate-y-0.5 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500"
            >
              <!-- Feather icon: Trash Can -->
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="30"
                height="30"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="text-gray-400 mb-2"
              >
                <path d="M3 6h18"></path>
                <path
                  d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                ></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
              </svg>
              <span
                class="text-sm sm:text-base font-semibold text-gray-200 text-center"
                >Clear All</span
              >
            </button>
          </div>
        </aside>

        <!-- Right Section: Input & Output Areas -->
        <main
          class="flex-1 flex flex-col lg:flex-row gap-6 md:gap-8 bg-gray-800 p-6 md:p-10"
        >
          <!-- Left Sub-Section: Input Area -->
          <div class="flex-1 flex flex-col">
            <h2
              class="text-2xl md:text-3xl font-bold text-gray-100 mb-5 text-center lg:text-left"
            >
              Input Your Text
            </h2>

            <div class="mb-4 flex-grow">
              <textarea
                id="inputText"
                class="w-full h-[28rem] md:h-[36rem] p-4 border border-gray-700 bg-gray-900 rounded-xl focus:ring-4 focus:ring-indigo-600 focus:border-indigo-600 transition-all duration-200 resize-none text-base md:text-lg text-gray-200 shadow-sm placeholder-gray-500"
                placeholder="Paste your text here to get started..."
                aria-label="Text input for writing assistant features"
              ></textarea>
            </div>

            <!-- Text Statistics -->
            <div class="flex justify-between text-sm text-gray-400 mb-6 px-1">
              <span id="wordCount">Words: 0</span>
              <span id="charCount">Characters: 0</span>
            </div>
          </div>

          <!-- Right Sub-Section: Output Area -->
          <div class="flex-1 mt-8 lg:mt-0 flex flex-col">
            <h2
              class="text-2xl md:text-3xl font-bold text-gray-100 mb-5 text-center lg:text-left"
            >
              Results
            </h2>

            <p
              id="errorMessage"
              class="mb-4 text-red-400 text-center lg:text-left font-medium hidden px-1"
              role="alert"
            ></p>

            <!-- Loading Spinner Container (centralized) -->
            <div
              id="loadingContainer"
              class="flex-grow flex flex-col items-center justify-center bg-gray-900 rounded-xl border border-gray-700 shadow-inner hidden"
            >
              <svg
                class="animate-spin h-14 w-14 text-indigo-400 mb-4"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
              >
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"
                ></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
              <span class="text-xl text-gray-400 font-semibold" id="loadingText"
                >Processing...</span
              >
            </div>

            <!-- Output Sections (initially all hidden except default placeholder) -->
            <div
              id="outputContainer"
              class="flex-grow relative bg-gray-900 p-5 h-[340px] md:min-h-[320px] lg:min-h-[400px] border border-gray-700 rounded-xl text-base md:text-lg text-gray-200 shadow-inner overflow-auto"
            >
              <p
                id="generalPlaceholderText"
                class="text-gray-500 italic text-center py-5"
              >
                Select a feature to see the results here.
              </p>

              <!-- Grammar Correction Output -->
              <div id="grammarOutput" class="output-section hidden">
                <h3 class="text-xl font-bold text-gray-100 mb-3">
                  Refined Text
                </h3>
                <!-- Corrected text will be inserted here with highlighting -->
                <div
                  id="correctedText"
                  class="whitespace-pre-wrap grammar-diff leading-relaxed"
                ></div>
                <p
                  class="feature-error-message mt-2 text-red-400 font-medium hidden"
                ></p>
              </div>

              <!-- Summarizer Output -->
              <div id="summarizerOutput" class="output-section hidden">
                <h3 class="text-xl font-bold text-gray-100 mb-3">Summary</h3>
                <p
                  id="summarizedText"
                  class="whitespace-pre-wrap leading-relaxed"
                ></p>
                <p
                  class="feature-error-message mt-2 text-red-400 font-medium hidden"
                ></p>
              </div>

              <!-- Tone Analysis Output -->
              <div id="toneOutput" class="output-section hidden">
                <h3 class="text-xl font-bold text-gray-100 mb-3">
                  Tone Analysis
                </h3>
                <p
                  id="analyzedTone"
                  class="whitespace-pre-wrap leading-relaxed"
                ></p>
                <p
                  class="feature-error-message mt-2 text-red-400 font-medium hidden"
                ></p>
              </div>

              <!-- Paraphrase Output -->
              <div id="paraphraseOutput" class="output-section hidden">
                <h3 class="text-xl font-bold text-gray-100 mb-3">
                  Paraphrased Text
                </h3>
                <p
                  id="paraphrasedText"
                  class="whitespace-pre-wrap leading-relaxed"
                ></p>
                <p
                  class="feature-error-message mt-2 text-red-400 font-medium hidden"
                ></p>
              </div>

              <!-- Keywords Output -->
              <div id="keywordsOutput" class="output-section hidden">
                <h3 class="text-xl font-bold text-gray-100 mb-3">Keywords</h3>
                <p
                  id="extractedKeywords"
                  class="whitespace-pre-wrap leading-relaxed"
                ></p>
                <p
                  class="feature-error-message mt-2 text-red-400 font-medium hidden"
                ></p>
              </div>

              <!-- Readability Output -->
              <div id="readabilityOutput" class="output-section hidden">
                <h3 class="text-xl font-bold text-gray-100 mb-3">
                  Readability Assessment
                </h3>
                <p
                  id="readabilityAssessment"
                  class="whitespace-pre-wrap leading-relaxed"
                ></p>
                <p
                  class="feature-error-message mt-2 text-red-400 font-medium hidden"
                ></p>
              </div>

              <!-- Conciseness Output -->
              <div id="concisenessOutput" class="output-section hidden">
                <h3 class="text-xl font-bold text-gray-100 mb-3">
                  Conciseness Suggestions
                </h3>
                <p
                  id="concisenessSuggestions"
                  class="whitespace-pre-wrap leading-relaxed"
                ></p>
                <p
                  class="feature-error-message mt-2 text-red-400 font-medium hidden"
                ></p>
              </div>
            </div>

            <!-- Copy Button (Conditionally visible) -->
            <div
              id="copyButtonContainer"
              class="mt-6 flex justify-center lg:justify-end hidden"
            >
              <button
                id="copyToClipboardButton"
                class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl border border-indigo-600 shadow-sm hover:bg-indigo-700 hover:border-indigo-700 transition-colors duration-200 flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 transform hover:scale-[1.02] active:scale-[0.98]"
                aria-label="Copy result to clipboard"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                  stroke="currentColor"
                  class="w-6 h-6"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75m11.25 0H16.5a2.25 2.25 0 00-2.25 2.25v2.25M15 1.5V5.25m4.5 9.75v-4.5m-1.5 1.5h.75m-7.5 0v-4.5m1.5 1.5h.75m7.5 0l-.75 2.25m-3.75 0L12 18l-.75 2.25"
                  />
                </svg>
                <span id="copyButtonText">Copy Result</span>
              </button>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script type="module">
      import { aiCreditSystem } from "./ai-credit-system.js";
      import { authAppState, signOutUser } from "./auth.js";

      document.addEventListener("DOMContentLoaded", () => {
        // Get references to DOM elements from the user's script
        const inputTextarea = document.getElementById("inputText");
        const checkGrammarBtn = document.getElementById("checkGrammarButton");
        const summarizeButton = document.getElementById("summarizeButton");
        const analyzeToneButton = document.getElementById("analyzeToneButton");
        const paraphraseButton = document.getElementById("paraphraseButton");
        const keywordsButton = document.getElementById("keywordsButton");
        const readabilityButton = document.getElementById("readabilityButton");
        const concisenessButton = document.getElementById("concisenessButton");
        const clearAllButton = document.getElementById("clearAllButton");

        const loadingContainer = document.getElementById("loadingContainer");
        const loadingText = document.getElementById("loadingText");
        const errorMessage = document.getElementById("errorMessage");

        const outputContainer = document.getElementById("outputContainer");
        const generalPlaceholderText = document.getElementById(
          "generalPlaceholderText"
        );

        const featureOutputs = {
          grammar: {
            container: document.getElementById("grammarOutput"),
            content: document.getElementById("correctedText"),
          },
          summarize: {
            container: document.getElementById("summarizerOutput"),
            content: document.getElementById("summarizedText"),
          },
          tone: {
            container: document.getElementById("toneOutput"),
            content: document.getElementById("analyzedTone"),
          },
          paraphrase: {
            container: document.getElementById("paraphraseOutput"),
            content: document.getElementById("paraphrasedText"),
          },
          keywords: {
            container: document.getElementById("keywordsOutput"),
            content: document.getElementById("extractedKeywords"),
          },
          readability: {
            container: document.getElementById("readabilityOutput"),
            content: document.getElementById("readabilityAssessment"),
          },
          conciseness: {
            container: document.getElementById("concisenessOutput"),
            content: document.getElementById("concisenessSuggestions"),
          },
        };

        const copyButtonContainer = document.getElementById(
          "copyButtonContainer"
        );
        const copyToClipboardBtn = document.getElementById(
          "copyToClipboardButton"
        );
        const copyButtonText = document.getElementById("copyButtonText");

        const wordCountSpan = document.getElementById("wordCount");
        const charCountSpan = document.getElementById("charCount");
        const mainContainer = document.getElementById("main-container");

        // Profile UI Elements
        const userProfileContainer = document.getElementById(
          "user-profile-container"
        );
        const userProfileButton = document.getElementById(
          "user-profile-button"
        );
        const userProfileName = document.getElementById("user-profile-name");
        const userProfileDropdown = document.getElementById(
          "user-profile-dropdown"
        );
        const signOutBtn = document.getElementById("sign-out-btn");

        let currentActiveFeature = null;
        let currentResultText = "";

        // --- Profile and Auth System Setup ---
        const updateProfileUI = () => {
          if (authAppState.userProfile && authAppState.isAuthReady) {
            userProfileName.textContent =
              authAppState.userProfile.name || "User";
            userProfileContainer.classList.remove("hidden");
          } else {
            userProfileContainer.classList.add("hidden");
          }
        };

        userProfileButton.addEventListener("click", (e) => {
          e.stopPropagation();
          userProfileDropdown.classList.toggle("hidden");
        });

        document.addEventListener("click", (e) => {
          if (
            !userProfileContainer.contains(e.target) &&
            !userProfileDropdown.classList.contains("hidden")
          ) {
            userProfileDropdown.classList.add("hidden");
          }
        });

        signOutBtn.addEventListener("click", async (e) => {
          e.preventDefault();
          await signOutUser();
        });

        const onAccessGranted = () => {
          mainContainer.classList.remove("hidden");
          updateProfileUI();
        };

        aiCreditSystem.initialize(onAccessGranted);

        // --- Application Logic (from user's script) ---
        const updateCounts = () => {
          const text = inputTextarea.value;
          const words =
            text.trim() === "" ? 0 : text.trim().split(/\s+/).length;
          const chars = text.length;
          wordCountSpan.textContent = `Words: ${words}`;
          charCountSpan.textContent = `Characters: ${chars}`;
        };

        const setLoadingState = (isLoading, featureName = "Processing") => {
          const featureButtons = document.querySelectorAll(".feature-card");
          featureButtons.forEach((button) => {
            button.disabled = isLoading;
          });
          clearAllButton.disabled = isLoading;

          if (isLoading) {
            loadingContainer.classList.remove("hidden");
            loadingText.textContent = `${featureName}...`;
            outputContainer.classList.add("hidden");
            copyButtonContainer.classList.add("hidden");
            generalPlaceholderText.classList.add("hidden");
          } else {
            loadingContainer.classList.add("hidden");
            outputContainer.classList.remove("hidden");
          }
        };

        const displayGeneralMessage = (message, duration = 0) => {
          errorMessage.textContent = message;
          errorMessage.classList.remove("hidden");
          if (duration > 0) {
            setTimeout(() => {
              errorMessage.classList.add("hidden");
              errorMessage.textContent = "";
            }, duration);
          }
        };

        const displayFeatureError = (featureId, message) => {
          const outputSection = featureOutputs[featureId].container;
          const errorMessageElement = outputSection.querySelector(
            ".feature-error-message"
          );
          if (errorMessageElement) {
            errorMessageElement.textContent = message;
            errorMessageElement.classList.remove("hidden");
          }
          featureOutputs[featureId].content.innerHTML = "";
        };

        const clearMessages = () => {
          errorMessage.classList.add("hidden");
          errorMessage.textContent = "";
          document.querySelectorAll(".feature-error-message").forEach((el) => {
            el.classList.add("hidden");
            el.textContent = "";
          });
        };

        const activateFeatureOutput = (feature) => {
          document.querySelectorAll(".feature-card").forEach((card) => {
            card.classList.remove(
              "ring-2",
              "ring-indigo-500",
              "border-indigo-500",
              "bg-indigo-50"
            );
            card.classList.add("bg-gray-900", "border-gray-700");
            if (card.id === "clearAllButton") {
              card.classList.add("bg-gray-700", "border-gray-600");
              card.classList.remove("bg-gray-900", "border-gray-700");
            }
          });

          Object.values(featureOutputs).forEach((item) => {
            item.container.classList.add("hidden");
            item.container
              .querySelector(".feature-error-message")
              .classList.add("hidden");
          });
          generalPlaceholderText.classList.add("hidden");

          if (feature && featureOutputs[feature]) {
            featureOutputs[feature].container.classList.remove("hidden");
            const selectedButton = document.querySelector(
              `.feature-card[data-feature="${feature}"]`
            );
            if (selectedButton) {
              selectedButton.classList.add(
                "ring-2",
                "ring-indigo-500",
                "border-indigo-500"
              );
              selectedButton.classList.remove("bg-gray-900", "border-gray-700");
              selectedButton.classList.add("bg-gray-700", "border-gray-600");
            }
          } else {
            generalPlaceholderText.classList.remove("hidden");
          }
          currentActiveFeature = feature;

          if (currentResultText && feature) {
            copyButtonContainer.classList.remove("hidden");
          } else {
            copyButtonContainer.classList.add("hidden");
          }
          copyButtonText.textContent = "Copy Result";
        };

        clearAllButton.addEventListener("click", () => {
          inputTextarea.value = "";
          Object.values(featureOutputs).forEach(
            (item) => (item.content.innerHTML = "")
          );
          currentResultText = "";
          updateCounts();
          clearMessages();
          generalPlaceholderText.classList.remove("hidden");
          copyButtonContainer.classList.add("hidden");
          activateFeatureOutput(null);
          setLoadingState(false);
        });

        inputTextarea.addEventListener("input", () => {
          clearMessages();
          updateCounts();
          currentResultText = "";
          copyButtonContainer.classList.add("hidden");
          Object.values(featureOutputs).forEach(
            (item) => (item.content.innerHTML = "")
          );
          if (inputTextarea.value.trim() === "") {
            activateFeatureOutput(null);
          } else {
            if (currentActiveFeature && featureOutputs[currentActiveFeature]) {
              activateFeatureOutput(currentActiveFeature);
            } else {
              generalPlaceholderText.classList.remove("hidden");
              outputContainer.classList.remove("hidden");
            }
          }
        });

        const callGeminiAPI = async (prompt) => {
          const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
          const payload = { contents: chatHistory };
          const apiKey = "AIzaSyCsdeFOJrU43BZmnRP5WD1pm80fZH1cxN4";
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            let errorDetails = `Status: ${response.status} - ${response.statusText}.`;
            try {
              const errorJson = await response.json();
              errorDetails += ` Details: ${
                errorJson.error?.message || JSON.stringify(errorJson, null, 2)
              }`;
            } catch (jsonParseError) {
              try {
                const rawText = await response.text();
                if (rawText.trim()) {
                  errorDetails += ` Raw Response: ${rawText.substring(
                    0,
                    200
                  )}...`;
                } else {
                  errorDetails +=
                    " No specific error message provided by the API body.";
                }
              } catch (readTextError) {
                errorDetails += " Failed to read response body.";
              }
            }
            throw new Error(`API request failed. ${errorDetails}`);
          }

          const result = await response.json();
          if (result?.candidates?.[0]?.content?.parts?.[0]?.text) {
            return result.candidates[0].content.parts[0].text;
          } else {
            console.log(
              "Unexpected API response structure or empty content:",
              result
            );
            throw new Error(
              "AI did not return expected content. This might happen with very short or ambiguous inputs."
            );
          }
        };

        function highlightDifferences(originalText, correctedText) {
          const splitRegex = /(\s+|[.,!?;:()"])/g;
          const wordsOriginal = originalText
            .split(splitRegex)
            .filter((s) => s.trim() !== "");
          const wordsCorrected = correctedText
            .split(splitRegex)
            .filter((s) => s.trim() !== "");
          let html = "";
          let origIdx = 0;
          let corrIdx = 0;

          while (
            origIdx < wordsOriginal.length ||
            corrIdx < wordsCorrected.length
          ) {
            const originalWord = wordsOriginal[origIdx];
            const correctedWord = wordsCorrected[corrIdx];

            if (originalWord === correctedWord) {
              html += `<span>${originalWord}</span>`;
              origIdx++;
              corrIdx++;
            } else {
              let foundMatchInCorrected = false;
              let foundMatchInOriginal = false;
              let lookAheadCorrIdx = corrIdx;
              while (lookAheadCorrIdx < wordsCorrected.length) {
                if (wordsCorrected[lookAheadCorrIdx] === originalWord) {
                  foundMatchInCorrected = true;
                  break;
                }
                lookAheadCorrIdx++;
              }
              let lookAheadOrigIdx = origIdx;
              while (lookAheadOrigIdx < wordsOriginal.length) {
                if (wordsOriginal[lookAheadOrigIdx] === correctedWord) {
                  foundMatchInOriginal = true;
                  break;
                }
                lookAheadOrigIdx++;
              }

              if (foundMatchInCorrected && !foundMatchInOriginal) {
                html += `<ins class="bg-green-900/50 text-green-400 px-0.5 rounded">${correctedWord}</ins>`;
                corrIdx++;
              } else if (foundMatchInOriginal && !foundMatchInCorrected) {
                html += `<del class="bg-red-900/50 text-red-400 line-through px-0.5 rounded">${originalWord}</del>`;
                origIdx++;
              } else if (
                originalWord !== undefined &&
                correctedWord !== undefined
              ) {
                html += `<del class="bg-red-900/50 text-red-400 line-through px-0.5 rounded">${originalWord}</del>`;
                html += `<ins class="bg-green-900/50 text-green-400 px-0.5 rounded">${correctedWord}</ins>`;
                origIdx++;
                corrIdx++;
              } else if (originalWord !== undefined) {
                html += `<del class="bg-red-900/50 text-red-400 line-through px-0.5 rounded">${originalWord}</del>`;
                origIdx++;
              } else if (correctedWord !== undefined) {
                html += `<ins class="bg-green-900/50 text-green-400 px-0.5 rounded">${correctedWord}</ins>`;
                corrIdx++;
              }
            }
            if (
              (origIdx < wordsOriginal.length ||
                corrIdx < wordsCorrected.length) &&
              !splitRegex.test(wordsOriginal[origIdx - 1] || "") &&
              !splitRegex.test(wordsCorrected[corrIdx - 1] || "") &&
              !splitRegex.test(wordsOriginal[origIdx] || "") &&
              !splitRegex.test(wordsCorrected[corrIdx] || "")
            ) {
              html += " ";
            } else if (
              splitRegex.test(wordsOriginal[origIdx - 1] || "") ||
              splitRegex.test(wordsCorrected[corrIdx - 1] || "")
            ) {
              if (
                splitRegex.test(wordsOriginal[origIdx] || "") ||
                splitRegex.test(wordsCorrected[corrIdx] || "")
              ) {
                // No space if next is also punctuation
              } else if (html.length > 0 && !html.endsWith(" ")) {
                html += " ";
              }
            }
          }
          return html.replace(/\s+/g, " ").trim();
        }

        const handleFeatureRequest = async (
          featureId,
          loadingMsg,
          promptFunc,
          outputElement,
          errorPlaceholderText
        ) => {
          // *** INTEGRATION: Check for credits before proceeding ***
          const hasAccess = await aiCreditSystem.requestAccess();
          if (!hasAccess) {
            return; // Stop if user has no access or cancelled the upgrade
          }

          const originalInputText = inputTextarea.value.trim();
          if (!originalInputText) {
            displayGeneralMessage(
              "Please enter some text to use this feature."
            );
            return;
          }

          setLoadingState(true, loadingMsg);
          clearMessages();
          outputElement.innerHTML = "";
          currentResultText = "";
          copyButtonContainer.classList.add("hidden");

          try {
            activateFeatureOutput(featureId);
            const prompt = promptFunc(originalInputText);
            const result = await callGeminiAPI(prompt);

            if (featureId === "grammar") {
              outputElement.innerHTML = highlightDifferences(
                originalInputText,
                result
              );
            } else {
              outputElement.textContent = result;
            }

            currentResultText = result;
            copyButtonContainer.classList.remove("hidden");
          } catch (err) {
            console.error(`Error with ${featureId} feature:`, err);
            displayFeatureError(
              featureId,
              `Error: ${err.message}. ${errorPlaceholderText}`
            );
            outputElement.innerHTML = "";
          } finally {
            setLoadingState(false);
          }
        };

        // Event Listeners for each feature button
        checkGrammarBtn.addEventListener("click", () => {
          handleFeatureRequest(
            "grammar",
            "Checking Grammar",
            (text) => `Please correct the grammar and spelling...`, // (prompt from user script)
            featureOutputs.grammar.content,
            "Could not get grammar correction. Please ensure your text is clear and try again."
          );
        });

        summarizeButton.addEventListener("click", () => {
          handleFeatureRequest(
            "summarize",
            "Summarizing Text",
            (text) => `Summarize the following English text concisely...`, // (prompt from user script)
            featureOutputs.summarize.content,
            "Could not generate summary..."
          );
        });

        analyzeToneButton.addEventListener("click", () => {
          handleFeatureRequest(
            "tone",
            "Analyzing Tone",
            (text) => `Analyze the overall tone and sentiment...`, // (prompt from user script)
            featureOutputs.tone.content,
            "Could not analyze tone..."
          );
        });

        paraphraseButton.addEventListener("click", () => {
          handleFeatureRequest(
            "paraphrase",
            "Paraphrasing Text",
            (text) =>
              `Rewrite the following English text to improve clarity...`, // (prompt from user script)
            featureOutputs.paraphrase.content,
            "Could not paraphrase text..."
          );
        });

        keywordsButton.addEventListener("click", () => {
          handleFeatureRequest(
            "keywords",
            "Extracting Keywords",
            (text) => `Extract the 5-10 most important keywords...`, // (prompt from user script)
            featureOutputs.keywords.content,
            "Could not extract keywords..."
          );
        });

        readabilityButton.addEventListener("click", () => {
          handleFeatureRequest(
            "readability",
            "Assessing Readability",
            (text) => `Assess the readability of the following English text...`, // (prompt from user script)
            featureOutputs.readability.content,
            "Could not assess readability..."
          );
        });

        concisenessButton.addEventListener("click", () => {
          handleFeatureRequest(
            "conciseness",
            "Checking Conciseness",
            (text) => `Review the following English text for conciseness...`, // (prompt from user script)
            featureOutputs.conciseness.content,
            "Could not check conciseness..."
          );
        });

        copyToClipboardBtn.addEventListener("click", () => {
          if (currentResultText) {
            const textarea = document.createElement("textarea");
            textarea.value = currentResultText;
            document.body.appendChild(textarea);
            textarea.select();
            try {
              document.execCommand("copy");
              copyButtonText.textContent = "Copied!";
              setTimeout(() => {
                copyButtonText.textContent = "Copy Result";
              }, 2000);
            } catch (err) {
              console.error("Failed to copy text: ", err);
              displayGeneralMessage("Failed to copy text.");
            }
            document.body.removeChild(textarea);
          }
        });

        // Initial setup
        updateCounts();
        activateFeatureOutput(null);
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/ScrollTrigger.min.js"></script>
    <script src="free-resourses-details.js"></script>
    <script src="dropdown-settings.js"></script>
    <script src="app.js"></script>
    <script src="gsap.js"></script>
    <script type="module" src="auth.js"></script>
    <script type="module" src="auth-page-loading.js"></script>
    <script src="navigation.js"></script>
  </body>
</html>
