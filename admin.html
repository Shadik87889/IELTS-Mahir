<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Anton&family=Dancing+Script:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <link rel="stylesheet" href="admin-panel-extra.css" />
  </head>
  <body class="flex h-full">
    <!-- Login Section -->
    <div
      id="login-section"
      class="min-h-screen flex items-center justify-center w-full bg-gray-100"
    >
      <div
        class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md border border-gray-200"
      >
        <div class="flex flex-col items-center mb-6">
          <img
            src="https://placehold.co/60x60/ED3A52/white?text=A"
            alt="Admin Logo"
            class="w-16 h-16 rounded-full mb-4 shadow-md"
          />
          <h2 class="text-3xl font-extrabold text-gray-900">Admin Login</h2>
          <p class="mt-2 text-center text-sm text-gray-600">
            Sign in to manage your dashboard
          </p>
        </div>
        <form id="login-form" class="space-y-6">
          <div>
            <label
              for="login-email"
              class="block text-sm font-medium text-gray-700"
              >Email address</label
            >
            <input
              id="login-email"
              name="email"
              type="email"
              autocomplete="email"
              required
              class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-900 sm:text-sm"
              value="admin@example.com"
            />
          </div>
          <div>
            <label
              for="login-password"
              class="block text-sm font-medium text-gray-700"
              >Password</label
            >
            <input
              id="login-password"
              name="password"
              type="password"
              autocomplete="current-password"
              required
              class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-900 sm:text-sm"
              value="password123"
            />
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <input
                id="remember-me"
                name="remember-me"
                type="checkbox"
                class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded"
              />
              <label for="remember-me" class="ml-2 block text-sm text-gray-900"
                >Remember me</label
              >
            </div>
            <div class="text-sm">
              <!-- <a href="#" class="font-medium text-red-600 hover:text-red-500"
                >Forgot your password?</a
              > -->
            </div>
          </div>
          <div>
            <button
              type="submit"
              class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200"
            >
              Sign in
            </button>
          </div>
        </form>
        <p class="mt-6 text-center text-sm text-gray-600">
          Not an admin? Access to this panel is restricted.
        </p>
      </div>
    </div>

    <!-- Admin Panel Section -->
    <div id="admin-panel" class="flex flex-1 hidden">
      <div id="sidebar-overlay" class="lg:hidden hidden overlay"></div>
      <aside
        id="sidebar"
        class="w-64 bg-white shadow-lg p-6 flex flex-col rounded-r-lg max-h-screen overflow-y-auto sidebar-menu fixed lg:static inset-y-0 left-0 z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out"
      >
        <div class="flex items-center justify-center mb-10 mt-2">
          <img
            src="https://placehold.co/40x40/ED3A52/white?text=A"
            alt="Admin Logo"
            class="w-10 h-10 rounded-full mr-3 shadow-md"
          />
          <span class="text-xl font-bold text-gray-800">Admin Panel</span>
        </div>
        <div class="relative mb-6 lg:hidden">
          <input
            type="text"
            id="sidebar-search"
            placeholder="Search..."
            class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-700 text-sm w-full"
          />
          <i
            class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
          ></i>
        </div>
        <nav class="flex-grow">
  <ul class="space-y-2">
    <li>
      <a
        href="#"
        class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-50 hover:text-red-600 font-semibold transition-colors duration-200 active-link"
        data-page="dashboard"
      >
        <i class="fas fa-chart-line text-lg mr-4"></i>
        Dashboard
      </a>
    </li>

    <li>
      <a
        href="#"
        class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-50 hover:text-red-600 font-semibold transition-colors duration-200"
        data-page="messages"
      >
        <i class="fas fa-envelope text-lg mr-4"></i>
        Messages
      </a>
    </li>
    <li>
      <a
        href="#"
        class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-50 hover:text-red-600 font-semibold transition-colors duration-200"
        data-page="speaking-requests"
      >
        <i class="fas fa-microphone-alt text-lg mr-4"></i>
        Speaking Requests
      </a>
    </li>
    <li>
      <a
        href="#"
        class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-50 hover:text-red-600 font-semibold transition-colors duration-200"
        data-page="our-teacher"
      >
        <i class="fas fa-chalkboard-teacher text-lg mr-4"></i>
        Our Teacher
      </a>
    </li>

    <li>
      <a
        href="#"
        class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-50 hover:text-red-600 font-semibold transition-colors duration-200"
        data-page="community-forum"
      >
        <i class="fas fa-users text-lg mr-4"></i>
        Community Forum
      </a>
    </li>
    <li>
      <a
        href="#"
        class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-50 hover:text-red-600 font-semibold transition-colors duration-200"
        data-page="blog"
      >
        <i class="fas fa-blog text-lg mr-4"></i>
        Blog
      </a>
    </li>
    <li>
      <a
        href="#"
        class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-50 hover:text-red-600 font-semibold transition-colors duration-200"
        data-page="free-resources"
      >
        <i class="fas fa-file-alt text-lg mr-4"></i>
        Free Resources
      </a>
    </li>
    <li>
      <a
        href="#"
        class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-50 hover:text-red-600 font-semibold transition-colors duration-200"
        data-page="testimonial"
      >
        <i class="fas fa-star text-lg mr-4"></i>
        Testimonial
      </a>
    </li>
    <li>
      <a
        href="#"
        class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-50 hover:text-red-600 font-semibold transition-colors duration-200"
        data-page="user-management"
      >
        <i class="fas fa-user-shield text-lg mr-4"></i>
        User Management
      </a>
    </li>
  </ul>
</nav>

        <div class="mt-auto pt-6">
          <button
            onclick="handleLogout()"
            class="flex items-center w-full p-3 rounded-lg text-gray-700 hover:bg-red-50 hover:text-red-600 font-semibold transition-colors duration-200"
          >
            <i class="fas fa-sign-out-alt text-lg mr-4"></i>
            Logout
          </button>
        </div>
      </aside>
      <div class="flex-1 flex flex-col bg-gray-50 h-full w-[100%]">
        <header
          class="bg-white shadow-sm py-4 px-6 flex items-center justify-between flex-nowrap rounded-bl-lg"
        >
          <div class="flex items-center space-x-4 flex-shrink-0">
            <button
              id="hamburger-menu"
              class="lg:hidden text-gray-600 hover:text-red-600 text-2xl"
            >
              <i class="fas fa-bars"></i>
            </button>
            <div class="relative">
              <input
                type="date"
                id="date-picker"
                class="p-2 border hidden border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500 text-gray-700 text-sm w-32 sm:w-auto"
              />
            </div>
          </div>
          <div
            class="flex items-center space-x-4 sm:space-x-6 flex-shrink-0 ml-auto"
          >
            <div class="relative hidden md:block flex-grow-0">
              <!-- <input
                type="text"
                placeholder="Search..."
                class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-700 text-sm w-40 lg:w-64"
              />
              <i
                class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
              ></i>
            </div>
            <button
              id="notifications-btn"
              class="relative text-gray-600 hover:text-red-600 transition-colors duration-200"
            >
              <i class="fas fa-bell text-xl"></i>
              <span
                class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full transform translate-x-1/2 -translate-y-1/2"
                >3</span
              >
            </button>
            <button
              id="settings-btn"
              class="text-gray-600 hover:text-red-600 transition-colors duration-200"
            >
              <i class="fas fa-cog text-xl"></i>
            </button> -->
            <div class="relative group flex-shrink-0">
              <img
                src="https://placehold.co/40x40/9CA3AF/white?text=IM"
                alt="User Avatar"
                class="w-10 h-10 rounded-full border-2 border-gray-300 transition-all duration-200"
                title="Admin User"
              />
            </div>
          </div>
        </header>
        <main
          id="content-area"
          class="flex-1 p-4 sm:p-6 md:p-8 overflow-y-auto custom-scrollbar"
        ></main>
      </div>
    </div>
    <div
      id="message-box"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-[1000] hidden"
    >
      <div
        class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center"
      >
        <p id="message-content" class="text-gray-800 text-lg mb-4"></p>
        <button
          id="close-message-box"
          class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200"
        >
          OK
        </button>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
  <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        doc,
        addDoc,
        updateDoc,
        deleteDoc,
        onSnapshot,
        getDoc,
        serverTimestamp,
        query,
        where,
        getDocs,
        writeBatch,
        setDoc, // Added setDoc here
        orderBy,
        limit,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      import {
        getAuth,
        signInWithEmailAndPassword, // Added for email/password login
        signOut, // Added for logout functionality
        onAuthStateChanged, // Added for real-time auth state management
        createUserWithEmailAndPassword, // Added for creating new users
        updatePassword, // Added for updating user password
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

      const defaultAppId = "ielts-mahir-community-forum";
      const defaultFirebaseConfig = {
        apiKey: "AIzaSyAxsd0CnLsh7t7yFy3ZPp6saGD_YpLL1mY",
        authDomain: "ielts-mahir-community-forum.firebaseapp.com",
        projectId: "ielts-mahir-community-forum",
        storageBucket: "ielts-mahir-community-forum.firebasestorage.app",
        messagingSenderId: "1036043607546",
        appId: "1:1036043607546:web:bd217e04cc0ec5f296d843",
        measurementId: "G-YC4CG1WKD3",
      };

      const firebaseConfig =
        typeof __firebase_config !== "undefined"
          ? JSON.parse(__firebase_config)
          : defaultFirebaseConfig;

      // Initialize a named Firebase app instance for the admin panel
      const ADMIN_APP_NAME = "adminPanelApp";
      const app = initializeApp(firebaseConfig, ADMIN_APP_NAME);

      // Get Firestore and Auth instances from the named app
      const db = getFirestore(app);
      const auth = getAuth(app);

      const appId = typeof __app_id !== "undefined" ? __app_id : defaultAppId;

      let userId = null;
      let isAuthReady = false; // This will now be managed by onAuthStateChanged
      let summernoteEditorInstance = null;
      let currentUserRole = null; // To store the role of the currently logged-in user

      let blogCurrentPage = 1;
      const blogItemsPerPage = 6;
      let blogCurrentFilters = {
        status: "all",
        category: "all categories",
        searchTerm: "",
      };

      let testimonialCurrentPage = 1;
      const testimonialItemsPerPage = 6;
      let testimonialCurrentFilters = { status: "all", searchTerm: "" };

      let contactMessageCurrentPage = 1;
      const contactMessageItemsPerPage = 5;
      let contactMessageCurrentFilters = { status: "all", searchTerm: "" };

      let teacherCurrentPage = 1;
      const teacherItemsPerPage = 6;
      let teacherCurrentFilters = { status: "all", searchTerm: "" };
      let freeResourceCurrentPage = 1;
      const freeResourceItemsPerPage = 6;
      let freeResourceCurrentFilters = {
        status: "all",
        category: "all categories",
        searchTerm: "",
      };

      // New state variables for Community Forum management in Admin Panel
      let forumPostsCurrentPage = 1;
      const forumPostsItemsPerPage = 5;
      let forumPostsCurrentFilters = {
        status: "all", // New filter for post status (pending, approved, rejected)
        category: "all categories",
        searchTerm: "",
      };

      let forumCommentsCurrentPage = 1;
      const forumCommentsItemsPerPage = 5;
      let forumCommentsCurrentFilters = {
        searchTerm: "",
      };

      // New state variables for Speaking Session Requests
      let speakingRequestCurrentPage = 1;
      const speakingRequestItemsPerPage = 5;
      let speakingRequestCurrentFilters = { status: "all", searchTerm: "" };

      const FORUM_CATEGORIES_DATA = [
        {
          name: "IELTS Speaking",
          subcategories: ["Cue Cards", "Fluency", "Pronunciation"],
        },
        {
          name: "IELTS Writing",
          subcategories: [
            "Writing Task 1",
            "Writing Task 2",
            "Grammar Help",
            "Vocabulary",
          ],
        },
        { name: "IELTS Listening" },
        { name: "IELTS Reading" },
        { name: "Tips & Strategies" },
        { name: "Band 9 Answers" },
        { name: "Motivation & Support" },
      ];

      const showMessage = (message) => {
        const messageBox = document.getElementById("message-box");
        const messageContent = document.getElementById("message-content");
        messageContent.textContent = message;
        messageBox.classList.remove("hidden");
      };

      const showAdminPanel = () => {
        document.getElementById("login-section").classList.add("hidden");
        document.getElementById("admin-panel").classList.remove("hidden");
        loadPageContent("dashboard"); // Load default page after successful login
      };

      const showLoginForm = () => {
        document.getElementById("login-section").classList.remove("hidden");
        document.getElementById("admin-panel").classList.add("hidden");
      };

      // Handle user login with email and password
      const handleLogin = async (email, password) => {
        try {
          const userCredential = await signInWithEmailAndPassword(
            auth,
            email,
            password
          );
          console.log("User logged in:", userCredential.user.uid);
          // The onAuthStateChanged listener will now handle showing the admin panel
          // based on whether the logged-in user is the admin.
          showMessage("Attempting login...", "info"); // Provide immediate feedback
        } catch (error) {
          console.error("Login failed:", error);
          showMessage(
            `Login failed: ${error.message}. Please check your email and password.`
          );
        }
      };

      // Handle user logout
      window.handleLogout = async () => {
        try {
          await signOut(auth);
          console.log("User logged out.");
          showMessage("Logged out successfully.", "info");
          // The onAuthStateChanged listener will handle showing the login form
        } catch (error) {
          console.error("Logout failed:", error);
          showMessage(`Logout failed: ${error.message}.`);
        }
      };

      // Set up authentication state listener immediately after Firebase app initialization
      // This listener is now moved inside DOMContentLoaded to ensure elements are present.

      const processAndResizeImage = (file, maxWidth, maxHeight, callback) => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement("canvas");
            let [width, height] = [img.width, img.height];
            if (width > height) {
              if (width > maxWidth) {
                height *= maxWidth / width;
                width = maxWidth;
              }
            } else {
              if (height > maxHeight) {
                width *= maxHeight / height;
                height = maxHeight;
              }
            }
            canvas.width = width;
            canvas.height = height;
            canvas.getContext("2d").drawImage(img, 0, 0, width, height);
            callback(canvas.toDataURL("image/jpeg", 1.0));
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      };

      const setupImageDragAndDrop = (
        hiddenInputId,
        dropZoneId,
        previewImgId,
        maxWidth = 800,
        maxHeight = 400
      ) => {
        const hiddenInput = document.getElementById(hiddenInputId);
        const dropZone = document.getElementById(dropZoneId);
        const previewImg = document.getElementById(previewImgId);
        const placeholderText = dropZone.querySelector(".placeholder-text");
        const changeText = dropZone.querySelector(".change-text");

        if (
          !hiddenInput ||
          !dropZone ||
          !previewImg ||
          !placeholderText ||
          !changeText
        ) {
          console.error(
            `Missing elements for drag and drop setup: ${hiddenInputId}, ${dropZoneId}, ${previewImgId}`
          );
          return;
        }

        const updateImagePreview = (src) => {
          previewImg.src = src || "";
          previewImg.classList.toggle("hidden", !src);
          placeholderText.classList.toggle("hidden", !!src);
          changeText.classList.toggle("hidden", !src);
          hiddenInput.value = src || "";
        };

        updateImagePreview(hiddenInput.value);

        ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
          dropZone.addEventListener(eventName, preventDefaults, false);
          document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        ["dragenter", "dragover"].forEach((eventName) => {
          dropZone.addEventListener(
            eventName,
            () => dropZone.classList.add("border-red-500", "bg-red-50"),
            false
          );
        });

        ["dragleave", "drop"].forEach((eventName) => {
          dropZone.addEventListener(
            eventName,
            () => dropZone.classList.remove("border-red-500", "bg-red-50"),
            false
          );
        });

        dropZone.addEventListener(
          "drop",
          (e) => {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
              const file = files[0];
              file.type.startsWith("image/")
                ? processAndResizeImage(
                    file,
                    maxWidth,
                    maxHeight,
                    (dataUrl) => {
                      updateImagePreview(dataUrl);
                      showMessage(
                        "Image dropped, resized, and converted to Data URL."
                      );
                    }
                  )
                : showMessage(
                    "Please drop an image file (e.g., .jpg, .png, .gif)."
                  );
            } else if (
              e.dataTransfer
                .getData("text/plain")
                .match(/\.(jpeg|jpg|gif|png|webp|svg)$/i)
            ) {
              updateImagePreview(e.dataTransfer.getData("text/plain"));
              showMessage("Image URL dropped.");
            } else {
              showMessage("Dropped text is not a valid image URL.");
            }
          },
          false
        );

        dropZone.addEventListener("click", () => {
          const input = document.createElement("input");
          input.type = "file";
          input.accept = "image/*";
          input.onchange = (e) => {
            const file = e.target.files[0];
            file && file.type.startsWith("image/")
              ? processAndResizeImage(file, maxWidth, maxHeight, (dataUrl) => {
                  updateImagePreview(dataUrl);
                  showMessage(
                    "Image selected, resized, and converted to Data URL."
                  );
                })
              : showMessage("Please select an image file.");
          };
          input.click();
        });
        dropZone._setImage = updateImagePreview;
      };

      const generatePageHeader = (title) => `
          <h1 class="text-3xl font-bold text-gray-800 mb-6">${title}</h1>
          <div class="bg-white p-6 rounded-xl shadow-md mb-8">
              <p class="text-gray-600">This is the content for the <strong>${title}</strong> page.</p>
          </div>
          `;

      const closeAllKebabDropdowns = () => {
        document
          .querySelectorAll(".kebab-dropdown.active")
          .forEach((dropdown) => dropdown.classList.remove("active"));
      };

      window.updateTestimonialStatus = async (id, newStatus) => {
        if (!isAuthReady)
          return showMessage("Firebase not ready. Please try again.");
        closeAllKebabDropdowns();
        try {
          await updateDoc(
            doc(db, "artifacts", appId, "public", "data", "testimonials", id),
            { status: newStatus }
          );
          showMessage(`Testimonial status updated to '${newStatus}'.`);
        } catch (error) {
          console.error("Error updating testimonial status:", error);
          showMessage(`Failed to update testimonial status: ${error.message}.`);
        }
      };

      window.editTestimonial = async (id) => {
        if (!isAuthReady)
          return showMessage("Firebase not ready. Please try again.");
        closeAllKebabDropdowns();
        try {
          const docSnap = await getDoc(
            doc(db, "artifacts", appId, "public", "data", "testimonials", id)
          );
          if (!docSnap.exists()) return showMessage("Testimonial not found.");
          const testimonial = docSnap.data();
          document.getElementById("testimonial-id").value = id;
          document.getElementById("testimonial-name").value = testimonial.name;
          document.getElementById("testimonial-role").value = testimonial.role;
          document.getElementById("testimonial-text").value =
            testimonial.text || "";
          document
            .getElementById("avatar-drop-zone")
            ._setImage(testimonial.avatarSrc || "");
          const typeVideoRadio = document.getElementById(
            "testimonial-type-video"
          );
          const videoUrlGroup = document.getElementById("video-url-group");
          const testimonialVideoSrc = document.getElementById(
            "testimonial-video-src"
          );
          typeVideoRadio.checked = testimonial.type === "video";
          videoUrlGroup.classList.toggle(
            "hidden",
            testimonial.type !== "video"
          );
          testimonialVideoSrc.value = testimonial.videoSrc || "";
          document.getElementById("testimonial-type-text").checked =
            testimonial.type !== "video";
          document.getElementById("add-testimonial-btn").textContent =
            "Update Testimonial";
          showMessage(
            "Form populated for editing. Update and submit to save changes."
          );
        } catch (error) {
          console.error("Error fetching testimonial for edit:", error);
          showMessage(
            `Failed to load testimonial for editing: ${error.message}.`
          );
        }
      };

      window.deleteTestimonial = async (id) => {
        if (!isAuthReady)
          return showMessage("Firebase not ready. Please try again.");
        closeAllKebabDropdowns();
        const messageBox = document.getElementById("message-box");
        const messageContent = document.getElementById("message-content");
        const closeMessageBoxBtn = document.getElementById("close-message-box");
        messageContent.textContent =
          "Are you sure you want to delete this testimonial? This action cannot be undone.";
        messageBox.classList.remove("hidden");

        const confirmDeleteBtn = document.createElement("button");
        confirmDeleteBtn.textContent = "Confirm Delete";
        confirmDeleteBtn.className =
          "bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 ml-2";
        confirmDeleteBtn.id = "confirm-delete-btn";
        messageBox.querySelector(".text-center").appendChild(confirmDeleteBtn);

        confirmDeleteBtn.addEventListener("click", async () => {
          try {
            await deleteDoc(
              doc(db, "artifacts", appId, "public", "data", "testimonials", id)
            );
            showMessage("Testimonial deleted successfully.");
          } catch (error) {
            console.error("Error deleting testimonial:", error);
            showMessage(`Failed to delete testimonial: ${error.message}.`);
          } finally {
            confirmDeleteBtn.remove();
            messageBox.classList.add("hidden");
          }
        });

        const originalCloseHandler = closeMessageBoxBtn.onclick;
        closeMessageBoxBtn.onclick = () => {
          confirmDeleteBtn.remove();
          messageBox.classList.add("hidden");
          if (originalCloseHandler) originalCloseHandler();
          closeMessageBoxBtn.onclick = originalCloseHandler;
        };
      };

      const renderTestimonials = (filters, currentPage, itemsPerPage) => {
        if (!isAuthReady)
          return showMessage(
            "Testimonials cannot be loaded or managed because Firebase authentication is not ready. Please try refreshing the page."
          );
        const [pendingList, approvedList, rejectedList, paginationContainer] = [
          document.getElementById("pending-testimonials-list"),
          document.getElementById("approved-testimonials-list"),
          document.getElementById("rejected-testimonials-list"),
          document.getElementById("testimonial-pagination"),
        ];
        if (
          !pendingList ||
          !approvedList ||
          !rejectedList ||
          !paginationContainer
        )
          return console.error("Testimonial elements not found.");

        onSnapshot(
          collection(db, "artifacts", appId, "public", "data", "testimonials"),
          (snapshot) => {
            [
              pendingList,
              approvedList,
              rejectedList,
              paginationContainer,
            ].forEach((el) => (el.innerHTML = ""));
            let allTestimonials = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            let filteredTestimonials = allTestimonials.filter(
              (t) =>
                (filters.status === "all" || t.status === filters.status) &&
                (filters.searchTerm === "" ||
                  t.name
                    .toLowerCase()
                    .includes(filters.searchTerm.toLowerCase()) ||
                  t.role
                    .toLowerCase()
                    .includes(filters.searchTerm.toLowerCase()) ||
                  (t.text &&
                    t.text
                      .toLowerCase()
                      .includes(filters.searchTerm.toLowerCase())))
            );
            filteredTestimonials.sort(
              (a, b) =>
                (b.timestamp?.toDate() || new Date(0)).getTime() -
                (a.timestamp?.toDate() || new Date(0)).getTime()
            );

            const totalPages = Math.ceil(
              filteredTestimonials.length / itemsPerPage
            );
            const paginatedTestimonials = filteredTestimonials.slice(
              (currentPage - 1) * itemsPerPage,
              currentPage * itemsPerPage
            );

            if (paginatedTestimonials.length === 0) {
              pendingList.innerHTML =
                '<p class="text-gray-500 text-center col-span-full">No pending testimonials.</p>';
              approvedList.innerHTML =
                '<p class="text-gray-500 text-center col-span-full">No approved testimonials.</p>';
              rejectedList.innerHTML =
                '<p class="text-gray-500 text-center col-span-full">No rejected testimonials.</p>';
            }

            paginatedTestimonials.forEach((testimonial) => {
              const card = document.createElement("div");
              card.classList.add("testimonial-card-admin");
              card.dataset.id = testimonial.id;
              let contentHtml =
                testimonial.type === "video"
                  ? `
              <img src="${testimonial.avatarSrc}" alt="${
                      testimonial.name
                    }" class="avatar video-avatar" onerror="this.src='https://placehold.co/80x80/9CA3AF/white?text=User'">
              <video class="tes-video" src="${
                testimonial.videoSrc
              }" preload="metadata"></video>
              <div class="play-button" data-video-id="${
                testimonial.id
              }"><i class="fa-solid fa-play"></i></div>
              <div class="pause-button" data-video-id="${
                testimonial.id
              }" style="display:none;"><i class="fa-solid fa-pause"></i></div>
              <p class="name video-name">${
                testimonial.name
              }</p><p class="role video-role">${testimonial.role}</p>
              <p class="hidden-text" style="display:none;">${
                testimonial.text || ""
              }</p>
            `
                  : `
              <img src="${testimonial.avatarSrc}" alt="${testimonial.name}" class="avatar" onerror="this.src='https://placehold.co/80x80/9CA3AF/white?text=User'">
              <div class="text-content"><p class="text">"${testimonial.text}"</p></div>
              <p class="name">${testimonial.name}</p><p class="role">${testimonial.role}</p>
            `;
              const kebabMenu = `
              <div class="kebab-menu-container">
                  <button class="kebab-button" aria-label="Testimonial actions" data-testimonial-id="${
                    testimonial.id
                  }"><i class="fas fa-ellipsis-v"></i></button>
                  <div class="kebab-dropdown">
                      ${
                        testimonial.status === "pending"
                          ? `<button onclick="updateTestimonialStatus('${testimonial.id}', 'approved')"><i class="fas fa-check-circle"></i> Approve</button><button onclick="updateTestimonialStatus('${testimonial.id}', 'rejected')"><i class="fas fa-times-circle"></i> Reject</button>`
                          : ""
                      }
                      ${
                        testimonial.status === "approved"
                          ? `<button onclick="updateTestimonialStatus('${testimonial.id}', 'pending')"><i class="fas fa-ban"></i> Unpublish</button>`
                          : ""
                      }
                      ${
                        testimonial.status === "rejected"
                          ? `<button onclick="updateTestimonialStatus('${testimonial.id}', 'approved')"><i class="fas fa-check-circle"></i> Approve</button>`
                          : ""
                      }
                      <button onclick="editTestimonial('${
                        testimonial.id
                      }')"><i class="fas fa-edit"></i> Edit</button>
                      <button onclick="deleteTestimonial('${
                        testimonial.id
                      }')"><i class="fas fa-trash-alt"></i> Delete</button>
                  </div>
              </div>`;
                  card.innerHTML = contentHtml + kebabMenu;
              if (
                filters.status === "all" ||
                testimonial.status === filters.status
              ) {
                if (testimonial.status === "pending")
                  pendingList.appendChild(card);
                else if (testimonial.status === "approved")
                  approvedList.appendChild(card);
                else if (testimonial.status === "rejected")
                  rejectedList.appendChild(card);
              }
            });

            document
              .querySelectorAll(".testimonial-card-admin .play-button")
              .forEach((button) => {
                button.addEventListener("click", (e) => {
                  const video = e.currentTarget
                    .closest(".testimonial-card-admin")
                    .querySelector(".tes-video");
                  if (video) {
                    video.play();
                    e.currentTarget.style.display = "none";
                    video.nextElementSibling.style.display = "flex";
                  }
                });
              });
            document
              .querySelectorAll(".testimonial-card-admin .pause-button")
              .forEach((button) => {
                button.addEventListener("click", (e) => {
                  const video = e.currentTarget
                    .closest(".testimonial-card-admin")
                    .querySelector(".tes-video");
                  if (video) {
                    video.pause();
                    e.currentTarget.style.display = "none";
                    video.previousElementSibling.style.display = "flex";
                  }
                });
              });
            document
              .querySelectorAll(".testimonial-card-admin .tes-video")
              .forEach((video) => {
                video.addEventListener("ended", (e) => {
                  const card = e.target.closest(".testimonial-card-admin");
                  card.querySelector(".play-button").style.display = "flex";
                  card.querySelector(".pause-button").style.display = "none";
                });
                video.addEventListener("play", (e) => {
                  const card = e.target.closest(".testimonial-card-admin");
                  card.querySelector(".play-button").style.display = "none";
                  card.querySelector(".pause-button").style.display = "flex";
                });
                video.addEventListener("pause", (e) => {
                  const card = e.target.closest(".testimonial-card-admin");
                  card.querySelector(".play-button").style.display = "flex";
                  card.querySelector(".pause-button").style.display = "none";
                });
              });
            document.querySelectorAll(".kebab-button").forEach((button) => {
              button.addEventListener("click", (event) => {
                const dropdown = button.nextElementSibling;
                const isActive = dropdown.classList.contains('active');
                
                // Always close all dropdowns first
                closeAllKebabDropdowns();

                // If the clicked menu wasn't already active, open it.
                if (!isActive) {
                    dropdown.classList.add('active');
                }
              });
            });

            paginationContainer.innerHTML = "";
            if (totalPages > 1) {
              const paginationNav = document.createElement("nav");
              paginationNav.className =
                "flex justify-center items-center space-x-2 mt-4";
              const createButton = (text, page, disabled, onClick) => {
                const btn = document.createElement("button");
                btn.textContent = text;
                btn.className = `px-3 py-1 rounded-lg text-sm transition-colors duration-200 ${
                  disabled
                    ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                    : page === currentPage
                    ? "bg-red-600 text-white"
                    : "bg-red-500 hover:bg-red-600 text-white"
                }`;
                btn.disabled = disabled;
                btn.addEventListener("click", onClick);
                return btn;
              };
              paginationNav.appendChild(
                createButton(
                  "Previous",
                  currentPage - 1,
                  currentPage === 1,
                  () => {
                    testimonialCurrentPage--;
                    renderTestimonials(
                      filters,
                      testimonialCurrentPage,
                      itemsPerPage
                    );
                  }
                )
              );
              for (let i = 1; i <= totalPages; i++) {
                paginationNav.appendChild(
                  createButton(i, i, false, () => {
                    testimonialCurrentPage = i;
                    renderTestimonials(
                      filters,
                      testimonialCurrentPage,
                      itemsPerPage
                    );
                  })
                );
              }
              paginationNav.appendChild(
                createButton(
                  "Next",
                  currentPage + 1,
                  currentPage === totalPages,
                  () => {
                    testimonialCurrentPage++;
                    renderTestimonials(
                      filters,
                      testimonialCurrentPage,
                      itemsPerPage
                    );
                  }
                )
              );
              paginationContainer.appendChild(paginationNav);
            }
          },
          (error) =>
            showMessage(`Error loading testimonials: ${error.message}.`)
        );
      };

      window.updateBlogPostStatus = async (id, newStatus) => {
        if (!isAuthReady)
          return showMessage("Firebase not ready. Please try again.");
        try {
          await updateDoc(
            doc(db, "artifacts", appId, "public", "data", "blogPosts", id),
            { status: newStatus }
          );
          showMessage(`Blog post status updated to '${newStatus}'.`);
        } catch (error) {
          console.error("Error updating blog post status:", error);
          showMessage(`Failed to update blog post status: ${error.message}.`);
        }
      };

      window.editBlogPost = async (id) => {
        if (!isAuthReady)
          return showMessage("Firebase not ready. Please try again.");
        try {
          const docSnap = await getDoc(
            doc(db, "artifacts", appId, "public", "data", "blogPosts", id)
          );
          if (!docSnap.exists()) return showMessage("Blog post not found.");
          const blogPost = docSnap.data();
          document.getElementById("blog-id").value = id;
          document.getElementById("blog-title").value = blogPost.title;
          document.getElementById("blog-category").value = blogPost.category;
          $("#blog-content").summernote("code", blogPost.content || "");
          document.getElementById("blog-author").value = blogPost.author;
          document
            .getElementById("blog-image-drop-zone")
            ._setImage(blogPost.image || "");
          document
            .getElementById("author-image-drop-zone")
            ._setImage(blogPost.authorImg || "");
          document.getElementById("add-blog-btn").textContent =
            "Update Blog Post";
          showMessage(
            "Form populated for editing. Update and submit to save changes."
          );
        } catch (error) {
          console.error("Error fetching blog post for edit:", error);
          showMessage(
            `Failed to load blog post for editing: ${error.message}.`
          );
        }
      };

      window.deleteBlogPost = async (id) => {
        if (!isAuthReady)
          return showMessage("Firebase not ready. Please try again.");
        const messageBox = document.getElementById("message-box");
        const messageContent = document.getElementById("message-content");
        const closeMessageBoxBtn = document.getElementById("close-message-box");
        messageContent.textContent =
          "Are you sure you want to delete this blog post? This action cannot be undone.";
        messageBox.classList.remove("hidden");

        const confirmDeleteBtn = document.createElement("button");
        confirmDeleteBtn.textContent = "Confirm Delete";
        confirmDeleteBtn.className =
          "bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 ml-2";
        confirmDeleteBtn.id = "confirm-delete-btn";
        messageBox.querySelector(".text-center").appendChild(confirmDeleteBtn);

        confirmDeleteBtn.addEventListener("click", async () => {
          try {
            await deleteDoc(
              doc(db, "artifacts", appId, "public", "data", "blogPosts", id)
            );
            showMessage("Blog post deleted successfully.");
          } catch (error) {
            console.error("Error deleting blog post:", error);
            showMessage(`Failed to delete blog post: ${error.message}.`);
          } finally {
            confirmDeleteBtn.remove();
            messageBox.classList.add("hidden");
          }
        });

        const originalCloseHandler = closeMessageBoxBtn.onclick;
        closeMessageBoxBtn.onclick = () => {
          confirmDeleteBtn.remove();
          messageBox.classList.add("hidden");
          if (originalCloseHandler) originalCloseHandler();
          closeMessageBoxBtn.onclick = originalCloseHandler;
        };
      };

      const renderBlogPosts = (filters, currentPage, itemsPerPage) => {
        if (!isAuthReady)
          return showMessage(
            "Blog posts cannot be loaded or managed because Firebase authentication is not ready. Please try refreshing the page."
          );
        const [container, heading, pagination] = [
          document.getElementById("blog-posts-container"),
          document.getElementById("blog-posts-list-heading"),
          document.getElementById("blog-pagination"),
        ];
        if (!container || !heading || !pagination)
          return console.error("Blog post elements not found.");

        onSnapshot(
          collection(db, "artifacts", appId, "public", "data", "blogPosts"),
          (snapshot) => {
            [container, pagination].forEach((el) => (el.innerHTML = ""));
            let allPosts = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            let filteredPosts = allPosts.filter(
              (p) =>
                (filters.status === "all" || p.status === filters.status) &&
                (filters.category === "all categories" ||
                  p.category === filters.category) &&
                (filters.searchTerm === "" ||
                  p.title
                    .toLowerCase()
                    .includes(filters.searchTerm.toLowerCase()) ||
                  (p.content &&
                    p.content
                      .toLowerCase()
                      .includes(filters.searchTerm.toLowerCase())) ||
                  p.author
                    .toLowerCase()
                    .includes(filters.searchTerm.toLowerCase()))
            );
            filteredPosts.sort(
              (a, b) =>
                (b.timestamp?.toDate() || new Date(0)).getTime() -
                (a.timestamp?.toDate() || new Date(0)).getTime()
            );

            const totalPages = Math.ceil(filteredPosts.length / itemsPerPage);
            const paginatedPosts = filteredPosts.slice(
              (currentPage - 1) * itemsPerPage,
              currentPage * itemsPerPage
            );

            heading.textContent =
              filters.status === "all"
                ? "All Blog Posts"
                : filters.status === "published"
                ? "Published Blog Posts"
                : "Draft Blog Posts";
            if (paginatedPosts.length === 0)
              container.innerHTML =
                '<p class="text-gray-500 text-center col-span-full">No blog posts found matching your criteria.</p>';

            paginatedPosts.forEach((blogPost) => {
              const formattedDate = (
                blogPost.timestamp?.toDate() || new Date()
              ).toLocaleDateString("en-US", {
                year: "numeric",
                month: "long",
                day: "numeric",
              });
              const card = document.createElement("div");
              card.classList.add(
                "bg-white",
                "p-4",
                "rounded-lg",
                "shadow-sm",
                "flex",
                "flex-col",
                "border",
                "border-gray-300"
              );
              card.innerHTML = `<img src="${
                blogPost.image ||
                "https://placehold.co/400x200/cccccc/white?text=Blog+Image"
              }" alt="${
                blogPost.title
              }" class="w-full h-[40vw] md:h-[24vw] lg:h-[14vw] object-cover rounded-md mb-4 onerror="this.src='https://placehold.co/400x200/cccccc/white?text=Blog+Image'"><div class="flex items-center justify-between text-xs text-gray-500 mb-2"><span class="bg-red-100 text-red-800 px-2 py-1 rounded-full">${
                blogPost.category
              }</span><span>${formattedDate}</span></div><h3 class="font-bold text-gray-800 text-lg mb-2">${
                blogPost.title
              }</h3><div class="flex items-center text-sm text-gray-700 mb-4"><img src="${
                blogPost.authorImg ||
                "https://placehold.co/40x40/9CA3AF/white?text=A"
              }" alt="${
                blogPost.author
              }" class="w-8 h-8 rounded-full mr-2" onerror="this.src='https://placehold.co/40x40/9CA3AF/white?text=A'"><span>${
                blogPost.author
              }</span></div><div class="flex flex-wrap gap-2 mt-auto">${
                blogPost.status === "draft"
                  ? `<button class="bg-green-600 hover:bg-green-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="updateBlogPostStatus('${blogPost.id}', 'published')">Publish</button>`
                  : `<button class="bg-orange-600 hover:bg-orange-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="updateBlogPostStatus('${blogPost.id}', 'draft')">Unpublish</button>`
              }<button class="bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="editBlogPost('${
                blogPost.id
              }')">Edit</button><button class="bg-red-600 hover:bg-red-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="deleteBlogPost('${
                blogPost.id
              }')">Delete</button></div>`;
              container.appendChild(card);
            });

            pagination.innerHTML = "";
            if (totalPages > 1) {
              const paginationNav = document.createElement("nav");
              paginationNav.className =
                "flex justify-center items-center space-x-2 mt-4";
              const createButton = (text, page, disabled, onClick) => {
                const btn = document.createElement("button");
                btn.textContent = text;
                btn.className = `px-3 py-1 rounded-lg text-sm transition-colors duration-200 ${
                  disabled
                    ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                    : page === currentPage
                    ? "bg-red-600 text-white"
                    : "bg-gray-200 text-gray-700 hover:bg-gray-300"
                }`;
                btn.disabled = disabled;
                btn.addEventListener("click", onClick);
                return btn;
              };
              paginationNav.appendChild(
                createButton(
                  "Previous",
                  currentPage - 1,
                  currentPage === 1,
                  () => {
                    blogCurrentPage--;
                    renderBlogPosts(filters, blogCurrentPage, itemsPerPage);
                  }
                )
              );
              for (let i = 1; i <= totalPages; i++) {
                paginationNav.appendChild(
                  createButton(i, i, false, () => {
                    blogCurrentPage = i;
                    renderBlogPosts(filters, blogCurrentPage, itemsPerPage);
                  })
                );
              }
              paginationNav.appendChild(
                createButton(
                  "Next",
                  currentPage + 1,
                  currentPage === totalPages,
                  () => {
                    blogCurrentPage++;
                    renderBlogPosts(filters, blogCurrentPage, itemsPerPage);
                  }
                )
              );
              pagination.appendChild(paginationNav);
            }
          },
          (error) => showMessage(`Error loading blog posts: ${error.message}.`)
        );
      };

      // --- NEW: Functions to manage contact message status ---
      window.markMessageAsReplied = async (messageId) => {
        if (!isAuthReady)
          return showMessage("Firebase not ready. Please try again.");
        try {
          await updateDoc(
            doc(
              db,
              "artifacts",
              appId,
              "public",
              "data",
              "contactMessages",
              messageId
            ),
            {
              status: "replied",
              adminReplyTimestamp: serverTimestamp(), // Keep track of when it was marked
            }
          );
          showMessage("Message marked as replied!");
        } catch (error) {
          console.error("Error marking message as replied:", error);
          showMessage(`Failed to update message status: ${error.message}.`);
        }
      };

      window.unmarkMessage = async (messageId) => {
        if (!isAuthReady)
          return showMessage("Firebase not ready. Please try again.");
        try {
          await updateDoc(
            doc(
              db,
              "artifacts",
              appId,
              "public",
              "data",
              "contactMessages",
              messageId
            ),
            {
              status: "pending",
              // Note: adminReplyTimestamp is not removed to preserve history
            }
          );
          showMessage("Message status reverted to pending.");
        } catch (error) {
          console.error("Error reverting message status:", error);
          showMessage(`Failed to update message status: ${error.message}.`);
        }
      };
      // --- END NEW Functions ---

      // --- UPDATED: renderContactMessages function ---
      const renderContactMessages = (filters, currentPage, itemsPerPage) => {
        if (!isAuthReady)
          return showMessage(
            "Contact messages cannot be loaded or managed because Firebase authentication is not ready. Please try refreshing the page."
          );
        const [container, pagination] = [
          document.getElementById("contact-messages-list"),
          document.getElementById("contact-message-pagination"),
        ];
        if (!container || !pagination)
          return console.error("Contact message elements not found.");

        onSnapshot(
          collection(
            db,
            "artifacts",
            appId,
            "public",
            "data",
            "contactMessages"
          ),
          (snapshot) => {
            [container, pagination].forEach((el) => (el.innerHTML = ""));
            let allMessages = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            let filteredMessages = allMessages.filter(
              (m) =>
                (filters.status === "all" || m.status === filters.status) &&
                (filters.searchTerm === "" ||
                  m.name
                    .toLowerCase()
                    .includes(filters.searchTerm.toLowerCase()) ||
                  m.email
                    .toLowerCase()
                    .includes(filters.searchTerm.toLowerCase()) ||
                  m.subject
                    .toLowerCase()
                    .includes(filters.searchTerm.toLowerCase()) ||
                  m.message
                    .toLowerCase()
                    .includes(filters.searchTerm.toLowerCase()))
            );
            filteredMessages.sort(
              (a, b) =>
                (b.timestamp?.toDate() || new Date(0)).getTime() -
                (a.timestamp?.toDate() || new Date(0)).getTime()
            );

            const totalPages = Math.ceil(
              filteredMessages.length / itemsPerPage
            );
            const paginatedMessages = filteredMessages.slice(
              (currentPage - 1) * itemsPerPage,
              currentPage * itemsPerPage
            );

            if (paginatedMessages.length === 0)
              container.innerHTML =
                '<p class="text-gray-500 text-center col-span-full">No contact messages found matching your criteria.</p>';

            paginatedMessages.forEach((message) => {
              const formattedDate = (
                message.timestamp?.toDate() || new Date()
              ).toLocaleString();
              let actionsSection = "";
              let statusBadge = "";
              const subject = encodeURIComponent(`Re: ${message.subject}`);
              const body = encodeURIComponent(
                `Hi ${
                  message.name
                },\n\n\n\n---\nOriginal Message:\n> ${message.message.replace(
                  /\n/g,
                  "\n> "
                )}`
              );
              const mailtoLink = `mailto:${message.email}?subject=${subject}&body=${body}`;

              if (message.status === "pending") {
                statusBadge =
                  '<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-semibold">Pending</span>';
                actionsSection = `
                <div class="flex flex-wrap gap-2 mt-4">
                    <a href="${mailtoLink}" target="_blank" class="bg-red-600 hover:bg-red-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200 inline-flex items-center">
                        <i class="fas fa-reply mr-2"></i> Reply via Email
                    </a>
                    <button onclick="markMessageAsReplied('${message.id}')" class="bg-green-600 hover:bg-green-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200 inline-flex items-center">
                        <i class="fas fa-check-circle mr-2"></i> Mark as Replied
                    </button>
                </div>`;
              } else if (message.status === "replied") {
                statusBadge =
                  '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-semibold">Replied</span>';
                const replyDate = (
                  message.adminReplyTimestamp?.toDate() || "N/A"
                ).toLocaleString();
                actionsSection = `
                <div class="mt-4 p-3 bg-green-50 rounded-lg border border-green-200">
                    <p class="text-gray-500 text-xs">Marked as replied on: ${replyDate}</p>
                    <button onclick="unmarkMessage('${message.id}')" class="mt-2 bg-yellow-500 hover:bg-yellow-600 text-white text-sm py-1 px-2 rounded-lg transition-colors duration-200">
                        Mark as Pending
                    </button>
                </div>`;
              }
              const card = document.createElement("div");
              card.classList.add(
                "bg-white",
                "p-4",
                "rounded-lg",
                "shadow-sm",
                "border",
                "border-gray-300"
              );
              card.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="font-bold text-gray-800 text-lg">${message.subject}</h3>
                        <p class="text-gray-700 text-sm">From: ${message.name} &lt;<a href="mailto:${message.email}" class="text-blue-600 hover:underline">${message.email}</a>&gt;</p>
                        <p class="text-gray-700 text-sm">Phone: <a href="tel:${message.phone}" class="text-blue-600 hover:underline">${message.phone}</a></p>
                        <p class="text-gray-500 text-xs mt-1">Received: ${formattedDate}</p>
                    </div>
                    ${statusBadge}
                </div>
                <p class="text-gray-600 text-base mb-4 border-t pt-3 mt-3">${message.message}</p>
                ${actionsSection}`;
              container.appendChild(card);
            });

            pagination.innerHTML = "";
            if (totalPages > 1) {
              const paginationNav = document.createElement("nav");
              paginationNav.className =
                "flex justify-center items-center space-x-2 mt-4";
              const createButton = (text, page, disabled, onClick) => {
                const btn = document.createElement("button");
                btn.textContent = text;
                btn.className = `px-3 py-1 rounded-lg text-sm transition-colors duration-200 ${
                  disabled
                    ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                    : page === currentPage
                    ? "bg-red-600 text-white"
                    : "bg-red-500 hover:bg-red-600 text-white"
                }`;
                btn.disabled = disabled;
                btn.addEventListener("click", onClick);
                return btn;
              };
              paginationNav.appendChild(
                createButton(
                  "Previous",
                  currentPage - 1,
                  currentPage === 1,
                  () => {
                    contactMessageCurrentPage--;
                    renderContactMessages(
                      contactMessageCurrentFilters,
                      contactMessageCurrentPage,
                      contactMessageItemsPerPage
                    );
                  }
                )
              );
              for (let i = 1; i <= totalPages; i++) {
                paginationNav.appendChild(
                  createButton(i, i, false, () => {
                    contactMessageCurrentPage = i;
                    renderContactMessages(
                      contactMessageCurrentFilters,
                      contactMessageCurrentPage,
                      contactMessageItemsPerPage
                    );
                  })
                );
              }
              paginationNav.appendChild(
                createButton(
                  "Next",
                  currentPage + 1,
                  currentPage === totalPages,
                  () => {
                    contactMessageCurrentPage++;
                    renderContactMessages(
                      contactMessageCurrentFilters,
                      contactMessageCurrentPage,
                      contactMessageItemsPerPage
                    );
                  }
                )
              );
              pagination.appendChild(paginationNav);
            }
          },
          (error) =>
            showMessage(`Error loading contact messages: ${error.message}.`)
        );
      };
      // --- END UPDATED function ---

      window.updateTeacherStatus = async (id, newStatus) => {
        if (!isAuthReady)
          return showMessage("Firebase not ready. Please try again.");
        try {
          await updateDoc(
            doc(db, "artifacts", appId, "public", "data", "teachers", id),
            { status: newStatus }
          );
          showMessage(`Teacher status updated to '${newStatus}'.`);
        } catch (error) {
          console.error("Error updating teacher status:", error);
          showMessage(`Failed to update teacher status: ${error.message}.`);
        }
      };

      window.editTeacher = async (id) => {
        if (!isAuthReady)
          return showMessage("Firebase not ready. Please try again.");
        try {
          const docSnap = await getDoc(
            doc(db, "artifacts", appId, "public", "data", "teachers", id)
          );
          if (!docSnap.exists()) return showMessage("Teacher not found.");
          const teacher = docSnap.data();
          document.getElementById("teacher-id").value = id;
          document.getElementById("teacher-name").value = teacher.name;
          document.getElementById("teacher-expertise").value =
            teacher.expertise;
          $("#teacher-bio").summernote("code", teacher.bio || "");
          document
            .getElementById("teacher-image-drop-zone")
            ._setImage(teacher.image || "");
          document.getElementById("add-teacher-btn").textContent =
            "Update Teacher";
          showMessage(
            "Form populated for editing. Update and submit to save changes."
          );
        } catch (error) {
          console.error("Error fetching teacher for edit:", error);
          showMessage(`Failed to load teacher for editing: ${error.message}.`);
        }
      };

      window.deleteTeacher = async (id) => {
        if (!isAuthReady)
          return showMessage("Firebase not ready. Please try again.");
        const messageBox = document.getElementById("message-box");
        const messageContent = document.getElementById("message-content");
        const closeMessageBoxBtn = document.getElementById("close-message-box");
        messageContent.textContent =
          "Are you sure you want to delete this teacher's profile? This action cannot be undone.";
        messageBox.classList.remove("hidden");

        const confirmDeleteBtn = document.createElement("button");
        confirmDeleteBtn.textContent = "Confirm Delete";
        confirmDeleteBtn.className =
          "bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 ml-2";
        confirmDeleteBtn.id = "confirm-delete-btn";
        messageBox.querySelector(".text-center").appendChild(confirmDeleteBtn);

        confirmDeleteBtn.addEventListener("click", async () => {
          try {
            await deleteDoc(
              doc(db, "artifacts", appId, "public", "data", "teachers", id)
            );
            showMessage("Teacher profile deleted successfully.");
          } catch (error) {
            console.error("Error deleting teacher:", error);
            showMessage(`Failed to delete teacher: ${error.message}.`);
          } finally {
            confirmDeleteBtn.remove();
            messageBox.classList.add("hidden");
          }
        });

        const originalCloseHandler = closeMessageBoxBtn.onclick;
        closeMessageBoxBtn.onclick = () => {
          confirmDeleteBtn.remove();
          messageBox.classList.add("hidden");
          if (originalCloseHandler) originalCloseHandler();
          closeMessageBoxBtn.onclick = originalCloseHandler;
        };
      };

      const renderTeachers = (filters, currentPage, itemsPerPage) => {
        if (!isAuthReady)
          return showMessage(
            "Teacher profiles cannot be loaded or managed because Firebase authentication is not ready. Please try refreshing the page."
          );
        const [container, pagination] = [
          document.getElementById("teachers-list-container"),
          document.getElementById("teacher-pagination"),
        ];
        if (!container || !pagination)
          return console.error("Teacher elements not found.");

        onSnapshot(
          collection(db, "artifacts", appId, "public", "data", "teachers"),
          (snapshot) => {
            [container, pagination].forEach((el) => (el.innerHTML = ""));
            let allTeachers = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            let filteredTeachers = allTeachers.filter(
              (t) =>
                (filters.status === "all" || t.status === filters.status) &&
                (filters.searchTerm === "" ||
                  t.name
                    .toLowerCase()
                    .includes(filters.searchTerm.toLowerCase()) ||
                  t.expertise
                    .toLowerCase()
                    .includes(filters.searchTerm.toLowerCase()) ||
                  (t.bio &&
                    t.bio
                      .toLowerCase()
                      .includes(filters.searchTerm.toLowerCase())))
            );
            filteredTeachers.sort(
              (a, b) =>
                (b.timestamp?.toDate() || new Date(0)).getTime() -
                (a.timestamp?.toDate() || new Date(0)).getTime()
            );

            const totalPages = Math.ceil(
              filteredTeachers.length / itemsPerPage
            );
            const paginatedTeachers = filteredTeachers.slice(
              (currentPage - 1) * itemsPerPage,
              currentPage * itemsPerPage
            );

            if (paginatedTeachers.length === 0)
              container.innerHTML =
                '<p class="text-gray-500 text-center col-span-full">No teachers found matching your criteria.</p>';

            paginatedTeachers.forEach((teacher) => {
              const card = document.createElement("div");
              card.classList.add(
                "bg-white",
                "p-4",
                "rounded-lg",
                "shadow-sm",
                "flex",
                "flex-col",
                "items-center",
                "text-center",
                "border",
                "border-gray-300"
              );
              card.innerHTML = `<img src="${
                teacher.image ||
                "https://placehold.co/100x100/9CA3AF/white?text=Teacher"
              }" alt="${
                teacher.name
              }" class="w-24 h-24 rounded-full object-cover mb-4" onerror="this.src='https://placehold.co/100x100/9CA3AF/white?text=Teacher'"><h3 class="font-bold text-gray-800 text-lg mb-1">${
                teacher.name
              }</h3><p class="text-red-600 text-sm mb-3">${
                teacher.expertise
              }</p><div class="flex flex-wrap gap-2 mt-auto">${
                teacher.status === "inactive"
                  ? `<button class="bg-green-600 hover:bg-green-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="updateTeacherStatus('${teacher.id}', 'active')">Activate</button>`
                  : `<button class="bg-orange-600 hover:bg-orange-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="updateTeacherStatus('${teacher.id}', 'inactive')">Deactivate</button>`
              }<button class="bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="editTeacher('${
                teacher.id
              }')">Edit</button><button class="bg-red-600 hover:bg-red-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="deleteTeacher('${
                teacher.id
              }')">Delete</button></div>`;
              container.appendChild(card);
            });

            pagination.innerHTML = "";
            if (totalPages > 1) {
              const paginationNav = document.createElement("nav");
              paginationNav.className =
                "flex justify-center items-center space-x-2 mt-4";
              const createButton = (text, page, disabled, onClick) => {
                const btn = document.createElement("button");
                btn.textContent = text;
                btn.className = `px-3 py-1 rounded-lg text-sm transition-colors duration-200 ${
                  disabled
                    ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                    : page === currentPage
                    ? "bg-red-600 text-white"
                    : "bg-gray-200 text-gray-700 hover:bg-gray-300"
                }`;
                btn.disabled = disabled;
                btn.addEventListener("click", onClick);
                return btn;
              };
              paginationNav.appendChild(
                createButton(
                  "Previous",
                  currentPage - 1,
                  currentPage === 1,
                  () => {
                    teacherCurrentPage--;
                    renderTeachers(filters, teacherCurrentPage, itemsPerPage);
                  }
                )
              );
              for (let i = 1; i <= totalPages; i++) {
                paginationNav.appendChild(
                  createButton(i, i, false, () => {
                    teacherCurrentPage = i;
                    renderTeachers(filters, teacherCurrentPage, itemsPerPage);
                  })
                );
              }
              paginationNav.appendChild(
                createButton(
                  "Next",
                  currentPage + 1,
                  currentPage === totalPages,
                  () => {
                    teacherCurrentPage++;
                    renderTeachers(filters, teacherCurrentPage, itemsPerPage);
                  }
                )
              );
              pagination.appendChild(paginationNav);
            }
          },
          (error) => showMessage(`Error loading teachers: ${error.message}.`)
        );
      };

      window.updateFreeResourceStatus = async (id, newStatus) => {
        if (!isAuthReady)
          return showMessage("Firebase not ready. Please try again.");
        try {
          await updateDoc(
            doc(db, "artifacts", appId, "public", "data", "freeResources", id),
            { status: newStatus }
          );
          showMessage(`Free resource status updated to '${newStatus}'.`);
        } catch (error) {
          console.error("Error updating free resource status:", error);
          showMessage(
            `Failed to update free resource status: ${error.message}.`
          );
        }
      };

      window.editFreeResource = async (id) => {
        if (!isAuthReady)
          return showMessage("Firebase not ready. Please try again.");
        try {
          const docSnap = await getDoc(
            doc(db, "artifacts", appId, "public", "data", "freeResources", id)
          );
          if (!docSnap.exists()) return showMessage("Free resource not found.");
          const resource = docSnap.data();
          document.getElementById("free-resource-id").value = id;
          document.getElementById("free-resource-title").value = resource.title;
          document.getElementById("free-resource-category").value =
            resource.category;
          document.getElementById("free-resource-link").value = resource.link;
          document.getElementById("free-resource-summary").value =
            resource.summary;
          document.getElementById(
            "free-resource-keypoints"
          ).value = Array.isArray(resource.keypoints)
            ? resource.keypoints.join("\n")
            : "";
          document
            .getElementById("free-resource-image-drop-zone")
            ._setImage(resource.img || "");
          document.getElementById("add-free-resource-btn").textContent =
            "Update Free Resource";
          showMessage(
            "Form populated for editing. Update and submit to save changes."
          );
        } catch (error) {
          console.error("Error fetching free resource for edit:", error);
          showMessage(
            `Failed to load free resource for editing: ${error.message}.`
          );
        }
      };

      window.deleteFreeResource = async (id) => {
        if (!isAuthReady)
          return showMessage("Firebase not ready. Please try again.");
        const messageBox = document.getElementById("message-box");
        const messageContent = document.getElementById("message-content");
        const closeMessageBoxBtn = document.getElementById("close-message-box");
        messageContent.textContent =
          "Are you sure you want to delete this free resource? This action cannot be undone.";
        messageBox.classList.remove("hidden");

        const confirmDeleteBtn = document.createElement("button");
        confirmDeleteBtn.textContent = "Confirm Delete";
        confirmDeleteBtn.className =
          "bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 ml-2";
        confirmDeleteBtn.id = "confirm-delete-btn";
        messageBox.querySelector(".text-center").appendChild(confirmDeleteBtn);

        confirmDeleteBtn.addEventListener("click", async () => {
          try {
            await deleteDoc(
              doc(db, "artifacts", appId, "public", "data", "freeResources", id)
            );
            showMessage("Free resource deleted successfully.");
          } catch (error) {
            console.error("Error deleting free resource:", error);
            showMessage(`Failed to delete free resource: ${error.message}.`);
          } finally {
            confirmDeleteBtn.remove();
            messageBox.classList.add("hidden");
          }
        });

        const originalCloseHandler = closeMessageBoxBtn.onclick;
        closeMessageBoxBtn.onclick = () => {
          confirmDeleteBtn.remove();
          messageBox.classList.add("hidden");
          if (originalCloseHandler) originalCloseHandler();
          closeMessageBoxBtn.onclick = originalCloseHandler;
        };
      };

      const renderFreeResources = (filters, currentPage, itemsPerPage) => {
        if (!isAuthReady)
          return showMessage(
            "Free resources cannot be loaded or managed because Firebase authentication is not ready. Please try refreshing the page."
          );
        const [container, pagination] = [
          document.getElementById("free-resources-list-container"),
          document.getElementById("free-resource-pagination"),
        ];
        if (!container || !pagination)
          return console.error("Free resource elements not found.");

        onSnapshot(
          collection(db, "artifacts", appId, "public", "data", "freeResources"),
          (snapshot) => {
            [container, pagination].forEach((el) => (el.innerHTML = ""));
            let allResources = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            let filteredResources = allResources.filter(
              (r) =>
                (filters.status === "all" || r.status === filters.status) &&
                (filters.category === "all categories" ||
                  r.category.toLowerCase() ===
                    filters.category.toLowerCase()) &&
                (filters.searchTerm === "" ||
                  r.title
                    .toLowerCase()
                    .includes(filters.searchTerm.toLowerCase()) ||
                  r.category
                    .toLowerCase()
                    .includes(filters.searchTerm.toLowerCase()) ||
                  (r.summary &&
                    r.summary
                      .toLowerCase()
                      .includes(filters.searchTerm.toLowerCase())))
            );
            filteredResources.sort(
              (a, b) =>
                (b.timestamp?.toDate() || new Date(0)).getTime() -
                (a.timestamp?.toDate() || new Date(0)).getTime()
            );

            const totalPages = Math.ceil(
              filteredResources.length / itemsPerPage
            );
            const paginatedResources = filteredResources.slice(
              (currentPage - 1) * itemsPerPage,
              currentPage * itemsPerPage
            );

            if (paginatedResources.length === 0)
              container.innerHTML =
                '<p class="text-gray-500 text-center col-span-full">No free resources found matching your criteria.</p>';

            paginatedResources.forEach((resource) => {
              const formattedDate = (
                resource.timestamp?.toDate() || new Date()
              ).toLocaleDateString("en-US", {
                year: "numeric",
                month: "short",
                day: "numeric",
              });
              const card = document.createElement("div");
              card.classList.add(
                "bg-white",
                "p-4",
                "rounded-lg",
                "shadow-sm",
                "flex",
                "flex-col",
                "border",
                "border-gray-300"
              );
              card.innerHTML = `<img src="${
                resource.img ||
                "https://placehold.co/400x200/cccccc/white?text=Resource+Image"
              }" alt="${
                resource.title
              }" class="w-full h-36 object-cover rounded-md mb-4" onerror="this.src='https://placehold.co/400x200/cccccc/white?text=Resource+Image'"><h3 class="font-bold text-gray-800 text-lg mb-1">${
                resource.title
              }</h3><p class="text-red-600 text-sm mb-2">${
                resource.category
              }</p><p class="text-gray-500 text-xs mb-3">${formattedDate}</p><div class="flex flex-wrap gap-2 mt-auto">${
                resource.status === "inactive"
                  ? `<button class="bg-green-600 hover:bg-green-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="updateFreeResourceStatus('${resource.id}', 'active')">Activate</button>`
                  : `<button class="bg-orange-600 hover:bg-orange-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="updateFreeResourceStatus('${resource.id}', 'inactive')">Deactivate</button>`
              }<button class="bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="editFreeResource('${
                resource.id
              }')">Edit</button><button class="bg-red-600 hover:bg-red-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="deleteFreeResource('${
                resource.id
              }')">Delete</button></div>`;
              container.appendChild(card);
            });

            pagination.innerHTML = "";
            if (totalPages > 1) {
              const paginationNav = document.createElement("nav");
              paginationNav.className =
                "flex justify-center items-center space-x-2 mt-4";
              const createButton = (text, page, disabled, onClick) => {
                const btn = document.createElement("button");
                btn.textContent = text;
                btn.className = `px-3 py-1 rounded-lg text-sm transition-colors duration-200 ${
                  disabled
                    ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                    : page === currentPage
                    ? "bg-red-600 text-white"
                    : "bg-gray-200 text-gray-700 hover:bg-gray-300"
                }`;
                btn.disabled = disabled;
                btn.addEventListener("click", onClick);
                return btn;
              };
              paginationNav.appendChild(
                createButton(
                  "Previous",
                  currentPage - 1,
                  currentPage === 1,
                  () => {
                    freeResourceCurrentPage--;
                    renderFreeResources(
                      filters,
                      freeResourceCurrentPage,
                      freeResourceItemsPerPage
                    );
                  }
                )
              );
              for (let i = 1; i <= totalPages; i++) {
                paginationNav.appendChild(
                  createButton(i, i, false, () => {
                    freeResourceCurrentPage = i;
                    renderFreeResources(
                      filters,
                      freeResourceCurrentPage,
                      freeResourceItemsPerPage
                    );
                  })
                );
              }
              paginationNav.appendChild(
                createButton(
                  "Next",
                  currentPage + 1,
                  currentPage === totalPages,
                  () => {
                    freeResourceCurrentPage++;
                    renderFreeResources(
                      filters,
                      freeResourceCurrentPage,
                      freeResourceItemsPerPage
                    );
                  }
                )
              );
              pagination.appendChild(paginationNav);
            }
          },
          (error) =>
            showMessage(`Error loading free resources: ${error.message}.`)
        );
      };

      const getCollectionCount = async (collectionName, queryConstraints = []) => {
        try {
            const collRef = collection(db, "artifacts", appId, "public", "data", collectionName);
            const q = query(collRef, ...queryConstraints);
            const snapshot = await getDocs(q);
            return snapshot.size;
        } catch (error) {
            console.error(`Error getting count for ${collectionName}:`, error);
            // Don't show a message for every failed count, just log it.
            return 0;
        }
      };

      const updateDashboardStats = async () => {
        // Fetch all stats in parallel for efficiency
        const [
            pendingForumPosts,
            pendingTestimonials,
            pendingMessages,
            pendingSpeakingRequests,
            totalBlogPosts,
            totalTeachers,
            totalResources,
            totalForumPosts
        ] = await Promise.all([
            getCollectionCount('posts', [where('status', '==', 'pending')]),
            getCollectionCount('testimonials', [where('status', '==', 'pending')]),
            getCollectionCount('contactMessages', [where('status', '==', 'pending')]),
            getCollectionCount('speakingSessionRequests', [where('status', '==', 'pending')]),
            getCollectionCount('blogPosts'),
            getCollectionCount('teachers'),
            getCollectionCount('freeResources'),
            getCollectionCount('posts')
        ]);

        // Helper to update text content and remove loading animation
        const updateStat = (elementId, value) => {
            const el = document.getElementById(elementId);
            if (el) {
                el.textContent = value;
                el.classList.remove('animate-pulse');
            }
        };

        // Update main stat cards
        updateStat('pending-posts-stat', pendingForumPosts);
        updateStat('pending-testimonials-stat', pendingTestimonials);
        updateStat('pending-messages-stat', pendingMessages);
        updateStat('pending-speaking-requests-stat', pendingSpeakingRequests);
        
        // Update content overview stats
        updateStat('total-blog-posts-stat', totalBlogPosts);
        updateStat('total-teachers-stat', totalTeachers);
        updateStat('total-resources-stat', totalResources);
        updateStat('total-forum-posts-stat', totalForumPosts);
      };

      const renderRecentDashboardMessages = async () => {
        const container = document.getElementById('dashboard-messages-list');
        if (!container) return;

        try {
            const messagesRef = collection(db, "artifacts", appId, "public", "data", "contactMessages");
            // The original query for recent messages required a composite index in Firestore, which can cause errors if not set up.
            // This updated approach fetches the 25 most recent messages regardless of status,
            // then filters them on the client-side to find the 5 most recent 'pending' ones.
            // This is a robust workaround that avoids the need for a specific index.
            const q = query(messagesRef, orderBy('timestamp', 'desc'), limit(25));
            const snapshot = await getDocs(q);

            container.innerHTML = ''; // Clear "Loading..."
            
            const pendingMessages = snapshot.docs
                .map(doc => doc.data())
                .filter(message => message.status === 'pending')
                .slice(0, 5); // Get the 5 most recent pending messages

            if (pendingMessages.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm text-center">No pending messages.</p>';
                return;
            }

            pendingMessages.forEach(message => {
                const relativeTime = formatRelativeTime(message.timestamp);
                const initial = message.name ? message.name.charAt(0).toUpperCase() : '?';
                const messageHtml = `
                    <div class="flex items-start">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center mr-3">
                            <span class="text-gray-600 font-semibold">${initial}</span>
                        </div>
                        <div class="flex-1 overflow-hidden">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-semibold text-gray-800 truncate">${message.name}</span>
                                <span class="text-xs text-gray-500 flex-shrink-0 ml-2">${relativeTime}</span>
                            </div>
                            <p class="text-gray-600 text-sm truncate">${message.subject}</p>
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', messageHtml);
            });
        } catch (error) {
            console.error("Error loading recent messages for dashboard:", error);
            container.innerHTML = '<p class="text-red-500 text-sm text-center">Could not load messages.</p>';
        }
      }

      // --- NEW: Speaking Session Request Management Functions ---
      window.updateSpeakingRequestStatus = async (requestId, newStatus) => {
        if (!isAuthReady) return showMessage("Firebase not ready. Please try again.");
        try {
            await updateDoc(doc(db, "artifacts", appId, "public", "data", "speakingSessionRequests", requestId), {
                status: newStatus,
            });
            showMessage(`Request status updated to '${newStatus}'.`);
        } catch (error) {
            console.error("Error updating request status:", error);
            showMessage(`Failed to update request status: ${error.message}.`);
        }
      };

      window.deleteSpeakingRequest = async (requestId) => {
          if (!isAuthReady) return showMessage("Firebase not ready. Please try again.");
      
          const messageBox = document.getElementById("message-box");
          const messageContent = document.getElementById("message-content");
          const closeMessageBoxBtn = document.getElementById("close-message-box");
          messageContent.textContent = "Are you sure you want to delete this speaking request? This action cannot be undone.";
          messageBox.classList.remove("hidden");
      
          const confirmDeleteBtn = document.createElement("button");
          confirmDeleteBtn.textContent = "Confirm Delete";
          confirmDeleteBtn.className = "bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 ml-2";
          confirmDeleteBtn.id = "confirm-delete-btn";
          messageBox.querySelector('.text-center').appendChild(confirmDeleteBtn);
      
          confirmDeleteBtn.addEventListener('click', async () => {
              try {
                  await deleteDoc(doc(db, "artifacts", appId, "public", "data", "speakingSessionRequests", requestId));
                  showMessage("Speaking request deleted successfully.");
              } catch (error) {
                  console.error("Error deleting speaking request:", error);
                  showMessage(`Failed to delete request: ${error.message}.`);
              } finally {
                  confirmDeleteBtn.remove();
                  messageBox.classList.add("hidden");
              }
          });
      
          const originalCloseHandler = closeMessageBoxBtn.onclick;
          closeMessageBoxBtn.onclick = () => {
              confirmDeleteBtn.remove();
              messageBox.classList.add("hidden");
              if (originalCloseHandler) originalCloseHandler();
              closeMessageBoxBtn.onclick = originalCloseHandler;
          };
      };

      const renderSpeakingRequests = (filters, currentPage, itemsPerPage) => {
        if (!isAuthReady) return showMessage("Speaking requests cannot be loaded because Firebase authentication is not ready. Please try refreshing the page.");
        const [container, pagination] = [
            document.getElementById("speaking-requests-list"),
            document.getElementById("speaking-request-pagination"),
        ];
        if (!container || !pagination) return console.error("Speaking request elements not found.");
    
        onSnapshot(collection(db, "artifacts", appId, "public", "data", "speakingSessionRequests"), (snapshot) => {
            [container, pagination].forEach((el) => (el.innerHTML = ""));
            let allRequests = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
            let filteredRequests = allRequests.filter(
                (r) =>
                (filters.status === "all" || r.status === filters.status) &&
                (filters.searchTerm === "" ||
                    (r.userName && r.userName.toLowerCase().includes(filters.searchTerm.toLowerCase())) ||
                    (r.userEmail && r.userEmail.toLowerCase().includes(filters.searchTerm.toLowerCase())) ||
                    (r.mobilePhone && r.mobilePhone.toLowerCase().includes(filters.searchTerm.toLowerCase())))
            );
            filteredRequests.sort((a, b) => (b.submittedAt?.toDate() || new Date(0)).getTime() - (a.submittedAt?.toDate() || new Date(0)).getTime());
    
            const totalPages = Math.ceil(filteredRequests.length / itemsPerPage);
            const paginatedRequests = filteredRequests.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
    
            if (paginatedRequests.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center col-span-full">No speaking requests found matching your criteria.</p>';
                return;
            }
    
            paginatedRequests.forEach((request) => {
                const formattedDate = (request.submittedAt?.toDate() || new Date()).toLocaleString();
                let statusBadge = "";
                switch (request.status) {
                    case "pending":
                        statusBadge = '<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-semibold">Pending</span>';
                        break;
                    case "confirmed":
                        statusBadge = '<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-semibold">Confirmed</span>';
                        break;
                    case "completed":
                        statusBadge = '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-semibold">Completed</span>';
                        break;
                    case "cancelled":
                        statusBadge = '<span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-semibold">Cancelled</span>';
                        break;
                    default:
                        statusBadge = '<span class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-xs font-semibold">Unknown</span>';
                }
    
                const card = document.createElement("div");
                card.className = "bg-white p-4 rounded-lg shadow-sm border border-gray-300";
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">${request.userName}</h3>
                            <p class="text-gray-700 text-sm">Email: <a href="mailto:${request.userEmail}" class="text-blue-600 hover:underline">${request.userEmail}</a></p>
                            <p class="text-gray-700 text-sm">Phone: <a href="tel:${request.mobilePhone}" class="text-blue-600 hover:underline">${request.mobilePhone}</a></p>
                            <p class="text-gray-600 text-sm font-semibold mt-1">Preferred Slot: ${request.preferredDate} at ${request.preferredTime}</p>
                            <p class="text-gray-500 text-xs mt-1">Submitted: ${formattedDate}</p>
                        </div>
                        ${statusBadge}
                    </div>
                    ${request.notes ? `<p class="text-gray-600 text-base mb-4 border-t pt-3 mt-3"><strong>Notes:</strong> ${request.notes}</p>` : ''}
                    <div class="flex flex-wrap gap-2 mt-4">
                        <button onclick="updateSpeakingRequestStatus('${request.id}', 'confirmed')" class="bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200">Confirm</button>
                        <button onclick="updateSpeakingRequestStatus('${request.id}', 'completed')" class="bg-green-600 hover:bg-green-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200">Complete</button>
                        <button onclick="updateSpeakingRequestStatus('${request.id}', 'cancelled')" class="bg-yellow-500 hover:bg-yellow-600 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200">Cancel</button>
                        <button onclick="deleteSpeakingRequest('${request.id}')" class="bg-red-600 hover:bg-red-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200">Delete</button>
                    </div>`;
                container.appendChild(card);
            });
    
            pagination.innerHTML = "";
            if (totalPages > 1) {
                const paginationNav = document.createElement("nav");
                paginationNav.className = "flex justify-center items-center space-x-2 mt-4";
                const createButton = (text, page, disabled, onClick) => {
                    const btn = document.createElement("button");
                    btn.textContent = text;
                    btn.className = `px-3 py-1 rounded-lg text-sm transition-colors duration-200 ${
                      disabled
                        ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                        : page === currentPage
                        ? "bg-red-600 text-white"
                        : "bg-red-500 hover:bg-red-600 text-white"
                    }`;
                    btn.disabled = disabled;
                    btn.addEventListener("click", onClick);
                    return btn;
                };
                paginationNav.appendChild(createButton("Previous", currentPage - 1, currentPage === 1, () => {
                    speakingRequestCurrentPage--;
                    renderSpeakingRequests(filters, speakingRequestCurrentPage, itemsPerPage);
                }));
                for (let i = 1; i <= totalPages; i++) {
                    paginationNav.appendChild(createButton(i, i, false, () => {
                        speakingRequestCurrentPage = i;
                        renderSpeakingRequests(filters, speakingRequestCurrentPage, itemsPerPage);
                    }));
                }
                paginationNav.appendChild(createButton("Next", currentPage + 1, currentPage === totalPages, () => {
                    speakingRequestCurrentPage++;
                    renderSpeakingRequests(filters, speakingRequestCurrentPage, itemsPerPage);
                }));
                pagination.appendChild(paginationNav);
            }
        }, (error) => showMessage(`Error loading speaking requests: ${error.message}.`));
      };
      // --- END NEW Functions ---

      let overviewChartInstance = null;
      const renderDashboardChart = async () => { // Renaming renderCharts
        const ctx = document.getElementById("overviewChart");
        if (!ctx) return;

        const [
            blogCount,
            teacherCount,
            testimonialCount,
            resourceCount,
            forumPostCount
        ] = await Promise.all([
            getCollectionCount('blogPosts'),
            getCollectionCount('teachers'),
            getCollectionCount('testimonials'),
            getCollectionCount('freeResources'),
            getCollectionCount('posts')
        ]);
        
        const chartData = {
            labels: ['Blog Posts', 'Teachers', 'Testimonials', 'Resources', 'Forum Posts'],
            datasets: [{
                label: 'Content Count',
                data: [blogCount, teacherCount, testimonialCount, resourceCount, forumPostCount],
                backgroundColor: [
                  'rgba(239, 68, 68, 0.8)', // red-500
                  'rgba(59, 130, 246, 0.8)', // blue-500
                  'rgba(16, 185, 129, 0.8)', // green-500
                  'rgba(245, 158, 11, 0.8)', // amber-500
                  'rgba(139, 92, 246, 0.8)' // violet-500
                ],
                borderColor: '#ffffff',
                borderWidth: 2,
                hoverOffset: 4
            }]
        };

        if (overviewChartInstance) {
            overviewChartInstance.destroy();
        }

        overviewChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            boxWidth: 12,
                            font: {
                                size: 14,
                                family: 'Inter, sans-serif'
                            },
                            color: '#4B5563' // gray-600
                        }
                    },
                    tooltip: {
                         bodyFont: {
                            family: 'Inter, sans-serif'
                         },
                         titleFont: {
                            family: 'Inter, sans-serif'
                         }
                    }
                }
            }
        });
      };

      // Helper for formatting time (already exists, ensuring it's available)
      function formatRelativeTime(timestamp) {
        if (!timestamp) return "N/A";
        const date = timestamp.toDate ? timestamp.toDate() : timestamp;
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);

        if (seconds < 60) return seconds <= 0 ? "Just now" : `${seconds}s ago`;
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes}m ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h ago`;

        const yesterday = new Date(now);
        yesterday.setDate(now.getDate() - 1);
        if (
          date.getDate() === yesterday.getDate() &&
          date.getMonth() === yesterday.getMonth() &&
          date.getFullYear() === yesterday.getFullYear()
        ) {
          return `Yesterday at ${new Intl.DateTimeFormat("en-US", {
            hour: "numeric",
            minute: "numeric",
            hour12: true,
          }).format(date)}`;
        }

        if (date.getFullYear() === now.getFullYear()) {
          return new Intl.DateTimeFormat("en-US", {
            month: "short",
            day: "numeric",
            hour: "numeric",
            minute: "numeric",
            hour12: true,
          }).format(date);
        }

        return new Intl.DateTimeFormat("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
        }).format(date);
      }

      // Admin functions for Forum Posts
      // Removed addForumPost as per user request

      window.updateForumPost = async (postId, updatedData) => {
        if (!isAuthReady) {
          showMessage("Firebase not ready. Please try again.");
          return;
        }
        try {
          await updateDoc(
            doc(db, `artifacts/${appId}/public/data/posts`, postId),
            updatedData
          );
          showMessage("Forum post updated successfully!", "success");
        } catch (error) {
          console.error("Error updating forum post:", error);
          showMessage(`Failed to update forum post: ${error.message}.`);
        }
      };

      window.deleteForumPost = async (postId) => {
        if (!isAuthReady) {
          showMessage("Firebase not ready. Please try again.");
          return;
        }
        const messageBox = document.getElementById("message-box");
        const messageContent = document.getElementById("message-content");
        const closeMessageBoxBtn = document.getElementById("close-message-box");

        messageContent.textContent =
          "Are you sure you want to delete this forum post and all its comments? This action cannot be undone.";
        messageBox.classList.remove("hidden");

        const confirmDeleteBtn = document.createElement("button");
        confirmDeleteBtn.textContent = "Confirm Delete";
        confirmDeleteBtn.className =
          "bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 ml-2";
        confirmDeleteBtn.id = "confirm-delete-btn";
        messageBox.querySelector(".text-center").appendChild(confirmDeleteBtn);

        confirmDeleteBtn.addEventListener("click", async () => {
          try {
            const batch = writeBatch(db);
            batch.delete(
              doc(db, `artifacts/${appId}/public/data/posts`, postId)
            );
            // Also delete associated comments
            const commentsQuery = query(
              collection(db, `artifacts/${appId}/public/data/comments`),
              where("postId", "==", postId)
            );
            const commentsSnapshot = await getDocs(commentsQuery);
            commentsSnapshot.forEach((commentDoc) =>
              batch.delete(commentDoc.ref)
            );

            await batch.commit();
            showMessage(
              "Forum post and comments deleted successfully!",
              "success"
            );
          } catch (error) {
            console.error("Error deleting forum post:", error);
            showMessage(`Failed to delete forum post: ${error.message}.`);
          } finally {
            confirmDeleteBtn.remove();
            messageBox.classList.add("hidden");
          }
        });

        const originalCloseHandler = closeMessageBoxBtn.onclick;
        closeMessageBoxBtn.onclick = () => {
          confirmDeleteBtn.remove();
          messageBox.classList.add("hidden");
          if (originalCloseHandler) originalCloseHandler();
          closeMessageBoxBtn.onclick = originalCloseHandler;
        };
      };

      window.updateForumPostStatus = async (postId, newStatus) => {
        if (!isAuthReady) {
          showMessage("Firebase not ready. Please try again.");
          return;
        }
        closeAllKebabDropdowns(); // Close any open kebab menus
        try {
          await updateDoc(
            doc(db, `artifacts/${appId}/public/data/posts`, postId),
            { status: newStatus }
          );
          showMessage(`Forum post status updated to '${newStatus}'!`, "info");
        } catch (error) {
          console.error("Error updating post status:", error);
          showMessage(`Failed to update post status: ${error.message}.`);
        }
      };

      // Admin functions for Forum Comments
      window.updateForumComment = async (commentId, updatedContent) => {
        if (!isAuthReady) {
          showMessage("Firebase not ready. Please try again.");
          return;
        }
        try {
          await updateDoc(
            doc(db, `artifacts/${appId}/public/data/comments`, commentId),
            { content: updatedContent }
          );
          showMessage("Forum comment updated successfully!", "success");
        } catch (error) {
          console.error("Error updating forum comment:", error);
          showMessage(`Failed to update forum comment: ${error.message}.`);
        }
      };

      window.deleteForumComment = async (commentId, postId) => {
        if (!isAuthReady) {
          showMessage("Firebase not ready. Please try again.");
          return;
        }
        const messageBox = document.getElementById("message-box");
        const messageContent = document.getElementById("message-content");
        const closeMessageBoxBtn = document.getElementById("close-message-box");

        messageContent.textContent =
          "Are you sure you want to delete this forum comment and its replies? This action cannot be undone.";
        messageBox.classList.remove("hidden");

        const confirmDeleteBtn = document.createElement("button");
        confirmDeleteBtn.textContent = "Confirm Delete";
        confirmDeleteBtn.className =
          "bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 ml-2";
        confirmDeleteBtn.id = "confirm-delete-btn";
        messageBox.querySelector(".text-center").appendChild(confirmDeleteBtn);

        confirmDeleteBtn.addEventListener("click", async () => {
          try {
            const batch = writeBatch(db);
            batch.delete(
              doc(db, `artifacts/${appId}/public/data/comments`, commentId)
            );
            // Optionally, delete nested replies if they are structured with parentId
            const nestedRepliesQuery = query(
              collection(db, `artifacts/${appId}/public/data/comments`),
              where("parentId", "==", commentId)
            );
            const nestedRepliesSnapshot = await getDocs(nestedRepliesQuery);
            nestedRepliesSnapshot.forEach((nestedReplyDoc) =>
              batch.delete(nestedReplyDoc.ref)
            );

            await batch.commit();
            showMessage("Forum comment deleted successfully!", "success");
          } catch (error) {
            console.error("Error deleting forum comment:", error);
            showMessage(`Failed to delete forum comment: ${error.message}.`);
          } finally {
            confirmDeleteBtn.remove();
            messageBox.classList.add("hidden");
          }
        });

        const originalCloseHandler = closeMessageBoxBtn.onclick;
        closeMessageBoxBtn.onclick = () => {
          confirmDeleteBtn.remove();
          messageBox.classList.add("hidden");
          if (originalCloseHandler) originalCloseHandler();
          closeMessageBoxBtn.onclick = originalCloseHandler;
        };
      };

      const renderCommunityForumPosts = (
        filters,
        currentPage,
        itemsPerPage
      ) => {
        if (!isAuthReady) {
          showMessage(
            "Forum posts cannot be loaded because Firebase authentication is not ready. Please try refreshing the page."
          );
          return;
        }
        const container = document.getElementById("forum-posts-list-container");
        const paginationContainer = document.getElementById(
          "forum-posts-pagination"
        );
        if (!container || !paginationContainer) {
          console.error("Forum posts elements not found.");
          return;
        }

        onSnapshot(
          collection(db, `artifacts/${appId}/public/data/posts`),
          (snapshot) => {
            container.innerHTML = "";
            paginationContainer.innerHTML = "";
            let allPosts = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));

            let filteredPosts = allPosts.filter((post) => {
              const matchesStatus =
                filters.status === "all" || post.status === filters.status;
              const matchesCategory =
                filters.category === "all categories" ||
                post.category === filters.category;
              const matchesSearch =
                filters.searchTerm === "" ||
                post.title
                  .toLowerCase()
                  .includes(filters.searchTerm.toLowerCase()) ||
                post.content
                  .toLowerCase()
                  .includes(filters.searchTerm.toLowerCase()) ||
                post.authorName
                  .toLowerCase()
                  .includes(filters.searchTerm.toLowerCase());
              return matchesStatus && matchesCategory && matchesSearch;
            });

            filteredPosts.sort(
              (a, b) =>
                (b.createdAt?.toDate() || new Date(0)) -
                (a.createdAt?.toDate() || new Date(0))
            );

            const totalPages = Math.ceil(filteredPosts.length / itemsPerPage);
            const paginatedPosts = filteredPosts.slice(
              (currentPage - 1) * itemsPerPage,
              currentPage * itemsPerPage
            );

            if (paginatedPosts.length === 0) {
              container.innerHTML =
                '<p class="text-gray-500 text-center col-span-full">No forum posts found matching your criteria.</p>';
            } else {
              paginatedPosts.forEach((post) => {
                const formattedTime = formatRelativeTime(post.createdAt);
                let statusBadgeClass = "";
                let statusText = "";
                switch (post.status) {
                  case "pending":
                    statusBadgeClass = "bg-yellow-100 text-yellow-800";
                    statusText = "Pending";
                    break;
                  case "approved":
                    statusBadgeClass = "bg-green-100 text-green-800";
                    statusText = "Approved";
                    break;
                  case "rejected":
                    statusBadgeClass = "bg-red-100 text-red-800";
                    statusText = "Rejected";
                    break;
                  default:
                    statusBadgeClass = "bg-gray-100 text-gray-800";
                    statusText = "Unknown";
                }

                const postCard = document.createElement("div");
                postCard.className =
                  "bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200 relative"; // Added relative for kebab menu
                postCard.innerHTML = `
                <h4 class="font-bold text-gray-800 text-lg mb-2">${
                  post.title
                }</h4>
                <p class="text-gray-600 text-sm mb-2 line-clamp-2">${
                  post.content
                }</p>
                <div class="flex flex-wrap items-center text-xs text-gray-500 mb-2">
                    <span class="mr-2">By: ${post.authorName}</span>
                    <span class="mr-2">Category: ${post.category}</span>
                    ${
                      post.subCategory
                        ? `<span class="mr-2">Subcategory: ${post.subCategory}</span>`
                        : ""
                    }
                    <span>${formattedTime}</span>
                    <span class="ml-auto px-2 py-1 rounded-full text-xs font-semibold ${statusBadgeClass}">${statusText}</span>
                </div>
                <div class="kebab-menu-container absolute top-4 right-4">
                    <button class="kebab-button text-gray-500 hover:text-gray-700" aria-label="Post actions" data-post-id="${
                      post.id
                    }"><i class="fas fa-ellipsis-v"></i></button>
                    <div class="kebab-dropdown">
                        <button onclick="editForumPost('${
                          post.id
                        }')"><i class="fas fa-edit"></i> Edit</button>
                        <button onclick="deleteForumPost('${
                          post.id
                        }')"><i class="fas fa-trash-alt"></i> Delete</button>
                        ${
                          post.status !== "approved"
                            ? `<button onclick="updateForumPostStatus('${post.id}', 'approved')"><i class="fas fa-check-circle"></i> Approve</button>`
                            : ""
                        }
                        ${
                          post.status !== "pending"
                            ? `<button onclick="updateForumPostStatus('${post.id}', 'pending')"><i class="fas fa-hourglass-half"></i> Mark Pending</button>`
                            : ""
                        }
                        ${
                          post.status !== "rejected"
                            ? `<button onclick="updateForumPostStatus('${post.id}', 'rejected')"><i class="fas fa-times-circle"></i> Reject</button>`
                            : ""
                        }
                    </div>
                </div>
              `;
                container.appendChild(postCard);
              });

              // Attach event listeners for kebab menus after they are rendered
              document.querySelectorAll(".kebab-button").forEach((button) => {
                button.addEventListener("click", (event) => {
                    const dropdown = button.nextElementSibling;
                    const wasActive = dropdown.classList.contains('active');
                    
                    // First, close all dropdowns.
                    closeAllKebabDropdowns();
                    
                    // If the one we clicked wasn't active, open it.
                    if (!wasActive) {
                        dropdown.classList.add('active');
                    }
                });
              });
            }

            if (totalPages > 1) {
              const paginationNav = document.createElement("nav");
              paginationNav.className =
                "flex justify-center items-center space-x-2 mt-4";
              const createButton = (text, page, disabled, onClick) => {
                const btn = document.createElement("button");
                btn.textContent = text;
                btn.className = `px-3 py-1 rounded-lg text-sm transition-colors duration-200 ${
                  disabled
                    ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                    : page === currentPage
                    ? "bg-red-600 text-white"
                    : "bg-gray-200 text-gray-700 hover:bg-gray-300"
                }`;
                btn.disabled = disabled;
                btn.addEventListener("click", onClick);
                return btn;
              };
              paginationNav.appendChild(
                createButton(
                  "Previous",
                  currentPage - 1,
                  currentPage === 1,
                  () => {
                    forumPostsCurrentPage--;
                    renderCommunityForumPosts(
                      filters,
                      forumPostsCurrentPage,
                      itemsPerPage
                    );
                  }
                )
              );
              for (let i = 1; i <= totalPages; i++) {
                paginationNav.appendChild(
                  createButton(i, i, false, () => {
                    forumPostsCurrentPage = i;
                    renderCommunityForumPosts(
                      filters,
                      forumPostsCurrentPage,
                      itemsPerPage
                    );
                  })
                );
              }
              paginationNav.appendChild(
                createButton(
                  "Next",
                  currentPage + 1,
                  currentPage === totalPages,
                  () => {
                    forumPostsCurrentPage++;
                    renderCommunityForumPosts(
                      filters,
                      forumPostsCurrentPage,
                      itemsPerPage
                    );
                  }
                )
              );
              paginationContainer.appendChild(paginationNav);
            }
          },
          (error) => showMessage(`Error loading forum posts: ${error.message}.`)
        );
      };

      window.editForumPost = async (postId) => {
        if (!isAuthReady) {
          showMessage("Firebase not ready. Please try again.");
          return;
        }
        closeAllKebabDropdowns(); // Close any open kebab menus
        try {
          const docSnap = await getDoc(
            doc(db, `artifacts/${appId}/public/data/posts`, postId)
          );
          if (!docSnap.exists()) {
            showMessage("Forum post not found.");
            return;
          }
          const post = docSnap.data();

          // Create a temporary modal or form to edit the post
          const editModalHtml = `
            <div id="edit-post-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-[1000]">
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full">
                    <h3 class="text-xl font-bold mb-4">Edit Forum Post</h3>
                    <input type="hidden" id="edit-post-id" value="${postId}">
                    <div class="mb-4">
                        <label for="edit-post-title-input" class="block text-gray-700 text-sm font-semibold mb-2">Title</label>
                        <input type="text" id="edit-post-title-input" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" value="${
                          post.title
                        }" required>
                    </div>
                    <div class="mb-4">
                        <label for="edit-post-content-input" class="block text-gray-700 text-sm font-semibold mb-2">Content</label>
                        <textarea id="edit-post-content-input" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500 h-32" required>${
                          post.content
                        }</textarea>
                    </div>
                    <div class="mb-4">
                        <label for="edit-post-category-select" class="block text-gray-700 text-sm font-semibold mb-2">Category</label>
                        <select id="edit-post-category-select" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                            ${FORUM_CATEGORIES_DATA.map(
                              (cat) =>
                                `<option value="${cat.name}" ${
                                  post.category === cat.name ? "selected" : ""
                                }>${cat.name}</option>`
                            ).join("")}
                        </select>
                    </div>
                    <div id="edit-post-subcategory-container" class="mb-4 ${
                      post.subCategory ? "" : "hidden"
                    }">
                        <label for="edit-post-sub-category-select" class="block text-gray-700 text-sm font-semibold mb-2">Subcategory (Optional)</label>
                        <select id="edit-post-sub-category-select" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500">
                            <option value="">Select a Subcategory</option>
                            ${(
                              FORUM_CATEGORIES_DATA.find(
                                (c) => c.name === post.category
                              )?.subcategories || []
                            )
                              .map(
                                (sub) =>
                                  `<option value="${sub}" ${
                                    post.subCategory === sub ? "selected" : ""
                                  }>${sub}</option>`
                              )
                              .join("")}
                        </select>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button id="cancel-edit-post-modal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors duration-200">Cancel</button>
                        <button id="save-edit-post-changes" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Save Changes</button>
                    </div>
                </div>
            </div>
          `;
          document.body.insertAdjacentHTML("beforeend", editModalHtml);

          const editPostModal = document.getElementById("edit-post-modal");
          const editPostTitleInput = document.getElementById(
            "edit-post-title-input"
          );
          const editPostContentInput = document.getElementById(
            "edit-post-content-input"
          );
          const editPostCategorySelect = document.getElementById(
            "edit-post-category-select"
          );
          const editPostSubCategorySelect = document.getElementById(
            "edit-post-sub-category-select"
          );
          const editPostSubCategoryContainer = document.getElementById(
            "edit-post-subcategory-container"
          );

          // Handle subcategory dropdown change
          editPostCategorySelect.onchange = () => {
            const selectedCategory = FORUM_CATEGORIES_DATA.find(
              (cat) => cat.name === editPostCategorySelect.value
            );
            editPostSubCategorySelect.innerHTML =
              '<option value="">Select a Subcategory</option>';
            if (selectedCategory?.subcategories?.length) {
              editPostSubCategoryContainer.classList.remove("hidden");
              selectedCategory.subcategories.forEach((sub) => {
                const option = document.createElement("option");
                option.value = sub;
                option.textContent = sub;
                editPostSubCategorySelect.appendChild(option);
              });
            } else {
              editPostSubCategoryContainer.classList.add("hidden");
            }
          };
          // Trigger initial subcategory population
          editPostCategorySelect.dispatchEvent(new Event("change"));

          document.getElementById("cancel-edit-post-modal").onclick = () =>
            editPostModal.remove();
          document.getElementById(
            "save-edit-post-changes"
          ).onclick = async () => {
            const newTitle = editPostTitleInput.value.trim();
            const newContent = editPostContentInput.value.trim();
            const newCategory = editPostCategorySelect.value;
            const newSubCategory = editPostSubCategorySelect.value || null;

            if (!newTitle || !newContent || !newCategory) {
              showMessage(
                "Title, Content, and Category cannot be empty.",
                "error"
              );
              return;
            }
            await window.updateForumPost(postId, {
              title: newTitle,
              content: newContent,
              category: newCategory,
              subCategory: newSubCategory,
            });
            editPostModal.remove();
          };
        } catch (error) {
          console.error("Error fetching forum post for edit:", error);
          showMessage(
            `Failed to load forum post for editing: ${error.message}.`
          );
        }
      };

      const renderCommunityForumComments = (
        filters,
        currentPage,
        itemsPerPage
      ) => {
        if (!isAuthReady) {
          showMessage(
            "Forum comments cannot be loaded because Firebase authentication is not ready. Please try refreshing the page."
          );
          return;
        }
        const container = document.getElementById(
          "forum-comments-list-container"
        );
        const paginationContainer = document.getElementById(
          "forum-comments-pagination"
        );
        if (!container || !paginationContainer) {
          console.error("Forum comments elements not found.");
          return;
        }

        onSnapshot(
          collection(db, `artifacts/${appId}/public/data/comments`),
          (snapshot) => {
            container.innerHTML = "";
            paginationContainer.innerHTML = "";
            let allComments = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));

            let filteredComments = allComments.filter((comment) => {
              const matchesSearch =
                filters.searchTerm === "" ||
                comment.content
                  .toLowerCase()
                  .includes(filters.searchTerm.toLowerCase()) ||
                comment.authorName
                  .toLowerCase()
                  .includes(filters.searchTerm.toLowerCase());
              return matchesSearch;
            });

            filteredComments.sort(
              (a, b) =>
                (b.createdAt?.toDate() || new Date(0)) -
                (a.createdAt?.toDate() || new Date(0))
            );

            const totalPages = Math.ceil(
              filteredComments.length / itemsPerPage
            );
            const paginatedComments = filteredComments.slice(
              (currentPage - 1) * itemsPerPage,
              currentPage * itemsPerPage
            );

            if (paginatedComments.length === 0) {
              container.innerHTML =
                '<p class="text-gray-500 text-center col-span-full">No forum comments found matching your criteria.</p>';
            } else {
              paginatedComments.forEach((comment) => {
                const formattedTime = formatRelativeTime(comment.createdAt);
                const commentCard = document.createElement("div");
                commentCard.className =
                  "bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200";
                commentCard.innerHTML = `
                <p class="text-gray-600 text-sm mb-2 line-clamp-2">${
                  comment.content
                }</p>
                <div class="flex flex-wrap items-center text-xs text-gray-500 mb-2">
                    <span class="mr-2">By: ${comment.authorName}</span>
                    ${
                      comment.postId
                        ? `<span class="mr-2">Post ID: ${comment.postId.substring(
                            0,
                            8
                          )}...</span>`
                        : ""
                    }
                    ${
                      comment.parentId
                        ? `<span class="mr-2">Reply to: ${comment.parentId.substring(
                            0,
                            8
                          )}...</span>`
                        : ""
                    }
                    <span>${formattedTime}</span>
                </div>
                <div class="flex flex-wrap gap-2 mt-3">
                    <button class="bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="editForumComment('${
                      comment.id
                    }')">Edit</button>
                    <button class="bg-red-600 hover:bg-red-700 text-white text-sm py-2 px-3 rounded-lg transition-colors duration-200" onclick="deleteForumComment('${
                      comment.id
                    }', '${comment.postId}')">Delete</button>
                </div>
              `;
                container.appendChild(commentCard);
              });
            }

            if (totalPages > 1) {
              const paginationNav = document.createElement("nav");
              paginationNav.className =
                "flex justify-center items-center space-x-2 mt-4";
              const createButton = (text, page, disabled, onClick) => {
                const btn = document.createElement("button");
                btn.textContent = text;
                btn.className = `px-3 py-1 rounded-lg text-sm transition-colors duration-200 ${
                  disabled
                    ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                    : page === currentPage
                    ? "bg-red-600 text-white"
                    : "bg-gray-200 text-gray-700 hover:bg-gray-300"
                }`;
                btn.disabled = disabled;
                btn.addEventListener("click", onClick);
                return btn;
              };
              paginationNav.appendChild(
                createButton(
                  "Previous",
                  currentPage - 1,
                  currentPage === 1,
                  () => {
                    forumCommentsCurrentPage--;
                    renderCommunityForumComments(
                      filters,
                      forumCommentsCurrentPage,
                      itemsPerPage
                    );
                  }
                )
              );
              for (let i = 1; i <= totalPages; i++) {
                paginationNav.appendChild(
                  createButton(i, i, false, () => {
                    forumCommentsCurrentPage = i;
                    renderCommunityForumComments(
                      filters,
                      forumCommentsCurrentPage,
                      itemsPerPage
                    );
                  })
                );
              }
              paginationNav.appendChild(
                createButton(
                  "Next",
                  currentPage + 1,
                  currentPage === totalPages,
                  () => {
                    forumCommentsCurrentPage++;
                    renderCommunityForumComments(
                      filters,
                      forumCommentsCurrentPage,
                      forumCommentsItemsPerPage
                    );
                  }
                )
              );
              paginationContainer.appendChild(paginationNav);
            }
          },
          (error) =>
            showMessage(`Error loading forum comments: ${error.message}.`)
        );
      };

      window.editForumComment = async (commentId) => {
        if (!isAuthReady) {
          showMessage("Firebase not ready. Please try again.");
          return;
        }
        try {
          const docSnap = await getDoc(
            doc(db, `artifacts/${appId}/public/data/comments`, commentId)
          );
          if (!docSnap.exists()) {
            showMessage("Forum comment not found.");
            return;
          }
          const comment = docSnap.data();

          const editModalHtml = `
            <div id="edit-comment-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-[1000]">
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full">
                    <h3 class="text-xl font-bold mb-4">Edit Forum Comment</h3>
                    <input type="hidden" id="edit-comment-id" value="${commentId}">
                    <div class="mb-4">
                        <label for="edit-comment-content-input" class="block text-gray-700 text-sm font-semibold mb-2">Content</label>
                        <textarea id="edit-comment-content-input" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500 h-24" required>${comment.content}</textarea>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button id="cancel-edit-comment-modal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors duration-200">Cancel</button>
                        <button id="save-edit-comment-changes" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Save Changes</button>
                    </div>
                </div>
            </div>
          `;
          document.body.insertAdjacentHTML("beforeend", editModalHtml);

          const editCommentModal = document.getElementById(
            "edit-comment-modal"
          );
          const editCommentContentInput = document.getElementById(
            "edit-comment-content-input"
          );

          document.getElementById("cancel-edit-comment-modal").onclick = () =>
            editCommentModal.remove();
          document.getElementById(
            "save-edit-comment-changes"
          ).onclick = async () => {
            const newContent = editCommentContentInput.value.trim();
            if (!newContent) {
              showMessage("Comment content cannot be empty.", "error");
              return;
            }
            await window.updateForumComment(commentId, newContent);
            editCommentModal.remove();
          };
        } catch (error) {
          console.error("Error fetching forum comment for edit:", error);
          showMessage(
            `Failed to load forum comment for editing: ${error.message}.`
          );
        }
      };

      // --- User Management Functions ---

      // Function for current admin to change their own password
      window.changeCurrentUserPassword = async (
        currentPassword,
        newPassword,
        confirmNewPassword
      ) => {
        if (!isAuthReady) {
          showMessage("You must be logged in to change your password.");
          return;
        }
        if (newPassword !== confirmNewPassword) {
          showMessage("New password and confirm password do not match.");
          return;
        }
        if (newPassword.length < 6) {
          showMessage("Password should be at least 6 characters.");
          return;
        }

        const user = auth.currentUser;
        if (!user) {
          showMessage("No user is currently logged in.");
          return;
        }

        try {
          // Firebase requires re-authentication for sensitive operations like password change
          // This is a simplified approach; a full implementation might involve prompting for current password
          // and reauthenticating the user. For this demo, we'll try to update directly.
          await updatePassword(user, newPassword);
          showMessage("Your password has been changed successfully!");
          // Clear the form
          document.getElementById("current-password").value = "";
          document.getElementById("new-password").value = "";
          document.getElementById("confirm-new-password").value = "";
        } catch (error) {
          console.error("Error changing password:", error);
          if (error.code === "auth/requires-recent-login") {
            showMessage(
              "Please re-login recently to change your password. For security reasons, this operation requires recent authentication."
            );
          } else {
            showMessage(`Failed to change password: ${error.message}.`);
          }
        }
      };

      // Function to update another admin/moderator's role
      window.updateAdminUserRole = async (targetUserId, newRole) => {
        if (!isAuthReady || currentUserRole !== "admin") {
          showMessage(
            "You must be logged in as an admin to change user roles."
          );
          return;
        }
        if (targetUserId === auth.currentUser.uid && newRole !== "admin") {
          showMessage("You cannot demote your own admin role.");
          return;
        }
        try {
          await updateDoc(
            doc(
              db,
              "artifacts",
              appId,
              "public",
              "data",
              "adminUsers",
              targetUserId
            ),
            {
              role: newRole,
              updatedAt: serverTimestamp(),
              updatedBy: auth.currentUser.email || "Unknown Admin",
            }
          );
          showMessage(
            `User role updated to '${newRole}' for user ID: ${targetUserId}.`
          );
        } catch (error) {
          console.error("Error updating user role:", error);
          showMessage(`Failed to update user role: ${error.message}.`);
        }
      };

      // Function to delete an admin/moderator user (Firestore record only for simplicity)
      window.deleteAdminUser = async (targetUserId) => {
        if (!isAuthReady || currentUserRole !== "admin") {
          showMessage("You must be logged in as an admin to delete users.");
          return;
        }
        if (targetUserId === auth.currentUser.uid) {
          showMessage(
            "You cannot delete your own account from here. Please log out first if you wish to delete your account via Firebase Console."
          );
          return;
        }

        const messageBox = document.getElementById("message-box");
        const messageContent = document.getElementById("message-content");
        const closeMessageBoxBtn = document.getElementById("close-message-box");
        messageContent.textContent =
          "Are you sure you want to delete this admin/moderator account? This will remove their access from the panel (Firestore record). To fully delete the Firebase Authentication user, server-side admin privileges are required.";
        messageBox.classList.remove("hidden");

        const confirmDeleteBtn = document.createElement("button");
        confirmDeleteBtn.textContent = "Confirm Delete";
        confirmDeleteBtn.className =
          "bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 ml-2";
        confirmDeleteBtn.id = "confirm-delete-btn";
        messageBox.querySelector(".text-center").appendChild(confirmDeleteBtn);

        confirmDeleteBtn.addEventListener("click", async () => {
          try {
            // Delete the role document from Firestore
            await deleteDoc(
              doc(
                db,
                "artifacts",
                appId,
                "public",
                "data",
                "adminUsers",
                targetUserId
              )
            );
            showMessage(
              "Admin/Moderator account (Firestore record) deleted successfully."
            );
            // Note: Deleting the actual Firebase Auth user requires Firebase Admin SDK on a server.
            // For a client-side only app, this is a limitation.
          } catch (error) {
            console.error("Error deleting user:", error);
            showMessage(`Failed to delete user: ${error.message}.`);
          } finally {
            confirmDeleteBtn.remove();
            messageBox.classList.add("hidden");
          }
        });

        const originalCloseHandler = closeMessageBoxBtn.onclick;
        closeMessageBoxBtn.onclick = () => {
          confirmDeleteBtn.remove();
          messageBox.classList.add("hidden");
          if (originalCloseHandler) originalCloseHandler();
          closeMessageBoxBtn.onclick = originalCloseHandler;
        };
      };

      // Function to render the list of admin/moderator users
      const renderAdminUsers = () => {
        if (!isAuthReady || currentUserRole !== "admin") {
          document.getElementById("admin-users-list").innerHTML =
            '<p class="text-gray-500 text-center">Only admins can view and manage user accounts.</p>';
          return;
        }
        const container = document.getElementById("admin-users-list");
        if (!container)
          return console.error("Admin users list container not found.");

        onSnapshot(
          collection(db, "artifacts", appId, "public", "data", "adminUsers"),
          (snapshot) => {
            container.innerHTML = "";
            if (snapshot.empty) {
              container.innerHTML =
                '<p class="text-gray-500 text-center">No admin or moderator accounts found.</p>';
              return;
            }

            snapshot.docs.forEach((docSnap) => {
              const user = { id: docSnap.id, ...docSnap.data() };
              const userCard = document.createElement("div");
              userCard.className =
                "bg-gray-100 p-4 rounded-lg shadow-sm mb-3 flex items-center justify-between";
              userCard.innerHTML = `
                <div>
                  <p class="font-semibold text-gray-800">${user.email}</p>
                  <p class="text-sm text-gray-600">Role: <span class="capitalize">${
                    user.role
                  }</span></p>
                  <p class="text-xs text-gray-500">User ID: ${user.id.substring(
                    0,
                    8
                  )}...</p>
                </div>
                <div class="flex items-center space-x-2">
                  <select onchange="updateAdminUserRole('${
                    user.id
                  }', this.value)" class="p-2 border border-gray-300 rounded-md text-sm">
                    <option value="moderator" ${
                      user.role === "moderator" ? "selected" : ""
                    }>Moderator</option>
                    <option value="admin" ${
                      user.role === "admin" ? "selected" : ""
                    } ${
                user.id === auth.currentUser.uid ? "disabled" : ""
              }>Admin</option>
                  </select>
                  <button onclick="deleteAdminUser('${
                    user.id
                  }')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm transition-colors duration-200 ${
                user.id === auth.currentUser.uid
                  ? "opacity-50 cursor-not-allowed"
                  : ""
              }" ${
                user.id === auth.currentUser.uid ? "disabled" : ""
              }>Delete</button>
                </div>
              `;
              container.appendChild(userCard);
            });
          },
          (error) => showMessage(`Error loading admin users: ${error.message}.`)
        );
      };
      // --- End User Management Functions ---

      const DASHBOARD_HTML = `
        ${generatePageHeader("Dashboard")}
        <div id="dashboard-stats-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                <div>
                    <div id="pending-posts-stat" class="text-3xl font-bold text-gray-800 animate-pulse">...</div>
                    <div class="text-gray-500">Pending Forum Posts</div>
                </div>
                <i class="fas fa-comments text-5xl text-red-200"></i>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                <div>
                    <div id="pending-testimonials-stat" class="text-3xl font-bold text-gray-800 animate-pulse">...</div>
                    <div class="text-gray-500">Pending Testimonials</div>
                </div>
                <i class="fas fa-star text-5xl text-blue-200"></i>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                <div>
                    <div id="pending-messages-stat" class="text-3xl font-bold text-gray-800 animate-pulse">...</div>
                    <div class="text-gray-500">Pending Messages</div>
                </div>
                <i class="fas fa-envelope text-5xl text-green-200"></i>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                <div>
                    <div id="pending-speaking-requests-stat" class="text-3xl font-bold text-gray-800 animate-pulse">...</div>
                    <div class="text-gray-500">Speaking Requests</div>
                </div>
                <i class="fas fa-microphone-alt text-5xl text-purple-200"></i>
            </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Content Distribution</h2>
                <div class="h-80"><canvas id="overviewChart"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex items-center justify-between mb-4"><h2 class="text-xl font-semibold text-gray-800">Recent Messages</h2><a href="javascript:void(0)" class="text-red-500 hover:underline text-sm" onclick="loadPageContent('messages')">View All</a></div>
                <div id="dashboard-messages-list" class="space-y-4">
                    <p class="text-gray-500 text-sm text-center">Loading messages...</p>
                </div>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Content Overview</h2>
            <div id="content-overview-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div>
                    <p class="text-2xl font-bold text-gray-800" id="total-blog-posts-stat">...</p>
                    <p class="text-gray-500 text-sm">Total Blog Posts</p>
                </div>
                <div>
                    <p class="text-2xl font-bold text-gray-800" id="total-teachers-stat">...</p>
                    <p class="text-gray-500 text-sm">Total Teachers</p>
                </div>
                <div>
                    <p class="text-2xl font-bold text-gray-800" id="total-resources-stat">...</p>
                    <p class="text-gray-500 text-sm">Free Resources</p>
                </div>
                <div>
                    <p class="text-2xl font-bold text-gray-800" id="total-forum-posts-stat">...</p>
                    <p class="text-gray-500 text-sm">Forum Posts</p>
                </div>
            </div>
        </div>`;

      const MESSAGES_HTML = `
        ${generatePageHeader("Contact Form Submissions")}
        <div class="bg-white p-6 rounded-xl shadow-md">
            <p class="text-gray-700">Review and respond to messages submitted through the website's contact form.</p>
            <div class="mt-4 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Filter Contact Messages</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label for="contact-filter-status" class="block text-gray-700 text-sm font-semibold mb-2">Status</label><select id="contact-filter-status" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500"><option value="all">All Statuses</option><option value="pending">Pending</option><option value="replied">Replied</option></select></div>
                    <div><label for="contact-filter-search" class="block text-gray-700 text-sm font-semibold mb-2">Search</label><input type="text" id="contact-filter-search" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="Search by name, email, subject..."></div>
                </div>
            </div>
            <div id="contact-messages-list" class="space-y-4"></div>
            <div id="contact-message-pagination" class="mt-8 flex justify-center"></div>
        </div>`;

      const SPEAKING_REQUESTS_HTML = `
        ${generatePageHeader("Speaking Session Requests")}
        <div class="bg-white p-6 rounded-xl shadow-md">
            <p class="text-gray-700">Manage 1-on-1 speaking practice session requests submitted by users.</p>
            <div class="mt-4 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Filter Requests</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="speaking-request-filter-status" class="block text-gray-700 text-sm font-semibold mb-2">Status</label>
                        <select id="speaking-request-filter-status" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500">
                            <option value="all">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div>
                        <label for="speaking-request-filter-search" class="block text-gray-700 text-sm font-semibold mb-2">Search</label>
                        <input type="text" id="speaking-request-filter-search" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="Search by name, email, phone...">
                    </div>
                </div>
            </div>
            <div id="speaking-requests-list" class="space-y-4"></div>
            <div id="speaking-request-pagination" class="mt-8 flex justify-center"></div>
        </div>`;

      const OUR_TEACHER_HTML = `
        ${generatePageHeader("Teacher Management")}
        <div class="bg-white p-6 rounded-xl shadow-md">
            <p class="text-gray-700">Add, edit, and manage profiles for all your IELTS teachers. Use the rich text editor for detailed biographies.</p>
            <div class="mt-4 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Add/Edit Teacher</h3>
                <form id="teacher-form"><input type="hidden" id="teacher-id"><div class="mb-4"><label for="teacher-name" class="block text-gray-700 text-sm font-semibold mb-2">Teacher Name</label><input type="text" id="teacher-name" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="e.g., Mahir Hossain" required></div><div class="mb-4"><label for="teacher-expertise" class="block text-gray-700 text-sm font-semibold mb-2">Expertise</label><select id="teacher-expertise" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" required><option value="">Select an Expertise</option><option value="IELTS Speaking">IELTS Speaking</option><option value="IELTS Writing">IELTS Writing</option><option value="IELTS Listening">IELTS Listening</option><option value="IELTS Reading">IELTS Reading</option><option value="IELTS General Training">IELTS General Training</option><option value="IELTS Academic">IELTS Academic</option><option value="Grammar & Vocabulary">Grammar & Vocabulary</option><option value="Test Strategies">Test Strategies</option><option value="Beginner IELTS">Beginner IELTS</option><option value="Advanced IELTS">Advanced IELTS</option><option value="Overall IELTS">Overall IELTS</option></select></div><div class="mb-4"><label for="teacher-bio" class="block text-gray-700 text-sm font-semibold mb-2">Biography</label><textarea id="teacher-bio" name="bio" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500 h-48"></textarea></div><div class="mb-6"><label class="block text-gray-700 text-sm font-semibold mb-2">Teacher Image</label><input type="hidden" id="teacher-image"><div id="teacher-image-drop-zone" class="drop-zone border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-red-400 transition-colors duration-200"><img id="teacher-image-preview" class="hidden max-w-full h-auto mx-auto mb-2 rounded-full w-24 h-24 object-cover" src="" alt="Teacher Image Preview"><p class="text-gray-500 placeholder-text"><i class="fas fa-cloud-upload-alt mr-2"></i> Drag & drop an image here or click to select</p><p class="text-gray-500 change-text hidden"><i class="fas fa-sync-alt mr-2"></i> Click or drag to change image</p></div></div><button type="submit" id="add-teacher-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Add Teacher</button></form>
            </div>
            <div class="mt-8 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Filter Teachers</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label for="teacher-filter-status" class="block text-gray-700 text-sm font-semibold mb-2">Status</label><select id="teacher-filter-status" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500"><option value="all">All Statuses</option><option value="active">Active</option><option value="inactive">Inactive</option></select></div>
                    <div><label for="teacher-filter-search" class="block text-gray-700 text-sm font-semibold mb-2">Search</label><input type="text" id="teacher-filter-search" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="Search by name, expertise..."></div>
                </div>
            </div>
            <div class="mt-8"><h3 class="text-xl font-semibold text-gray-800 mb-4">All Teachers</h3><div id="teachers-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>
            <div id="teacher-pagination" class="mt-8 flex justify-center"></div>
        </div>`;

      const COMMUNITY_FORUM_HTML = `
        ${generatePageHeader("Community Forum Management")}
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <p class="text-gray-700">Oversee discussions, moderate content, and manage users in the community forum. You can approve, reject, or mark posts as pending, and edit/delete posts and comments directly from here.</p>
        </div>

        <!-- Filter Posts Section -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Filter Forum Posts</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="forum-post-filter-status" class="block text-gray-700 text-sm font-semibold mb-2">Status</label>
                    <select id="forum-post-filter-status" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500">
                        <option value="all">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
                <div>
                    <label for="forum-post-filter-category" class="block text-gray-700 text-sm font-semibold mb-2">Category</label>
                    <select id="forum-post-filter-category" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500">
                        <option value="all categories">All Categories</option>
                        <option value="IELTS Speaking">IELTS Speaking</option>
                        <option value="IELTS Writing">IELTS Writing</option>
                        <option value="IELTS Listening">IELTS Listening</option>
                        <option value="IELTS Reading">IELTS Reading</option>
                        <option value="Tips & Strategies">Tips & Strategies</option>
                        <option value="Band 9 Answers">Band 9 Answers</option>
                        <option value="Motivation & Support">Motivation & Support</option>
                    </select>
                </div>
                <div>
                    <label for="forum-post-filter-search" class="block text-gray-700 text-sm font-semibold mb-2">Search Posts</label>
                    <input type="text" id="forum-post-filter-search" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="Search by title, content, author...">
                </div>
            </div>
        </div>

        <!-- All Forum Posts Section -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">All Forum Posts</h3>
            <div id="forum-posts-list-container" class="space-y-4"></div>
            <div id="forum-posts-pagination" class="mt-8 flex justify-center"></div>
        </div>

        <!-- Filter Comments Section -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Filter Forum Comments</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="forum-comment-filter-search" class="block text-gray-700 text-sm font-semibold mb-2">Search Comments</label>
                    <input type="text" id="forum-comment-filter-search" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="Search by content, author...">
                </div>
            </div>
        </div>

        <!-- All Forum Comments Section -->
        <div class="bg-white p-6 rounded-xl shadow-md">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">All Forum Comments</h3>
            <div id="forum-comments-list-container" class="space-y-4"></div>
            <div id="forum-comments-pagination" class="mt-8 flex justify-center"></div>
        </div>`;
      const BLOG_HTML = `
        ${generatePageHeader("Blog Management")}
        <div class="bg-white p-6 rounded-xl shadow-md">
            <p class="text-gray-700">Create, edit, and publish blog posts. Manage content and authors.</p>
            <div class="mt-4 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Add/Edit Blog Post</h3>
                <form id="blog-post-form"><input type="hidden" id="blog-id"><div class="mb-4"><label for="blog-title" class="block text-gray-700 text-sm font-semibold mb-2">Title</label><input type="text" id="blog-title" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="Enter blog post title" required></div><div class="mb-4"><label for="blog-category" class="block text-gray-700 text-sm font-semibold mb-2">Category</label><select id="blog-category" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" required><option value="">Select a Category</option><option value="all categories">All Categories</option><option value="preparation">Preparation</option><option value="reading">Reading</option><option value="writing">Writing</option><option value="listening">Listening</option><option value="speaking">Speaking</option><option value="grammar">Grammar</option><option value="study plan">Study Plan</option><option value="higher study">Higher Study</option><option value="ielts motivation">IELTS Motivation</option><option value="others">Others</option></select></div><div class="mb-4"><label for="blog-content" class="block text-gray-700 text-sm font-semibold mb-2">Content</label><textarea id="blog-content" name="content" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500 h-48"></textarea></div><div class="mb-4"><label for="blog-author" class="block text-gray-700 text-sm font-semibold mb-2">Author Name</label><input type="text" id="blog-author" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="e.g., John Doe" required></div><div class="mb-4"><label class="block text-gray-700 text-sm font-semibold mb-2">Author Image</label><input type="hidden" id="blog-author-img"><div id="author-image-drop-zone" class="drop-zone border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-red-400 transition-colors duration-200"><img id="author-image-preview" class="hidden max-w-full h-auto mx-auto mb-2 rounded-full w-24 h-24 object-cover" src="" alt="Author Image Preview"><p class="text-gray-500 placeholder-text"><i class="fas fa-cloud-upload-alt mr-2"></i> Drag & drop an image here or click to select</p><p class="text-gray-500 change-text hidden"><i class="fas fa-sync-alt mr-2"></i> Click or drag to change image</p></div></div><div class="mb-6"><label class="block text-gray-700 text-sm font-semibold mb-2">Featured Image</label><input type="hidden" id="blog-image"><div id="blog-image-drop-zone" class="drop-zone border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-red-400 transition-colors duration-200"><img id="blog-image-preview" class="hidden max-w-full h-auto mx-auto mb-2" src="" alt="Blog Image Preview"><p class="text-gray-500 placeholder-text"><i class="fas fa-cloud-upload-alt mr-2"></i> Drag & drop an image here or click to select</p><p class="text-gray-500 change-text hidden"><i class="fas fa-sync-alt mr-2"></i> Click or drag to change image</p></div></div><button type="submit" id="add-blog-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Add Blog Post</button></form>
            </div>
            <div class="mt-8 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Filter Blog Posts</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div><label for="blog-filter-status" class="block text-gray-700 text-sm font-semibold mb-2">Status</label><select id="blog-filter-status" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500"><option value="all">All Statuses</option><option value="published">Published</option><option value="draft">Draft</option></select></div>
                    <div><label for="blog-filter-category" class="block text-gray-700 text-sm font-semibold mb-2">Category</label><select id="blog-filter-category" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500"><option value="all categories">All Categories</option><option value="preparation">Preparation</option><option value="reading">Reading</option><option value="writing">Writing</option><option value="listening">Listening</option><option value="speaking">Speaking</option><option value="grammar">Grammar</option><option value="study plan">Study Plan</option><option value="higher study">Higher Study</option><option value="ielts motivation">IELTS Motivation</option><option value="others">Others</option></select></div>
                    <div><label for="blog-filter-search" class="block text-gray-700 text-sm font-semibold mb-2">Search</label><input type="text" id="blog-filter-search" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="Search by title, author..."></div>
                </div>
            </div>
            <div class="mt-8" id="blog-display-section"><h3 class="text-xl font-semibold text-gray-800 mb-4" id="blog-posts-list-heading">All Blog Posts</h3><div id="blog-posts-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>
            <div id="blog-pagination" class="mt-8 flex justify-center"></div>
        </div>`;
      const FREE_RESOURCES_HTML = `
        ${generatePageHeader("Free Resources Management")}
        <div class="bg-white p-6 rounded-xl shadow-md">
            <p class="text-gray-700">Manage free learning resources like e-books, practice materials, and webinars. Ensure content is up-to-date and accessible.</p>
            <div class="mt-4 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Add/Edit Free Resource (Video)</h3>
                <form id="free-resource-form"><input type="hidden" id="free-resource-id"><div class="mb-4"><label for="free-resource-title" class="block text-gray-700 text-sm font-semibold mb-2">Video Title</label><input type="text" id="free-resource-title" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="e.g., IELTS Speaking Band 7.5 Real Test" required></div><div class="mb-4"><label for="free-resource-category" class="block text-gray-700 text-sm font-semibold mb-2">Category</label><select id="free-resource-category" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" required><option value="">Select a Category</option><option value="Speaking">Speaking</option><option value="Writing">Writing</option><option value="Listening">Listening</option><option value="Reading">Reading</option><option value="Grammar">Grammar</option><option value="Vocabulary">Vocabulary</option>option value="Higher Study">Higher Study</option><option value="Tips & Tricks">Tips & Tricks</option><option value="Study Plan">Study Plan</option><option value="Live">Classes</option><option value="Full Tests">Full Tests</option><option value="Motivation">Motivation</option><option value="Others">Others</option></select></div><div class="mb-4"><label for="free-resource-link" class="block text-gray-700 text-sm font-semibold mb-2">YouTube Video Link</label><input type="url" id="free-resource-link" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="e.g., https://www.youtube.com/watch?v=VIDEO_ID" required></div><div class="mb-4"><label for="free-resource-summary" class="block text-gray-700 text-sm font-semibold mb-2">Summary</label><textarea id="free-resource-summary" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500 h-24" placeholder="Brief summary of the video content"></textarea></div><div class="mb-6"><label for="free-resource-keypoints" class="block text-gray-700 text-sm font-semibold mb-2">Key Points (One per line)</label><textarea id="free-resource-keypoints" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500 h-32" placeholder="List key takeaways, one point per line"></textarea></div><div class="mb-6"><label class="block text-gray-700 text-sm font-semibold mb-2">Thumbnail Image</label><input type="hidden" id="free-resource-image"><div id="free-resource-image-drop-zone" class="drop-zone border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-red-400 transition-colors duration-200"><img id="free-resource-image-preview" class="hidden max-w-full h-auto mx-auto mb-2" src="" alt="Thumbnail Image Preview"><p class="text-gray-500 placeholder-text"><i class="fas fa-cloud-upload-alt mr-2"></i> Drag & drop an image here or click to select</p><p class="text-gray-500 change-text hidden"><i class="fas fa-sync-alt mr-2"></i> Click or drag to change image</p></div></div><button type="submit" id="add-free-resource-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Add Free Resource</button></form>
            </div>
            <div class="mt-8 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Filter Free Resources</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div><label for="free-resource-filter-status" class="block text-gray-700 text-sm font-semibold mb-2">Status</label><select id="free-resource-filter-status" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500"><option value="all">All Statuses</option><option value="active">Active</option><option value="inactive">Inactive</option></select></div>
                    <div><label for="free-resource-filter-category" class="block text-gray-700 text-sm font-semibold mb-2">Category</label><select id="free-resource-filter-category" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500"><option value="">Select a Category</option><option value="Speaking">Speaking</option><option value="Writing">Writing</option><option value="Listening">Listening</option><option value="Reading">Reading</option><option value="Grammar">Grammar</option><option value="Vocabulary">Vocabulary</option>option value="Higher Study">Higher Study</option><option value="Tips & Tricks">Tips & Tricks</option><option value="Study Plan">Study Plan</option><option value="Live">Classes</option><option value="Full Tests">Full Tests</option><option value="Motivation">Motivation</option><option value="Others">Others</option></select></div>
                    <div><label for="free-resource-filter-search" class="block text-gray-700 text-sm font-semibold mb-2">Search</label><input type="text" id="free-resource-filter-search" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="Search by title, category, summary..."></div>
                </div>
            </div>
            <div class="mt-8"><h3 class="text-xl font-semibold text-gray-800 mb-4">All Free Resources</h3><div id="free-resources-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>
            <div id="free-resource-pagination" class="mt-8 flex justify-center"></div>
        </div>`;

      const TESTIMONIAL_HTML = `
        ${generatePageHeader("Testimonial Management")}
        <div class="testimonials-section-admin bg-white p-6 rounded-xl shadow-md">
            <p class="text-gray-700 mb-6">Manage customer testimonials. Approve, reject, edit, or delete submitted testimonials.</p>
            <div class="mt-4 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Add/Edit Testimonial</h3>
                <form id="testimonial-form"><input type="hidden" id="testimonial-id"><div class="mb-4"><label for="testimonial-name" class="block text-gray-700 text-sm font-semibold mb-2">Name</label><input type="text" id="testimonial-name" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="e.g., Jane Doe" required></div><div class="mb-4"><label for="testimonial-role" class="block text-gray-700 text-sm font-semibold mb-2">Role/Course</label><input type="text" id="testimonial-role" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="e.g., IELTS Student" required></div><div class="mb-4"><label class="block text-gray-700 text-sm font-semibold mb-2">Testimonial Type</label><div class="flex items-center space-x-4"><label class="inline-flex items-center"><input type="radio" name="testimonial-type" id="testimonial-type-text" value="text" class="form-radio text-red-600" checked><span class="ml-2 text-gray-700">Text</span></label><label class="inline-flex items-center"><input type="radio" name="testimonial-type" id="testimonial-type-video" value="video" class="form-radio text-red-600"><span class="ml-2 text-gray-700">Video</span></label></div></div><div class="mb-4" id="text-content-group"><label for="testimonial-text" class="block text-gray-700 text-sm font-semibold mb-2">Testimonial Text</label><textarea id="testimonial-text" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500 h-24" placeholder="Enter testimonial text"></textarea></div><div class="mb-4 hidden" id="video-url-group"><label for="testimonial-video-src" class="block text-gray-700 text-sm font-semibold mb-2">Video URL</label><input type="url" id="testimonial-video-src" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="e.g., https://example.com/video.mp4"></div><div class="mb-6"><label class="block text-gray-700 text-sm font-semibold mb-2">Avatar Image</label><input type="hidden" id="testimonial-avatar-src"><div id="avatar-drop-zone" class="drop-zone border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-red-400 transition-colors duration-200"><img id="avatar-image-preview" class="hidden max-w-full h-auto mx-auto mb-2 rounded-full w-24 h-24 object-cover" src="" alt="Avatar Image Preview"><p class="text-gray-500 placeholder-text"><i class="fas fa-cloud-upload-alt mr-2"></i> Drag & drop an image here or click to select</p><p class="text-gray-500 change-text hidden"><i class="fas fa-sync-alt mr-2"></i> Click or drag to change image</p></div></div><button type="submit" id="add-testimonial-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Add Testimonial</button></form>
            </div>
            <div class="mt-8 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Filter Testimonials</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label for="testimonial-filter-status" class="block text-gray-700 text-sm font-semibold mb-2">Status</label><select id="testimonial-filter-status" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500"><option value="all">All Statuses</option><option value="pending">Pending</option><option value="approved">Approved</option><option value="rejected">Rejected</option></select></div>
                    <div><label for="testimonial-filter-search" class="block text-gray-700 text-sm font-semibold mb-2">Search</label><input type="text" id="testimonial-filter-search" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="Search by name, role, text..."></div>
                </div>
            </div>
            <div class="mt-8"><h3 class="text-xl font-semibold text-gray-800 mb-4">Pending Testimonials</h3><div id="pending-testimonials-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>
            <div class="mt-8"><h3 class="text-xl font-semibold text-gray-800 mb-4">Approved Testimonials</h3><div id="approved-testimonials-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>
            <div class="mt-8"><h3 class="text-xl font-semibold text-gray-800 mb-4">Rejected Testimonials</h3><div id="rejected-testimonials-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>
            <div id="testimonial-pagination" class="mt-8 flex justify-center"></div>
        </div>`;

      const USER_MANAGEMENT_HTML = `
        ${generatePageHeader("User Management")}
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <p class="text-gray-700">Manage admin and moderator accounts for this panel. You can change user roles and update your own password.</p>
        </div>

        <!-- Section for Current Admin to Change Password -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Change Your Password</h3>
            <form id="change-password-form" class="space-y-4">
                <div>
                    <label for="current-password" class="block text-sm font-medium text-gray-700">Current Password</label>
                    <input type="password" id="current-password" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-900 sm:text-sm" required>
                </div>
                <div>
                    <label for="new-password" class="block text-sm font-medium text-gray-700">New Password</label>
                    <input type="password" id="new-password" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-900 sm:text-sm" required>
                </div>
                <div>
                    <label for="confirm-new-password" class="block text-sm font-medium text-gray-700">Confirm New Password</label>
                    <input type="password" id="confirm-new-password" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 text-gray-900 sm:text-sm" required>
                </div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200">Change Password</button>
            </form>
        </div>

        <!-- Section to Manage Existing Admin/Moderator -->
        <div class="bg-white p-6 rounded-xl shadow-md">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Manage Existing Admin/Moderator Users</h3>
            <div id="admin-users-list"></div>
        </div>
      `;

      window.loadPageContent = (pageName) => {
        const contentArea = document.getElementById("content-area");
        document
          .querySelectorAll(".nav-link")
          .forEach((link) =>
            link.classList.remove("active-link", "bg-red-50", "text-red-600")
          );
        document
          .querySelector(`.nav-link[data-page="${pageName}"]`)
          ?.classList.add("active-link", "bg-red-50", "text-red-600");

        if (summernoteEditorInstance && $("#blog-content").data("summernote")) {
          $("#blog-content").summernote("destroy");
          summernoteEditorInstance = null;
        }
        if (summernoteEditorInstance && $("#teacher-bio").data("summernote")) {
          $("#teacher-bio").summernote("destroy");
          summernoteEditorInstance = null;
        }

        let contentHtml = "";
        switch (pageName) {
          case "dashboard":
            contentHtml = DASHBOARD_HTML;
            break;
          case "messages":
            contentHtml = MESSAGES_HTML;
            break;
          case "speaking-requests":
            contentHtml = SPEAKING_REQUESTS_HTML;
            break;
          case "our-teacher":
            contentHtml = OUR_TEACHER_HTML;
            break;
          case "community-forum":
            contentHtml = COMMUNITY_FORUM_HTML;
            break;
          case "blog":
            contentHtml = BLOG_HTML;
            break;
          case "free-resources":
            contentHtml = FREE_RESOURCES_HTML;
            break;
          case "testimonial":
            contentHtml = TESTIMONIAL_HTML;
            break;
          case "user-management": // New case for user management
            contentHtml = USER_MANAGEMENT_HTML;
            break;
        }
        contentArea.innerHTML = contentHtml;

        setTimeout(() => {
          if (pageName === "blog") {
            const blogContentTextArea = document.getElementById("blog-content");
            if (blogContentTextArea) {
              $(blogContentTextArea).summernote({
                placeholder: "Start writing your blog post here...",
                tabsize: 2,
                height: 300,
                toolbar: [
                  ["style", ["style"]],
                  ["font", ["bold", "italic", "underline", "clear"]],
                  ["fontname", ["fontname"]],
                  ["fontsize", ["fontsize"]],
                  ["color", ["color"]],
                  ["para", ["ul", "ol", "paragraph"]],
                  ["height", ["height"]],
                  ["table", ["table"]],
                  ["insert", ["link", "picture", "video", "hr"]],
                  ["view", ["codeview", "help"]],
                  ["misc", ["undo", "redo"]],
                ],
              });
              summernoteEditorInstance = $(blogContentTextArea);
            }
            setupImageDragAndDrop(
              "blog-image",
              "blog-image-drop-zone",
              "blog-image-preview",
              800,
              400
            );
            setupImageDragAndDrop(
              "blog-author-img",
              "author-image-drop-zone",
              "author-image-preview",
              200,
              200
            );
            const blogFilterStatus = document.getElementById(
              "blog-filter-status"
            );
            const blogFilterCategory = document.getElementById(
              "blog-filter-category"
            );
            const blogFilterSearch = document.getElementById(
              "blog-filter-search"
            );
            if (blogFilterStatus) {
              blogFilterStatus.value = blogCurrentFilters.status;
              blogFilterStatus.addEventListener("change", (e) => {
                blogCurrentFilters.status = e.target.value;
                blogCurrentPage = 1;
                renderBlogPosts(
                  blogCurrentFilters,
                  blogCurrentPage,
                  blogItemsPerPage
                );
              });
            }
            if (blogFilterCategory) {
              blogFilterCategory.value = blogCurrentFilters.category;
              blogFilterCategory.addEventListener("change", (e) => {
                blogCurrentFilters.category = e.target.value;
                blogCurrentPage = 1;
                renderBlogPosts(
                  blogCurrentFilters,
                  blogCurrentPage,
                  blogItemsPerPage
                );
              });
            }
            if (blogFilterSearch) {
              blogFilterSearch.value = blogCurrentFilters.searchTerm;
              blogFilterSearch.addEventListener("input", (e) => {
                blogCurrentFilters.searchTerm = e.target.value;
                blogCurrentPage = 1;
                renderBlogPosts(
                  blogCurrentFilters,
                  blogCurrentPage,
                  blogItemsPerPage
                );
              });
            }
          }
          if (pageName === "dashboard") {
            updateDashboardStats();
            renderDashboardChart();
            renderRecentDashboardMessages();
          }
          if (pageName === "testimonial") {
            renderTestimonials(
              testimonialCurrentFilters,
              testimonialCurrentPage,
              testimonialItemsPerPage
            );
            setupImageDragAndDrop(
              "testimonial-avatar-src",
              "avatar-drop-zone",
              "avatar-image-preview",
              200,
              200
            );
            const typeTextRadio = document.getElementById(
              "testimonial-type-text"
            );
            const typeVideoRadio = document.getElementById(
              "testimonial-type-video"
            );
            const textContentGroup = document.getElementById(
              "text-content-group"
            );
            const videoUrlGroup = document.getElementById("video-url-group");
            const toggleTestimonialType = () => {
              textContentGroup.classList.toggle(
                "hidden",
                typeVideoRadio.checked
              );
              videoUrlGroup.classList.toggle("hidden", !typeVideoRadio.checked);
            };
            typeTextRadio.addEventListener("change", toggleTestimonialType);
            typeVideoRadio.addEventListener("change", toggleTestimonialType);
            toggleTestimonialType();
            const testimonialFilterStatus = document.getElementById(
              "testimonial-filter-status"
            );
            const testimonialFilterSearch = document.getElementById(
              "testimonial-filter-search"
            );
            if (testimonialFilterStatus) {
              testimonialFilterStatus.value = testimonialCurrentFilters.status;
              testimonialFilterStatus.addEventListener("change", (e) => {
                testimonialCurrentFilters.status = e.target.value;
                testimonialCurrentPage = 1;
                renderTestimonials(
                  testimonialCurrentFilters,
                  testimonialCurrentPage,
                  testimonialItemsPerPage
                );
              });
            }
            if (testimonialFilterSearch) {
              testimonialFilterSearch.value =
                testimonialCurrentFilters.searchTerm;
              testimonialFilterSearch.addEventListener("input", (e) => {
                testimonialCurrentFilters.searchTerm = e.target.value;
                testimonialCurrentPage = 1;
                renderTestimonials(
                  testimonialCurrentFilters,
                  testimonialCurrentPage,
                  testimonialItemsPerPage
                );
              });
            }
          }
          if (pageName === "quizzes") renderQuizzes();
          if (pageName === "blog") {
            blogCurrentFilters = {
              status: "all",
              category: "all categories",
              searchTerm: "",
            };
            document.getElementById("blog-filter-status").value =
              blogCurrentFilters.status;
            document.getElementById("blog-filter-category").value =
              blogCurrentFilters.category;
            renderBlogPosts(
              blogCurrentFilters,
              blogCurrentPage,
              blogItemsPerPage
            );
          }
          if (pageName === "messages")
            renderContactMessages(
              contactMessageCurrentFilters,
              contactMessageCurrentPage,
              contactMessageItemsPerPage
            );
          if (pageName === "speaking-requests") {
            document.getElementById("speaking-request-filter-status").addEventListener("change", (e) => {
                speakingRequestCurrentFilters.status = e.target.value;
                speakingRequestCurrentPage = 1;
                renderSpeakingRequests(speakingRequestCurrentFilters, speakingRequestCurrentPage, speakingRequestItemsPerPage);
            });
            document.getElementById("speaking-request-filter-search").addEventListener("input", (e) => {
                speakingRequestCurrentFilters.searchTerm = e.target.value;
                speakingRequestCurrentPage = 1;
                renderSpeakingRequests(speakingRequestCurrentFilters, speakingRequestCurrentPage, speakingRequestItemsPerPage);
            });
            renderSpeakingRequests(speakingRequestCurrentFilters, speakingRequestCurrentPage, speakingRequestItemsPerPage);
          }
          if (pageName === "our-teacher") {
            const teacherBioTextArea = document.getElementById("teacher-bio");
            if (teacherBioTextArea) {
              $(teacherBioTextArea).summernote({
                placeholder: "Enter teacher's biography here...",
                tabsize: 2,
                height: 200,
                toolbar: [
                  ["style", ["style"]],
                  ["font", ["bold", "italic", "underline", "clear"]],
                  ["fontname", ["fontname"]],
                  ["fontsize", ["fontsize"]],
                  ["color", ["color"]],
                  ["para", ["ul", "ol", "paragraph"]],
                  ["height", ["height"]],
                  ["insert", ["link", "picture", "hr"]],
                  ["view", ["codeview", "help"]],
                  ["misc", ["undo", "redo"]],
                ],
                callbacks: {
                  onImageUpload: function (files) {
                    const editor = $(this);
                    files.length > 0 && files[0].type.startsWith("image/")
                      ? processAndResizeImage(files[0], 600, 300, (dataUrl) => {
                          editor.summernote("insertImage", dataUrl);
                          showMessage(
                            "Image inserted into bio (resized and Base64 encoded)."
                          );
                        })
                      : showMessage("Please upload an image file.");
                  },
                },
              });
              summernoteEditorInstance = $(teacherBioTextArea);
            }
            setupImageDragAndDrop(
              "teacher-image",
              "teacher-image-drop-zone",
              "teacher-image-preview",
              200,
              200
            );
            document
              .getElementById("teacher-filter-status")
              .addEventListener("change", (e) => {
                teacherCurrentFilters.status = e.target.value;
                teacherCurrentPage = 1;
                renderTeachers(
                  teacherCurrentFilters,
                  teacherCurrentPage,
                  teacherItemsPerPage
                );
              });
            document
              .getElementById("teacher-filter-search")
              .addEventListener("input", (e) => {
                teacherCurrentFilters.searchTerm = e.target.value;
                teacherCurrentPage = 1;
                renderTeachers(
                  teacherCurrentFilters,
                  teacherCurrentPage,
                  teacherItemsPerPage
                );
              });
            renderTeachers(
              teacherCurrentFilters,
              teacherCurrentPage,
              teacherItemsPerPage
            );
          }
          if (pageName === "free-resources") {
            setupImageDragAndDrop(
              "free-resource-image",
              "free-resource-image-drop-zone",
              "free-resource-image-preview",
              480,
              270
            );
            document
              .getElementById("free-resource-filter-status")
              .addEventListener("change", (e) => {
                freeResourceCurrentFilters.status = e.target.value;
                freeResourceCurrentPage = 1;
                renderFreeResources(
                  freeResourceCurrentFilters,
                  freeResourceCurrentPage,
                  freeResourceItemsPerPage
                );
              });
            document
              .getElementById("free-resource-filter-category")
              .addEventListener("change", (e) => {
                freeResourceCurrentFilters.category = e.target.value;
                freeResourceCurrentPage = 1;
                renderFreeResources(
                  freeResourceCurrentFilters,
                  freeResourceCurrentPage,
                  freeResourceItemsPerPage
                );
              });
            document
              .getElementById("free-resource-filter-search")
              .addEventListener("input", (e) => {
                freeResourceCurrentFilters.searchTerm = e.target.value;
                freeResourceCurrentPage = 1;
                renderFreeResources(
                  freeResourceCurrentFilters,
                  freeResourceCurrentPage,
                  freeResourceItemsPerPage
                );
              });
            renderFreeResources(
              freeResourceCurrentFilters,
              freeResourceCurrentPage,
              freeResourceItemsPerPage
            );
          }
          if (pageName === "community-forum") {
            // Setup for Filter Posts
            const forumPostFilterStatus = document.getElementById(
              "forum-post-filter-status"
            );
            const forumPostFilterCategory = document.getElementById(
              "forum-post-filter-category"
            );
            const forumPostFilterSearch = document.getElementById(
              "forum-post-filter-search"
            );

            // Clear existing options for filter category before populating
            forumPostFilterCategory.innerHTML =
              '<option value="all categories">All Categories</option>';
            FORUM_CATEGORIES_DATA.forEach((cat) => {
              const option = document.createElement("option");
              option.value = cat.name;
              option.textContent = cat.name;
              forumPostFilterCategory.appendChild(option);
            });

            forumPostFilterStatus.value = forumPostsCurrentFilters.status;
            forumPostFilterCategory.value = forumPostsCurrentFilters.category;
            forumPostFilterSearch.value = forumPostsCurrentFilters.searchTerm;

            forumPostFilterStatus.addEventListener("change", (e) => {
              forumPostsCurrentFilters.status = e.target.value;
              forumPostsCurrentPage = 1;
              renderCommunityForumPosts(
                forumPostsCurrentFilters,
                forumPostsCurrentPage,
                forumPostsItemsPerPage
              );
            });
            forumPostFilterCategory.addEventListener("change", (e) => {
              forumPostsCurrentFilters.category = e.target.value;
              forumPostsCurrentPage = 1;
              renderCommunityForumPosts(
                forumPostsCurrentFilters,
                forumPostsCurrentPage,
                forumPostsItemsPerPage
              );
            });
            forumPostFilterSearch.addEventListener("input", (e) => {
              forumPostsCurrentFilters.searchTerm = e.target.value;
              forumPostsCurrentPage = 1;
              renderCommunityForumPosts(
                forumPostsCurrentFilters,
                forumPostsCurrentPage,
                forumPostsItemsPerPage
              );
            });

            renderCommunityForumPosts(
              forumPostsCurrentFilters,
              forumPostsCurrentPage,
              forumPostsItemsPerPage
            );

            // Setup for Filter Comments
            const forumCommentFilterSearch = document.getElementById(
              "forum-comment-filter-search"
            );
            forumCommentFilterSearch.value =
              forumCommentsCurrentFilters.searchTerm;
            forumCommentFilterSearch.addEventListener("input", (e) => {
              forumCommentsCurrentFilters.searchTerm = e.target.value;
              forumCommentsCurrentPage = 1;
              renderCommunityForumComments(
                forumCommentsCurrentFilters,
                forumCommentsCurrentPage,
                forumCommentsItemsPerPage
              );
            });

            renderCommunityForumComments(
              forumCommentsCurrentFilters,
              forumCommentsCurrentPage,
              forumCommentsItemsPerPage
            );
          }
          if (pageName === "user-management") {
            renderAdminUsers(); // Load the list of admin/moderator users

            // Event listener for changing current user's password
            const changePasswordForm = document.getElementById(
              "change-password-form"
            );
            if (changePasswordForm) {
              changePasswordForm.onsubmit = async (e) => {
                e.preventDefault();
                const currentPassword = document.getElementById(
                  "current-password"
                ).value;
                const newPassword = document.getElementById("new-password")
                  .value;
                const confirmNewPassword = document.getElementById(
                  "confirm-new-password"
                ).value;
                await changeCurrentUserPassword(
                  currentPassword,
                  newPassword,
                  confirmNewPassword
                );
              };
            }
          }
        }, 0);
      };

      document.addEventListener("DOMContentLoaded", async () => {
        // Set up authentication state listener
        onAuthStateChanged(auth, async (user) => {
          if (user) {
            // User is signed in.
            userId = user.uid;
            // Fetch user's role from Firestore
            const userRoleDoc = await getDoc(
              doc(
                db,
                "artifacts",
                appId,
                "public",
                "data",
                "adminUsers",
                userId
              )
            );
            if (userRoleDoc.exists()) {
              currentUserRole = userRoleDoc.data().role;
              if (
                currentUserRole === "admin" ||
                currentUserRole === "moderator"
              ) {
                isAuthReady = true;
                console.log(
                  "Firebase authenticated. User ID:",
                  userId,
                  "Role:",
                  currentUserRole
                );
                showAdminPanel();
              } else {
                // User has a role but not admin/moderator, log them out
                console.log(
                  "User is logged in but not an authorized admin/moderator. Logging out."
                );
                await signOut(auth);
                isAuthReady = false;
                showLoginForm();
              }
            } else {
              // User is authenticated in Firebase Auth but has no role document.
              // This could mean they are a regular user or a new admin not yet assigned a role.
              // For this panel, we assume only users with roles in 'adminUsers' collection can access.
              console.log(
                "User is authenticated but no role found in Firestore. Logging out."
              );
              await signOut(auth);
              isAuthReady = false;
              showLoginForm();
            }
          } else {
            // User is signed out.
            userId = null;
            isAuthReady = false;
            currentUserRole = null;
            console.log("User is logged out or not authenticated.");
            showLoginForm();
          }
        });

        // Add a global click listener to handle closing kebab menus
        document.addEventListener('click', (event) => {
            // If the click is on a kebab button, its own handler will manage the state.
            if (event.target.closest('.kebab-button')) {
                return;
            }
            // If the click is anywhere else, ensure all dropdowns are closed.
            closeAllKebabDropdowns();
        });

        // Event listener for the login form
        const loginForm = document.getElementById("login-form");
        if (loginForm) {
          loginForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.getElementById("login-email").value;
            const password = document.getElementById("login-password").value;
            await handleLogin(email, password);
          });
        }

        document.querySelectorAll(".nav-link").forEach((link) => {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            loadPageContent(e.currentTarget.dataset.page);
          });
        });

        document
          .getElementById("close-message-box")
          .addEventListener("click", () =>
            document.getElementById("message-box").classList.add("hidden")
          );

        const hamburgerMenu = document.getElementById("hamburger-menu");
        const sidebar = document.getElementById("sidebar");
        const sidebarOverlay = document.getElementById("sidebar-overlay");

        hamburgerMenu.addEventListener("click", () => {
          sidebar.classList.toggle("-translate-x-full");
          sidebar.classList.toggle("translate-x-0");
          sidebarOverlay.classList.toggle("hidden");
        });

        sidebarOverlay.addEventListener("click", () => {
          sidebar.classList.add("-translate-x-full");
          sidebar.classList.remove("translate-x-0");
          sidebarOverlay.classList.add("hidden");
        });

        window.addEventListener("resize", () => {
          if (window.innerWidth >= 1024) {
            sidebar.classList.remove("-translate-x-full", "translate-x-0");
            sidebar.classList.add("lg:translate-x-0");
            sidebarOverlay.classList.add("hidden");
          }
        });

        document
          .getElementById("content-area")
          .addEventListener("submit", async (e) => {
            if (!isAuthReady) {
              showMessage("Firebase not ready. Please try again.");
              return;
            }
            e.preventDefault();

            let data = {};
            let collectionName = "";
            let idField = "";
            let successMessage = "";
            let addBtnId = "";
            let imageDropZoneId = "";
            let imagePreviewId = "";
            let summernoteId = "";

            switch (e.target.id) {
              case "testimonial-form":
                collectionName = "testimonials";
                idField = "testimonial-id";
                addBtnId = "add-testimonial-btn";
                imageDropZoneId = "avatar-drop-zone";
                imagePreviewId = "testimonial-avatar-src";
                data = {
                  name: document.getElementById("testimonial-name").value,
                  role: document.getElementById("testimonial-role").value,
                  avatarSrc:
                    document.getElementById("testimonial-avatar-src").value ||
                    "https://placehold.co/80x80/9CA3AF/white?text=User",
                  type: document.getElementById("testimonial-type-text").checked
                    ? "text"
                    : "video",
                  timestamp: serverTimestamp(),
                  status: "pending",
                };
                if (data.type === "text")
                  data.text = document.getElementById("testimonial-text").value;
                else
                  data.videoSrc = document.getElementById(
                    "testimonial-video-src"
                  ).value;
                successMessage = "Testimonial";
                break;
              case "blog-post-form":
                collectionName = "blogPosts";
                idField = "blog-id";
                addBtnId = "add-blog-btn";
                imageDropZoneId = "blog-image-drop-zone";
                imagePreviewId = "blog-image";
                summernoteId = "blog-content";
                data = {
                  title: document.getElementById("blog-title").value,
                  category: document.getElementById("blog-category").value,
                  content: $(`#${summernoteId}`).summernote("code"),
                  author: document.getElementById("blog-author").value,
                  authorImg:
                    document.getElementById("blog-author-img").value ||
                    "https://placehold.co/40x40/9CA3AF/white?text=A",
                  image:
                    document.getElementById("blog-image").value ||
                    "https://placehold.co/400x200/cccccc/white?text=Blog+Image",
                  timestamp: serverTimestamp(),
                  status: "draft",
                };
                successMessage = "Blog post";
                break;
              case "teacher-form":
                collectionName = "teachers";
                idField = "teacher-id";
                addBtnId = "add-teacher-btn";
                imageDropZoneId = "teacher-image-drop-zone";
                imagePreviewId = "teacher-image";
                summernoteId = "teacher-bio";
                data = {
                  name: document.getElementById("teacher-name").value,
                  expertise: document.getElementById("teacher-expertise").value,
                  bio: $(`#${summernoteId}`).summernote("code"),
                  image:
                    document.getElementById("teacher-image").value ||
                    "https://placehold.co/200x200/9CA3AF/white?text=Teacher",
                  timestamp: serverTimestamp(),
                  status: "active",
                };
                successMessage = "Teacher profile";
                break;
              case "free-resource-form":
                collectionName = "freeResources";
                idField = "free-resource-id";
                addBtnId = "add-free-resource-btn";
                imageDropZoneId = "free-resource-image-drop-zone";
                imagePreviewId = "free-resource-image";
                data = {
                  title: document.getElementById("free-resource-title").value,
                  category: document.getElementById("free-resource-category")
                    .value,
                  link: document.getElementById("free-resource-link").value,
                  summary: document.getElementById("free-resource-summary")
                    .value,
                  keypoints: document
                    .getElementById("free-resource-keypoints")
                    .value.split("\n")
                    .map((kp) => kp.trim())
                    .filter((kp) => kp !== ""),
                  img:
                    document.getElementById("free-resource-image").value ||
                    "https://placehold.co/400x200/cccccc/white?text=Resource+Image",
                  timestamp: serverTimestamp(),
                  views: "0 views",
                  status: "active",
                };
                successMessage = "Free resource";
                break;
              default:
                return;
            }

            try {
              const docId = document.getElementById(idField).value;
              if (docId) {
                await updateDoc(
                  doc(
                    db,
                    "artifacts",
                    appId,
                    "public",
                    "data",
                    collectionName,
                    docId
                  ),
                  data
                );
                showMessage(`${successMessage} updated successfully!`);
              } else {
                await addDoc(
                  collection(
                    db,
                    "artifacts",
                    appId,
                    "public",
                    "data",
                    collectionName
                  ),
                  data
                );
                showMessage(`${successMessage} added successfully!`);
              }
              e.target.reset();
              document.getElementById(idField).value = "";
              document.getElementById(
                addBtnId
              ).textContent = `Add ${successMessage}`;
              if (summernoteId && $(`#${summernoteId}`).data("summernote"))
                $(`#${summernoteId}`).summernote("code", "");
              if (imageDropZoneId)
                document.getElementById(imageDropZoneId)._setImage("");
              if (
                imageDropZoneId === "blog-image-drop-zone" &&
                document.getElementById("author-image-drop-zone")
              )
                document.getElementById("author-image-drop-zone")._setImage("");
            } catch (error) {
              console.error(`Error adding/updating ${collectionName}: `, error);
              showMessage(`Error: ${error.message}`);
            }
          });
      });
    </script>

  </body>
</html>

