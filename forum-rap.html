<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IELTS Mahir Community Forum</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for professional icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      /* Changed to system font stack for a more "Apple app-like" and professional feel */
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji",
          "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      /* Specific font classes can be kept for titles if desired, but general body will use system font */
      .font-anton {
        font-family: "Anton", sans-serif; /* Kept for strong branding on title */
      }
      /* Custom scrollbar for better aesthetics */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: var(--bg-scroll-track, #f1f1f1);
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb {
        background: var(--bg-scroll-thumb, #888);
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--bg-scroll-thumb-hover, #555);
      }

      /* Theme-specific scrollbar colors */
      .dark {
        --bg-scroll-track: #374151; /* gray-700 */
        --bg-scroll-thumb: #6b7280; /* gray-500 */
        --bg-scroll-thumb-hover: #4b5563; /* gray-600 */
      }
      .light {
        --bg-scroll-track: #f3f4f6; /* gray-100 */
        --bg-scroll-thumb: #a0aec0; /* gray-400 */
        --bg-scroll-thumb-hover: #718096; /* gray-500 */
      }

      /* Toast Notification Styling */
      #toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .toast {
        padding: 12px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        color: white;
        opacity: 0;
        transform: translateY(-20px);
        transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        min-width: 250px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }
      .toast.success {
        background-color: #28a745;
      } /* Green */
      .toast.error {
        background-color: #dc3545;
      } /* Red */
      .toast.info {
        background-color: #007bff;
      } /* Blue */
    </style>
  </head>
  <body class="light">
    <div
      id="app-root"
      class="min-h-screen flex flex-col transition-colors duration-300"
    >
      <!-- Header will be injected here -->
      <header
        id="app-header"
        class="py-4 px-6 md:px-8 flex items-center justify-between shadow-sm rounded-b-2xl transition-colors duration-300"
      ></header>

      <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar will be injected here -->
        <aside
          id="app-sidebar"
          class="fixed inset-y-0 left-0 w-64 md:relative md:w-auto transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out p-6 shadow-xl rounded-r-2xl md:rounded-2xl md:shadow-none z-40"
        ></aside>

        <!-- Main content area -->
        <main
          id="main-content"
          class="flex-1 overflow-y-auto p-4 md:p-6 lg:p-8 flex"
        ></main>
      </div>
    </div>

    <!-- AI Response Modal -->
    <div
      id="ai-modal-overlay"
      class="hidden fixed inset-0 bg-white flex items-center justify-center p-4 z-50"
    >
      <div
        id="ai-modal-content"
        class="relative rounded-2xl shadow-2xl p-6 md:p-8 max-w-lg w-full max-h-[85vh] md:max-h-[90vh] overflow-y-auto"
      >
        <button
          id="ai-modal-close-btn"
          class="absolute top-4 right-4 p-2 rounded-full transition-colors"
        >
          <i class="fas fa-times"></i>
        </button>
        <h3 id="ai-modal-title" class="text-2xl font-bold font-normal mb-4">
          AI Response
        </h3>
        <div id="ai-modal-body">
          <!-- AI content or loading spinner will be here -->
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Firebase SDK (Version 11.6.1 used in React example, so maintaining for consistency) -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        GoogleAuthProvider,
        signInWithPopup,
        onAuthStateChanged,
        signOut,
        deleteUser,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        addDoc,
        setDoc,
        updateDoc,
        deleteDoc,
        onSnapshot,
        collection,
        query,
        orderBy,
        where,
        arrayUnion,
        arrayRemove,
        serverTimestamp,
        writeBatch,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      // Removed Firebase Storage import as it won't be used for file uploads

      // --- Global State ---
      const appState = {
        db: null,
        auth: null,
        userId: null, // Current authenticated user's ID
        userProfile: null, // Current authenticated user's profile data
        isAuthReady: false,
        view: "auth", // Initial view is 'auth' to force login/signup
        homeFeedType: "latest", // 'latest', 'forYou', 'following' - default, can be set in settings
        selectedPost: null,
        posts: [], // All posts fetched from Firestore
        comments: {}, // Comments will now store nested structure if available
        notifications: [], // Current user's notifications
        unreadNotificationCount: 0,
        showSidebar: false,
        // Track Firestore listeners to unsubscribe later if needed (though for a simple app, not not strictly necessary)
        postsUnsubscribe: null,
        commentsUnsubscribe: null,
        notificationsUnsubscribe: null, // New unsubscribe for notifications
        userProfileUnsubscribe: null, // New unsubscribe for current user's profile to get real-time updates on preferences
        allUsersProfilesUnsubscribe: null, // New unsubscribe for all user profiles
        activeCategory: null, // Track active category for filtering
        activeSubCategory: null, // Track active subcategory for filtering
        // State for "See More" comments/replies
        visibleCommentsCount: 5, // Initial count for main post comments
        visibleRepliesCount: {}, // Object to store visible count per parent comment ID
        editingPostId: null, // Track which post is being edited
        editingCommentId: null, // Track which comment is being edited
        expandedReplies: {}, // New state to track which comment replies are expanded
        editingProfile: false, // New state for profile editing (now part of settings)
        viewedProfile: null, // The profile object of the user currently being viewed
        allUsersProfiles: [], // Cache for all user profiles for display and lookup
        shouldCompleteProfile: false, // New flag for profile completion enforcement
      };

      // --- Constants ---
      const MAX_VISIBLE_TOP_LEVEL_COMMENTS = 5;
      const MAX_VISIBLE_NESTED_REPLIES = 3;

      const BAND_GOALS = [
        "N/A",
        "5.0",
        "5.5",
        "6.0",
        "6.5",
        "7.0",
        "7.5",
        "8.0",
        "8.5",
        "9.0",
      ];
      const PREP_STATUSES = [
        "New Learner",
        "Beginner",
        "Intermediate",
        "Advanced",
        "Ready for Test",
        "Test Taken",
      ];
      const COUNTRIES = [
        "Afghanistan",
        "Albania",
        "Algeria",
        "Andorra",
        "Angola",
        "Antigua and Barbuda",
        "Argentina",
        "Armenia",
        "Australia",
        "Austria",
        "Azerbaijan",
        "Bahamas",
        "Bahrain",
        "Bangladesh",
        "Barbados",
        "Belarus",
        "Belgium",
        "Belize",
        "Benin",
        "Bhutan",
        "Bolivia",
        "Bosnia and Herzegovina",
        "Botswana",
        "Brazil",
        "Brunei",
        "Bulgaria",
        "Burkina Faso",
        "Burundi",
        "Cabo Verde",
        "Cambodia",
        "Cameroon",
        "Central African Republic",
        "Chad",
        "Chile",
        "China",
        "Colombia",
        "Comoros",
        "Congo (Congo-Brazzaville)",
        "Costa Rica",
        "Croatia",
        "Cuba",
        "Cyprus",
        "Czechia (Czech Republic)",
        "Democratic Republic of the Congo",
        "Denmark",
        "Djibouti",
        "Dominica",
        "Dominican Republic",
        "Ecuador",
        "Egypt",
        "El Salvador",
        "Equatorial Guinea",
        "Eritrea",
        "Estonia",
        "Eswatini (formerly Swaziland)",
        "Ethiopia",
        "Fiji",
        "Finland",
        "France",
        "Gabon",
        "Gambia",
        "Georgia",
        "Germany",
        "Ghana",
        "Greece",
        "Grenada",
        "Guatemala",
        "Guinea",
        "Guinea-Bissau",
        "Guyana",
        "Haiti",
        "Honduras",
        "Hungary",
        "Iceland",
        "India",
        "Indonesia",
        "Iran",
        "Iraq",
        "Ireland",
        "Israel",
        "Italy",
        "Ivory Coast",
        "Jamaica",
        "Japan",
        "Jordan",
        "Kazakhstan",
        "Kenya",
        "Kiribati",
        "Kuwait",
        "Kyrgyzstan",
        "Laos",
        "Latvia",
        "Lebanon",
        "Lesotho",
        "Liberia",
        "Libya",
        "Liechtenstein",
        "Lithuania",
        "Luxembourg",
        "Madagascar",
        "Malawi",
        "Malaysia",
        "Maldives",
        "Mali",
        "Malta",
        "Marshall Islands",
        "Mauritania",
        "Mauritius",
        "Mexico",
        "Micronesia",
        "Moldova",
        "Monaco",
        "Mongolia",
        "Montenegro",
        "Morocco",
        "Mozambique",
        "Myanmar (formerly Burma)",
        "Namibia",
        "Nauru",
        "Nepal",
        "Netherlands",
        "New Zealand",
        "Nicaragua",
        "Niger",
        "Nigeria",
        "North Korea",
        "North Macedonia (formerly Macedonia)",
        "Norway",
        "Oman",
        "Pakistan",
        "Palau",
        "Palestine State",
        "Panama",
        "Papua New Guinea",
        "Paraguay",
        "Peru",
        "Philippines",
        "Poland",
        "Portugal",
        "Qatar",
        "Romania",
        "Russia",
        "Rwanda",
        "Saint Kitts and Nevis",
        "Saint Lucia",
        "Saint Vincent and the Grenadines",
        "Samoa",
        "San Marino",
        "Sao Tome and Principe",
        "Saudi Arabia",
        "Senegal",
        "Serbia",
        "Seychelles",
        "Sierra Leone",
        "Singapore",
        "Slovakia",
        "Slovenia",
        "Solomon Islands",
        "Somalia",
        "South Africa",
        "South Korea",
        "South Sudan",
        "Spain",
        "Sri Lanka",
        "Sudan",
        "Suriname",
        "Sweden",
        "Switzerland",
        "Syria",
        "Taiwan",
        "Tajikistan",
        "Tanzania",
        "Thailand",
        "Timor-Leste",
        "Togo",
        "Tonga",
        "Trinidad and Tobago",
        "Tunisia",
        "Turkey",
        "Turkmenistan",
        "Tuvalu",
        "Uganda",
        "Ukraine",
        "United Arab Emirates",
        "United Kingdom",
        "United States of America",
        "Uruguay",
        "Uzbekistan",
        "Vanuatu",
        "Venezuela",
        "Vietnam",
        "Yemen",
        "Zambia",
        "Zimbabwe",
      ];
      const IELTS_EXPERIENCES = [
        "First time taking IELTS",
        "Taken multiple times",
        "Preparing for the first time",
        "Already taken and passed",
      ];

      // Sample Badge Data (for UI display purposes)
      const ALL_BADGES = [
        {
          id: "first_post",
          name: "First Post",
          description: "Created your first forum post!",
          icon: "‚úçÔ∏è",
        },
        {
          id: "helpful_member",
          name: "Helpful Member",
          description: "Received 10 upvotes on your posts/comments.",
          icon: "üåü",
        },
        {
          id: "ielts_master",
          name: "IELTS Master",
          description: "Achieved Band 9 goal.",
          icon: "üèÜ",
        },
        {
          id: "daily_streak",
          name: "Daily Contributor",
          description: "Posted or commented for 3 consecutive days.",
          icon: "üî•",
        },
        {
          id: "speaking_expert",
          name: "Speaking Expert",
          description: "Contributed significantly to Speaking topics.",
          icon: "üó£Ô∏è",
        },
        {
          id: "writing_guru",
          name: "Writing Guru",
          description: "Contributed significantly to Writing topics.",
          icon: "üìù",
        },
        {
          id: "resolved_solver",
          name: "Problem Solver",
          description: "Marked 5 of your questions as resolved.",
          icon: "‚úÖ",
        },
      ];

      // --- DOM Elements Cache ---
      const elements = {};

      // --- Helper Icons (Font Awesome classes) ---
      const Icons = {
        Sun: `<i class="fas fa-sun"></i>`, // Keeping for now, even if not used directly
        Moon: `<i class="fas fa-moon"></i>`, // Keeping for now, even if not used directly
        Plus: `<i class="fas fa-plus"></i>`,
        MessageCircleMore: `<i class="fas fa-comments"></i>`,
        Search: `<i class="fas fa-search"></i>`,
        ChevronDown: `<i class="fas fa-chevron-down"></i>`,
        ChevronRight: `<i class="fas fa-chevron-right"></i>`,
        User: `<i class="fas fa-user-circle"></i>`,
        Award: `<i class="fas fa-award"></i>`,
        Zap: `<i class="fas fa-bolt"></i>`,
        CheckCircle: `<i class="fas fa-check-circle"></i>`,
        ThumbsUp: `<i class="far fa-thumbs-up"></i>`,
        ThumbsUpSolid: `<i class="fas fa-thumbs-up"></i>`,
        ThumbsDown: `<i class="far fa-thumbs-down"></i>`,
        ThumbsDownSolid: `<i class="fas fa-thumbs-down"></i>`,
        ArrowLeft: `<i class="fas fa-arrow-left"></i>`,
        Menu: `<i class="fas fa-bars"></i>`,
        X: `<i class="fas fa-times"></i>`,
        Target: `<i class="fas fa-bullseye"></i>`,
        Activity: `<i class="fas fa-chart-line"></i>`,
        Edit: `<i class="fas fa-edit"></i>`,
        Save: `<i class="fas fa-save"></i>`,
        Cancel: `<i class="fas fa-times-circle"></i>`,
        Link: `<i class="fas fa-external-link-alt"></i>`,
        Trash: `<i class="fas fa-trash-alt"></i>`,
        Star: `<i class="fas fa-star"></i>`,
        Users: `<i class="fas fa-users"></i>`,
        Filter: `<i class="fas fa-filter"></i>`,
        Heart: `<i class="fas fa-heart"></i>`,
        UserPlus: `<i class="fas fa-user-plus"></i>`,
        UserCheck: `<i class="fas fa-user-check"></i>`,
        Bell: `<i class="fas fa-bell"></i>`, // New: Bell icon for notifications
        Cog: `<i class="fas fa-cog"></i>`, // New: Cog icon for settings
      };

      // --- Core Functions ---

      /**
       * Displays a transient toast notification to the user.
       * @param {string} message The message to display.
       * @param {'success'|'error'|'info'} type The type of notification (influences styling).
       * @param {number} duration The duration in milliseconds before the toast disappears.
       */
      function showToast(message, type, duration = 3000) {
        const toastContainer = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.innerHTML = `
                ${
                  type === "success"
                    ? '<i class="fas fa-check-circle"></i>'
                    : ""
                }
                ${
                  type === "error"
                    ? '<i class="fas fa-exclamation-triangle"></i>'
                    : ""
                }
                ${type === "info" ? '<i class="fas fa-info-circle"></i>' : ""}
                <span>${message}</span>
            `;
        toastContainer.appendChild(toast);

        // Trigger reflow to ensure CSS transition plays
        void toast.offsetWidth;

        toast.classList.add("show");

        setTimeout(() => {
          toast.classList.remove("show");
          toast.addEventListener("transitionend", () => toast.remove());
        }, duration);
      }

      /**
       * Formats a Firestore Timestamp or Date object into a Facebook-like relative time string.
       * @param {firebase.firestore.Timestamp | Date} timestamp The timestamp or date object.
       * @returns {string} The formatted relative time string.
       */
      function formatRelativeTime(timestamp) {
        if (!timestamp) return "N/A";

        const date = timestamp.toDate ? timestamp.toDate() : timestamp; // Convert Firestore Timestamp to Date object
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);

        if (seconds < 60) {
          return seconds <= 0 ? "Just now" : `${seconds}s ago`;
        }

        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) {
          return `${minutes}m ago`;
        }

        const hours = Math.floor(minutes / 60);
        if (hours < 24) {
          return `${hours}h ago`;
        }

        const yesterday = new Date(now);
        yesterday.setDate(now.getDate() - 1);
        if (
          date.getDate() === yesterday.getDate() &&
          date.getMonth() === yesterday.getMonth() &&
          date.getFullYear() === yesterday.getFullYear()
        ) {
          return `Yesterday at ${new Intl.DateTimeFormat("en-US", {
            hour: "numeric",
            minute: "numeric",
            hour12: true,
          }).format(date)}`;
        }

        // Within the current year
        if (date.getFullYear() === now.getFullYear()) {
          return new Intl.DateTimeFormat("en-US", {
            month: "short",
            day: "numeric",
            hour: "numeric",
            minute: "numeric",
            hour12: true,
          }).format(date);
        }

        // Older than current year
        return new Intl.DateTimeFormat("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
        }).format(date);
      }

      /**
       * Navigates to a new view in the application.
       * @param {string} newView The name of the new view ('home', 'postDetail', 'createPost', 'profile', 'notifications', 'settings', 'auth').
       * @param {object} [options={}] Optional parameters for the new view.
       * @param {object} [options.post] The post object if navigating to 'postDetail'.
       * @param {string} [options.category] The category to filter by if navigating to 'home'.
       * @param {string} [options.subCategory] The subcategory to filter by if navigating to 'home'.
       * @param {string} [options.targetUserId] The ID of the user whose profile is to be viewed if navigating to 'profile'.
       * @param {'latest'|'forYou'|'following'} [options.homeFeedType] The type of feed to show if navigating to 'home'.
       * @param {'login'|'signup'} [options.authMode] The mode for the auth page.
       */
      function navigateTo(newView, options = {}) {
        // If not authenticated and trying to access a protected view, redirect to auth.
        const protectedViews = [
          "home",
          "postDetail",
          "createPost",
          "profile",
          "notifications",
          "settings",
        ];
        if (!appState.userId && protectedViews.includes(newView)) {
          showToast("Please sign in or create an account.", "info");
          appState.view = "auth";
          appState.authMode = options.authMode || "login"; // Default to login
          renderMainContent();
          return;
        }

        appState.view = newView;
        appState.authMode = options.authMode || "login"; // Set auth mode for auth view
        appState.selectedPost = options.post || null;
        appState.activeCategory = options.category || null;
        appState.activeSubCategory = options.subCategory || null;
        appState.showSidebar = false; // Close sidebar on navigation

        // Update homeFeedType only if navigating to 'home' and a new type is provided
        if (newView === "home" && options.homeFeedType) {
          appState.homeFeedType = options.homeFeedType;
        } else if (newView === "home" && !options.homeFeedType) {
          // If navigating to home without a specific type, use the user's default, otherwise 'latest'
          appState.homeFeedType =
            appState.userProfile?.defaultHomeFeed || "latest";
        } else if (newView !== "home") {
          // No change to homeFeedType if not navigating to home
        }

        // Set the viewed profile ID. If navigating to 'profile' and targetUserId is provided, use it.
        // Otherwise, if it's 'profile' view without a target, assume current user.
        // For other views, clear viewedProfile to ensure no stale data.
        if (newView === "profile") {
          appState.viewedProfile = options.targetUserId || appState.userId;
        } else {
          appState.viewedProfile = null;
        }

        // Reset visible comment/reply counts and editing state when navigating away from post detail
        if (newView !== "postDetail") {
          appState.visibleCommentsCount = MAX_VISIBLE_TOP_LEVEL_COMMENTS;
          appState.visibleRepliesCount = {};
          appState.editingPostId = null;
          appState.editingCommentId = null;
          appState.expandedReplies = {}; // Reset expanded replies state
        }
        // Reset profile editing state if navigating away from profile/settings (or to a different profile)
        if (
          newView !== "settings" &&
          (newView !== "profile" || options.targetUserId !== appState.userId)
        ) {
          appState.editingProfile = false;
        }

        renderMainContent();
        renderSidebar(); // Update sidebar visibility
      }

      /**
       * Creates a notification for a target user.
       * @param {string} targetUserId The ID of the user to notify.
       * @param {string} message The notification message.
       * @param {string} type The type of notification (e.g., 'vote', 'reply', 'follow', 'new_post').
       * @param {string} link An internal link (e.g., postId, commentId, userId) for the notification.
       * @param {string|null} sourceUserId The ID of the user who triggered the notification, if applicable.
       */
      async function createNotification(
        targetUserId,
        message,
        type,
        link,
        sourceUserId = null
      ) {
        if (!appState.db || !targetUserId) {
          console.warn(
            "Cannot create notification: DB or targetUserId missing"
          );
          return;
        }

        // Check user's notification preferences before creating
        const appId =
          typeof __app_id !== "undefined"
            ? __app_id
            : "ielts-mahir-community-forum";
        const targetUserProfileRef = doc(
          appState.db,
          `artifacts/${appId}/users/${targetUserId}/userProfile/profile`
        );
        try {
          const profileSnap = await getDoc(targetUserProfileRef);
          if (profileSnap.exists()) {
            const preferences =
              profileSnap.data().notificationPreferences || {};
            // If the user has explicitly disabled this type of notification, don't create it.
            // If type is 'new_post' and preferences.new_post is false, then skip.
            // Default is true if preference is undefined.
            if (preferences[type] === false) {
              // console.log(`Notification for ${type} disabled by user ${targetUserId}`);
              return;
            }
          }
        } catch (e) {
          console.error("Error checking notification preferences:", e);
          // Proceed with notification creation even if we can't check preferences
        }

        try {
          await addDoc(
            collection(
              appState.db,
              `artifacts/${appId}/users/${targetUserId}/notifications`
            ),
            {
              message,
              type,
              link, // Can be postId, or combined postId/commentId for replies
              createdAt: serverTimestamp(),
              read: false,
              sourceUserId: sourceUserId, // Who caused this notification
            }
          );
          // console.log("Notification created successfully for user:", targetUserId);
        } catch (e) {
          console.error("Error adding notification:", e);
        }
      }

      async function addPost(newPostData) {
        if (!appState.db || !appState.userId || !appState.userProfile) {
          console.error("Database, user ID or user profile not ready.");
          showToast(
            "Error: User not authenticated or profile missing.",
            "error"
          );
          return;
        }

        try {
          const appId =
            typeof __app_id !== "undefined"
              ? __app_id
              : "ielts-mahir-community-forum";
          const newPostRef = await addDoc(
            collection(appState.db, `artifacts/${appId}/public/data/posts`),
            {
              ...newPostData,
              authorId: appState.userId,
              authorName: appState.userProfile.name,
              createdAt: serverTimestamp(),
              upvotes: 0,
              downvotes: 0,
              upvotedBy: [],
              downvotedBy: [],
              isResolved: false,
              tags: [],
              imageUrl: null,
              videoUrl: null,
            }
          );
          console.log("Post added successfully!");
          showToast("Post created successfully!", "success");

          // --- Broad Notification: New Post to Followers ---
          const postAuthorId = appState.userId;
          const postAuthorName = appState.userProfile.name;
          const postId = newPostRef.id;
          const postTitle = newPostData.title;

          console.log(
            "Attempting to notify followers for new post:",
            postTitle
          );
          console.log(
            "Current appState.allUsersProfiles for follower lookup:",
            appState.allUsersProfiles
          );

          // Find all users who are following the post author
          const followers = appState.allUsersProfiles.filter((profile) => {
            // Ensure profile.following is an array and contains the postAuthorId
            return (profile.following || []).includes(postAuthorId);
          });

          console.log("Identified followers:", followers);

          // Create a notification for each follower
          for (const follower of followers) {
            // Do not notify the author themselves for their own post
            if (follower.userId !== postAuthorId) {
              try {
                await createNotification(
                  follower.userId,
                  `${postAuthorName} has posted a new discussion: "${postTitle.substring(
                    0,
                    50
                  )}..."`,
                  "new_post", // New notification type
                  postId, // Link to the new post
                  postAuthorId // Source is the post author
                );
                console.log(
                  `Notification sent to ${follower.name || follower.userId}`
                );
              } catch (notifError) {
                console.error(
                  `Error sending notification to ${follower.userId}:`,
                  notifError
                );
              }
            }
          }

          navigateTo("home");
        } catch (e) {
          console.error("Error adding post: ", e);
          showToast("Error creating post. Check console.", "error");
        }
      }

      async function updatePost(postId, updatedData) {
        if (!appState.db) return;
        try {
          const appId =
            typeof __app_id !== "undefined"
              ? __app_id
              : "ielts-mahir-community-forum";
          await updateDoc(
            doc(appState.db, `artifacts/${appId}/public/data/posts`, postId),
            updatedData
          );
          console.log("Post updated successfully!");
          showToast("Post updated successfully!", "success");
          appState.editingPostId = null; // Exit editing mode
          renderPostDetail(); // Re-render to show updated post
        } catch (e) {
          console.error("Error updating post: ", e);
          showToast("Error updating post. Check console.", "error");
        }
      }

      async function deletePost(postId) {
        if (!appState.db || !appState.userId) {
          showToast("Error: User not authenticated.", "error");
          return;
        }

        showConfirmationModal(
          "Delete Post",
          "Are you sure you want to delete this post and all its comments?",
          async () => {
            try {
              const appId =
                typeof __app_id !== "undefined"
                  ? __app_id
                  : "ielts-mahir-community-forum";
              const batch = writeBatch(appState.db);

              // Delete the post document
              const postRef = doc(
                appState.db,
                `artifacts/${appId}/public/data/posts`,
                postId
              );
              batch.delete(postRef);

              // Query and delete all comments associated with the post
              const commentsQuery = query(
                collection(
                  appState.db,
                  `artifacts/${appId}/public/data/comments`
                ),
                where("postId", "==", postId)
              );
              const commentsSnapshot = await getDocs(commentsQuery);
              commentsSnapshot.forEach((commentDoc) => {
                batch.delete(commentDoc.ref);
              });

              await batch.commit();
              console.log("Post and associated comments deleted successfully!");
              showToast("Post and comments deleted successfully!", "success");
              navigateTo("home"); // Go back to home page after deletion
            } catch (e) {
              console.error("Error deleting post and comments: ", e);
              showToast(
                "Error deleting post. Check console for details (e.g., permissions).",
                "error"
              );
            }
          }
        );
      }

      async function addComment(postId, content, parentId = null, depth = 0) {
        if (
          !appState.db ||
          !appState.userId ||
          !appState.userProfile ||
          !content.trim()
        ) {
          console.error(
            "Database, user ID, user profile, or comment content not ready."
          );
          showToast(
            "Error: User not authenticated or comment content empty.",
            "error"
          );
          return;
        }
        try {
          const appId =
            typeof __app_id !== "undefined"
              ? __app_id
              : "ielts-mahir-community-forum";
          const newCommentRef = await addDoc(
            collection(appState.db, `artifacts/${appId}/public/data/comments`),
            {
              postId: postId,
              authorId: appState.userId,
              authorName: appState.userProfile.name,
              content: content,
              createdAt: serverTimestamp(),
              parentId: parentId,
              depth: depth,
              upvotes: 0,
              downvotes: 0,
              upvotedBy: [],
              downvotedBy: [],
            }
          );
          console.log("Comment added successfully!");
          showToast("Comment added successfully!", "success");

          // --- Notification: Reply to Post/Comment ---
          const post = appState.posts.find((p) => p.id === postId);
          if (post && post.authorId !== appState.userId) {
            // Notify post author if current user commented on their post
            await createNotification(
              post.authorId,
              `${
                appState.userProfile.name
              } commented on your post: "${post.title.substring(0, 30)}..."`,
              "reply",
              postId,
              appState.userId
            );
          } else if (parentId) {
            // If it's a reply to a comment, notify the parent comment's author
            const parentComment = Object.values(appState.comments)
              .flat()
              .find((c) => c.id === parentId);
            if (parentComment && parentComment.authorId !== appState.userId) {
              await createNotification(
                parentComment.authorId,
                `${
                  appState.userProfile.name
                } replied to your comment: "${parentComment.content.substring(
                  0,
                  30
                )}..."`,
                "reply",
                `${postId}#${newCommentRef.id}`, // Link to comment specifically
                appState.userId
              );
            }
          }
        } catch (e) {
          console.error("Error adding comment: ", e);
          showToast("Error adding comment. Check console.", "error");
        }
      }

      async function updateComment(commentId, updatedContent) {
        if (!appState.db) return;
        try {
          const appId =
            typeof __app_id !== "undefined"
              ? __app_id
              : "ielts-mahir-community-forum";
          await updateDoc(
            doc(
              appState.db,
              `artifacts/${appId}/public/data/comments`,
              commentId
            ),
            {
              content: updatedContent,
            }
          );
          console.log("Comment updated successfully!");
          showToast("Comment updated successfully!", "success");
          appState.editingCommentId = null; // Exit editing mode
          renderComments(appState.selectedPost.id); // Re-render comments
        } catch (e) {
          console.error("Error updating comment: ", e);
          showToast("Error updating comment. Check console.", "error");
        }
      }

      async function deleteComment(commentId, postId) {
        if (!appState.db || !appState.userId) {
          showToast("Error: User not authenticated.", "error");
          return;
        }

        showConfirmationModal(
          "Delete Comment",
          "Are you sure you want to delete this comment and its replies?",
          async () => {
            try {
              const appId =
                typeof __app_id !== "undefined"
                  ? __app_id
                  : "ielts-mahir-community-forum";
              const batch = writeBatch(appState.db);

              // Delete the comment document itself
              const commentRef = doc(
                appState.db,
                `artifacts/${appId}/public/data/comments`,
                commentId
              );
              batch.delete(commentRef);

              // Query and delete all replies to this comment (recursively not needed, just direct children)
              // The Firestore listener for comments will re-evaluate and update the UI accordingly.
              const nestedRepliesQuery = query(
                collection(
                  appState.db,
                  `artifacts/${appId}/public/data/comments`
                ),
                where("parentId", "==", commentId)
              );
              const nestedRepliesSnapshot = await getDocs(nestedRepliesQuery);
              nestedRepliesSnapshot.forEach((nestedReplyDoc) => {
                batch.delete(nestedReplyDoc.ref);
              });

              await batch.commit();
              console.log("Comment and nested replies deleted successfully!");
              showToast("Comment deleted successfully!", "success");
              // Re-render comments for the current post to reflect changes
              renderComments(postId);
            } catch (e) {
              console.error("Error deleting comment and nested replies: ", e);
              showToast(
                "Error deleting comment. Check console for details (e.g., permissions).",
                "error"
              );
            }
          }
        );
      }

      async function togglePostResolved(postId, isResolved) {
        if (!appState.db) return;
        try {
          const appId =
            typeof __app_id !== "undefined"
              ? __app_id
              : "ielts-mahir-community-forum";
          await updateDoc(
            doc(appState.db, `artifacts/${appId}/public/data/posts`, postId),
            {
              isResolved: !isResolved,
            }
          );
          console.log("Post resolved status updated.");
          showToast("Post resolved status updated!", "info");
        } catch (e) {
          console.error("Error updating post resolved status: ", e);
          showToast("Error updating resolved status. Check console.", "error");
        }
      }

      async function updatePostVotes(postId, type) {
        if (!appState.db || !appState.userId) return;
        try {
          const appId =
            typeof __app_id !== "undefined"
              ? __app_id
              : "ielts-mahir-community-forum";
          const postRef = doc(
            appState.db,
            `artifacts/${appId}/public/data/posts`,
            postId
          );
          const postSnap = await getDoc(postRef);
          if (postSnap.exists()) {
            const currentData = postSnap.data();
            let newUpvotes = currentData.upvotes || 0;
            let newDownvotes = currentData.downvotes || 0;
            let upvotedBy = currentData.upvotedBy || [];
            let downvotedBy = currentData.downvotedBy || [];

            const userAlreadyUpvoted = upvotedBy.includes(appState.userId);
            const userAlreadyDownvoted = downvotedBy.includes(appState.userId);

            let authorReputationChange = 0;

            if (type === "up") {
              if (userAlreadyUpvoted) {
                // User clicked upvote again, so remove upvote
                upvotedBy = upvotedBy.filter((id) => id !== appState.userId);
                newUpvotes--;
                authorReputationChange = -1; // Lose 1 reputation for removing upvote
              } else {
                // User upvoted
                upvotedBy = [...upvotedBy, appState.userId];
                newUpvotes++;
                authorReputationChange = 1; // Gain 1 reputation for upvote
                // If previously downvoted, remove downvote
                if (userAlreadyDownvoted) {
                  downvotedBy = downvotedBy.filter(
                    (id) => id !== appState.userId
                  );
                  newDownvotes--;
                  authorReputationChange += 1; // Gain 1 more reputation for negating a downvote
                }
              }
            } else if (type === "down") {
              if (userAlreadyDownvoted) {
                // User clicked downvote again, so remove downvote
                downvotedBy = downvotedBy.filter(
                  (id) => id !== appState.userId
                );
                newDownvotes--;
                authorReputationChange = 1; // Gain 1 reputation for removing downvote
              } else {
                downvotedBy = [...downvotedBy, appState.userId];
                newDownvotes++;
                authorReputationChange = -1; // Lose 1 reputation for downvote
                // If previously upvoted, remove upvote
                if (userAlreadyUpvoted) {
                  upvotedBy = upvotedBy.filter((id) => id !== appState.userId);
                  newUpvotes--;
                  authorReputationChange += -1; // Lose 1 more reputation for negating an upvote
                }
              }
            }

            await updateDoc(postRef, {
              upvotes: newUpvotes,
              downvotes: newDownvotes,
              upvotedBy: upvotedBy,
              downvotedBy: downvotedBy,
            });

            // --- START FIX: Reputation update is now client-side only if the voter is the author of the post.
            // For a production app, use Firebase Cloud Functions to securely update reputation from the server.
            if (
              authorReputationChange !== 0 &&
              currentData.authorId === appState.userId // Only update if the author is the current user
            ) {
              const authorProfileRef = doc(
                appState.db,
                `artifacts/${appId}/users/${currentData.authorId}/userProfile/profile`
              );
              const authorProfileSnap = await getDoc(authorProfileRef);
              if (authorProfileSnap.exists()) {
                const currentReputation =
                  authorProfileSnap.data().reputation || 0;
                await updateDoc(authorProfileRef, {
                  reputation: Math.max(
                    0,
                    currentReputation + authorReputationChange
                  ), // Reputation cannot go below 0
                });
                // showToast(`Reputation for ${currentData.authorName} changed by ${authorReputationChange}`, 'info');
              }
            }
            // --- END FIX ---

            showToast("Vote updated!", "info");

            // --- Notification: Vote on Post ---
            if (
              currentData.authorId !== appState.userId &&
              (type === "up" || type === "down")
            ) {
              const voterName = appState.userProfile?.name || "Someone";
              const voteType = type === "up" ? "upvoted" : "downvoted";
              const message = `${voterName} ${voteType} your post: "${currentData.title.substring(
                0,
                30
              )}..."`;
              await createNotification(
                currentData.authorId,
                message,
                "vote",
                postId,
                appState.userId
              );
            }
          }
        } catch (e) {
          console.error("Error updating post votes: ", e);
          showToast("Error updating vote. Check console.", "error");
        }
      }

      async function updateCommentVotes(commentId, type) {
        if (!appState.db || !appState.userId) return;
        try {
          const appId =
            typeof __app_id !== "undefined"
              ? __app_id
              : "ielts-mahir-community-forum";
          const commentRef = doc(
            appState.db,
            `artifacts/${appId}/public/data/comments`,
            commentId
          );
          const commentSnap = await getDoc(commentRef);
          if (commentSnap.exists()) {
            const currentData = commentSnap.data();
            let newUpvotes = currentData.upvotes || 0;
            let newDownvotes = currentData.downvotes || 0;
            let upvotedBy = currentData.upvotedBy || [];
            let downvotedBy = currentData.downvotedBy || [];

            const userAlreadyUpvoted = upvotedBy.includes(appState.userId);
            const userAlreadyDownvoted = downvotedBy.includes(appState.userId);

            let authorReputationChange = 0;

            if (type === "up") {
              if (userAlreadyUpvoted) {
                upvotedBy = upvotedBy.filter((id) => id !== appState.userId);
                newUpvotes--;
                authorReputationChange = -1;
              } else {
                upvotedBy = [...upvotedBy, appState.userId];
                newUpvotes++;
                authorReputationChange = 1;
                if (userAlreadyDownvoted) {
                  downvotedBy = downvotedBy.filter(
                    (id) => id !== appState.userId
                  );
                  newDownvotes--;
                  authorReputationChange += 1;
                }
              }
            } else if (type === "down") {
              if (userAlreadyDownvoted) {
                downvotedBy = downvotedBy.filter(
                  (id) => id !== appState.userId
                );
                newDownvotes--;
                authorReputationChange = 1;
              } else {
                downvotedBy = [...downvotedBy, appState.userId];
                newDownvotes++;
                authorReputationChange = -1;
                if (userAlreadyUpvoted) {
                  upvotedBy = upvotedBy.filter((id) => id !== appState.userId);
                  newUpvotes--;
                  authorReputationChange += -1;
                }
              }
            }

            await updateDoc(commentRef, {
              upvotes: newUpvotes,
              downvotes: newDownvotes,
              upvotedBy: upvotedBy,
              downvotedBy: downvotedBy,
            });

            // --- START FIX: Reputation update is now client-side only if the voter is the author of the comment.
            // For a production app, use Firebase Cloud Functions to securely update reputation from the server.
            if (
              authorReputationChange !== 0 &&
              currentData.authorId === appState.userId // Only update if the author is the current user
            ) {
              const authorProfileRef = doc(
                appState.db,
                `artifacts/${appId}/users/${currentData.authorId}/userProfile/profile`
              );
              const authorProfileSnap = await getDoc(authorProfileRef);
              if (authorProfileSnap.exists()) {
                const currentReputation =
                  authorProfileSnap.data().reputation || 0;
                await updateDoc(authorProfileRef, {
                  reputation: Math.max(
                    0,
                    currentReputation + authorReputationChange
                  ),
                });
              }
            }
            // --- END FIX ---
            showToast("Comment vote updated!", "info");

            // --- Notification: Vote on Comment ---
            if (
              currentData.authorId !== appState.userId &&
              (type === "up" || type === "down")
            ) {
              const voterName = appState.userProfile?.name || "Someone";
              const voteType = type === "up" ? "upvoted" : "downvoted";
              const message = `${voterName} ${voteType} your comment: "${currentData.content.substring(
                0,
                30
              )}..."`;
              await createNotification(
                currentData.authorId,
                message,
                "vote",
                `${currentData.postId}#${commentId}`, // Link to specific comment
                appState.userId
              );
            }
          }
        } catch (e) {
          console.error("Error updating comment votes: ", e);
          showToast("Error updating comment vote. Check console.", "error");
        }
      }

      /**
       * Toggles follow status for a target user.
       * @param {string} targetUserId The ID of the user to follow/unfollow.
       */
      async function toggleFollow(targetUserId) {
        if (!appState.db || !appState.userId || !appState.userProfile) {
          showToast("Please sign in to follow users.", "info");
          return;
        }
        if (targetUserId === appState.userId) {
          showToast("You cannot follow yourself.", "info");
          return;
        }

        try {
          const appId =
            typeof __app_id !== "undefined"
              ? __app_id
              : "ielts-mahir-community-forum";
          const currentUserProfileRef = doc(
            appState.db,
            `artifacts/${appId}/users/${appState.userId}/userProfile/profile`
          );

          let updatedFollowingArray;
          let isCurrentlyFollowing =
            appState.userProfile.following &&
            appState.userProfile.following.includes(targetUserId);

          if (isCurrentlyFollowing) {
            // Unfollow
            updatedFollowingArray = appState.userProfile.following.filter(
              (id) => id !== targetUserId
            );
            showToast(
              `Unfollowed ${
                appState.allUsersProfiles.find((p) => p.userId === targetUserId)
                  ?.name || "user"
              }.`,
              "info"
            );
          } else {
            // Follow
            updatedFollowingArray = [
              ...(appState.userProfile.following || []),
              targetUserId,
            ];
            showToast(
              `Following ${
                appState.allUsersProfiles.find((p) => p.userId === targetUserId)
                  ?.name || "user"
              }!`,
              "success"
            );
            // --- Notification: New Follower ---
            await createNotification(
              targetUserId,
              `${
                appState.userProfile?.name || "Someone"
              } started following you!`,
              "follow",
              appState.userId, // Link to the follower's profile
              appState.userId
            );
          }

          // Update Firestore
          await updateDoc(currentUserProfileRef, {
            following: updatedFollowingArray,
          });

          // Update local appState immediately
          appState.userProfile.following = updatedFollowingArray;

          // Re-render the main content to update all follow buttons
          renderMainContent();
        } catch (e) {
          console.error("Error toggling follow:", e);
          showToast("Error toggling follow. Check console.", "error");
        }
      }

      async function callGeminiAI(prompt, targetElementId) {
        const modalBody = document.getElementById("ai-modal-body");
        modalBody.innerHTML = `<div class="flex flex-col justify-center items-center h-24">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div>
                <p class="mt-3 text-gray-700">Generating AI response...</p>
            </div>`;
        document.getElementById("ai-modal-overlay").classList.remove("hidden");
        document
          .getElementById("ai-modal-overlay")
          .classList.add("opacity-100");

        try {
          let chatHistory = [];
          chatHistory.push({ role: "user", parts: [{ text: prompt }] });
          const payload = { contents: chatHistory };
          // IMPORTANT: API key is provided by the environment, leave empty string
          const apiKey = ""; // Canvas will automatically provide the API key
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const result = await response.json();
          if (
            result.candidates &&
            result.candidates.length > 0 &&
            result.candidates[0].content &&
            result.candidates[0].content.parts &&
            result.candidates[0].content.parts.length > 0
          ) {
            const text = result.candidates[0].content.parts[0].text;
            modalBody.innerHTML = `<p class="font-normal whitespace-pre-wrap text-gray-700">${text}</p>`;
          } else {
            modalBody.innerHTML = `<p class="font-normal text-red-600">Failed to get AI response: Unexpected structure.</p>`;
            console.error(
              "Gemini API: Unexpected response structure or content missing.",
              result
            );
          }
        } catch (error) {
          modalBody.innerHTML = `<p class="font-normal text-red-600">Error calling AI. Please try again.</p>`;
          console.error("Error calling Gemini API:", error);
        }
      }

      // --- Custom Confirmation Modal ---
      function showConfirmationModal(title, message, onConfirm) {
        const modalOverlay = elements.aiModalOverlay; // Reusing AI modal for confirmation
        const modalContent = document.getElementById("ai-modal-content");
        const modalTitle = document.getElementById("ai-modal-title");
        const modalBody = document.getElementById("ai-modal-body");

        modalTitle.textContent = title;
        modalBody.innerHTML = `
                <p class="mb-4 text-gray-700">${message}</p>
                <div class="flex justify-end gap-3">
                    <button id="confirm-cancel-btn" class="px-4 py-2 rounded-xl text-sm font-semibold bg-gray-300 text-gray-800 hover:bg-gray-400">Cancel</button>
                    <button id="confirm-ok-btn" class="px-4 py-2 rounded-xl text-sm font-semibold bg-red-600 text-white hover:bg-red-700">Confirm</button>
                </div>
            `;
        modalOverlay.classList.remove("hidden");
        modalOverlay.classList.add("opacity-100");

        document.getElementById("confirm-ok-btn").onclick = () => {
          modalOverlay.classList.add("hidden");
          modalOverlay.classList.remove("opacity-100");
          onConfirm();
        };
        document.getElementById("confirm-cancel-btn").onclick = () => {
          modalOverlay.classList.add("hidden");
          modalOverlay.classList.remove("opacity-100");
        };
        // Close button on modal header
        elements.aiModalCloseBtn.onclick = () => {
          modalOverlay.classList.add("hidden");
          modalOverlay.classList.remove("opacity-100");
        };
      }

      // --- Update User Profile Function (used by settings page) ---
      async function updateUserProfile(updatedData) {
        if (!appState.db || !appState.userId) {
          showToast("Error: User not authenticated.", "error");
          return;
        }
        try {
          const appId =
            typeof __app_id !== "undefined"
              ? __app_id
              : "ielts-mahir-community-forum";
          const userRef = doc(
            appState.db,
            `artifacts/${appId}/users/${appState.userId}/userProfile/profile`
          );

          const oldProfileName = appState.userProfile.name;
          const newProfileName = updatedData.name;

          await updateDoc(userRef, updatedData);
          showToast("Profile updated successfully!", "success");
          appState.editingProfile = false; // Exit editing mode

          // If the user's name has changed, update all their posts and comments
          if (
            newProfileName &&
            newProfileName !== oldProfileName &&
            appState.userId
          ) {
            console.log("User name changed. Updating posts and comments...");
            const batch = writeBatch(appState.db);

            // Update posts
            const userPostsQuery = query(
              collection(appState.db, `artifacts/${appId}/public/data/posts`),
              where("authorId", "==", appState.userId)
            );
            const userPostsSnap = await getDocs(userPostsQuery);
            userPostsSnap.forEach((postDoc) => {
              batch.update(postDoc.ref, { authorName: newProfileName });
            });

            // Update comments
            const userCommentsQuery = query(
              collection(
                appState.db,
                `artifacts/${appId}/public/data/comments`
              ),
              where("authorId", "==", appState.userId)
            );
            const userCommentsSnap = await getDocs(userCommentsQuery);
            userCommentsSnap.forEach((commentDoc) => {
              batch.update(commentDoc.ref, { authorName: newProfileName });
            });

            await batch.commit();
            console.log("All posts and comments updated with new author name.");
          }

          // The onSnapshot listener for userProfile will update appState.userProfile
          // We trigger renderMainContent only, because the user profile update from snapshot
          // will cause a full render.
          renderMainContent(); // Re-render current user's profile/settings view
        } catch (e) {
          console.error("Error updating user profile: ", e);
          showToast("Error updating profile. Check console.", "error");
        }
      }

      /**
       * Handles account deletion, including associated Firestore data.
       */
      async function deleteAccount() {
        if (!appState.auth || !appState.auth.currentUser || !appState.db) {
          showToast(
            "No user is currently signed in or database not ready.",
            "error"
          );
          return;
        }

        const currentUser = appState.auth.currentUser;
        const userIdToDelete = currentUser.uid;
        const appId =
          typeof __app_id !== "undefined"
            ? __app_id
            : "ielts-mahir-community-forum";

        showConfirmationModal(
          "Delete Account",
          "Are you absolutely sure you want to delete your account? This action cannot be undone. All your posts, comments, and profile data will be permanently removed.",
          async () => {
            try {
              const batch = writeBatch(appState.db);

              // 1. Delete user's profile document
              const userProfileRef = doc(
                appState.db,
                `artifacts/${appId}/users/${userIdToDelete}/userProfile/profile`
              );
              batch.delete(userProfileRef);
              console.log("Marked profile for deletion.");

              // 2. Delete all posts authored by this user
              const userPostsQuery = query(
                collection(appState.db, `artifacts/${appId}/public/data/posts`),
                where("authorId", "==", userIdToDelete)
              );
              const userPostsSnap = await getDocs(userPostsQuery);
              userPostsSnap.forEach((postDoc) => {
                batch.delete(postDoc.ref);
                console.log(`Marked post ${postDoc.id} for deletion.`);
              });

              // 3. Delete all comments authored by this user
              const userCommentsQuery = query(
                collection(
                  appState.db,
                  `artifacts/${appId}/public/data/comments`
                ),
                where("authorId", "==", userIdToDelete)
              );
              const userCommentsSnap = await getDocs(userCommentsQuery);
              userCommentsSnap.forEach((commentDoc) => {
                batch.delete(commentDoc.ref);
                console.log(`Marked comment ${commentDoc.id} for deletion.`);
              });

              // 4. Delete all notifications for this user
              const userNotificationsQuery = query(
                collection(
                  appState.db,
                  `artifacts/${appId}/users/${userIdToDelete}/notifications`
                )
              );
              const userNotificationsSnap = await getDocs(
                userNotificationsQuery
              );
              userNotificationsSnap.forEach((notifDoc) => {
                batch.delete(notifDoc.ref);
                console.log(`Marked notification ${notifDoc.id} for deletion.`);
              });

              // Commit all Firestore deletions
              await batch.commit();
              console.log("All user data deleted from Firestore.");
              showToast("Your data has been removed.", "success");

              // 5. Delete the Firebase Authentication user
              await deleteUser(currentUser);
              console.log("Firebase Auth user deleted.");
              showToast(
                "Account deleted successfully! Redirecting...",
                "success"
              );

              // Unsubscribe all listeners explicitly after account deletion
              if (appState.postsUnsubscribe) appState.postsUnsubscribe();
              if (appState.commentsUnsubscribe) appState.commentsUnsubscribe();
              if (appState.notificationsUnsubscribe)
                appState.notificationsUnsubscribe();
              if (appState.userProfileUnsubscribe)
                appState.userProfileUnsubscribe();
              if (appState.allUsersProfilesUnsubscribe)
                appState.allUsersProfilesUnsubscribe();

              // Clear local state completely
              appState.db = null;
              appState.auth = null;
              appState.userId = null;
              appState.userProfile = null;
              appState.isAuthReady = false;
              appState.posts = [];
              appState.comments = {};
              appState.notifications = [];
              appState.unreadNotificationCount = 0;
              appState.allUsersProfiles = [];
              appState.selectedPost = null;
              appState.viewedProfile = null;
              appState.shouldCompleteProfile = false; // Reset profile flag

              // Immediately reload the page to ensure fresh anonymous sign-in or prompt
              window.location.reload();
            } catch (error) {
              console.error("Error during account deletion:", error);
              if (error.code === "auth/requires-recent-login") {
                showToast(
                  "Please re-authenticate recently to delete your account (e.g., sign out and sign back in).",
                  "error"
                );
              } else {
                showToast(
                  "Error deleting account. Check console for details.",
                  "error"
                );
              }
            }
          }
        );
      }
      // New function to update the cache of user profiles from posts and comments
      async function updateCachedUserProfiles() {
        if (!appState.db) return;
        const appId =
          typeof __app_id !== "undefined"
            ? __app_id
            : "ielts-mahir-community-forum";

        const uniqueUserIds = new Set();
        // Add current user to ensure their profile is always in cache
        if (appState.userId) {
          uniqueUserIds.add(appState.userId);
        }
        // Add author IDs from posts
        appState.posts.forEach((post) => uniqueUserIds.add(post.authorId));
        // Add author IDs from comments
        Object.values(appState.comments)
          .flat()
          .forEach((comment) => uniqueUserIds.add(comment.authorId));

        const newAllUsersProfiles = [];
        for (const userId of uniqueUserIds) {
          // Check if profile is already in cache to avoid re-fetching unnecessarily
          const existingProfile = appState.allUsersProfiles.find(
            (p) => p.userId === userId
          );
          if (existingProfile) {
            newAllUsersProfiles.push(existingProfile);
            continue; // Skip fetching if already cached
          }

          const profileRef = doc(
            appState.db,
            `artifacts/${appId}/users/${userId}/userProfile/profile`
          );
          try {
            const profileSnap = await getDoc(profileRef);
            if (profileSnap.exists()) {
              newAllUsersProfiles.push({
                userId: userId,
                ...profileSnap.data(),
              });
            }
          } catch (e) {
            console.warn(
              `Could not fetch profile for user ${userId} during cache update (might be deleted or permission issue for specific user):`,
              e
            );
          }
        }
        appState.allUsersProfiles = newAllUsersProfiles;

        // Trigger re-render for views that depend on allUsersProfiles
        if (
          appState.view === "profile" ||
          appState.view === "home" ||
          appState.view === "postDetail"
        ) {
          renderMainContent();
        }
        renderRightSidebar(); // Ensure right sidebar updates with top users
      }
      // --- Render Functions for Views ---

      function renderRightSidebar() {
        const rightSidebar = document.getElementById("right-sidebar");
        if (!rightSidebar) return; // Only render if sidebar exists (i.e., on larger screens)

        // Clear existing content and set base classes for consistency
        rightSidebar.innerHTML = "";
        rightSidebar.className = `w-64 ml-8 p-6 hidden lg:block rounded-2xl shadow-lg bg-white flex-shrink-0`;

        // Search Bar Section
        const searchSection = document.createElement("div");
        searchSection.className = `mb-8 p-4 rounded-xl bg-gray-50 shadow-inner`;
        searchSection.innerHTML = `
                <h3 class="text-lg font-semibold mb-3 text-gray-800">
                    <i class="fas fa-search mr-2"></i> Search Forum
                </h3>
                <div class="relative">
                    <input type="text" id="sidebar-search-input" placeholder="Search posts and people..." class="w-full p-2.5 pl-10 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent border-gray-200 bg-white text-gray-900 transition-colors">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">${Icons.Search}</span>
                </div>
                <div id="sidebar-search-results" class="mt-3 max-h-60 overflow-y-auto space-y-2 text-sm"></div>
            `;
        rightSidebar.appendChild(searchSection);

        const searchInput = document.getElementById("sidebar-search-input");
        const searchResultsContainer = document.getElementById(
          "sidebar-search-results"
        );

        let searchTimeout;
        searchInput.oninput = () => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            const query = searchInput.value.toLowerCase().trim();
            searchResultsContainer.innerHTML = ""; // Clear previous results

            if (query.length > 0) {
              // Search for posts
              const matchingPosts = appState.posts
                .filter(
                  (post) =>
                    post.title.toLowerCase().includes(query) ||
                    post.content.toLowerCase().includes(query)
                )
                .slice(0, 3); // Limit to top 3 posts

              // Search for people
              const matchingUsers = appState.allUsersProfiles
                .filter(
                  (user) =>
                    user.name.toLowerCase().includes(query) ||
                    (user.bio && user.bio.toLowerCase().includes(query)) ||
                    user.userId.toLowerCase().includes(query) // Can also search by user ID prefix
                )
                .slice(0, 3); // Limit to top 3 users

              if (matchingPosts.length > 0) {
                const postsHeader = document.createElement("h4");
                postsHeader.className = `font-semibold text-base mb-2 mt-3 text-gray-800`;
                postsHeader.textContent = "Posts";
                searchResultsContainer.appendChild(postsHeader);

                matchingPosts.forEach((post) => {
                  const resultItem = document.createElement("div");
                  resultItem.className = `p-2 rounded-lg cursor-pointer hover:bg-blue-50 text-gray-700 transition-colors`;
                  resultItem.innerHTML = `
                                    <div class="font-medium text-blue-700 line-clamp-1">${post.title}</div>
                                    <div class="text-xs text-gray-600 line-clamp-2">${post.content}</div>
                                `;
                  resultItem.onclick = (e) => {
                    e.stopPropagation(); // Prevent search input from losing focus immediately
                    navigateTo("postDetail", { post: post });
                  };
                  searchResultsContainer.appendChild(resultItem);
                });
              }

              if (matchingUsers.length > 0) {
                const peopleHeader = document.createElement("h4");
                peopleHeader.className = `font-semibold text-base mb-2 mt-3 text-gray-800`;
                peopleHeader.textContent = "People";
                searchResultsContainer.appendChild(peopleHeader);

                matchingUsers.forEach((user) => {
                  const resultItem = document.createElement("div");
                  resultItem.className = `p-2 rounded-lg cursor-pointer flex items-center gap-2 hover:bg-green-50 text-gray-700 transition-colors`;
                  resultItem.innerHTML = `
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center bg-blue-100 text-blue-600 text-lg font-bold">
                                        ${
                                          user.name
                                            ? user.name[0].toUpperCase()
                                            : Icons.User
                                        }
                                    </div>
                                    <div>
                                        <div class="font-medium text-green-700">${
                                          user.name ||
                                          `User-${user.userId.substring(0, 5)}`
                                        }</div>
                                        <div class="text-xs text-gray-600 line-clamp-1">${
                                          user.bio || "IELTS Aspirant"
                                        } ‚Ä¢ ${user.reputation || 0} pts</div>
                                    </div>
                                `;
                  resultItem.onclick = (e) => {
                    e.stopPropagation();
                    navigateTo("profile", { targetUserId: user.userId });
                  };
                  searchResultsContainer.appendChild(resultItem);
                });
              }

              if (matchingPosts.length === 0 && matchingUsers.length === 0) {
                searchResultsContainer.innerHTML = `<p class="p-2 text-gray-500">No results found.</p>`;
              }
            }
          }, 300); // Debounce search input
        };

        // User Stats Section
        const userStatsSection = document.createElement("div");
        userStatsSection.className = `mb-8 p-4 rounded-xl bg-gray-50 shadow-inner`;
        userStatsSection.innerHTML = `
                <h3 class="text-lg font-semibold mb-4 text-gray-800">
                    <i class="fas fa-user-circle mr-2"></i> Your Stats
                </h3>
                ${
                  appState.userProfile
                    ? `
                    <div class="space-y-3 text-sm">
                        <div class="flex items-center gap-2 text-gray-700">
                            ${
                              Icons.Award
                            } Reputation: <span class="font-bold">${
                        appState.userProfile.reputation || 0
                      }</span>
                        </div>
                        <div class="flex items-center gap-2 text-gray-700">
                            ${
                              Icons.Target
                            } Target Band: <span class="font-bold">${
                        appState.userProfile.bandGoal || "N/A"
                      }</span>
                        </div>
                        <div class="flex items-center gap-2 text-gray-700">
                            ${Icons.Activity} Status: <span class="font-bold">${
                        appState.userProfile.preparationStatus || "New Learner"
                      }</span>
                        </div>
                    </div>
                `
                    : `<p class="text-sm text-gray-600">Sign in to see your stats.</p>`
                }
            `;
        rightSidebar.appendChild(userStatsSection);

        // Top Users Section (Simplified Leaderboard)
        const topUsersSection = document.createElement("div");
        topUsersSection.className = `mb-8 p-4 rounded-xl bg-gray-50 shadow-inner`;
        // Sort allUsersProfiles by reputation in descending order, take top 5
        const topUsers = [...appState.allUsersProfiles]
          .sort((a, b) => (b.reputation || 0) - (a.reputation || 0))
          .slice(0, 5);

        let topUsersHtml = "";
        if (topUsers.length > 0) {
          topUsersHtml = `<ul class="space-y-3 text-sm">`;
          topUsers.forEach((user) => {
            topUsersHtml += `
                    <li class="flex items-center gap-2 text-gray-700">
                        <span class="w-5 h-5 flex-shrink-0">${
                          Icons.Award
                        }</span>
                        <span class="flex-1 font-semibold cursor-pointer hover:underline" data-user-id="${
                          user.userId
                        }">${
              user.name || `User-${user.userId.substring(0, 5)}`
            }</span>
                        <span class="font-bold text-blue-500">${
                          user.reputation || 0
                        } pts</span>
                    </li>
                `;
          });
          topUsersHtml += `</ul>`;
        } else {
          topUsersHtml = `<p class="text-sm text-gray-600">No top users yet.</p>`;
        }

        topUsersSection.innerHTML = `
            <h3 class="text-lg font-semibold mb-4 text-gray-800">
                <i class="fas fa-trophy mr-2"></i> Top Users
            </h3>
            ${topUsersHtml}
        `;
        rightSidebar.appendChild(topUsersSection);

        // Make top user names clickable
        topUsers.forEach((user) => {
          const userLink = topUsersSection.querySelector(
            `[data-user-id="${user.userId}"]`
          );
          if (userLink) {
            userLink.onclick = (e) => {
              e.stopPropagation();
              navigateTo("profile", { targetUserId: user.userId });
            };
          }
        });

        // Quick Links Section
        const quickLinksSection = document.createElement("div");
        quickLinksSection.className = `p-4 rounded-xl bg-gray-50 shadow-inner`;
        quickLinksSection.innerHTML = `
                <h3 class="text-lg font-semibold mb-4 text-gray-800">
                    <i class="fas fa-external-link-alt mr-2"></i> Quick Links
                </h3>
                <ul class="space-y-3 text-sm">
                    <li>
                        <a href="https://www.ielts.org/" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-blue-600 hover:text-blue-700 transition-colors">
                            ${Icons.Link} Official IELTS Website
                        </a>
                    </li>
                    <li>
                        <a href="https://takeielts.britishcouncil.org/prepare-test/free-ielts-practice-tests" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-blue-600 hover:text-blue-700 transition-colors">
                            ${Icons.Link} Free Practice Tests
                        </a>
                    </li>
                    <li>
                        <a href="https://www.youtube.com/c/E2IELTS" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-blue-600 hover:text-blue-700 transition-colors">
                            ${Icons.Link} E2 IELTS YouTube
                        </a>
                    </li>
                </ul>
            `;
        rightSidebar.appendChild(quickLinksSection);
      }

      function renderHeader() {
        const header = elements.header;
        header.innerHTML = `
                <div class="flex items-center gap-4">
                    <button id="menu-toggle-btn" class="md:hidden p-2 rounded-xl hover:bg-gray-100 transition-colors" aria-label="Toggle sidebar">
                        ${Icons.Menu}
                    </button>
                    <h1 id="app-title" class="font-anton text-3xl cursor-pointer text-blue-600 hover:text-blue-700 transition-colors">
                         Mahir
                    </h1>
                </div>
                <div class="flex items-center gap-4">
                    ${
                      appState.userId
                        ? `<span class="text-sm font-medium hidden sm:block text-gray-600">User ID: ${appState.userId.substring(
                            0,
                            8
                          )}...</span>`
                        : ""
                    }
                    <button id="create-post-btn" class="flex items-center gap-2 px-5 py-2.5 bg-blue-600 text-white rounded-xl shadow-md hover:bg-blue-700 transition-all text-sm font-semibold transform active:scale-95">
                        ${
                          Icons.Plus
                        } <span class="hidden sm:inline">Create Post</span>
                    </button>
                    <div class="relative">
                        <button id="notifications-btn" class="p-2.5 rounded-full shadow-sm bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors transform active:scale-95" aria-label="Notifications">
                            ${Icons.Bell}
                            ${
                              appState.unreadNotificationCount > 0
                                ? `<span class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full">${appState.unreadNotificationCount}</span>`
                                : ""
                            }
                        </button>
                    </div>
                    <button id="settings-btn" class="p-2.5 rounded-full shadow-sm bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors transform active:scale-95" aria-label="Settings">
                        ${Icons.Cog}
                    </button>
                    <button id="profile-btn" class="p-2.5 rounded-full shadow-sm bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors transform active:scale-95" aria-label="User Profile">
                        ${Icons.User}
                    </button>
                    <button id="sign-out-btn" class="px-4 py-2 bg-red-500 text-white rounded-xl shadow-md hover:bg-red-600 transition-colors text-sm font-semibold transform active:scale-95">
                        Sign Out
                    </button>
                </div>
            `;

        document.getElementById("app-title").onclick = () => navigateTo("home");
        document.getElementById("create-post-btn").onclick = () =>
          navigateTo("createPost");
        document.getElementById("notifications-btn").onclick = () =>
          navigateTo("notifications");
        document.getElementById("settings-btn").onclick = () =>
          navigateTo("settings");
        document.getElementById("profile-btn").onclick = () =>
          navigateTo("profile", { targetUserId: appState.userId });
        document.getElementById("menu-toggle-btn").onclick = () => {
          appState.showSidebar = !appState.showSidebar;
          renderSidebar();
        };
        document.getElementById("sign-out-btn").onclick = async () => {
          try {
            await signOut(appState.auth);
            showToast("Signed out successfully!", "success");
            // Clear app state and navigate to auth page
            appState.userId = null;
            appState.userProfile = null;
            appState.isAuthReady = true; // Still ready, just not authenticated
            appState.posts = [];
            appState.comments = {};
            appState.notifications = [];
            appState.unreadNotificationCount = 0;
            appState.allUsersProfiles = [];
            appState.selectedPost = null;
            appState.viewedProfile = null;
            appState.shouldCompleteProfile = false;
            // Unsubscribe all listeners explicitly after sign out
            if (appState.postsUnsubscribe) appState.postsUnsubscribe();
            if (appState.commentsUnsubscribe) appState.commentsUnsubscribe();
            if (appState.notificationsUnsubscribe)
              appState.notificationsUnsubscribe();
            if (appState.userProfileUnsubscribe)
              appState.userProfileUnsubscribe();
            if (appState.allUsersProfilesUnsubscribe)
              appState.allUsersProfilesUnsubscribe();

            navigateTo("auth", { authMode: "login" });
          } catch (error) {
            console.error("Error signing out:", error);
            showToast("Error signing out. Try again.", "error");
          }
        };
      }

      function renderSidebar() {
        const sidebar = elements.sidebar;
        const categoriesData = [
          {
            name: "IELTS Speaking",
            subcategories: ["Cue Cards", "Fluency", "Pronunciation"],
          },
          {
            name: "IELTS Writing",
            subcategories: [
              "Writing Task 1",
              "Writing Task 2",
              "Grammar Help",
              "Vocabulary",
            ],
          },
          { name: "IELTS Listening" },
          { name: "IELTS Reading" },
          { name: "Tips & Strategies" },
          { name: "Band 9 Answers" },
          { name: "Motivation & Support" },
        ];

        sidebar.classList.toggle("-translate-x-full", !appState.showSidebar);
        sidebar.classList.toggle("translate-x-0", appState.showSidebar);

        sidebar.innerHTML = `
                <div class="flex justify-between items-center mb-6 md:hidden">
                    <h2 class="font-normal font-bold text-xl text-blue-600">Categories</h2>
                    <button id="sidebar-close-btn" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                        ${Icons.X}
                    </button>
                </div>
                <nav id="sidebar-nav" class="space-y-3"></nav>
            `;

        document.getElementById("sidebar-close-btn").onclick = () => {
          appState.showSidebar = false;
          renderSidebar();
        };

        const sidebarNav = document.getElementById("sidebar-nav");

        // Add main feed filters
        const feedFiltersDiv = document.createElement("div");
        feedFiltersDiv.className = `pb-4 mb-4 border-b border-gray-200`;
        feedFiltersDiv.innerHTML = `
            <h3 class="text-lg font-semibold mb-3 text-gray-800">
                <span class="w-5 h-5 mr-2">${Icons.Filter}</span> Filter Feed
            </h3>
            <ul class="space-y-2">
                <li>
                    <button id="feed-latest-btn" class="block w-full text-left p-2 rounded-lg font-normal ${
                      appState.homeFeedType === "latest"
                        ? "bg-blue-100 text-blue-700"
                        : "text-gray-700 hover:bg-blue-50 hover:text-blue-700"
                    } transition-all">
                        Latest Posts
                    </button>
                </li>
                <li>
                    <button id="feed-for-you-btn" class="block w-full text-left p-2 rounded-lg font-normal ${
                      appState.homeFeedType === "forYou"
                        ? "bg-blue-100 text-blue-700"
                        : "text-gray-700 hover:bg-blue-50 hover:text-blue-700"
                    } transition-all">
                        <span class="w-4 h-4 inline-block align-middle mr-1">${
                          Icons.Heart
                        }</span> For You
                    </button>
                </li>
                <li>
                    <button id="feed-following-btn" class="block w-full text-left p-2 rounded-lg font-normal ${
                      appState.homeFeedType === "following"
                        ? "bg-blue-100 text-blue-700"
                        : "text-gray-700 hover:bg-blue-50 hover:text-blue-700"
                    } transition-all">
                        <span class="w-4 h-4 inline-block align-middle mr-1">${
                          Icons.Users
                        }</span> Following
                    </button>
                </li>
            </ul>
        `;
        sidebarNav.appendChild(feedFiltersDiv);

        document.getElementById("feed-latest-btn").onclick = () =>
          navigateTo("home", { homeFeedType: "latest" });
        document.getElementById("feed-for-you-btn").onclick = () =>
          navigateTo("home", { homeFeedType: "forYou" });
        document.getElementById("feed-following-btn").onclick = () =>
          navigateTo("home", { homeFeedType: "following" });

        // Add Categories section
        const categoriesSection = document.createElement("div");
        categoriesSection.className = `pb-4`;
        categoriesSection.innerHTML = `
            <h3 class="text-lg font-semibold mb-3 text-gray-800">
                <span class="w-5 h-5 mr-2">${Icons.ChevronDown}</span> Categories
            </h3>
            <nav id="categories-nav" class="space-y-3"></nav>
        `;
        sidebarNav.appendChild(categoriesSection);
        const categoriesNav = document.getElementById("categories-nav");

        categoriesData.forEach((category) => {
          const categoryDiv = document.createElement("div");
          const isCategoryActive = appState.activeCategory === category.name;

          categoryDiv.innerHTML = `
                    <button id="category-btn-${category.name.replace(
                      /\s/g,
                      "-"
                    )}" class="flex items-center justify-between w-full p-3 rounded-lg font-normal font-medium ${
            isCategoryActive
              ? "bg-blue-100 text-blue-700"
              : "text-gray-700 hover:bg-blue-50 hover:text-blue-700"
          } transition-all">
                        <span>${category.name}</span>
                        ${
                          category.subcategories
                            ? `<span id="chevron-${category.name.replace(
                                /\s/g,
                                "-"
                              )}" class="${
                                appState.openCategories?.[category.name]
                                  ? "rotate-180"
                                  : ""
                              } transition-transform duration-200">${
                                Icons.ChevronDown
                              }</span>`
                            : ""
                        }
                    </button>
                    ${
                      category.subcategories
                        ? `<ul id="subcategories-list-${category.name.replace(
                            /\s/g,
                            "-"
                          )}" class="ml-4 mt-2 space-y-2 ${
                            appState.openCategories?.[category.name]
                              ? ""
                              : "hidden"
                          }"></ul>`
                        : ""
                    }
                `;
          categoriesNav.appendChild(categoryDiv);

          document.getElementById(
            `category-btn-${category.name.replace(/\s/g, "-")}`
          ).onclick = () => {
            if (category.subcategories) {
              // Toggle subcategories display
              appState.openCategories = {
                ...appState.openCategories,
                [category.name]: !appState.openCategories?.[category.name],
              };
              renderSidebar(); // Re-render sidebar to toggle submenu
            }
            // Navigate to filter by main category or subcategory
            navigateTo("home", { category: category.name, subCategory: null }); // Always reset subCategory when main is clicked
          };

          if (category.subcategories) {
            const subcategoriesList = document.getElementById(
              `subcategories-list-${category.name.replace(/\s/g, "-")}`
            );
            subcategoriesList.className += ` border-l border-gray-200`;
            subcategoriesList.classList.add("text-gray-600");
            subcategoriesList.classList.add("pl-4");
            category.subcategories.forEach((sub) => {
              const subLi = document.createElement("li");
              const isSubCategoryActive =
                appState.activeSubCategory === sub &&
                appState.activeCategory === category.name;
              subLi.innerHTML = `
                            <button class="block w-full text-left p-2 rounded-lg font-normal text-sm ${
                              isSubCategoryActive
                                ? "bg-blue-50 text-blue-600"
                                : "text-gray-600 hover:bg-blue-50 hover:text-blue-600"
                            } transition-colors">
                                ${sub}
                            </button>
                        `;
              subLi.querySelector("button").onclick = () =>
                navigateTo("home", {
                  category: category.name,
                  subCategory: sub,
                });
              subcategoriesList.appendChild(subLi);
            });
          }
        });
      }

      function renderPostList() {
        const mainContent = elements.mainContent;
        mainContent.innerHTML = `
                <div class="flex-1">
                    <h2 class="text-3xl font-bold font-normal mb-8 text-gray-900">
                        ${
                          appState.homeFeedType === "latest"
                            ? "Latest Discussions"
                            : appState.homeFeedType === "forYou"
                            ? "For You Discussions"
                            : appState.homeFeedType === "following"
                            ? "Discussions from Followed Users"
                            : "Latest Discussions"
                        }
                        ${
                          appState.activeCategory
                            ? `<span class="text-blue-600"> - ${appState.activeCategory}</span>`
                            : ""
                        }
                        ${
                          appState.activeSubCategory
                            ? `<span class="text-indigo-600"> (${appState.activeSubCategory})</span>`
                            : ""
                        }
                    </h2>
                    <div id="posts-container" class="space-y-6"></div>
                </div>
                <div id="right-sidebar" class="w-64 ml-8 p-6 hidden lg:block rounded-2xl shadow-lg bg-white">
                    <!-- Right sidebar content will be rendered here -->
                </div>
            `;

        let postsToDisplay = [...appState.posts]; // Create a mutable copy

        // Apply category/subcategory filters
        postsToDisplay = postsToDisplay.filter((post) => {
          let matchesCategory = true;
          let matchesSubCategory = true;

          if (appState.activeCategory) {
            matchesCategory = post.category === appState.activeCategory;
          }
          if (appState.activeSubCategory) {
            matchesSubCategory =
              post.subCategory === appState.activeSubCategory;
          }
          return matchesCategory && matchesSubCategory;
        });

        // Apply feed type specific sorting/filtering
        if (appState.homeFeedType === "forYou") {
          // Simple "For You" logic: prioritize by net upvotes (upvotes - downvotes), then recency
          postsToDisplay.sort((a, b) => {
            const aScore = (a.upvotes || 0) - (a.downvotes || 0);
            const bScore = (b.upvotes || 0) - (b.downvotes || 0);
            if (bScore !== aScore) return bScore - aScore; // Higher score first
            return (
              (b.createdAt?.toDate() || new Date(0)) -
              (a.createdAt?.toDate() || new Date(0))
            ); // More recent if scores are equal
          });
        } else if (appState.homeFeedType === "following") {
          const followedUserIds = appState.userProfile?.following || [];
          if (followedUserIds.length > 0) {
            postsToDisplay = postsToDisplay.filter((post) =>
              followedUserIds.includes(post.authorId)
            );
          } else {
            postsToDisplay = []; // No posts if not following anyone
          }
          // Always sort followed posts by recency
          postsToDisplay.sort(
            (a, b) =>
              (b.createdAt?.toDate() || new Date(0)) -
              (a.createdAt?.toDate() || new Date(0))
          );
        } else {
          // 'latest' or default
          // Already sorted by createdAt DESC in Firestore listener, so no extra sort needed here.
          // If it wasn't, we'd do: postsToDisplay.sort((a, b) => (b.createdAt?.toDate() || new Date(0)) - (a.createdAt?.toDate() || new Date(0)));
        }

        const postsContainer = document.getElementById("posts-container");
        if (postsToDisplay.length === 0) {
          let message = "No posts found for this selection.";
          if (appState.homeFeedType === "following") {
            message =
              "You are not following any users, or they haven't posted yet.";
          }
          postsContainer.innerHTML = `<p class="text-lg text-gray-600">${message} Be the first to create one!</p>`;
        } else {
          postsToDisplay.forEach((post) => {
            const postDiv = document.createElement("div");
            postDiv.className = `p-6 rounded-2xl shadow-lg transition-all duration-200 hover:shadow-xl hover:scale-[1.01] cursor-pointer bg-white`;
            // Removed direct onclick on postDiv to prevent conflict with internal buttons
            // instead, we'll make sure clicking anywhere else on the postdiv also navigates
            postDiv.addEventListener("click", (e) => {
              // Only navigate if the click target is not a button or a clickable span (like author name, which will have its own handler)
              if (
                e.target.tagName !== "BUTTON" &&
                e.target.tagName !== "SPAN" &&
                e.target.tagName !== "A"
              ) {
                navigateTo("postDetail", { post: post });
              }
            });

            const formattedTime = formatRelativeTime(post.createdAt);
            const commentsCount = (appState.comments[post.id] || []).length;

            const isAuthorCurrentUsers =
              appState.userId && post.authorId === appState.userId;
            const isFollowingAuthor = appState.userProfile?.following?.includes(
              post.authorId
            );

            postDiv.innerHTML = `
                        <h3 class="text-xl font-semibold font-normal mb-2 text-blue-700">
                            ${post.title}
                        </h3>
                        <p class="text-sm text-gray-600 mb-3 line-clamp-2">
                            ${post.content}
                        </p>
                        <div class="flex items-center justify-between text-xs font-normal text-gray-500 border-t pt-3 mt-4 border-gray-100">
                            <div class="flex items-center gap-2">
                                <span class="w-4 h-4">${Icons.User}</span>
                                <span class="font-bold cursor-pointer hover:underline" data-user-id="${
                                  post.authorId
                                }">${post.authorName || "Anonymous"}</span>
                                ${
                                  !isAuthorCurrentUsers && appState.userId
                                    ? `
                                    <button class="ml-2 px-2 py-1 rounded-full text-xs font-semibold
                                        ${
                                          isFollowingAuthor
                                            ? "bg-gray-300 text-gray-800 hover:bg-gray-400"
                                            : "bg-blue-100 text-blue-700 hover:bg-blue-200"
                                        }
                                        transition-colors transform active:scale-95 follow-button hidden sm:block"
                                        data-target-user-id="${post.authorId}">
                                        ${
                                          isFollowingAuthor
                                            ? `<i class="fas fa-check"></i> Unfollow`
                                            : `<i class="fas fa-user-plus"></i> Follow`
                                        }
                                    </button>
                                `
                                    : ""
                                }
                                <span class="mx-1">‚Ä¢</span>
                                <span>${formattedTime}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="flex items-center gap-1 text-green-500">
                                    <span class="w-4 h-4">${
                                      Icons.ThumbsUp
                                    }</span> ${post.upvotes || 0}
                                </span>
                                <span class="flex items-center gap-1 text-red-500">
                                    <span class="w-4 h-4">${
                                      Icons.ThumbsDown
                                    }</span> ${post.downvotes || 0}
                                </span>
                                <span class="flex items-center gap-1 text-blue-500">
                                    <span class="w-4 h-4">${
                                      Icons.MessageCircleMore
                                    }</span> ${commentsCount}
                                </span>
                                ${
                                  post.isResolved
                                    ? `<span class="flex items-center gap-1 text-green-600 font-semibold"> <span class="w-4 h-4">${Icons.CheckCircle}</span> Resolved</span>`
                                    : ""
                                }
                            </div>
                        </div>
                        ${
                          post.category
                            ? `
                            <div class="mt-3 flex flex-wrap gap-2">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold bg-blue-50 text-blue-700">
                                    ${post.category}
                                </span>
                                ${
                                  post.subCategory
                                    ? `<span class="px-3 py-1 rounded-full text-xs font-semibold bg-indigo-50 text-indigo-700"> ${post.subCategory}</span>`
                                    : ""
                                }
                                ${
                                  post.tags && post.tags.length > 0
                                    ? post.tags
                                        .map(
                                          (tag) =>
                                            `<span class="px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-600">${tag}</span>`
                                        )
                                        .join("")
                                    : ""
                                }
                            </div>
                        `
                            : ""
                        }
                    `;
            postsContainer.appendChild(postDiv);

            // Make author names clickable
            const authorNameSpan = postDiv.querySelector(
              `span[data-user-id="${post.authorId}"]`
            );
            if (authorNameSpan) {
              authorNameSpan.onclick = (e) => {
                e.stopPropagation(); // Prevent the postDiv's click event from firing
                navigateTo("profile", { targetUserId: post.authorId });
              };
            }

            // Attach event listener for the new follow button
            const followButton = postDiv.querySelector(`.follow-button`);
            if (followButton) {
              followButton.onclick = (e) => {
                e.stopPropagation(); // Prevent the postDiv's click event from firing
                toggleFollow(post.authorId);
              };
            }
          });
        }
        renderRightSidebar(); // Render the right sidebar for home view
      }

      function renderPostDetail() {
        const post = appState.selectedPost;
        if (!post) {
          navigateTo("home"); // Redirect if no post is selected
          return;
        }

        const isAuthorCurrentUsers =
          appState.userId && post.authorId === appState.userId;
        const isFollowingAuthor = appState.userProfile?.following?.includes(
          post.authorId
        );
        const formattedTime = formatRelativeTime(post.createdAt);

        const mainContent = elements.mainContent;
        mainContent.innerHTML = `
                <div class="flex-1">
                    <button id="back-to-home-btn" class="mb-6 flex items-center gap-2 text-base font-semibold text-blue-600 hover:text-blue-700 transition-colors">
                        <span class="w-5 h-5">${
                          Icons.ArrowLeft
                        }</span> Back to Forum
                    </button>

                    <div class="p-6 md:p-8 rounded-2xl shadow-lg transition-colors duration-300 bg-white">
                        ${
                          appState.editingPostId === post.id
                            ? `
                            <!-- Edit Post Form -->
                            <div class="space-y-4">
                                <div>
                                    <label for="edit-post-title" class="block text-sm font-medium mb-1 text-gray-700">Title</label>
                                    <input type="text" id="edit-post-title" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent border-gray-200 bg-gray-50 text-gray-900 transition-colors" value="${post.title}" required />
                                </div>
                                <div>
                                    <label for="edit-post-content" class="block text-sm font-medium mb-1 text-gray-700">Content</label>
                                    <textarea id="edit-post-content" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent border-gray-200 bg-gray-50 text-gray-900 transition-colors" rows="8" required>${post.content}</textarea>
                                </div>
                                <div class="flex gap-3">
                                    <button id="save-post-btn" class="flex items-center gap-2 px-5 py-2.5 bg-green-600 text-white rounded-xl shadow-md hover:bg-green-700 transition-all text-sm font-semibold transform active:scale-95">
                                        ${Icons.Save} Save
                                    </button>
                                    <button id="cancel-edit-post-btn" class="flex items-center gap-2 px-5 py-2.5 bg-gray-300 text-gray-800 rounded-xl shadow-md hover:bg-gray-400 transition-all text-sm font-semibold transform active:scale-95">
                                        ${Icons.Cancel} Cancel
                                    </button>
                                </div>
                            </div>
                        `
                            : `
                            <!-- Display Post -->
                            <div class="flex items-center justify-between mb-3">
                                <h2 class="text-3xl md:text-4xl font-bold font-normal text-gray-900">
                                    ${post.title}
                                </h2>
                                <div class="flex gap-2">
                                    ${
                                      isAuthorCurrentUsers
                                        ? `
                                        <button id="edit-post-btn" class="p-2 rounded-full hover:bg-gray-100 transition-colors" aria-label="Edit Post">
                                            ${Icons.Edit}
                                        </button>
                                        <button id="delete-post-btn" class="p-2 rounded-full hover:bg-red-100 text-red-600 transition-colors" aria-label="Delete Post">
                                            ${Icons.Trash}
                                        </button>
                                    `
                                        : ""
                                    }
                                </div>
                            </div>
                            <div class="flex flex-wrap items-center gap-4 text-sm font-normal mb-4">
                                <span class="flex items-center gap-1 text-gray-600">
                                    <span class="w-4 h-4">${
                                      Icons.User
                                    }</span> <span class="font-bold cursor-pointer hover:underline" data-user-id="${
                                post.authorId
                              }">${post.authorName || "Anonymous"}</span>
                                </span>
                                ${
                                  !isAuthorCurrentUsers && appState.userId
                                    ? `
                                    <button id="follow-author-btn" class="px-2 py-1 rounded-full text-xs font-semibold
                                        ${
                                          isFollowingAuthor
                                            ? "bg-gray-300 text-gray-800 hover:bg-gray-400"
                                            : "bg-blue-100 text-blue-700 hover:bg-blue-200"
                                        }
                                        transition-colors transform active:scale-95">
                                        ${
                                          isFollowingAuthor
                                            ? `<i class="fas fa-check"></i> Unfollow`
                                            : `<i class="fas fa-user-plus"></i> Follow`
                                        }
                                    </button>
                                `
                                    : ""
                                }
                                ${
                                  post.createdAt
                                    ? `<span class="flex items-center gap-1 text-gray-600">
                                    <span class="mx-1">‚Ä¢</span>
                                    ${formattedTime}
                                </span>`
                                    : ""
                                }
                                ${
                                  post.isResolved
                                    ? `<span class="flex items-center gap-1 text-green-600 font-semibold px-2 py-1 bg-green-100 rounded-full">
                                    <span class="w-4 h-4">${Icons.CheckCircle}</span> Resolved
                                </span>`
                                    : ""
                                }
                            </div>
                            <p class="text-lg font-normal leading-relaxed mb-6 text-gray-800">
                                ${post.content}
                            </p>
                        `
                        }

                        <div class="flex flex-wrap gap-3 mb-6 border-t pt-4 border-gray-100">
                            <button id="upvote-btn" class="flex items-center gap-1 px-4 py-2 rounded-xl text-sm font-semibold 
                                ${
                                  post.upvotedBy &&
                                  post.upvotedBy.includes(appState.userId)
                                    ? "bg-blue-500 text-white"
                                    : "bg-blue-100 text-blue-700 hover:bg-blue-200"
                                }
                                transition-colors transform active:scale-95">
                                <span class="w-4 h-4">${
                                  post.upvotedBy &&
                                  post.upvotedBy.includes(appState.userId)
                                    ? Icons.ThumbsUpSolid
                                    : Icons.ThumbsUp
                                }</span> ${post.upvotes || 0}
                            </button>
                            <button id="downvote-btn" class="flex items-center gap-1 px-4 py-2 rounded-xl text-sm font-semibold 
                                ${
                                  post.downvotedBy &&
                                  post.downvotedBy.includes(appState.userId)
                                    ? "bg-red-500 text-white"
                                    : "bg-red-100 text-red-700 hover:bg-red-200"
                                }
                                transition-colors transform active:scale-95">
                                <span class="w-4 h-4">${
                                  post.downvotedBy &&
                                  post.downvotedBy.includes(appState.userId)
                                    ? Icons.ThumbsDownSolid
                                    : Icons.ThumbsDown
                                }</span> ${post.downvotes || 0}
                            </button>
                            ${
                              post.authorId === appState.userId
                                ? `
                                <button id="resolve-btn" class="flex items-center gap-1 px-4 py-2 rounded-xl text-sm font-semibold ${
                                  post.isResolved
                                    ? "bg-orange-100 text-orange-700 hover:bg-orange-200"
                                    : "bg-green-100 text-green-700 hover:bg-green-200"
                                } transition-colors transform active:scale-95">
                                    <span class="w-4 h-4">${
                                      Icons.CheckCircle
                                    }</span> ${
                                    post.isResolved
                                      ? "Unresolve"
                                      : "Mark as Resolved"
                                  }
                                </button>
                            `
                                : ""
                            }
                            <button id="ai-summary-btn" class="flex items-center gap-1 px-4 py-2 rounded-xl text-sm font-semibold bg-purple-100 text-purple-700 hover:bg-purple-200 transition-colors transform active:scale-95">
                                <span class="w-4 h-4">${
                                  Icons.Zap
                                }</span> AI Summary
                            </button>
                            <button id="ai-suggest-answer-btn" class="flex items-center gap-1 px-4 py-2 rounded-xl text-sm font-semibold bg-indigo-100 text-indigo-700 hover:bg-indigo-200 transition-colors transform active:scale-95">
                                <span class="w-4 h-4">${
                                  Icons.Zap
                                }</span> AI Suggest Answer
                            </button>
                            <button id="ai-grammar-check-btn" class="flex items-center gap-1 px-4 py-2 rounded-xl text-sm font-semibold bg-teal-100 text-teal-700 hover:bg-teal-200 transition-colors transform active:scale-95">
                                <span class="w-4 h-4">${
                                  Icons.Zap
                                }</span> AI Grammar Check
                            </button>
                            <button id="ai-auto-tag-btn" class="flex items-center gap-1 px-4 py-2 rounded-xl text-sm font-semibold bg-emerald-100 text-emerald-700 hover:bg-emerald-200 transition-colors transform active:scale-95">
                                <span class="w-4 h-4">${
                                  Icons.Zap
                                }</span> AI Auto-Tag
                            </button>
                        </div>

                        ${
                          post.category
                            ? `
                            <div class="mt-3 flex flex-wrap gap-2 mb-6">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold bg-blue-50 text-blue-700">
                                    ${post.category}
                                </span>
                                ${
                                  post.subCategory
                                    ? `<span class="px-3 py-1 rounded-full text-xs font-semibold bg-indigo-50 text-indigo-700"> ${post.subCategory}</span>`
                                    : ""
                                }
                                ${
                                  post.tags && post.tags.length > 0
                                    ? post.tags
                                        .map(
                                          (tag) =>
                                            `<span class="px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-600">${tag}</span>`
                                        )
                                        .join("")
                                    : ""
                                }
                            </div>
                        `
                            : ""
                        }
                    </div>

                    <div class="mt-8">
                        <h3 class="text-2xl font-bold font-normal mb-4 text-gray-900">Comments (<span id="comments-count">0</span>)</h3>
                        <div id="comments-container" class="space-y-4"></div>

                        <div class="mt-6 p-6 rounded-2xl shadow-lg bg-white">
                            <h4 class="text-xl font-bold font-normal mb-4 text-gray-900">Add a Comment</h4>
                            <textarea id="comment-content-textarea" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent border-gray-200 bg-gray-50 text-gray-900 transition-colors" rows="4" placeholder="Write your comment here..." required></textarea>
                            <button id="post-comment-btn" class="mt-4 px-6 py-3 bg-blue-600 text-white rounded-xl shadow-md hover:bg-blue-700 transition-colors font-semibold transform active:scale-95" disabled>
                                Post Comment
                            </button>
                        </div>
                    </div>
                </div>
                <div id="right-sidebar" class="w-64 ml-8 p-6 hidden lg:block rounded-2xl shadow-lg bg-white">
                    <!-- Right sidebar content will be rendered here -->
                </div>
            `;

        document.getElementById("back-to-home-btn").onclick = () =>
          navigateTo("home");
        document.getElementById("upvote-btn").onclick = () =>
          updatePostVotes(post.id, "up");
        document.getElementById("downvote-btn").onclick = () =>
          updatePostVotes(post.id, "down");

        // Make author name clickable
        const authorNameSpan = mainContent.querySelector(
          `span[data-user-id="${post.authorId}"]`
        );
        if (authorNameSpan) {
          authorNameSpan.onclick = (e) => {
            e.stopPropagation();
            navigateTo("profile", { targetUserId: post.authorId });
          };
        }

        // Attach event listener for the new follow button on post detail page
        const followAuthorBtn = document.getElementById("follow-author-btn");
        if (followAuthorBtn) {
          followAuthorBtn.onclick = (e) => {
            e.stopPropagation();
            toggleFollow(post.authorId);
          };
        }

        if (post.authorId === appState.userId) {
          const resolveBtn = document.getElementById("resolve-btn");
          if (resolveBtn) {
            // Ensure button exists if user is author
            resolveBtn.onclick = () =>
              togglePostResolved(post.id, post.isResolved);
          }

          const editPostBtn = document.getElementById("edit-post-btn");
          if (editPostBtn) {
            editPostBtn.onclick = () => {
              appState.editingPostId = post.id;
              renderPostDetail(); // Re-render in edit mode
            };
          }

          const deletePostBtn = document.getElementById("delete-post-btn");
          if (deletePostBtn) {
            deletePostBtn.onclick = () => deletePost(post.id);
          }

          const savePostBtn = document.getElementById("save-post-btn");
          const cancelEditPostBtn = document.getElementById(
            "cancel-edit-post-btn"
          );
          if (savePostBtn && cancelEditPostBtn) {
            savePostBtn.onclick = () => {
              const newTitle = document.getElementById("edit-post-title").value;
              const newContent = document.getElementById("edit-post-content")
                .value;
              if (newTitle.trim() && newContent.trim()) {
                updatePost(post.id, { title: newTitle, content: newContent });
              } else {
                showToast("Title and content cannot be empty.", "error");
              }
            };
            cancelEditPostBtn.onclick = () => {
              appState.editingPostId = null;
              renderPostDetail(); // Exit edit mode
            };
          }
        }

        document.getElementById("ai-summary-btn").onclick = () =>
          callGeminiAI(
            `Summarize the following IELTS forum post and its comments:\n\nPost Title: "${
              post.title
            }"\nPost Content: "${post.content}"\n\nComments:\n${(
              appState.comments[post.id] || []
            )
              .map((c) => c.content)
              .join("\n")}`,
            "ai-summary-response"
          );
        document.getElementById("ai-suggest-answer-btn").onclick = () =>
          callGeminiAI(
            `Given the following IELTS forum post and comments, suggest a helpful answer or improvement:\n\nPost Title: "${
              post.title
            }"\nPost Content: "${post.content}"\n\nExisting Comments:\n${(
              appState.comments[post.id] || []
            )
              .map((c) => c.content)
              .join("\n")}`,
            "ai-suggest-answer-response"
          );
        document.getElementById("ai-grammar-check-btn").onclick = () =>
          callGeminiAI(
            `Check the grammar and spelling of the following text from an IELTS forum post. Provide corrections and explanations:\n\n"${post.content}"`,
            "ai-grammar-check-response"
          );
        document.getElementById("ai-auto-tag-btn").onclick = () =>
          callGeminiAI(
            `Given the following IELTS forum post content, suggest relevant tags (e.g., "Grammar", "Band 7+", "Cue Card", "Writing Task 2", "Speaking Practice"). Provide them as a comma-separated list:\n\n"${post.content}"`,
            "ai-auto-tag-response"
          );

        const commentContentTextarea = document.getElementById(
          "comment-content-textarea"
        );
        const postCommentBtn = document.getElementById("post-comment-btn");

        commentContentTextarea.oninput = () => {
          postCommentBtn.disabled = !commentContentTextarea.value.trim();
        };
        postCommentBtn.onclick = () => {
          // Add top-level comment (depth 0)
          addComment(post.id, commentContentTextarea.value, null, 0);
          commentContentTextarea.value = "";
          postCommentBtn.disabled = true;
        };

        renderComments(post.id);
        renderRightSidebar(); // Render the right sidebar for post detail view
      }

      function renderComments(postId) {
        const commentsContainer = document.getElementById("comments-container");
        const commentsCountSpan = document.getElementById("comments-count");
        const allPostComments = appState.comments[postId] || [];

        commentsCountSpan.textContent = allPostComments.length;
        commentsContainer.innerHTML = ""; // Clear existing comments

        if (allPostComments.length === 0) {
          commentsContainer.innerHTML = `<p class="text-md text-gray-600">No comments yet. Be the first to reply!</p>`;
          return;
        }

        // Create a map for quick lookup and to store direct children for each comment
        const commentData = new Map();
        allPostComments.forEach((comment) => {
          commentData.set(comment.id, { ...comment, directChildren: [] });
        });

        // Populate directChildren for each comment
        allPostComments.forEach((comment) => {
          if (comment.parentId && commentData.has(comment.parentId)) {
            commentData
              .get(comment.parentId)
              .directChildren.push(commentData.get(comment.id));
          }
        });

        // Get all top-level comments and sort them
        const topLevelComments = Array.from(commentData.values())
          .filter(
            (comment) =>
              comment.parentId === null || comment.parentId === undefined
          )
          .sort(
            (a, b) =>
              (a.createdAt?.toDate() || new Date(0)) -
              (b.createdAt?.toDate() || new Date(0))
          );

        // Helper function to get all descendants (for unified toggle logic)
        function getAllDescendants(commentId, commentsMap) {
          let descendants = [];
          const comment = commentsMap.get(commentId);
          if (!comment || !comment.directChildren) return descendants;

          // Use a stack for depth-first traversal to ensure correct order for display
          const stack = [
            ...comment.directChildren.sort(
              (a, b) =>
                (b.createdAt?.toDate() || new Date(0)) -
                (a.createdAt?.toDate() || new Date(0))
            ),
          ]; // Sort initially for consistent processing order

          while (stack.length > 0) {
            const currentChild = stack.pop(); // Get the last item (LIFO for stack)
            descendants.push(currentChild);
            // Add children of the currentChild to the stack in reverse order to maintain chronological order when popped
            if (
              currentChild.directChildren &&
              currentChild.directChildren.length > 0
            ) {
              stack.push(
                ...currentChild.directChildren.sort(
                  (a, b) =>
                    (b.createdAt?.toDate() || new Date(0)) -
                    (a.createdAt?.toDate() || new Date(0))
                )
              );
            }
          }
          // Sort descendants by creation date to ensure chronological order in the flat list
          return descendants.sort(
            (a, b) =>
              (a.createdAt?.toDate() || new Date(0)) -
              (b.createdAt?.toDate() || new Date(0))
          );
        }

        // Function to render a single comment block
        function renderCommentBlock(comment, containerElement) {
          const isReply =
            comment.parentId !== null && comment.parentId !== undefined;
          // Apply ml-8 only if it's a reply
          const indentClasses = isReply ? "ml-8" : "";

          const isAuthorCurrentUsers =
            appState.userId && comment.authorId === appState.userId;
          const isFollowingAuthor = appState.userProfile?.following?.includes(
            comment.authorId
          );
          const formattedTime = formatRelativeTime(comment.createdAt);

          const commentDiv = document.createElement("div");
          commentDiv.className = `p-4 rounded-xl shadow-sm mb-3 bg-white border border-gray-100 ${indentClasses}`;

          let repliedToHtml = "";
          if (isReply) {
            const parentComment = commentData.get(comment.parentId);
            if (parentComment) {
              repliedToHtml = `<span class="text-blue-500 font-semibold">@${
                parentComment.authorName || "Anonymous"
              }</span> `;
            }
          }

          commentDiv.innerHTML = `
                    <div class="flex items-center gap-3 mb-2 text-sm">
                        <span class="w-4 h-4">${Icons.User}</span>
                        <span class="font-semibold text-gray-800 cursor-pointer hover:underline" data-user-id="${
                          comment.authorId
                        }">${comment.authorName || "Anonymous"}</span>
                        ${
                          !isAuthorCurrentUsers && appState.userId
                            ? `
                            <button class="ml-2 px-2 py-1 rounded-full text-xs font-semibold
                                ${
                                  isFollowingAuthor
                                    ? "bg-gray-300 text-gray-800 hover:bg-gray-400"
                                    : "bg-blue-100 text-blue-700 hover:bg-blue-200"
                                }
                                transition-colors transform active:scale-95 follow-button-comment"
                                data-target-user-id="${comment.authorId}">
                                ${
                                  isFollowingAuthor
                                    ? `<i class="fas fa-check"></i> Unfollow`
                                    : `<i class="fas fa-user-plus"></i> Follow`
                                }
                            </button>
                        `
                            : ""
                        }
                        <span class="text-gray-500">
                            ${formattedTime}
                        </span>
                    </div>
                    ${
                      appState.editingCommentId === comment.id
                        ? `
                        <!-- Edit Comment Form -->
                        <div class="space-y-2">
                            <textarea id="edit-comment-content-${comment.id}" class="w-full p-2 border rounded-xl focus:ring-1 focus:ring-blue-400 border-gray-200 bg-gray-50 text-gray-900 transition-colors" rows="2" required>${comment.content}</textarea>
                            <div class="flex gap-2">
                                <button id="save-comment-btn-${comment.id}" class="flex items-center gap-1 px-3 py-1.5 bg-green-600 text-white rounded-lg text-xs hover:bg-green-700 transition-colors">
                                    ${Icons.Save} Save
                                </button>
                                <button id="cancel-edit-comment-btn-${comment.id}" class="flex items-center gap-1 px-3 py-1.5 bg-gray-300 text-gray-800 rounded-lg text-xs hover:bg-gray-400 transition-colors">
                                    ${Icons.Cancel} Cancel
                                </button>
                            </div>
                        </div>
                    `
                        : `
                        <!-- Display Comment -->
                        <div class="flex items-center justify-between">
                            <p class="font-normal text-gray-700 mb-3">${repliedToHtml}${
                            comment.content
                          }</p>
                            ${
                              comment.authorId === appState.userId
                                ? `
                                <div class="flex gap-2">
                                    <button id="edit-comment-btn-${comment.id}" class="p-1 rounded-full hover:bg-gray-100 transition-colors text-xs" aria-label="Edit Comment">
                                        ${Icons.Edit}
                                    </button>
                                    <button id="delete-comment-btn-${comment.id}" class="p-1 rounded-full hover:bg-red-100 text-red-600 transition-colors text-xs" aria-label="Delete Comment">
                                        ${Icons.Trash}
                                    </button>
                                </div>
                            `
                                : ""
                            }
                        </div>
                    `
                    }
                    <div class="flex flex-wrap gap-2 text-sm">
                        <button id="comment-upvote-btn-${
                          comment.id
                        }" class="flex items-center gap-1 px-2 py-1 rounded-md text-xs font-semibold 
                            ${
                              comment.upvotedBy &&
                              comment.upvotedBy.includes(appState.userId)
                                ? "bg-blue-500 text-white"
                                : "bg-blue-50 text-blue-700 hover:bg-blue-100"
                            }
                            transition-colors">
                            <span class="w-3 h-3">${
                              comment.upvotedBy &&
                              comment.upvotedBy.includes(appState.userId)
                                ? Icons.ThumbsUpSolid
                                : Icons.ThumbsUp
                            }</span> ${comment.upvotes || 0}
                        </button>
                        <button id="comment-downvote-btn-${
                          comment.id
                        }" class="flex items-center gap-1 px-2 py-1 rounded-md text-xs font-semibold 
                            ${
                              comment.downvotedBy &&
                              comment.downvotedBy.includes(appState.userId)
                                ? "bg-red-500 text-white"
                                : "bg-red-50 text-red-700 hover:bg-red-100"
                            }
                            transition-colors">
                            <span class="w-3 h-3">${
                              comment.downvotedBy &&
                              comment.downvotedBy.includes(appState.userId)
                                ? Icons.ThumbsDownSolid
                                : Icons.ThumbsDown
                            }</span> ${comment.downvotes || 0}
                        </button>
                        <button id="comment-ai-summary-btn-${
                          comment.id
                        }" class="flex items-center gap-1 px-2 py-1 rounded-md text-xs font-semibold bg-purple-50 text-purple-700 hover:bg-purple-100 transition-colors">
                            <span class="w-3 h-3">${Icons.Zap}</span> AI
                        </button>
                        <button id="comment-reply-btn-${
                          comment.id
                        }" class="flex items-center gap-1 px-2 py-1 rounded-md text-xs font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors">
                            Reply
                        </button>
                    </div>
                    <div id="reply-form-container-${
                      comment.id
                    }" class="mt-3 hidden">
                        <textarea id="reply-textarea-${
                          comment.id
                        }" class="w-full p-2 border rounded-xl focus:ring-1 focus:ring-blue-400 border-gray-200 bg-gray-50 text-gray-900 transition-colors" rows="2" placeholder="Write your reply..." required></textarea>
                        <button id="submit-reply-btn-${
                          comment.id
                        }" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition-colors" disabled>Post Reply</button>
                    </div>
                `;
          containerElement.appendChild(commentDiv);

          // Make author name clickable in comments
          const commentAuthorNameSpan = commentDiv.querySelector(
            `span[data-user-id="${comment.authorId}"]`
          );
          if (commentAuthorNameSpan) {
            commentAuthorNameSpan.onclick = (e) => {
              e.stopPropagation();
              navigateTo("profile", { targetUserId: comment.authorId });
            };
          }

          // Attach event listener for the new follow button in comments
          const followCommentAuthorBtn = commentDiv.querySelector(
            `.follow-button-comment`
          );
          if (followCommentAuthorBtn) {
            followCommentAuthorBtn.onclick = (e) => {
              e.stopPropagation();
              toggleFollow(comment.authorId);
            };
          }

          // Attach event listeners for comment actions
          document.getElementById(
            `comment-upvote-btn-${comment.id}`
          ).onclick = () => updateCommentVotes(comment.id, "up");
          document.getElementById(
            `comment-downvote-btn-${comment.id}`
          ).onclick = () => updateCommentVotes(comment.id, "down");
          document.getElementById(
            `comment-ai-summary-btn-${comment.id}`
          ).onclick = () =>
            callGeminiAI(
              `Analyze and provide a concise summary or critique of the following comment within an IELTS forum discussion:\n\n"${comment.content}"\n\nComment Author: ${comment.authorName}`,
              `ai-comment-response-${comment.id}`
            );

          const replyButton = document.getElementById(
            `comment-reply-btn-${comment.id}`
          );
          const replyFormContainer = document.getElementById(
            `reply-form-container-${comment.id}`
          );
          const replyTextarea = document.getElementById(
            `reply-textarea-${comment.id}`
          );
          const submitReplyBtn = document.getElementById(
            `submit-reply-btn-${comment.id}`
          );

          replyButton.onclick = () => {
            replyFormContainer.classList.toggle("hidden");
            if (!replyFormContainer.classList.contains("hidden")) {
              replyTextarea.focus();
            }
          };

          replyTextarea.oninput = () => {
            submitReplyBtn.disabled = !replyTextarea.value.trim();
          };

          submitReplyBtn.onclick = () => {
            // When adding a reply, the depth increments. However, for visual display
            // we only care about the single indent for any reply.
            addComment(
              postId,
              replyTextarea.value,
              comment.id,
              comment.depth + 1
            );
            replyTextarea.value = "";
            submitReplyBtn.disabled = true;
            replyFormContainer.classList.add("hidden"); // Hide form after submitting
          };

          // Edit comment listeners
          if (comment.authorId === appState.userId) {
            const editCommentBtn = document.getElementById(
              `edit-comment-btn-${comment.id}`
            );
            if (editCommentBtn) {
              editCommentBtn.onclick = () => {
                appState.editingCommentId = comment.id;
                renderComments(postId); // Re-render comments to show edit form
              };
            }
            const saveCommentBtn = document.getElementById(
              `save-comment-btn-${comment.id}`
            );
            const cancelEditCommentBtn = document.getElementById(
              `cancel-edit-comment-btn-${comment.id}`
            );
            if (saveCommentBtn && cancelEditCommentBtn) {
              saveCommentBtn.onclick = () => {
                const newContent = document.getElementById(
                  `edit-comment-content-${comment.id}`
                ).value;
                if (newContent.trim()) {
                  updateComment(comment.id, newContent);
                } else {
                  showToast("Comment content cannot be empty.", "error");
                }
              };
              cancelEditCommentBtn.onclick = () => {
                appState.editingCommentId = null;
                renderComments(postId); // Exit edit mode
              };
            }
            const deleteCommentBtn = document.getElementById(
              `delete-comment-btn-${comment.id}`
            );
            if (deleteCommentBtn) {
              deleteCommentBtn.onclick = () =>
                deleteComment(comment.id, postId);
            }
          }
        }

        // Render comments based on the flattened and sorted list
        // Process top-level comments first, then their descendants if expanded
        topLevelComments.forEach((toplevelComment) => {
          renderCommentBlock(toplevelComment, commentsContainer); // Render the top-level comment

          // If the top-level comment is expanded, render all its descendants
          if (appState.expandedReplies[toplevelComment.id]) {
            const allDescendants = getAllDescendants(
              toplevelComment.id,
              commentData
            );
            allDescendants.forEach((descendant) => {
              renderCommentBlock(descendant, commentsContainer);
            });
          }

          // Add the "View/Hide Replies" button only for top-level comments that have direct children
          if (toplevelComment.directChildren.length > 0) {
            const toggleRepliesButton = document.createElement("button");
            const areRepliesExpanded =
              appState.expandedReplies[toplevelComment.id];
            const allReplyCount = getAllDescendants(
              toplevelComment.id,
              commentData
            ).length; // Count total descendants
            const buttonText = areRepliesExpanded
              ? `Hide Replies`
              : `View ${allReplyCount} replies`;
            const icon = areRepliesExpanded
              ? Icons.ChevronDown
              : Icons.ChevronRight;

            // This button should appear below the top-level comment's content, but before the next top-level comment.
            // It should not be indented, to indicate it controls the entire thread.
            toggleRepliesButton.className = `flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold mt-2 mb-3 bg-blue-50 text-blue-700 hover:bg-blue-100 transition-colors`;
            toggleRepliesButton.innerHTML = `${icon} ${buttonText}`;
            toggleRepliesButton.onclick = (e) => {
              e.stopPropagation();
              appState.expandedReplies = {
                ...appState.expandedReplies,
                [toplevelComment.id]: !areRepliesExpanded, // Toggle state for the top-level comment
              };
              renderComments(postId); // Re-render all comments to reflect changes
            };
            commentsContainer.appendChild(toggleRepliesButton);
          }
        });
      }

      function renderCreatePostForm() {
        const mainContent = elements.mainContent;
        mainContent.innerHTML = `
                <div class="flex-1">
                    <button id="back-to-home-btn" class="mb-6 flex items-center gap-2 text-base font-semibold text-blue-600 hover:text-blue-700 transition-colors">
                        <span class="w-5 h-5">${Icons.ArrowLeft}</span> Back to Forum
                    </button>
                    <div class="p-6 md:p-8 rounded-2xl shadow-lg transition-colors duration-300 bg-white">
                        <h2 class="text-3xl font-bold font-normal mb-6 text-gray-900">Create New Post</h2>
                        <form id="create-post-form" class="space-y-6">
                            <div>
                                <label for="post-title" class="block text-sm font-medium mb-2 text-gray-700">Title</label>
                                <input type="text" id="post-title" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent border-gray-200 bg-gray-50 text-gray-900 transition-colors" placeholder="Enter post title" required />
                            </div>
                            <div>
                                <label for="post-content" class="block text-sm font-medium mb-2 text-gray-700">Content</label>
                                <!-- Rich Text Editor Placeholder -->
                                <textarea id="post-content" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent border-gray-200 bg-gray-50 text-gray-900 transition-colors" rows="8" placeholder="Share your thoughts, questions, or tips..." required></textarea>
                                <p class="mt-2 text-xs text-gray-500">
                                    Share your thoughts, questions, or tips. (A rich text editor will be added here soon for better formatting!)
                                </p>
                            </div>
                            <!-- Image and Video upload fields removed -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="post-category" class="block text-sm font-medium mb-2 text-gray-700">Category</label>
                                    <select id="post-category" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent border-gray-200 bg-gray-50 text-gray-900 transition-colors" required>
                                        <option value="">Select a Category</option>
                                    </select>
                                </div>
                                <div id="subcategory-container" class="hidden">
                                    <label for="post-sub-category" class="block text-sm font-medium mb-2 text-gray-700">Subcategory (Optional)</label>
                                    <select id="post-sub-category" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent border-gray-200 bg-gray-50 text-gray-900 transition-colors"></select>
                                </div>
                            </div>
                            <button type="submit" class="w-full px-6 py-3 bg-blue-600 text-white rounded-xl shadow-md hover:bg-blue-700 transition-colors font-semibold transform active:scale-95">
                                Create Post
                            </button>
                        </form>
                    </div>
                </div>
                <div id="right-sidebar" class="w-64 ml-8 p-6 hidden lg:block rounded-2xl shadow-lg bg-white">
                    <!-- Right sidebar content will be rendered here -->
                </div>
            `;

        document.getElementById("back-to-home-btn").onclick = () =>
          navigateTo("home");

        const form = document.getElementById("create-post-form");
        const titleInput = document.getElementById("post-title");
        const contentTextarea = document.getElementById("post-content");
        const categorySelect = document.getElementById("post-category");
        const subCategorySelect = document.getElementById("post-sub-category");
        const subCategoryContainer = document.getElementById(
          "subcategory-container"
        );
        // Removed references to imageUpload and videoUpload

        const categoriesData = [
          {
            name: "IELTS Speaking",
            subcategories: ["Cue Cards", "Fluency", "Pronunciation"],
          },
          {
            name: "IELTS Writing",
            subcategories: [
              "Writing Task 1",
              "Writing Task 2",
              "Grammar Help",
              "Vocabulary",
            ],
          },
          { name: "IELTS Listening" },
          { name: "IELTS Reading" },
          { name: "Tips & Strategies" },
          { name: "Band 9 Answers" },
          { name: "Motivation & Support" },
        ];

        // Populate categories
        categoriesData.forEach((cat) => {
          const option = document.createElement("option");
          option.value = cat.name;
          option.textContent = cat.name;
          categorySelect.appendChild(option);
        });

        // Handle category change to update subcategories
        categorySelect.onchange = () => {
          const selectedCategory = categoriesData.find(
            (cat) => cat.name === categorySelect.value
          );
          subCategorySelect.innerHTML =
            '<option value="">Select a Subcategory</option>'; // Reset subcategories
          if (
            selectedCategory &&
            selectedCategory.subcategories &&
            selectedCategory.subcategories.length > 0
          ) {
            subCategoryContainer.classList.remove("hidden");
            selectedCategory.subcategories.forEach((sub) => {
              const option = document.createElement("option");
              option.value = sub;
              option.textContent = sub;
              subCategorySelect.appendChild(option);
            });
          } else {
            subCategoryContainer.classList.add("hidden");
          }
        };

        form.onsubmit = async (e) => {
          e.preventDefault();
          await addPost({
            title: titleInput.value,
            content: contentTextarea.value,
            category: categorySelect.value,
            subCategory: subCategorySelect.value || null,
          });
          // No need to clear file inputs as they are removed
        };
        renderRightSidebar(); // Render the right sidebar for create post view
      }

      /**
       * Renders a user's profile page. This function now supports viewing
       * both the current user's profile and other users' profiles.
       * @param {string} targetUserId The ID of the user whose profile is to be displayed.
       */
      async function renderProfilePage(targetUserId) {
        const mainContent = elements.mainContent;
        const appId =
          typeof __app_id !== "undefined"
            ? __app_id
            : "ielts-mahir-community-forum";

        let profileData = appState.allUsersProfiles.find(
          (p) => p.userId === targetUserId
        );
        let isCurrentUserProfile = targetUserId === appState.userId;

        // If profileData is not in our local cache, fetch it.
        if (!profileData) {
          if (!appState.db) {
            mainContent.innerHTML = `<div class="flex-1 p-6 flex justify-center items-center text-gray-700">Database not initialized.</div>`;
            return;
          }
          mainContent.innerHTML = `<div class="flex-1 p-6 flex justify-center items-center text-gray-700">
                    <div class="flex flex-col items-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                        <p class="text-lg text-gray-700">Loading profile...</p>
                    </div>
                </div>`;
          try {
            const userRef = doc(
              appState.db,
              `artifacts/${appId}/users/${targetUserId}/userProfile/profile`
            );
            const userSnap = await getDoc(userRef);
            if (userSnap.exists()) {
              profileData = { userId: targetUserId, ...userSnap.data() };
              // Add to cache
              const index = appState.allUsersProfiles.findIndex(
                (p) => p.userId === targetUserId
              );
              if (index === -1) {
                appState.allUsersProfiles.push(profileData);
              } else {
                appState.allUsersProfiles[index] = profileData;
              }
            } else {
              mainContent.innerHTML = `<div class="flex-1 p-6 flex justify-center items-center text-red-600">User profile not found.</div>`;
              return;
            }
          } catch (e) {
            console.error("Error fetching profile:", e);
            mainContent.innerHTML = `<div class="flex-1 p-6 flex justify-center items-center text-red-600">Error loading profile.</div>`;
            showToast("Error loading profile. Check console.", "error");
            return;
          }
        }

        const profile = profileData;
        let lastLoginStatus = "N/A";
        if (profile.lastLogin) {
          const now = new Date();
          const lastLoginDate = profile.lastLogin.toDate();
          const minutesSinceLastLogin = Math.floor(
            (now - lastLoginDate) / (1000 * 60)
          );

          if (minutesSinceLastLogin <= 15) {
            // Consider "active now" if logged in within last 15 minutes
            lastLoginStatus = "Active Now";
          } else {
            lastLoginStatus = `Last Online: ${formatRelativeTime(
              profile.lastLogin
            )}`;
          }
        }

        // Filter posts created by the current viewed user
        const userPosts = appState.posts.filter(
          (post) => post.authorId === targetUserId
        );

        // Check if current user is following the viewed profile
        const isFollowing = appState.userProfile?.following?.includes(
          targetUserId
        );

        // Calculate followers from the local cache of all users
        const followersCount = appState.allUsersProfiles.filter((p) =>
          p.following?.includes(targetUserId)
        ).length;
        mainContent.innerHTML = `
                <div class="flex-1">
                    <button id="back-to-home-btn" class="mb-6 flex items-center gap-2 text-base font-semibold text-blue-600 hover:text-blue-700 transition-colors">
                        <span class="w-5 h-5">${
                          Icons.ArrowLeft
                        }</span> Back to Forum
                    </button>
                    <div class="p-6 md:p-8 rounded-2xl shadow-lg transition-colors duration-300 bg-white">
                        <div class="flex flex-col sm:flex-row items-center gap-6 mb-6 pb-6 border-b border-gray-200">
                            <div class="w-28 h-28 rounded-full flex items-center justify-center bg-blue-100 text-blue-600 text-6xl font-anton ring-4 ring-blue-200">
                                ${
                                  profile.name
                                    ? profile.name[0].toUpperCase()
                                    : Icons.User
                                }
                            </div>
                            <div class="text-center sm:text-left flex-1">
                                <h2 class="text-3xl md:text-4xl font-bold font-anton text-gray-900">${
                                  profile.name || "Anonymous"
                                }</h2>
                                <p class="text-md text-gray-600">User ID: ${targetUserId}</p>
                                ${
                                  profile.lastLogin
                                    ? `<p class="text-xs text-gray-500">Status: ${lastLoginStatus}</p>`
                                    : ""
                                }
                            </div>
                            <div class="flex-shrink-0">
                                ${
                                  isCurrentUserProfile && appState.userId
                                    ? appState.editingProfile
                                      ? `
                                        <button id="save-profile-btn" class="flex items-center gap-2 px-5 py-2.5 bg-green-600 text-white rounded-xl shadow-md hover:bg-green-700 transition-all text-sm font-semibold transform active:scale-95">
                                            ${Icons.Save} Save Changes
                                        </button>
                                        <button id="cancel-edit-profile-btn" class="flex items-center gap-2 px-5 py-2.5 bg-gray-300 text-gray-800 rounded-xl shadow-md hover:bg-gray-400 transition-all text-sm font-semibold transform active:scale-95 mt-2">
                                            ${Icons.Cancel} Cancel
                                        </button>
                                    `
                                      : `
                                        <button id="edit-profile-btn" class="flex items-center gap-2 px-5 py-2.5 bg-blue-600 text-white rounded-xl shadow-md hover:bg-blue-700 transition-all text-sm font-semibold transform active:scale-95">
                                            ${Icons.Edit} Edit Profile
                                        </button>
                                    `
                                    : // Render Follow/Unfollow button for other users
                                    appState.userId &&
                                      targetUserId !== appState.userId
                                    ? `
                                        <button id="follow-btn" class="flex items-center gap-2 px-5 py-2.5 rounded-xl shadow-md transition-all text-sm font-semibold transform active:scale-95 ${
                                          isFollowing
                                            ? "bg-gray-300 text-gray-800 hover:bg-gray-400"
                                            : "bg-blue-600 text-white hover:bg-blue-700"
                                        }">
                                            ${
                                              isFollowing
                                                ? `<i class="fas fa-check"></i> Unfollow`
                                                : `<i class="fas fa-user-plus"></i> Follow`
                                            }
                                        </button>
                                    `
                                    : ""
                                }
                            </div>
                        </div>

                        ${
                          isCurrentUserProfile && appState.editingProfile
                            ? `
                            <!-- Edit Profile Form -->
                            <div class="space-y-4">
                                <div>
                                    <label for="edit-profile-name" class="block text-sm font-medium mb-1 text-gray-700">Name</label>
                                    <input type="text" id="edit-profile-name" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent border-gray-200 bg-gray-50 text-gray-900 transition-colors" value="${
                                      profile.name || ""
                                    }" required />
                                </div>
                                <div>
                                    <label for="edit-profile-bio" class="block text-sm font-medium mb-1 text-gray-700">Bio (Optional)</label>
                                    <textarea id="edit-profile-bio" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent border-gray-200 bg-gray-50 text-gray-900 transition-colors" rows="3" placeholder="Tell us about yourself...">${
                                      profile.bio || ""
                                    }</textarea>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="edit-profile-band-goal" class="block text-sm font-medium mb-1 text-gray-700">Target Band</label>
                                        <select id="edit-profile-band-goal" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent border-gray-200 bg-gray-50 text-gray-900 transition-colors"></select>
                                    </div>
                                    <div>
                                        <label for="edit-profile-prep-status" class="block text-sm font-medium mb-1 text-gray-700">Preparation Status</label>
                                        <select id="edit-profile-prep-status" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent border-gray-200 bg-gray-50 text-gray-900 transition-colors"></select>
                                    </div>
                                    <div>
                                        <label for="edit-profile-country" class="block text-sm font-medium mb-1 text-gray-700">Country</label>
                                        <select id="edit-profile-country" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent border-gray-200 bg-gray-50 text-gray-900 transition-colors"></select>
                                    </div>
                                    <div>
                                        <label for="edit-profile-ielts-experience" class="block text-sm font-medium mb-1 text-gray-700">IELTS Experience</label>
                                        <select id="edit-profile-ielts-experience" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent border-gray-200 bg-gray-50 text-gray-900 transition-colors"></select>
                                    </div>
                                </div>
                            </div>
                        `
                            : `
                            <!-- Display Profile -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div>
                                    <h3 class="text-xl font-semibold font-normal mb-4 text-gray-800">About Me</h3>
                                    <div class="space-y-4">
                                        <div class="flex items-start gap-3 p-3 rounded-lg bg-gray-50 shadow-sm">
                                            <span class="w-5 h-5 flex-shrink-0">${
                                              Icons.User
                                            }</span>
                                            <p class="font-normal text-gray-700">
                                                ${
                                                  profile.bio ||
                                                  "No bio provided."
                                                }
                                            </p>
                                        </div>
                                        <div class="flex items-center gap-3 p-3 rounded-lg bg-gray-50 shadow-sm">
                                            <span class="w-5 h-5">${
                                              Icons.Award
                                            }</span>
                                            <span class="font-normal text-gray-700">
                                                Reputation Points: <span class="font-bold text-lg">${
                                                  profile.reputation || 0
                                                }</span>
                                            </span>
                                        </div>
                                        <div class="flex items-center gap-3 p-3 rounded-lg bg-gray-50 shadow-sm">
                                            <span class="w-5 h-5">${
                                              Icons.Users
                                            }</span>
                                            <span class="font-normal text-gray-700">
                                                Followers: <span class="font-bold text-lg">${followersCount}</span>
                                            </span>
                                        </div>
                                        <div class="flex items-center gap-3 p-3 rounded-lg bg-gray-50 shadow-sm">
                                            <span class="w-5 h-5">${
                                              Icons.Star
                                            }</span>
                                            <span class="font-normal text-gray-700">
                                                Following: <span class="font-bold text-lg">${
                                                  (profile.following || [])
                                                    .length
                                                }</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <h3 class="text-xl font-semibold font-normal mb-4 text-gray-800">IELTS Journey</h3>
                                    <div class="space-y-4">
                                        <div class="flex items-center gap-3 p-3 rounded-lg bg-gray-50 shadow-sm">
                                            <span class="w-5 h-5">${
                                              Icons.Target
                                            }</span>
                                            <span class="font-normal text-gray-700">
                                                Target Band: <span class="font-bold text-lg">${
                                                  profile.bandGoal || "N/A"
                                                }</span>
                                            </span>
                                        </div>
                                        <div class="flex items-center gap-3 p-3 rounded-lg bg-gray-50 shadow-sm">
                                            <span class="w-5 h-5">${
                                              Icons.Activity
                                            }</span>
                                            <span class="font-normal text-gray-700">
                                                Preparation Status: <span class="font-bold text-lg">${
                                                  profile.preparationStatus ||
                                                  "New Learner"
                                                }</span>
                                            </span>
                                        </div>
                                        <div class="flex items-center gap-3 p-3 rounded-lg bg-gray-50 shadow-sm">
                                            <span class="w-5 h-5">${
                                              Icons.Link
                                            }</span>
                                            <span class="font-normal text-gray-700">
                                                Country: <span class="font-bold text-lg">${
                                                  profile.country ||
                                                  "Not specified"
                                                }</span>
                                            </span>
                                        </div>
                                        <div class="flex items-center gap-3 p-3 rounded-lg bg-gray-50 shadow-sm">
                                            <span class="w-5 h-5">${
                                              Icons.CheckCircle
                                            }</span>
                                            <span class="font-normal text-gray-700">
                                                IELTS Experience: <span class="font-bold text-lg">${
                                                  profile.ieltsExperience ||
                                                  "Not specified"
                                                }</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-span-1 md:col-span-2">
                                    <h3 class="text-xl font-semibold font-normal mb-4 text-gray-800">Badges</h3>
                                    <div id="badges-container" class="flex flex-wrap gap-3">
                                        <!-- Badges will be appended here -->
                                    </div>
                                </div>
                            </div>
                        `
                        }
                    </div>

                    <!-- User's Posts Section -->
                    <div class="mt-8 p-6 md:p-8 rounded-2xl shadow-lg transition-colors duration-300 bg-white">
                        <h3 class="text-2xl font-bold font-normal mb-4 text-gray-900">${
                          profile.name || "This user"
                        }'s Posts (${userPosts.length})</h3>
                        <div id="user-posts-container" class="space-y-6">
                            <!-- User's posts will be rendered here -->
                        </div>
                    </div>
                </div>
                <div id="right-sidebar" class="w-64 ml-8 p-6 hidden lg:block rounded-2xl shadow-lg bg-white">
                    <!-- Right sidebar content will be rendered here -->
                </div>
            `;
        document.getElementById("back-to-home-btn").onclick = () =>
          navigateTo("home");

        // Handle edit/save/cancel buttons ONLY if it's the current user's profile AND on profile page itself
        // (Note: Profile editing is now primarily through settings page)
        if (
          isCurrentUserProfile &&
          appState.userId &&
          appState.view === "profile"
        ) {
          if (appState.editingProfile) {
            const nameInput = document.getElementById("edit-profile-name");
            const bioTextarea = document.getElementById("edit-profile-bio");
            const bandGoalSelect = document.getElementById(
              "edit-profile-band-goal"
            );
            const prepStatusSelect = document.getElementById(
              "edit-profile-prep-status"
            );
            const countrySelect = document.getElementById(
              "edit-profile-country"
            );
            const ieltsExperienceSelect = document.getElementById(
              "edit-profile-ielts-experience"
            );

            // Populate select options
            BAND_GOALS.forEach((goal) => {
              const option = document.createElement("option");
              option.value = goal;
              option.textContent = goal;
              bandGoalSelect.appendChild(option);
            });
            bandGoalSelect.value = profile.bandGoal || BAND_GOALS[0];

            PREP_STATUSES.forEach((status) => {
              const option = document.createElement("option");
              option.value = status;
              option.textContent = status;
              prepStatusSelect.appendChild(option);
            });
            prepStatusSelect.value =
              profile.preparationStatus || PREP_STATUSES[0];

            COUNTRIES.forEach((country) => {
              const option = document.createElement("option");
              option.value = country;
              option.textContent = country;
              countrySelect.appendChild(option);
            });
            countrySelect.value = profile.country || ""; // Set default or current value

            IELTS_EXPERIENCES.forEach((exp) => {
              const option = document.createElement("option");
              option.value = exp;
              option.textContent = exp;
              ieltsExperienceSelect.appendChild(option);
            });
            ieltsExperienceSelect.value =
              profile.ieltsExperience || IELTS_EXPERIENCES[0];

            document.getElementById("save-profile-btn").onclick = () => {
              const updatedData = {
                name: nameInput.value.trim(),
                bio: bioTextarea.value.trim(),
                bandGoal: bandGoalSelect.value,
                preparationStatus: prepStatusSelect.value,
                country: countrySelect.value,
                ieltsExperience: ieltsExperienceSelect.value,
              };
              if (updatedData.name) {
                updateUserProfile(updatedData);
              } else {
                showToast("Name cannot be empty.", "error");
              }
            };
            document.getElementById("cancel-edit-profile-btn").onclick = () => {
              appState.editingProfile = false;
              renderProfilePage(targetUserId); // Re-render without edit mode
            };
          } else {
            // Edit Profile button on the profile display page itself
            const editProfileBtn = document.getElementById("edit-profile-btn");
            if (editProfileBtn) {
              editProfileBtn.onclick = () => {
                // Navigate to settings page for editing
                navigateTo("settings");
              };
            }
          }
        } else if (appState.userId && targetUserId !== appState.userId) {
          // Logic for other users' profiles
          const followBtn = document.getElementById("follow-btn");
          if (followBtn) {
            followBtn.onclick = () => toggleFollow(targetUserId);
          }
        }

        const badgesContainer = document.getElementById("badges-container");
        if (profile.badges && profile.badges.length > 0) {
          profile.badges.forEach((badgeId) => {
            const badge = ALL_BADGES.find((b) => b.id === badgeId);
            if (badge) {
              const badgeSpan = document.createElement("span");
              badgeSpan.className = `flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800 shadow-sm`;
              badgeSpan.innerHTML = `<span class="text-lg">${badge.icon}</span> ${badge.name}`;
              badgesContainer.appendChild(badgeSpan);
            }
          });
        } else {
          badgesContainer.innerHTML = `<p class="text-md text-gray-600">No badges earned yet.</p>`;
        }

        // Render user's posts
        const userPostsContainer = document.getElementById(
          "user-posts-container"
        );
        if (userPosts.length === 0) {
          userPostsContainer.innerHTML = `<p class="text-lg text-gray-600">There are no posts from this user yet.</p>`;
        } else {
          userPosts.forEach((post) => {
            const postDiv = document.createElement("div");
            postDiv.className = `p-6 rounded-2xl shadow-lg transition-all duration-200 hover:shadow-xl hover:scale-[1.01] cursor-pointer bg-white`;
            postDiv.addEventListener("click", (e) => {
              if (
                e.target.tagName !== "BUTTON" &&
                e.target.tagName !== "SPAN" &&
                e.target.tagName !== "A"
              ) {
                navigateTo("postDetail", { post: post });
              }
            });

            const formattedTime = formatRelativeTime(post.createdAt);
            const commentsCount = (appState.comments[post.id] || []).length;
            const isAuthorCurrentUsersPost =
              appState.userId && post.authorId === appState.userId;
            const isFollowingPostAuthor = appState.userProfile?.following?.includes(
              post.authorId
            );

            postDiv.innerHTML = `
                        <h3 class="text-xl font-semibold font-normal mb-2 text-blue-700">
                            ${post.title}
                        </h3>
                        <p class="text-sm text-gray-600 mb-3 line-clamp-2">
                            ${post.content}
                        </p>
                        <div class="flex items-center justify-between text-xs font-normal text-gray-500 border-t pt-3 mt-4 border-gray-100">
                            <div class="flex items-center gap-2">
                                <span class="w-4 h-4">${Icons.User}</span>
                                <span class="font-bold cursor-pointer hover:underline" data-user-id="${targetUserId}">${
              post.authorName || "Anonymous"
            }</span>
                                ${
                                  !isAuthorCurrentUsersPost && appState.userId
                                    ? `
                                    <button class="ml-2 px-2 py-1 rounded-full text-xs font-semibold
                                        ${
                                          isFollowingPostAuthor
                                            ? "bg-gray-300 text-gray-800 hover:bg-gray-400"
                                            : "bg-blue-100 text-blue-700 hover:bg-blue-200"
                                        }
                                        transition-colors transform active:scale-95 follow-button hidden sm:block"
                                        data-target-user-id="${post.authorId}">
                                        ${
                                          isFollowingPostAuthor
                                            ? `<i class="fas fa-check"></i> Unfollow`
                                            : `<i class="fas fa-user-plus"></i> Follow`
                                        }
                                    </button>
                                `
                                    : ""
                                }
                                <span class="mx-1">‚Ä¢</span>
                                <span>${formattedTime}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="flex items-center gap-1 text-green-500">
                                    <span class="w-4 h-4">${
                                      Icons.ThumbsUp
                                    }</span> ${post.upvotes || 0}
                                </span>
                                <span class="flex items-center gap-1 text-red-500">
                                    <span class="w-4 h-4">${
                                      Icons.ThumbsDown
                                    }</span> ${post.downvotes || 0}
                                </span>
                                <span class="flex items-center gap-1 text-blue-500">
                                    <span class="w-4 h-4">${
                                      Icons.MessageCircleMore
                                    }</span> ${commentsCount}
                                </span>
                                ${
                                  post.isResolved
                                    ? `<span class="flex items-center gap-1 text-green-600 font-semibold"> <span class="w-4 h-4">${Icons.CheckCircle}</span> Resolved</span>`
                                    : ""
                                }
                            </div>
                        </div>
                        ${
                          post.category
                            ? `
                            <div class="mt-3 flex flex-wrap gap-2">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold bg-blue-50 text-blue-700">
                                    ${post.category}
                                </span>
                                ${
                                  post.subCategory
                                    ? `<span class="px-3 py-1 rounded-full text-xs font-semibold bg-indigo-50 text-indigo-700"> ${post.subCategory}</span>`
                                    : ""
                                }
                                ${
                                  post.tags && post.tags.length > 0
                                    ? post.tags
                                        .map(
                                          (tag) =>
                                            `<span class="px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-600">${tag}</span>`
                                        )
                                        .join("")
                                    : ""
                                }
                            </div>
                        `
                            : ""
                        }
                    `;
            userPostsContainer.appendChild(postDiv);

            const postAuthorNameSpan = postDiv.querySelector(
              `span[data-user-id="${targetUserId}"]`
            );
            if (postAuthorNameSpan) {
              postAuthorNameSpan.onclick = (e) => {
                e.stopPropagation();
                navigateTo("profile", { targetUserId: targetUserId });
              };
            }

            // Attach event listener for the new follow button
            const followButtonPost = postDiv.querySelector(`.follow-button`);
            if (followButtonPost) {
              followButtonPost.onclick = (e) => {
                e.stopPropagation(); // Prevent the postDiv's click event from firing
                toggleFollow(post.authorId);
              };
            }
          });
        }
        renderRightSidebar(); // Render the right sidebar for profile view
      }

      /**
       * Renders the notifications page.
       */
      async function renderNotificationsPage() {
        if (!appState.userId) {
          elements.mainContent.innerHTML = `<div class="flex-1 p-6 flex justify-center items-center text-gray-700">Please sign in to view notifications.</div>`;
          return;
        }

        const mainContent = elements.mainContent;
        mainContent.innerHTML = `
                <div class="flex-1">
                    <button id="back-to-home-btn" class="mb-6 flex items-center gap-2 text-base font-semibold text-blue-600 hover:text-blue-700 transition-colors">
                        <span class="w-5 h-5">${
                          Icons.ArrowLeft
                        }</span> Back to Forum
                    </button>
                    <div class="p-6 md:p-8 rounded-2xl shadow-lg bg-white">
                        <h2 class="text-3xl font-bold font-normal mb-6 text-gray-900">Your Notifications (<span id="unread-count">${
                          appState.unreadNotificationCount
                        }</span> Unread)</h2>
                        <div id="notifications-list" class="space-y-4">
                            <!-- Notifications will be loaded here -->
                        </div>
                        <button id="mark-all-read-btn" class="mt-6 px-5 py-2.5 bg-blue-600 text-white rounded-xl shadow-md hover:bg-blue-700 transition-all text-sm font-semibold transform active:scale-95 ${
                          appState.unreadNotificationCount === 0
                            ? "opacity-50 cursor-not-allowed"
                            : ""
                        }" ${
          appState.unreadNotificationCount === 0 ? "disabled" : ""
        }>
                            Mark All As Read
                        </button>
                    </div>
                </div>
                <div id="right-sidebar" class="w-64 ml-8 p-6 hidden lg:block rounded-2xl shadow-lg bg-white">
                    <!-- Right sidebar content will be rendered here -->
                </div>
            `;
        document.getElementById("back-to-home-btn").onclick = () =>
          navigateTo("home");

        const notificationsList = document.getElementById("notifications-list");
        const markAllReadBtn = document.getElementById("mark-all-read-btn");

        if (appState.notifications.length === 0) {
          notificationsList.innerHTML = `<p class="text-md text-gray-600">No notifications yet.</p>`;
        } else {
          appState.notifications
            .sort(
              (a, b) =>
                (b.createdAt?.toDate() || new Date(0)) -
                (a.createdAt?.toDate() || new Date(0))
            )
            .forEach((notification) => {
              const notificationItem = document.createElement("div");
              notificationItem.className = `p-4 rounded-xl shadow-sm border border-gray-100 ${
                notification.read
                  ? "bg-gray-50 text-gray-500"
                  : "bg-blue-50 text-gray-800 font-semibold"
              } flex items-start gap-4`;

              let icon;
              switch (notification.type) {
                case "vote":
                  icon = Icons.ThumbsUpSolid;
                  break;
                case "reply":
                  icon = Icons.MessageCircleMore;
                  break;
                case "follow":
                  icon = Icons.UserPlus;
                  break;
                case "new_post": // New icon for new post notifications
                  icon = Icons.Plus;
                  break;
                default:
                  icon = Icons.Bell;
              }

              notificationItem.innerHTML = `
                        <div class="flex-shrink-0 text-blue-600 text-xl">${icon}</div>
                        <div class="flex-1">
                            <p class="text-sm">${notification.message}</p>
                            <span class="text-xs text-gray-500">${formatRelativeTime(
                              notification.createdAt
                            )}</span>
                        </div>
                        <div class="flex-shrink-0 flex items-center gap-2">
                            ${
                              !notification.read
                                ? `<button class="mark-as-read-btn px-3 py-1 rounded-full text-xs font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300" data-id="${notification.id}">Mark as Read</button>`
                                : ""
                            }
                            ${
                              notification.link
                                ? `<button class="view-notification-link px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-700 hover:bg-blue-200" data-id="${notification.id}" data-link="${notification.link}">View</button>`
                                : ""
                            }
                        </div>
                    `;
              notificationsList.appendChild(notificationItem);
            });

          document.querySelectorAll(".mark-as-read-btn").forEach((button) => {
            button.onclick = async (e) => {
              const notificationId = e.target.dataset.id;
              await markNotificationAsRead(notificationId);
            };
          });

          document
            .querySelectorAll(".view-notification-link")
            .forEach((button) => {
              button.onclick = (e) => {
                const link = e.target.dataset.link;
                const notificationId = e.target.dataset.id;
                if (link.includes("#")) {
                  // It's a post detail link with a comment ID
                  const [postId, commentId] = link.split("#");
                  const post = appState.posts.find((p) => p.id === postId);
                  if (post) {
                    navigateTo("postDetail", { post: post });
                    // Optional: Scroll to comment if commentId exists after render
                    setTimeout(() => {
                      const targetComment = document.getElementById(
                        `comment-${commentId}`
                      );
                      if (targetComment) {
                        targetComment.scrollIntoView({
                          behavior: "smooth",
                          block: "start",
                        });
                      }
                    }, 500); // Give time for content to render
                  } else {
                    showToast("Post for this notification not found.", "info");
                  }
                } else {
                  // Assume it's a postId or userId for a profile
                  const post = appState.posts.find((p) => p.id === link);
                  if (post) {
                    navigateTo("postDetail", { post: post });
                  } else {
                    // Try navigating to profile if it matches a user ID from our cache
                    const targetUser = appState.allUsersProfiles.find(
                      (p) => p.userId === link
                    );
                    if (targetUser) {
                      navigateTo("profile", { targetUserId: link });
                    } else {
                      showToast(
                        "Content for this notification not found.",
                        "info"
                      );
                    }
                  }
                }
                markNotificationAsRead(notificationId); // Mark as read when viewed
              };
            });

          markAllReadBtn.onclick = async () => {
            const batch = writeBatch(appState.db);
            appState.notifications.forEach((notif) => {
              if (!notif.read) {
                const notifRef = doc(
                  appState.db,
                  `artifacts/${
                    typeof __app_id !== "undefined"
                      ? __app_id
                      : "ielts-mahir-community-forum"
                  }/users/${appState.userId}/notifications`,
                  notif.id
                );
                batch.update(notifRef, { read: true });
              }
            });
            try {
              await batch.commit();
              showToast("All notifications marked as read!", "success");
            } catch (e) {
              console.error("Error marking all as read:", e);
              showToast("Error marking all as read.", "error");
            }
          };
        }
        renderRightSidebar(); // Render the right sidebar for notifications view
      }

      /**
       * Marks a specific notification as read.
       * @param {string} notificationId The ID of the notification to mark as read.
       */
      async function markNotificationAsRead(notificationId) {
        if (!appState.db || !appState.userId) return;
        const appId =
          typeof __app_id !== "undefined"
            ? __app_id
            : "ielts-mahir-community-forum";
        try {
          const notifRef = doc(
            appState.db,
            `artifacts/${appId}/users/${appState.userId}/notifications`,
            notificationId
          );
          await updateDoc(notifRef, { read: true });
          // The onSnapshot listener will update appState.notifications and trigger re-render
        } catch (e) {
          console.error("Error marking notification as read:", e);
          showToast("Error marking notification as read.", "error");
        }
      }

      /**
       * Renders the settings page, including profile editing and notification preferences.
       */
      function renderSettingsPage() {
        if (!appState.userId || !appState.userProfile) {
          elements.mainContent.innerHTML = `<div class="flex-1 p-6 flex justify-center items-center text-gray-700">Please sign in to view settings.</div>`;
          return;
        }

        const mainContent = elements.mainContent;
        const profile = appState.userProfile; // Use the live userProfile from appState

        mainContent.innerHTML = `
                <div class="flex-1">
                    <button id="back-to-home-btn" class="mb-6 flex items-center gap-2 text-base font-semibold text-blue-600 hover:text-blue-700 transition-colors">
                        <span class="w-5 h-5">${
                          Icons.ArrowLeft
                        }</span> Back to Forum
                    </button>
                    <div class="p-6 md:p-8 rounded-2xl shadow-lg bg-white">
                        <h2 class="text-3xl font-bold font-normal mb-6 text-gray-900">Settings</h2>

                        <!-- Profile Settings Section -->
                        <div class="mb-8 pb-8 border-b border-gray-200">
                            <h3 class="text-2xl font-semibold font-normal mb-4 text-gray-800">Profile Settings</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="settings-profile-name" class="block text-sm font-medium mb-1 text-gray-700">Name</label>
                                    <input type="text" id="settings-profile-name" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent border-gray-200 bg-gray-50 text-gray-900 transition-colors" value="${
                                      profile.name || ""
                                    }" required />
                                </div>
                                <div>
                                    <label for="settings-profile-bio" class="block text-sm font-medium mb-1 text-gray-700">Bio (Optional)</label>
                                    <textarea id="settings-profile-bio" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent border-gray-200 bg-gray-50 text-gray-900 transition-colors" rows="3" placeholder="Tell us about yourself...">${
                                      profile.bio || ""
                                    }</textarea>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="settings-profile-band-goal" class="block text-sm font-medium mb-1 text-gray-700">Target Band</label>
                                        <select id="settings-profile-band-goal" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent border-gray-200 bg-gray-50 text-gray-900 transition-colors"></select>
                                    </div>
                                    <div>
                                        <label for="settings-profile-prep-status" class="block text-sm font-medium mb-1 text-gray-700">Preparation Status</label>
                                        <select id="settings-profile-prep-status" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent border-gray-200 bg-gray-50 text-gray-900 transition-colors"></select>
                                    </div>
                                    <div>
                                        <label for="settings-profile-country" class="block text-sm font-medium mb-1 text-gray-700">Country</label>
                                        <select id="settings-profile-country" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent border-gray-200 bg-gray-50 text-gray-900 transition-colors"></select>
                                    </div>
                                    <div>
                                        <label for="settings-profile-ielts-experience" class="block text-sm font-medium mb-1 text-gray-700">IELTS Experience</label>
                                        <select id="settings-profile-ielts-experience" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent border-gray-200 bg-gray-50 text-gray-900 transition-colors"></select>
                                    </div>
                                </div>
                                <button id="save-profile-settings-btn" class="px-5 py-2.5 bg-blue-600 text-white rounded-xl shadow-md hover:bg-blue-700 transition-all text-sm font-semibold transform active:scale-95">
                                    Save Profile Changes
                                </button>
                            </div>
                        </div>

                        <!-- Notification Preferences Section -->
                        <div class="mb-8 pb-8 border-b border-gray-200">
                            <h3 class="text-2xl font-semibold font-normal mb-4 text-gray-800">Notification Preferences</h3>
                            <div class="space-y-3">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" id="notif-votes" class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500" ${
                                      profile.notificationPreferences?.vote !==
                                      false
                                        ? "checked"
                                        : ""
                                    }>
                                    <label for="notif-votes" class="text-gray-700">Receive notifications for votes on my content</label>
                                </div>
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" id="notif-replies" class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500" ${
                                      profile.notificationPreferences?.reply !==
                                      false
                                        ? "checked"
                                        : ""
                                    }>
                                    <label for="notif-replies" class="text-gray-700">Receive notifications for replies to my content</label>
                                </div>
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" id="notif-follows" class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500" ${
                                      profile.notificationPreferences
                                        ?.follow !== false
                                        ? "checked"
                                        : ""
                                    }>
                                    <label for="notif-follows" class="text-gray-700">Receive notifications when someone follows me</label>
                                </div>
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" id="notif-new-posts" class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500" ${
                                      profile.notificationPreferences
                                        ?.new_post !== false
                                        ? "checked"
                                        : ""
                                    }>
                                    <label for="notif-new-posts" class="text-gray-700">Receive notifications for new posts from followed users</label>
                                </div>
                                <button id="save-notif-settings-btn" class="px-5 py-2.5 bg-blue-600 text-white rounded-xl shadow-md hover:bg-blue-700 transition-all text-sm font-semibold transform active:scale-95">
                                    Save Notification Settings
                                </button>
                            </div>
                        </div>

                        <!-- App Preferences Section -->
                        <div class="mb-8 pb-8 border-b border-gray-200">
                            <h3 class="text-2xl font-semibold font-normal mb-4 text-gray-800">App Preferences</h3>
                            <div class="space-y-3">
                                <div>
                                    <label for="default-home-feed" class="block text-sm font-medium mb-1 text-gray-700">Default Home Feed</label>
                                    <select id="default-home-feed" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent border-gray-200 bg-gray-50 text-gray-900 transition-colors">
                                        <option value="latest">Latest Posts</option>
                                        <option value="forYou">For You (Trending)</option>
                                        <option value="following">Following (Posts from followed users)</option>
                                    </select>
                                </div>
                                <button id="save-app-settings-btn" class="px-5 py-2.5 bg-blue-600 text-white rounded-xl shadow-md hover:bg-blue-700 transition-all text-sm font-semibold transform active:scale-95">
                                    Save App Preferences
                                </button>
                            </div>
                        </div>

                        <!-- Account Settings Section -->
                        <div>
                            <h3 class="text-2xl font-semibold font-normal mb-4 text-gray-800">Account Settings</h3>
                            <div class="space-y-3">
                                <p class="text-gray-700 text-sm">
                                    You can delete your account and all associated data here. This action is irreversible.
                                </p>
                                <button id="delete-account-btn" class="px-5 py-2.5 bg-red-600 text-white rounded-xl shadow-md hover:bg-red-700 transition-all text-sm font-semibold transform active:scale-95">
                                    Delete Account
                                </button>
                            </div>
                        </div>

                    </div>
                </div>
                <div id="right-sidebar" class="w-64 ml-8 p-6 hidden lg:block rounded-2xl shadow-lg bg-white">
                    <!-- Right sidebar content will be rendered here -->
                </div>
            `;
        document.getElementById("back-to-home-btn").onclick = () =>
          navigateTo("home");

        // --- Profile Settings Logic ---
        const nameInput = document.getElementById("settings-profile-name");
        const bioTextarea = document.getElementById("settings-profile-bio");
        const bandGoalSelect = document.getElementById(
          "settings-profile-band-goal"
        );
        const prepStatusSelect = document.getElementById(
          "settings-profile-prep-status"
        );
        const countrySelect = document.getElementById(
          "settings-profile-country"
        );
        const ieltsExperienceSelect = document.getElementById(
          "settings-profile-ielts-experience"
        );

        // Populate select options for profile settings
        BAND_GOALS.forEach((goal) => {
          const option = document.createElement("option");
          option.value = goal;
          option.textContent = goal;
          bandGoalSelect.appendChild(option);
        });
        bandGoalSelect.value = profile.bandGoal || BAND_GOALS[0];

        PREP_STATUSES.forEach((status) => {
          const option = document.createElement("option");
          option.value = status;
          option.textContent = status;
          prepStatusSelect.appendChild(option);
        });
        prepStatusSelect.value = profile.preparationStatus || PREP_STATUSES[0];

        COUNTRIES.forEach((country) => {
          const option = document.createElement("option");
          option.value = country;
          option.textContent = country;
          countrySelect.appendChild(option);
        });
        countrySelect.value = profile.country || "";

        IELTS_EXPERIENCES.forEach((exp) => {
          const option = document.createElement("option");
          option.value = exp;
          option.textContent = exp;
          ieltsExperienceSelect.appendChild(option);
        });
        ieltsExperienceSelect.value =
          profile.ieltsExperience || IELTS_EXPERIENCES[0];

        document.getElementById("save-profile-settings-btn").onclick = () => {
          const updatedData = {
            name: nameInput.value.trim(),
            bio: bioTextarea.value.trim(),
            bandGoal: bandGoalSelect.value,
            preparationStatus: prepStatusSelect.value,
            country: countrySelect.value,
            ieltsExperience: ieltsExperienceSelect.value,
          };
          if (updatedData.name) {
            updateUserProfile(updatedData);
          } else {
            showToast("Name cannot be empty.", "error");
          }
        };

        // --- Notification Preferences Logic ---
        const notifVotes = document.getElementById("notif-votes");
        const notifReplies = document.getElementById("notif-replies");
        const notifFollows = document.getElementById("notif-follows");
        const notifNewPosts = document.getElementById("notif-new-posts"); // New checkbox

        // Ensure current state is reflected in checkboxes
        notifVotes.checked = profile.notificationPreferences?.vote !== false; // Default true if undefined
        notifReplies.checked = profile.notificationPreferences?.reply !== false;
        notifFollows.checked =
          profile.notificationPreferences?.follow !== false;
        notifNewPosts.checked =
          profile.notificationPreferences?.new_post !== false; // Set for new posts

        document.getElementById("save-notif-settings-btn").onclick = () => {
          const updatedPreferences = {
            vote: notifVotes.checked,
            reply: notifReplies.checked,
            follow: notifFollows.checked,
            new_post: notifNewPosts.checked, // Save new post preference
          };
          updateUserProfile({ notificationPreferences: updatedPreferences });
        };

        // --- App Preferences Logic ---
        const defaultHomeFeedSelect = document.getElementById(
          "default-home-feed"
        );
        defaultHomeFeedSelect.value = profile.defaultHomeFeed || "latest"; // Set current default

        document.getElementById("save-app-settings-btn").onclick = () => {
          updateUserProfile({ defaultHomeFeed: defaultHomeFeedSelect.value });
        };

        // --- Account Settings (Delete Account) ---
        document.getElementById("delete-account-btn").onclick = deleteAccount;

        renderRightSidebar(); // Render the right sidebar for settings view
      }

      /**
       * Renders the authentication (Sign Up/Sign In) page.
       * @param {'login'|'signup'} mode The current mode for the auth page.
       */
      function renderAuthPage(mode) {
        const mainContent = elements.mainContent;
        const isLoginMode = mode === "login";

        mainContent.innerHTML = `
                <div class="flex-1 flex items-center justify-center min-h-screen -mt-16">
                    <div class="p-8 md:p-10 rounded-2xl shadow-lg bg-white w-full max-w-md">
                        <h2 class="text-3xl font-bold font-normal mb-6 text-gray-900 text-center">
                            ${isLoginMode ? "Sign In" : "Sign Up"} to Mahir
                        </h2>
                        <form id="auth-form" class="space-y-5">
                            <div>
                                <label for="auth-email" class="block text-sm font-medium mb-1 text-gray-700">Email</label>
                                <input type="email" id="auth-email" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent border-gray-200 bg-gray-50 text-gray-900 transition-colors" placeholder="your@example.com" required />
                            </div>
                            <div>
                                <label for="auth-password" class="block text-sm font-medium mb-1 text-gray-700">Password</label>
                                <input type="password" id="auth-password" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent border-gray-200 bg-gray-50 text-gray-900 transition-colors" placeholder="Minimum 6 characters" required />
                            </div>
                            ${
                              !isLoginMode
                                ? `
                                <div>
                                    <label for="auth-confirm-password" class="block text-sm font-medium mb-1 text-gray-700">Confirm Password</label>
                                    <input type="password" id="auth-confirm-password" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent border-gray-200 bg-gray-50 text-gray-900 transition-colors" placeholder="Confirm your password" required />
                                </div>
                            `
                                : ""
                            }
                            <button type="submit" class="w-full px-6 py-3 bg-blue-600 text-white rounded-xl shadow-md hover:bg-blue-700 transition-colors font-semibold transform active:scale-95">
                                ${isLoginMode ? "Sign In" : "Sign Up"}
                            </button>
                        </form>
                        <div class="mt-6 text-center text-gray-600">
                            ${
                              isLoginMode
                                ? `Don't have an account? <button id="toggle-auth-mode" class="text-blue-600 font-semibold hover:underline">Sign Up</button>`
                                : `Already have an account? <button id="toggle-auth-mode" class="text-blue-600 font-semibold hover:underline">Sign In</button>`
                            }
                        </div>
                        <div class="relative flex items-center justify-center my-6">
                            <div class="absolute inset-x-0 h-px bg-gray-200"></div>
                            <span class="relative bg-white px-4 text-sm text-gray-500">OR</span>
                        </div>
                        <button id="google-auth-btn" class="w-full flex items-center justify-center gap-3 px-6 py-3 bg-red-500 text-white rounded-xl shadow-md hover:bg-red-600 transition-colors font-semibold transform active:scale-95">
                            <i class="fab fa-google text-lg"></i> Continue with Google
                        </button>
                    </div>
                </div>
            `;

        const authForm = document.getElementById("auth-form");
        const emailInput = document.getElementById("auth-email");
        const passwordInput = document.getElementById("auth-password");
        const confirmPasswordInput = document.getElementById(
          "auth-confirm-password"
        );
        const toggleAuthModeBtn = document.getElementById("toggle-auth-mode");
        const googleAuthBtn = document.getElementById("google-auth-btn");

        toggleAuthModeBtn.onclick = () => {
          navigateTo("auth", { authMode: isLoginMode ? "signup" : "login" });
        };

        authForm.onsubmit = async (e) => {
          e.preventDefault();
          const email = emailInput.value;
          const password = passwordInput.value;

          if (isLoginMode) {
            // Sign In
            try {
              await signInWithEmailAndPassword(appState.auth, email, password);
              showToast("Signed in successfully!", "success");
              navigateTo("home"); // Navigate to home on success
            } catch (error) {
              console.error("Sign-in error:", error);
              showToast(`Sign-in failed: ${error.message}`, "error");
            }
          } else {
            // Sign Up
            const confirmPassword = confirmPasswordInput.value;
            if (password !== confirmPassword) {
              showToast("Passwords do not match!", "error");
              return;
            }
            if (password.length < 6) {
              showToast(
                "Password must be at least 6 characters long.",
                "error"
              );
              return;
            }
            try {
              const userCredential = await createUserWithEmailAndPassword(
                appState.auth,
                email,
                password
              );
              // A default profile will be created by the auth listener
              showToast("Account created successfully! Welcome!", "success");
              navigateTo("home"); // Navigate to home on success
            } catch (error) {
              console.error("Sign-up error:", error);
              showToast(`Sign-up failed: ${error.message}`, "error");
            }
          }
        };

        googleAuthBtn.onclick = async () => {
          try {
            const provider = new GoogleAuthProvider();
            await signInWithPopup(appState.auth, provider);
            showToast("Signed in with Google successfully!", "success");
            navigateTo("home"); // Navigate to home on success
          } catch (error) {
            console.error("Google sign-in error:", error);
            showToast(`Google sign-in failed: ${error.message}`, "error");
          }
        };
      }

      // --- Main Render Loop ---
      function renderMainContent() {
        if (!appState.isAuthReady) {
          elements.mainContent.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center font-normal text-gray-800 flex-1">
                        <div class="flex flex-col items-center">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                            <p class="text-lg text-gray-700">Loading IELTS Mahir...</p>
                        </div>
                    </div>
                `;
          return;
        }

        // If not authenticated, always show the auth page.
        if (!appState.userId) {
          renderAuthPage(appState.authMode || "login");
          return;
        }

        // Profile completion enforcement (only if authenticated and profile is default)
        if (
          appState.userId &&
          appState.userProfile &&
          appState.userProfile.name.startsWith("User-") &&
          appState.view !== "settings"
        ) {
          showToast(
            "Please complete your profile first to access all features.",
            "info"
          );
          navigateTo("settings");
          return; // Stop rendering the requested view and show settings instead
        }

        switch (appState.view) {
          case "home":
            renderPostList();
            break;
          case "postDetail":
            renderPostDetail();
            break;
          case "createPost":
            renderCreatePostForm();
            break;
          case "profile":
            // Pass the target user ID for rendering
            renderProfilePage(appState.viewedProfile || appState.userId);
            break;
          case "notifications":
            renderNotificationsPage();
            break;
          case "settings":
            renderSettingsPage();
            break;
          case "auth": // Should not be reached if authenticated, but as a fallback
            renderAuthPage(appState.authMode || "login");
            break;
          default:
            renderPostList();
        }
      }

      function renderApp() {
        renderHeader();
        renderSidebar();
        renderMainContent();
      }

      // --- Firebase Listener Setup Function ---
      function setupFirestoreListeners() {
        const appId =
          typeof __app_id !== "undefined"
            ? __app_id
            : "ielts-mahir-community-forum";

        // Unsubscribe from previous listeners if they exist
        if (appState.postsUnsubscribe) appState.postsUnsubscribe();
        if (appState.commentsUnsubscribe) appState.commentsUnsubscribe();
        if (appState.notificationsUnsubscribe)
          appState.notificationsUnsubscribe();
        if (appState.userProfileUnsubscribe) appState.userProfileUnsubscribe();
        if (appState.allUsersProfilesUnsubscribe)
          appState.allUsersProfilesUnsubscribe();

        // 1. Listen for current user's profile changes
        if (appState.userId) {
          const userProfileRef = doc(
            appState.db,
            `artifacts/${appId}/users/${appState.userId}/userProfile/profile`
          );
          appState.userProfileUnsubscribe = onSnapshot(
            userProfileRef,
            (docSnap) => {
              if (docSnap.exists()) {
                appState.userProfile = docSnap.data();
                // Initialize following and notificationPreferences if they don't exist
                if (!appState.userProfile.following) {
                  appState.userProfile.following = [];
                }
                if (!appState.userProfile.notificationPreferences) {
                  // Ensure all notification preferences have a default of true if not explicitly set
                  appState.userProfile.notificationPreferences = {
                    vote: true,
                    reply: true,
                    follow: true,
                    new_post: true, // New: default new_post notifications to true
                  };
                } else {
                  // Ensure new_post preference is set if it's missing from existing preferences
                  if (
                    appState.userProfile.notificationPreferences.new_post ===
                    undefined
                  ) {
                    appState.userProfile.notificationPreferences.new_post = true;
                  }
                }
                if (!appState.userProfile.defaultHomeFeed) {
                  appState.userProfile.defaultHomeFeed = "latest";
                }
              } else {
                console.warn("User profile not found, creating a default one.");
                // This scenario should ideally be handled during initial auth, but as a fallback:
                const defaultProfile = {
                  name: `User-${appState.userId.substring(0, 5)}`,
                  bandGoal: "N/A",
                  preparationStatus: "New Learner",
                  reputation: 0,
                  badges: [],
                  createdAt: serverTimestamp(),
                  userId: appState.userId,
                  bio: "",
                  country: "",
                  ieltsExperience: "",
                  following: [],
                  notificationPreferences: {
                    // Default to all on, including new_post
                    vote: true,
                    reply: true,
                    follow: true,
                    new_post: true,
                  },
                  defaultHomeFeed: "latest",
                };
                setDoc(userProfileRef, defaultProfile)
                  .then(() => {
                    appState.userProfile = defaultProfile;
                  })
                  .catch((e) =>
                    console.error("Error creating default profile:", e)
                  );
              }
              // Set flag if profile needs completion
              if (appState.userProfile.name.startsWith("User-")) {
                appState.shouldCompleteProfile = true;
              } else {
                appState.shouldCompleteProfile = false;
              }
              updateCachedUserProfiles();

              // Render main content only if the view depends on the current user's profile
              if (
                appState.view === "profile" ||
                appState.view === "settings" ||
                appState.view === "home" ||
                appState.view === "notifications" || // To update unread count
                appState.shouldCompleteProfile // Always re-render if profile needs completion
              ) {
                // renderApp(); // Re-render whole app to update header, sidebar, and main content
              }
            },
            (error) => {
              console.error("Error fetching current user profile:", error);
            }
          );
        }

        // 3. Listen for posts
        let postsQueryRef = collection(
          appState.db,
          `artifacts/${appId}/public/data/posts`
        );
        postsQueryRef = query(postsQueryRef, orderBy("createdAt", "desc"));
        appState.postsUnsubscribe = onSnapshot(
          postsQueryRef,
          (snapshot) => {
            appState.posts = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            if (appState.view === "postDetail" && appState.selectedPost) {
              const updatedSelectedPost = appState.posts.find(
                (p) => p.id === appState.selectedPost.id
              );
              if (updatedSelectedPost) {
                appState.selectedPost = updatedSelectedPost;
              }
              updateCachedUserProfiles();
            }
            if (
              appState.view === "home" ||
              appState.view === "postDetail" ||
              appState.view === "profile"
            ) {
              renderMainContent();
            }
          },
          (error) => {
            console.error("Error fetching posts:", error);
            showToast("Error loading posts. Check console.", "error");
          }
        );

        // 4. Listen for comments
        const commentsColRef = collection(
          appState.db,
          `artifacts/${appId}/public/data/comments`
        );
        appState.commentsUnsubscribe = onSnapshot(
          commentsColRef,
          (snapshot) => {
            const allFetchedComments = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            const commentsByPost = {};
            allFetchedComments.forEach((comment) => {
              if (!commentsByPost[comment.postId]) {
                commentsByPost[comment.postId] = [];
              }
              commentsByPost[comment.postId].push(comment);
            });
            appState.comments = commentsByPost;
            updateCachedUserProfiles();
            if (appState.view === "home") {
              renderPostList();
            } else if (
              appState.view === "postDetail" &&
              appState.selectedPost
            ) {
              renderComments(appState.selectedPost.id);
            }
          },
          (error) => {
            console.error("Error fetching comments:", error);
            showToast("Error loading comments. Check console.", "error");
          }
        );

        // 5. Listen for current user's notifications
        if (appState.userId) {
          const notificationsColRef = collection(
            appState.db,
            `artifacts/${appId}/users/${appState.userId}/notifications`
          );
          const notificationsQuery = query(
            notificationsColRef,
            orderBy("createdAt", "desc")
          );
          appState.notificationsUnsubscribe = onSnapshot(
            notificationsQuery,
            (snapshot) => {
              appState.notifications = snapshot.docs.map((doc) => ({
                id: doc.id,
                ...doc.data(),
              }));
              appState.unreadNotificationCount = appState.notifications.filter(
                (n) => !n.read
              ).length;
              if (appState.view === "notifications") {
                renderNotificationsPage();
              }
              renderHeader(); // Re-render header to update notification count
            },
            (error) => {
              console.error("Error fetching notifications:", error);
            }
          );
        }
      }

      // --- Firebase Initialization and Listeners ---
      document.addEventListener("DOMContentLoaded", async () => {
        elements.header = document.getElementById("app-header");
        elements.sidebar = document.getElementById("app-sidebar");
        elements.mainContent = document.getElementById("main-content");
        elements.aiModalOverlay = document.getElementById("ai-modal-overlay");
        elements.aiModalCloseBtn = document.getElementById(
          "ai-modal-close-btn"
        );

        elements.aiModalCloseBtn.onclick = () => {
          elements.aiModalOverlay.classList.add("hidden");
          elements.aiModalOverlay.classList.remove("opacity-100");
        };

        // IMPORTANT: These have been updated with your provided details
        const defaultAppId = "ielts-mahir-community-forum";
        const defaultFirebaseConfig = {
          apiKey: "AIzaSyAxsd0CnLsh7t7yFy3ZPp6saGD_YpLL1mY",
          authDomain: "ielts-mahir-community-forum.firebaseapp.com",
          projectId: "ielts-mahir-community-forum",
          storageBucket: "ielts-mahir-community-forum.firebase-storage.app", // This will be unused
          messagingSenderId: "1036043607546",
          appId: "1:1036043607546:web:bd217e04cc0ec5f296d843",
          measurementId: "G-YC4CG1WKD3",
        };

        const appId = typeof __app_id !== "undefined" ? __app_id : defaultAppId;
        const firebaseConfig =
          typeof __firebase_config !== "undefined"
            ? JSON.parse(__firebase_config)
            : defaultFirebaseConfig;

        try {
          const app = initializeApp(firebaseConfig);
          appState.db = getFirestore(app);
          appState.auth = getAuth(app);

          // Listen for auth state changes
          onAuthStateChanged(appState.auth, async (user) => {
            if (user) {
              appState.userId = user.uid;
              appState.viewedProfile = user.uid; // Default to current user's profile on auth success

              // Initialize user profile (including new fields for notifications/settings)
              const userRef = doc(
                appState.db,
                `artifacts/${appId}/users/${user.uid}/userProfile/profile`
              );
              const userSnap = await getDoc(userRef);

              let newUserProfileData = {};

              if (userSnap.exists()) {
                newUserProfileData = userSnap.data();
              } else {
                console.warn("User profile not found, creating a default one.");
                // Create default profile for new users
                newUserProfileData = {
                  name: user.displayName || `User-${user.uid.substring(0, 5)}`, // Use display name if available, else default
                  email: user.email || "",
                  bandGoal: "N/A",
                  preparationStatus: "New Learner",
                  reputation: 0,
                  badges: [], // Start with empty badges; 'first_post' checked later
                  createdAt: serverTimestamp(),
                  userId: user.uid,
                  bio: "",
                  country: "",
                  ieltsExperience: "",
                  following: [], // Initialize following list
                  notificationPreferences: {
                    vote: true,
                    reply: true,
                    follow: true,
                    new_post: true, // Default new_post notifications to true for new users
                  },
                  defaultHomeFeed: "latest",
                };
                await setDoc(userRef, newUserProfileData);
              }

              // Set flag if profile needs completion (if name is still default anonymous)
              if (newUserProfileData.name.startsWith("User-")) {
                appState.shouldCompleteProfile = true;
              } else {
                appState.shouldCompleteProfile = false;
              }

              // Ensure 'first_post' badge is awarded if the user has posts but not the badge
              const userPostsQuery = query(
                collection(appState.db, `artifacts/${appId}/public/data/posts`),
                where("authorId", "==", user.uid)
              );
              const userPostsSnap = await getDocs(userPostsQuery);
              if (
                userPostsSnap.docs.length > 0 &&
                !(newUserProfileData.badges || []).includes("first_post")
              ) {
                await updateDoc(userRef, { badges: arrayUnion("first_post") });
                newUserProfileData.badges = [
                  ...(newUserProfileData.badges || []),
                  "first_post",
                ];
              } else if (
                userPostsSnap.docs.length === 0 &&
                (newUserProfileData.badges || []).includes("first_post")
              ) {
                // If user has no posts but has the badge, remove it (edge case, not critical)
                await updateDoc(userRef, {
                  badges: arrayRemove("first_post"),
                });
                newUserProfileData.badges = (
                  newUserProfileData.badges || []
                ).filter((b) => b !== "first_post");
              } else if (
                !(newUserProfileData.badges || []).includes("first_post")
              ) {
                // If user has no posts and no badge, ensure badge is not present by default.
                newUserProfileData.badges = [];
              }

              // Update lastLogin timestamp
              await updateDoc(userRef, { lastLogin: serverTimestamp() });

              appState.userProfile = newUserProfileData; // Set the profile in appState
              appState.isAuthReady = true;
              // ONLY set up Firestore listeners AFTER authentication is ready
              setupFirestoreListeners();
              // After auth, set default home feed based on user's preference
              if (appState.userProfile?.defaultHomeFeed) {
                appState.homeFeedType = appState.userProfile.defaultHomeFeed;
              }
              navigateTo("home"); // Navigate to home after successful authentication
            } else {
              // User is signed out or not yet authenticated
              appState.userId = null;
              appState.userProfile = null; // Clear user profile
              appState.isAuthReady = true; // Auth system is ready, just no user logged in
              appState.shouldCompleteProfile = false; // Reset for new session
              // Unsubscribe all listeners if user logs out
              if (appState.postsUnsubscribe) appState.postsUnsubscribe();
              if (appState.commentsUnsubscribe) appState.commentsUnsubscribe();
              if (appState.notificationsUnsubscribe)
                appState.notificationsUnsubscribe();
              if (appState.userProfileUnsubscribe)
                appState.userProfileUnsubscribe();
              if (appState.allUsersProfilesUnsubscribe)
                appState.allUsersProfilesUnsubscribe();

              navigateTo("auth", { authMode: "login" }); // Always redirect to auth page
            }
          });
        } catch (error) {
          console.error("Error initializing Firebase or signing in:", error);
          showToast(
            "Failed to initialize app. Check console for Firebase configuration and network issues.",
            "error"
          );
          appState.isAuthReady = true; // Ensure UI unblocks even on error
          renderApp();
        }
      });
    </script>
  </body>
</html>
