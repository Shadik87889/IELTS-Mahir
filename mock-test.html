<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IELTS Mahir - Mock Test</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter (for general text) and Anton (for headings) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Anton&family=Inter:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.lordicon.com/lordicon.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css"
    />
    <style id="mock-test-styles">
      /* Distinct styles for the Mock Test system */
      body {
        font-family: "Inter", sans-serif;
        background: linear-gradient(
          135deg,
          #f0f4f8 0%,
          #d9e2ec 100%
        ); /* A subtle, professional blue-gray gradient */
        color: #2d3748; /* Darker text for readability */
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .font-anton {
        font-family: "Anton", sans-serif;
      }
      .font-inter {
        font-family: "Inter", sans-serif;
      }

      /* Specific styles for the mock test page layout */
      .mock-test-layout {
        display: grid;
        grid-template-columns: 1fr; /* Default to single column */
        gap: 1.5rem;
        padding: 1rem; /* Reduced padding for mobile */
      }

      @media (min-width: 768px) {
        /* md breakpoint */
        .mock-test-layout {
          padding: 1.5rem; /* Medium padding for tablet */
        }
      }

      @media (min-width: 1024px) {
        /* lg breakpoint */
        .mock-test-layout {
          grid-template-columns: 3fr 1fr; /* Two columns on large screens */
          padding: 2rem; /* Larger padding for desktop */
        }
      }

      .main-test-content {
        background-color: #ffffff;
        border-radius: 1.5rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        padding: 1.5rem; /* Reduced padding for mobile */
        overflow-y: auto; /* Enable scrolling for test content */
      }

      @media (min-width: 768px) {
        .main-test-content {
          padding: 2rem; /* Standard padding for tablet and desktop */
        }
      }

      .sidebar {
        background-color: #2d3748; /* Dark blue background for sidebar */
        border-radius: 1.5rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        padding: 1.5rem; /* Standard padding */
        color: white;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .question-palette-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
        gap: 0.5rem;
      }

      .question-palette-btn {
        width: 40px;
        height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: all 0.2s ease-in-out;
      }

      .question-palette-btn.answered {
        background-color: #22c55e; /* Green for answered */
        color: white;
      }

      .question-palette-btn.unanswered {
        background-color: #4a5568; /* Darker gray for unanswered */
        color: white;
      }

      .question-palette-btn.current {
        background-color: #3b82f6; /* Blue for current question */
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        border: 2px solid #bfdbfe; /* Light blue border */
      }

      /* Audio Player Wrapper (for fixed position) */
      .audio-player-wrapper {
        position: sticky;
        top: 64px; /* Height of the header (py-4 * 2 + some default height) */
        width: 100%;
        background-color: #f0f4f8; /* Match body background or slightly different */
        padding: 0.75rem 1rem; /* Padding around the audio player */
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        z-index: 900; /* Below header, above main content */
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .audio-player-container {
        background-color: #e2e8f0; /* Light gray background */
        border-radius: 1rem;
        padding: 0.5rem 1rem; /* Adjusted padding */
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 900px; /* Example max-width for audio player */
      }

      .audio-player-container audio {
        width: 100%;
        border-radius: 0.5rem;
      }

      /* Mobile Question Palette Wrapper (fixed at bottom) */
      .mobile-question-palette-wrapper {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: #2d3748; /* Dark background like sidebar */
        color: white;
        box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.2);
        z-index: 950; /* Above main content, below header */
        display: none; /* Hidden by default */
        flex-direction: column;
        border-top-left-radius: 1rem;
        border-top-right-radius: 1rem;
        overflow: hidden; /* For rounded corners and content hiding */
      }

      #mobile-palette-content {
        max-height: 0; /* Initially collapsed */
        opacity: 0;
        transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        overflow-y: hidden; /* Hide scrollbar when collapsed */
      }

      .mobile-question-palette-wrapper.expanded #mobile-palette-content {
        max-height: 50vh; /* Max height when expanded, adjust as needed */
        opacity: 1;
        overflow-y: auto; /* Allow scrolling if content exceeds max-height */
      }

      .question-palette-grid-mobile {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
        gap: 0.5rem;
        padding: 0 1rem 1rem 1rem; /* Padding inside the mobile palette */
      }

      /* Media queries for responsive display */
      @media (max-width: 1023px) {
        /* For screens smaller than lg (desktop) */
        .mobile-question-palette-wrapper {
          display: flex; /* Show on mobile/tablet */
        }
        .sidebar {
          display: none; /* Hide desktop sidebar on mobile/tablet */
        }
        /* Adjust body padding to account for the fixed mobile palette header */
        body {
          padding-bottom: 64px; /* Approximate height of the mobile palette header */
        }
        .mock-test-layout {
          padding-bottom: 2rem; /* Ensure content above mobile palette */
        }
        /* Adjust top for audio player on smaller screens if header height changes */
        .audio-player-wrapper {
          top: 56px; /* Adjust if header is smaller on mobile */
        }
      }

      @media (min-width: 1024px) {
        /* For large screens (desktop) */
        .mobile-question-palette-wrapper {
          display: none; /* Hide mobile palette on desktop */
        }
        .sidebar {
          display: flex; /* Show desktop sidebar */
        }
        body {
          padding-bottom: 0; /* No extra padding needed on desktop */
        }
      }

      .question-section {
        margin-bottom: 2.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px dashed #e2e8f0;
      }

      .question-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }

      .question-group-instructions {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background-color: #f0f4f8; /* Light background for instructions */
        border-left: 4px solid #60a5fa; /* A slightly lighter blue border */
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      .question-group-instructions p {
        margin-bottom: 0.5rem;
        line-height: 1.4;
      }

      .question-group-instructions p:last-child {
        margin-bottom: 0;
      }

      .question-item {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background-color: #f8fafc;
        border-left: 4px solid #3b82f6;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      .question-item label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #2d3748;
      }

      .question-item .inline-question-text {
        display: inline; /* Make the text inline */
        font-size: 1.125rem; /* text-lg */
        font-weight: 600; /* font-semibold */
        color: #2d3748;
      }

      .question-item .inline-input {
        display: inline-block; /* Make the input inline-block */
        width: 120px; /* Adjust width as needed */
        padding: 0.3rem 0.6rem;
        margin: 0 0.5rem; /* Add some horizontal margin */
        border: 1px solid #cbd5e0;
        border-radius: 0.375rem; /* rounded-md */
        font-size: 1rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        vertical-align: middle; /* Align with text */
      }

      .question-item .inline-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      }

      /* New style for inputs on a new line */
      .question-item .block-input {
        display: block;
        width: calc(100% - 1rem); /* Full width minus padding */
        margin: 0.5rem 0.5rem 0 0.5rem; /* Top margin to separate from number/text */
        padding: 0.5rem 1rem; /* Larger padding for block input */
        border: 1px solid #cbd5e0;
        border-radius: 0.375rem;
        font-size: 1rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      .question-item .block-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      }

      /* Table specific styles */
      .table-responsive-wrapper {
        overflow-x: auto; /* Enable horizontal scrolling for table on small screens */
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
      }

      .question-item .table-input {
        width: 100%; /* Make input fill the table cell */
        padding: 0.3rem 0.6rem;
        border: 1px solid #cbd5e0;
        border-radius: 0.375rem;
        font-size: 1rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      .question-item .table-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      }

      .question-item table {
        width: 100%;
        min-width: 600px; /* Ensure table has a minimum width to trigger scroll if needed */
        border-collapse: collapse;
        margin-top: 1rem;
      }

      .question-item th,
      .question-item td {
        border: 1px solid #e2e8f0; /* Light border for table cells */
        padding: 0.75rem;
        text-align: left;
      }

      .question-item th {
        background-color: #f0f4f8; /* Light background for table headers */
        font-weight: 600;
        color: #2d3748;
      }

      .question-item input[type="radio"] {
        margin-right: 0.75rem;
        transform: scale(1.2);
      }

      .question-item .radio-option {
        display: flex;
        align-items: center;
        margin-bottom: 0.75rem;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 0.5rem;
        transition: background-color 0.2s ease;
      }

      .question-item .radio-option:hover {
        background-color: #eff6ff; /* Light blue on hover */
      }

      .question-item .radio-option input[type="radio"]:checked + span {
        font-weight: 600;
        color: #3b82f6;
      }

      .map-image-container {
        width: 100%;
        max-width: 600px;
        margin: 1.5rem auto;
        border-radius: 1rem;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .map-image-container img {
        width: 100%;
        height: auto;
        display: block;
      }

      .user-id-display {
        background-color: rgba(255, 255, 255, 0.7);
        border: 1px solid #d1d5db;
        color: #4b5563;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        backdrop-filter: blur(3px);
      }

      /* Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }

      .modal-overlay.visible {
        opacity: 1;
        visibility: visible;
      }

      .modal-content {
        background-color: #ffffff;
        padding: 2rem;
        border-radius: 1rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        max-width: 500px;
        width: 90%;
        text-align: center;
        transform: translateY(-20px);
        opacity: 0;
        transition: transform 0.3s ease, opacity 0.3s ease;
      }

      .modal-overlay.visible .modal-content {
        transform: translateY(0);
        opacity: 1;
      }

      .modal-header {
        font-size: 1.75rem; /* text-2xl */
        font-weight: 700; /* font-bold */
        color: #2d3748;
        margin-bottom: 1rem;
      }

      .modal-body {
        font-size: 1rem; /* text-base */
        color: #4a5568;
        margin-bottom: 1.5rem;
      }

      .modal-buttons {
        display: flex;
        justify-content: center;
        gap: 1rem;
      }

      .modal-button {
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: background-color 0.2s ease, transform 0.1s ease;
      }

      .modal-button.primary {
        background-color: #3b82f6; /* blue-500 */
        color: white;
      }

      .modal-button.primary:hover {
        background-color: #2563eb; /* blue-600 */
        transform: translateY(-1px);
      }

      .modal-button.secondary {
        background-color: #e2e8f0; /* gray-200 */
        color: #4a5568;
      }

      .modal-button.secondary:hover {
        background-color: #cbd5e0; /* gray-300 */
        transform: translateY(-1px);
      }
      #app-header {
        background-color: #ffffff; /* White background for header */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* Styles for results page elements (copied from mock-test-results.html) */
      .results-card {
        background: linear-gradient(
          145deg,
          #ffffff 0%,
          #f8faff 100%
        ); /* Subtle gradient for cards */
        border: 1px solid #e2e8f0; /* Light border */
        border-radius: 1.5rem; /* More rounded corners */
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08),
          0 4px 10px rgba(0, 0, 0, 0.05); /* Enhanced soft shadow */
        transition: all 0.3s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-fade-in {
        animation: fadeIn 0.5s ease-out forwards;
      }

      .animate-fade-in-up {
        animation: fadeInUp 0.6s ease-out forwards;
      }

      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #555;
      }

      .feedback-section .correct-answer {
        color: #16a34a; /* green-600 */
        font-weight: bold;
      }

      .feedback-section .incorrect-answer {
        color: #dc2626; /* red-600 */
        font-weight: bold;
      }

      .feedback-section .explanation {
        background-color: #f0f9ff; /* blue-50 */
        border-left: 4px solid #3b82f6; /* blue-500 */
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        margin-top: 0.5rem;
        font-style: italic;
        color: #475569; /* slate-600 */
      }

      .leaderboard-table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 0.75rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      }

      .leaderboard-table {
        min-width: 600px;
        width: 100%;
        border-collapse: collapse;
      }

      .leaderboard-table th,
      .leaderboard-table td {
        padding: 1rem 1.5rem;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
      }

      .leaderboard-table th {
        background-color: #f8fafc;
        font-weight: 700;
        color: #475569;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.05em;
      }

      .leaderboard-table tbody tr:last-child td {
        border-bottom: none;
      }

      .leaderboard-table tbody tr:hover {
        background-color: #f0f9ff;
      }

      .leaderboard-table tbody tr.current-user-row {
        background-color: #e0f2fe;
        font-weight: 600;
        color: #1e40af;
      }

      .leaderboard-table tbody tr.current-user-row:hover {
        background-color: #bfdbfe;
      }

      .rank-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        font-weight: bold;
        font-size: 0.875rem;
        color: white;
        margin-right: 0.5rem;
      }

      .rank-1 {
        background: linear-gradient(
          45deg,
          #ffbf00,
          #f7dc6f
        ); /* Gold gradient */
        box-shadow: 0 2px 6px rgba(255, 191, 0, 0.4);
      }
      .rank-2 {
        background: linear-gradient(
          45deg,
          #a7a7ad,
          #d4d4d8
        ); /* Silver gradient */
        box-shadow: 0 2px 6px rgba(167, 167, 173, 0.4);
      }
      .rank-3 {
        background: linear-gradient(
          45deg,
          #cd7f32,
          #e6a25b
        ); /* Bronze gradient */
        box-shadow: 0 2px 6px rgba(205, 127, 50, 0.4);
      }
      .rank-common {
        background-color: #94a3b8; /* Slate 400 */
        box-shadow: 0 2px 4px rgba(148, 163, 184, 0.4);
      }
    </style>
  </head>
  <body class="py-0 px-0">
    <!-- Header / Navigation Bar (Can be shared with quiz system) -->
    <header
      id="app-header"
      class="site-header py-4 px-4 md:px-8 flex items-center justify-between transition-colors duration-300 sticky top-0 z-50"
    >
      <div class="flex items-center gap-2 sm:gap-4">
        <img
          src="assets/278115481_106536582034386_7446598694214552893_n-removebg-preview.png"
          alt="IELTS Mahir Logo"
          class="h-8 md:h-10 w-auto"
          onerror="this.onerror=null; this.src='https://placehold.co/100x40/E0E0E0/333333?text=Logo';"
        />
        <nav class="hidden md:flex gap-6 ml-8 font-inter">
          <a href="quiz-home.html" class="nav-link transition-all"
            >Quiz System</a
          >
          <a href="mock-test-home.html" class="nav-link transition-all"
            >Mock Tests</a
          >
          <a href="#" class="nav-link transition-all">Resources</a>
        </nav>
      </div>
      <div id="auth-buttons-container" class="flex items-center gap-2 sm:gap-4">
        <!-- Authentication status will be handled by auth.js -->
        <div class="animate-pulse flex space-x-4">
          <div class="rounded-full bg-gray-300 h-8 w-8 sm:h-10 sm:w-10"></div>
          <div class="flex-1 space-y-4 py-1 hidden sm:block">
            <div class="h-2 bg-gray-300 rounded"></div>
            <div class="space-y-2">
              <div class="grid grid-cols-3 gap-2">
                <div class="h-2 bg-gray-300 rounded col-span-2"></div>
                <div class="h-2 bg-gray-300 rounded col-span-1"></div>
              </div>
              <div class="h-2 bg-gray-300 rounded"></div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Audio Player (fixed/sticky at top) -->
    <div id="fixed-audio-player-wrapper" class="audio-player-wrapper">
      <div class="audio-player-container">
        <audio id="test-audio-player" controls preload="auto" class="w-full">
          <source src="" type="audio/mpeg" />
          <!-- Audio URL will be set by JS -->
          Your browser does not support the audio element.
        </audio>
      </div>
    </div>

    <!-- Removed container mx-auto from #app to allow mock-test-layout to control full width and padding -->
    <div id="app" class="flex-grow">
      <!-- Application content will be rendered here by JavaScript -->
      <div class="flex justify-center items-center h-full">
        <div
          class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"
        ></div>
      </div>
    </div>

    <!-- Mobile Fixed Question Palette (fixed at bottom) -->
    <div
      id="mobile-question-palette-wrapper"
      class="mobile-question-palette-wrapper"
    >
      <div
        id="mobile-palette-header"
        class="flex justify-between items-center px-4 py-3 bg-gray-800 text-white rounded-t-lg shadow-lg cursor-pointer"
      >
        <div class="flex items-center gap-2 text-xl font-bold">
          <i class="fas fa-th-large"></i>
          <span>Question Palette</span>
        </div>
        <div class="flex items-center gap-2 text-xl font-bold">
          <i class="fas fa-clock"></i>
          <span id="timer-display-mobile">00:00</span>
          <i
            id="palette-toggle-icon"
            class="ph ph-caret-down text-2xl ml-2"
          ></i>
          <!-- Toggle icon -->
        </div>
      </div>
      <div id="mobile-palette-content">
        <!-- This will be toggled -->
        <div
          class="question-palette-grid-mobile"
          id="question-palette-mobile"
        ></div>
      </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-[100]"></div>

    <!-- Modal Container -->
    <div id="modal-container" class="modal-overlay">
      <div class="modal-content">
        <h3 id="modal-title" class="modal-header"></h3>
        <p id="modal-message" class="modal-body"></p>
        <div id="modal-buttons" class="modal-buttons"></div>
      </div>
    </div>

    <script type="module">
      // Import authentication functions and state from the central auth.js file
      import {
        initFirebaseAuth,
        authAppState,
        showToast,
        Icons,
        signOutUser,
      } from "./auth.js"; // Adjust path as necessary

      // Import mock test data
      import {
        MockTestModules,
        allMockTests,
        MockTestIcons,
        formatTime,
      } from "./mock-test-data.js";

      // Firebase imports for Firestore
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        updateDoc,
        collection,
        addDoc,
        serverTimestamp,
        query,
        where,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // Firebase instances (will be populated by auth.js)
      let db;
      let auth;

      // Current module and test IDs from URL
      let currentModuleId = null;
      let currentTestId = null;
      let currentTest = null;
      let totalQuestions = 0; // This will now represent total answerable slots

      // Test state encapsulated in an object
      let testState = {
        userAnswers: {}, // { questionId: userAnswer } (e.g., "mcq1", "q26")
        timerInterval: null,
        timeLeft: 0, // In seconds
        currentQuestionIndex: 0, // 0-based index for the questionPaletteItems array
        testCompleted: false, // New state to control view
        userResultDoc: null, // Stores the fetched user result for display
        leaderboard: [], // Stores leaderboard data
        userRank: null, // User's rank on the leaderboard
        isLoadingResults: false, // For loading state of results section
      };

      // New: Array to map palette numbers to question IDs and their HTML element IDs
      let questionPaletteItems = []; // Stores { paletteNumber: N, questionId: "qX" or "mcqY", htmlElementId: "question-Z" }

      /**
       * Displays a custom modal.
       * @param {string} title - The title of the modal.
       * @param {string} message - The message content of the modal.
       * @param {boolean} showConfirmButton - Whether to show a confirm button.
       * @param {function} onConfirm - Callback function for confirm button.
       * @param {function} onCancel - Callback function for cancel button.
       */
      function showModal(
        title,
        message,
        showConfirmButton,
        onConfirm,
        onCancel
      ) {
        const modalOverlay = document.getElementById("modal-container");
        const modalTitle = document.getElementById("modal-title");
        const modalMessage = document.getElementById("modal-message");
        const modalButtons = document.getElementById("modal-buttons");

        if (!modalOverlay || !modalTitle || !modalMessage || !modalButtons) {
          console.error("Modal elements not found.");
          return;
        }

        modalTitle.innerHTML = title;
        modalMessage.innerHTML = message;
        modalButtons.innerHTML = ""; // Clear existing buttons

        if (showConfirmButton) {
          const confirmButton = document.createElement("button");
          confirmButton.textContent = "Confirm";
          confirmButton.classList.add("modal-button", "primary");
          confirmButton.addEventListener("click", () => {
            hideModal();
            if (onConfirm) onConfirm();
          });
          modalButtons.appendChild(confirmButton);

          const cancelButton = document.createElement("button");
          cancelButton.textContent = "Cancel";
          cancelButton.classList.add("modal-button", "secondary");
          cancelButton.addEventListener("click", () => {
            hideModal();
            if (onCancel) onCancel();
          });
          modalButtons.appendChild(cancelButton);
        } else {
          // For informational modals, just show an OK button or no buttons
          const okButton = document.createElement("button");
          okButton.textContent = "OK";
          okButton.classList.add("modal-button", "primary");
          okButton.addEventListener("click", () => {
            hideModal();
            if (onConfirm) onConfirm(); // Use onConfirm as a general callback for OK
          });
          modalButtons.appendChild(okButton);
        }

        modalOverlay.classList.add("visible");
      }

      /**
       * Hides the custom modal.
       */
      function hideModal() {
        const modalOverlay = document.getElementById("modal-container");
        if (modalOverlay) {
          modalOverlay.classList.remove("visible");
        }
      }

      /**
       * Updates the navigation bar and user ID display based on authentication status.
       * @param {object|null} user - The Firebase User object or null if signed out.
       */
      async function updateAuthUI(user) {
        const authButtonsContainer = document.getElementById(
          "auth-buttons-container"
        );
        if (authButtonsContainer) {
          if (user) {
            // User is signed in: Show profile dropdown
            authButtonsContainer.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="relative">
                                <button id="profile-icon-btn" class="flex items-center justify-center w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-blue-600 text-white text-lg sm:text-xl font-bold shadow-md hover:bg-blue-700 transition-colors">
                                    ${(
                                      authAppState.userProfile?.name ||
                                      user.email ||
                                      user.uid
                                    )
                                      .charAt(0)
                                      .toUpperCase()}
                                </button>
                                <div id="profile-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl py-2 z-50 hidden text-gray-800">
                                    <div class="px-4 py-2 text-sm border-b border-gray-200">Hello, ${
                                      authAppState.userProfile?.name ||
                                      user.email ||
                                      user.uid.substring(0, 8)
                                    }</div>
                                    <a href="dashboard.html" class="flex items-center gap-2 px-4 py-2 hover:bg-gray-100">
                                        ${Icons.Dashboard.replace(
                                          /stroke="currentColor"/g,
                                          'stroke="gray"'
                                        )} Dashboard
                                    </a>
                                    <a href="ielts-mahir-community-forum.html" class="flex items-center gap-2 px-4 py-2 hover:bg-gray-100">
                                        ${Icons.Forum.replace(
                                          /stroke="currentColor"/g,
                                          'stroke="gray"'
                                        )} Forum
                                    </a>
                                    <button id="sign-out-dropdown-btn" class="flex items-center gap-2 w-full text-left px-4 py-2 text-red-600 hover:bg-red-100 rounded-b-lg">
                                        ${Icons.SignOut.replace(
                                          /stroke="currentColor"/g,
                                          'stroke="red"'
                                        )} Sign Out
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;

            const profileIconBtn = document.getElementById("profile-icon-btn");
            const profileDropdown = document.getElementById("profile-dropdown");
            const signOutDropdownBtn = document.getElementById(
              "sign-out-dropdown-btn"
            );

            profileIconBtn.addEventListener("click", (event) => {
              event.stopPropagation();
              profileDropdown.classList.toggle("hidden");
            });

            document.addEventListener("click", (event) => {
              if (
                !profileDropdown.contains(event.target) &&
                !profileIconBtn.contains(event.target)
              ) {
                profileDropdown.classList.add("hidden");
              }
            });

            signOutDropdownBtn.addEventListener("click", async () => {
              await signOutUser();
              // Redirect will happen via onAuthStateChanged in auth.js
            });
          } else {
            // User is signed out: Show sign-in button
            authButtonsContainer.innerHTML = `
                        <a href="auth.html" id="sign-in-nav-btn" class="px-4 py-2 bg-blue-600 text-white rounded-full shadow-md hover:bg-blue-700 transition-all text-sm font-semibold transform active:scale-95">
                            Join beta user
                        </a>
                    `;
          }
        }
      }

      /**
       * Calculates the IELTS band score based on the number of correct answers.
       * This is a simplified mapping and may not perfectly reflect official IELTS scoring.
       * @param {number} correctAnswersCount - The number of correct answers.
       * @param {number} totalQuestions - The total number of answerable questions/slots.
       * @returns {number|string} The calculated band score (e.g., 7.5) or "N/A" if totalQuestions is 0.
       */
      function calculateIELTSBandScore(correctAnswersCount, totalQuestions) {
        if (totalQuestions === 0) return "N/A";

        // This mapping is a simplified approximation for a 40-question test.
        // If your mock tests have a different number of total questions,
        // you might need to scale correctAnswersCount to a 40-question equivalent
        // or adjust the thresholds based on percentage.
        // For simplicity, let's assume this mapping is for a scaled score or direct 40-question count.
        // For varying totalQuestions, a percentage-based approach is more robust.
        const percentage = (correctAnswersCount / totalQuestions) * 100;

        if (percentage >= 90) return 9.0; // 36-40 correct (out of 40)
        if (percentage >= 85) return 8.5; // 34-35 correct
        if (percentage >= 80) return 8.0; // 32-33 correct
        if (percentage >= 75) return 7.5; // 30-31 correct
        if (percentage >= 70) return 7.0; // 28-29 correct
        if (percentage >= 65) return 6.5; // 26-27 correct
        if (percentage >= 60) return 6.0; // 24-25 correct
        if (percentage >= 55) return 5.5; // 22-23 correct
        if (percentage >= 50) return 5.0; // 20-21 correct
        if (percentage >= 45) return 4.5; // 18-19 correct
        if (percentage >= 40) return 4.0; // 16-17 correct
        if (percentage >= 35) return 3.5; // 14-15 correct
        if (percentage >= 30) return 3.0; // 12-13 correct
        if (percentage >= 25) return 2.5; // 10-11 correct
        if (percentage >= 20) return 2.0; // 8-9 correct
        if (percentage >= 15) return 1.5; // 6-7 correct
        if (percentage >= 10) return 1.0; // 4-5 correct
        return 0; // Less than 10% or 4 correct
      }

      /**
       * Handles user answer input.
       * @param {string} questionId - The ID of the question (e.g., "mcq1", "q26").
       * @param {string} answer - The user's answer.
       */
      function handleAnswerInput(questionId, answer) {
        testState.userAnswers[questionId] = answer.trim();
        updateQuestionPalette();
      }

      /**
       * Updates the question palette to reflect answered/unanswered questions.
       */
      function updateQuestionPalette() {
        questionPaletteItems.forEach((item) => {
          // Update desktop palette
          const desktopButton = document.querySelector(
            `#question-palette-desktop .question-palette-btn[data-palette-number="${item.paletteNumber}"]`
          );
          if (desktopButton) {
            const userAnswer = testState.userAnswers[item.questionId];
            if (userAnswer && userAnswer !== "") {
              desktopButton.classList.remove("unanswered");
              desktopButton.classList.add("answered");
            } else {
              desktopButton.classList.remove("answered");
              desktopButton.classList.add("unanswered");
            }
          }

          // Update mobile palette
          const mobileButton = document.querySelector(
            `#question-palette-mobile .question-palette-btn[data-palette-number="${item.paletteNumber}"]`
          );
          if (mobileButton) {
            const userAnswer = testState.userAnswers[item.questionId];
            if (userAnswer && userAnswer !== "") {
              mobileButton.classList.remove("unanswered");
              mobileButton.classList.add("answered");
            } else {
              mobileButton.classList.remove("answered");
              mobileButton.classList.add("unanswered");
            }
          }
        });
        highlightCurrentQuestionInPalette();
      }

      /**
       * Highlights the current question in the palette.
       */
      function highlightCurrentQuestionInPalette() {
        const desktopPaletteButtons = document.querySelectorAll(
          "#question-palette-desktop .question-palette-btn"
        );
        desktopPaletteButtons.forEach((button) => {
          button.classList.remove("current");
        });

        const mobilePaletteButtons = document.querySelectorAll(
          "#question-palette-mobile .question-palette-btn"
        );
        mobilePaletteButtons.forEach((button) => {
          button.classList.remove("current");
        });

        if (questionPaletteItems.length > 0) {
          const currentPaletteNumber = testState.currentQuestionIndex + 1;
          const currentDesktopQBtn = document.querySelector(
            `#question-palette-desktop .question-palette-btn[data-palette-number="${currentPaletteNumber}"]`
          );
          if (currentDesktopQBtn) {
            currentDesktopQBtn.classList.add("current");
          }
          const currentMobileQBtn = document.querySelector(
            `#question-palette-mobile .question-palette-btn[data-palette-number="${currentPaletteNumber}"]`
          );
          if (currentMobileQBtn) {
            currentMobileQBtn.classList.add("current");
          }
        }
      }

      /**
       * Scrolls to a specific question based on its palette number.
       * @param {number} paletteNumber - The 1-based number of the question in the palette.
       */
      function scrollToQuestion(paletteNumber) {
        const item = questionPaletteItems.find(
          (i) => i.paletteNumber === paletteNumber
        );
        if (item) {
          const questionElement = document.getElementById(item.htmlElementId);
          if (questionElement) {
            questionElement.scrollIntoView({
              behavior: "smooth",
              block: "start",
            });
            testState.currentQuestionIndex = paletteNumber - 1; // Update current index (0-based)
            highlightCurrentQuestionInPalette();
          }
        }
      }

      /**
       * Starts the test timer.
       */
      function startTimer() {
        if (testState.timerInterval) clearInterval(testState.timerInterval); // Clear any existing timer

        const desktopTimerDisplay = document.getElementById(
          "timer-display-desktop"
        );
        const mobileTimerDisplay = document.getElementById(
          "timer-display-mobile"
        );

        testState.timerInterval = setInterval(() => {
          testState.timeLeft--;
          if (testState.timeLeft >= 0) {
            const formattedTime = formatTime(testState.timeLeft);
            if (desktopTimerDisplay)
              desktopTimerDisplay.textContent = formattedTime;
            if (mobileTimerDisplay)
              mobileTimerDisplay.textContent = formattedTime;
          } else {
            clearInterval(testState.timerInterval);
            if (desktopTimerDisplay) desktopTimerDisplay.textContent = "00:00";
            if (mobileTimerDisplay) mobileTimerDisplay.textContent = "00:00";
            showToast("Time's up! Your test has been submitted.", "info");
            handleSubmitTest(); // Automatically submit when time runs out
          }
        }, 1000);
      }

      /**
       * Saves the mock test result to Firestore.
       * @param {number} correctAnswers - Number of correct answers.
       * @param {number} totalQuestions - Total number of questions/answerable slots.
       * @param {number|string} bandScore - Calculated IELTS band score.
       * @param {number} timeTakenSeconds - Time taken in seconds.
       */
      async function saveMockTestResultToFirestore(
        correctAnswers,
        totalQuestions,
        bandScore,
        timeTakenSeconds
      ) {
        if (!db || !authAppState.userId) {
          showToast(
            "Not logged in. Mock test results will not be saved.",
            "warning"
          );
          return;
        }

        const appId =
          typeof __app_id !== "undefined" ? __app_id : "default-app-id";
        const userId = authAppState.userId;
        const userEmail = authAppState.user?.email || "Anonymous";
        const userName =
          authAppState.userProfile?.name || userEmail.split("@")[0];

        const resultData = {
          userId: userId,
          userName: userName,
          userEmail: userEmail,
          moduleId: currentModuleId,
          testId: currentTestId,
          testTitle: currentTest.title,
          correctAnswers: correctAnswers,
          totalQuestions: totalQuestions,
          bandScore: bandScore,
          timeTakenSeconds: timeTakenSeconds,
          timestamp: serverTimestamp(),
          userAnswers: testState.userAnswers, // Save user answers for potential future review
        };

        try {
          // Save to private user results collection
          const privateDocRef = await addDoc(
            collection(
              db,
              `artifacts/${appId}/users/${userId}/mockTestResults`
            ),
            resultData
          );
          console.log("Mock test result saved to private collection.");
          testState.userResultDoc = { id: privateDocRef.id, ...resultData }; // Store the saved document

          // Save to public global results collection for leaderboard
          await addDoc(
            collection(
              db,
              `artifacts/${appId}/public/data/mockTestGlobalResults`
            ),
            resultData
          );
          console.log("Mock test result saved to public collection.");
          showToast("Mock test results saved successfully!", "success");
        } catch (error) {
          console.error("Error saving mock test result:", error);
          showToast("Failed to save mock test results.", "error");
        }
      }

      /**
       * Fetches the user's specific mock test result from Firestore.
       * @param {string} userId - The ID of the current user.
       * @param {string} testId - The ID of the test.
       * @returns {Promise<object|null>} The result document data or null if not found.
       */
      async function fetchUserMockTestResult(userId, testId) {
        if (!db || !userId || !testId) return null;
        const appId =
          typeof __app_id !== "undefined" ? __app_id : "default-app-id";
        const resultsRef = collection(
          db,
          `artifacts/${appId}/users/${userId}/mockTestResults`
        );
        const q = query(
          resultsRef,
          where("testId", "==", testId),
          where("userId", "==", userId)
        );

        try {
          const querySnapshot = await getDocs(q);
          if (!querySnapshot.empty) {
            let latestResult = null;
            let latestTimestamp = 0;
            querySnapshot.forEach((docSnap) => {
              const data = docSnap.data();
              const timestamp = data.timestamp ? data.timestamp.toMillis() : 0;
              if (timestamp > latestTimestamp) {
                latestTimestamp = timestamp;
                latestResult = { id: docSnap.id, ...data };
              }
            });
            return latestResult;
          }
          return null;
        } catch (error) {
          console.error("Error fetching user mock test result:", error);
          showToast("Failed to load your test results.", "error");
          return null;
        }
      }

      /**
       * Fetches and updates the leaderboard for the current mock test.
       */
      async function fetchLeaderboard() {
        if (!db || !currentTestId) return; // Use currentTestId from global scope
        const appId =
          typeof __app_id !== "undefined" ? __app_id : "default-app-id";
        const leaderboardRef = collection(
          db,
          `artifacts/${appId}/public/data/mockTestGlobalResults`
        );
        const q = query(leaderboardRef, where("testId", "==", currentTestId));

        try {
          const querySnapshot = await getDocs(q);
          let rawResults = [];
          querySnapshot.forEach((doc) => {
            rawResults.push(doc.data());
          });

          // Deduplicate results by userId, keeping the best score (highest band, then lowest time)
          const bestResultsMap = new Map(); // Map<userId, bestResult>
          rawResults.forEach((result) => {
            const currentBand = parseFloat(result.bandScore) || 0;
            const existingBest = bestResultsMap.get(result.userId);
            const existingBand = existingBest
              ? parseFloat(existingBest.bandScore) || 0
              : -1;

            if (
              !existingBest ||
              currentBand > existingBand ||
              (currentBand === existingBand &&
                result.timeTakenSeconds < (existingBest.timeTakenSeconds || 0))
            ) {
              bestResultsMap.set(result.userId, result);
            }
          });

          let leaderboard = Array.from(bestResultsMap.values());

          // Sort in memory: highest band score first, then lowest time taken
          leaderboard.sort((a, b) => {
            const aBand = parseFloat(a.bandScore) || 0;
            const bBand = parseFloat(b.bandScore) || 0;
            const aTime = parseFloat(a.timeTakenSeconds) || 0;
            const bTime = parseFloat(b.timeTakenSeconds) || 0;

            if (bBand !== aBand) {
              return bBand - aBand; // Higher band score first
            }
            return aTime - bTime; // Lower time taken first
          });

          testState.leaderboard = leaderboard.slice(0, 10); // Get top 10

          // Find user's rank
          if (authAppState.userId) {
            const userEntry = leaderboard.find(
              (entry) => entry.userId === authAppState.userId
            );
            if (userEntry) {
              testState.userRank = leaderboard.indexOf(userEntry) + 1;
            } else {
              testState.userRank = null; // User not on leaderboard
            }
          } else {
            testState.userRank = null;
          }

          console.log("Leaderboard fetched:", testState.leaderboard);
        } catch (error) {
          console.error("Error fetching leaderboard:", error);
          showToast("Failed to load leaderboard.", "error");
        }
      }

      /**
       * Calculates the score and updates user stats.
       */
      async function handleSubmitTest() {
        clearInterval(testState.timerInterval); // Stop the timer

        // Show a loading modal
        showModal("Submitting Test", "Calculating your score...", false);

        let correctAnswersCount = 0;

        currentTest.sections.forEach((section) => {
          section.questionGroups.forEach((qGroup) => {
            qGroup.questions.forEach((question) => {
              if (question.type === "mcq") {
                const userAnswer = testState.userAnswers[question.id];
                const correctAnswer = question.correctAnswer;
                if (userAnswer === correctAnswer) {
                  correctAnswersCount++;
                }
              } else if (
                question.type === "fill_in_the_blank" ||
                question.type === "map_labeling"
              ) {
                const userAnswer = testState.userAnswers[question.id];
                const correctAnswer = question.correctAnswer;
                // Case-insensitive and trim whitespace comparison
                if (
                  userAnswer &&
                  correctAnswer &&
                  userAnswer.toLowerCase() === correctAnswer.toLowerCase()
                ) {
                  correctAnswersCount++;
                }
              } else if (question.type === "table_fill_in_the_blank") {
                // For table questions, iterate through sub-questions defined in correctAnswer object
                for (const subQuestionId in question.correctAnswer) {
                  const userAnswer = testState.userAnswers[subQuestionId];
                  const correctAnswer = question.correctAnswer[subQuestionId];
                  if (
                    userAnswer &&
                    correctAnswer &&
                    userAnswer.toLowerCase() === correctAnswer.toLowerCase()
                  ) {
                    correctAnswersCount++;
                  }
                }
              }
            });
          });
        });

        const bandScore = calculateIELTSBandScore(
          correctAnswersCount,
          totalQuestions
        );
        const timeTakenSeconds = currentTest.duration * 60 - testState.timeLeft;

        // Save result to Firestore and update testState.userResultDoc
        await saveMockTestResultToFirestore(
          correctAnswersCount,
          totalQuestions,
          bandScore,
          timeTakenSeconds
        );

        // Fetch leaderboard after saving the user's result
        await fetchLeaderboard();

        // Update test state to show results
        testState.testCompleted = true;
        testState.isLoadingResults = false; // Ensure loading is off

        hideModal(); // Hide the submission modal
        renderApp(); // Re-render the app to show results
      }

      /**
       * Renders the mock test feedback section.
       * This function is now part of mock-test.html
       * @param {HTMLElement} parentDiv - The div to render the feedback into.
       */
      function renderMockTestFeedbackSection(parentDiv) {
        if (!currentTest || !testState.userResultDoc) {
          parentDiv.innerHTML =
            "<p class='text-center text-red-500'>No results data available. Please complete a mock test first.</p>";
          return;
        }

        const {
          testTitle,
          correctAnswers,
          totalQuestions,
          bandScore,
          timeTakenSeconds,
          userAnswers,
        } = testState.userResultDoc;

        const percentage =
          totalQuestions > 0
            ? ((correctAnswers / totalQuestions) * 100).toFixed(2)
            : 0;
        const formattedTimeTaken = formatTime(timeTakenSeconds);

        // Determine strengths and areas for improvement (simplified logic)
        const strengths = [];
        const areasForImprovement = [];
        if (bandScore >= 7.0) strengths.push("Excellent overall performance!");
        if (correctAnswers / totalQuestions > 0.7)
          strengths.push("Strong grasp of concepts.");
        if (correctAnswers / totalQuestions < 0.6)
          areasForImprovement.push("Review core concepts for improvement.");
        if (timeTakenSeconds > currentTest.duration * 60 * 0.8)
          areasForImprovement.push("Work on time management to finish faster.");

        parentDiv.innerHTML = `
                <div class="max-w-4xl mx-auto results-card p-6 sm:p-8 rounded-2xl shadow-xl animate-fade-in-up">
                    <h2 class="text-3xl sm:text-4xl font-extrabold text-center text-blue-700 mb-6">
                        Mock Test Results: ${testTitle}
                    </h2>

                    <!-- Overall Performance Summary -->
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg mb-8 shadow-md">
                        <h3 class="text-xl sm:text-2xl font-bold text-blue-800 mb-3 flex items-center gap-2">
                            ${MockTestIcons.ChartBar.replace(
                              /width="24" height="24"/g,
                              'width="24" height="24" class="w-6 h-6 text-blue-600"'
                            )} Overall Performance
                        </h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-gray-700">
                            <p><strong>Correct Answers:</strong> ${correctAnswers} / ${totalQuestions}</p>
                            <p><strong>Percentage:</strong> ${percentage}%</p>
                            <p><strong>IELTS Band Score:</strong> <span class="font-bold text-green-600 text-2xl">${bandScore}</span></p>
                            <p><strong>Time Taken:</strong> ${formattedTimeTaken}</p>
                        </div>
                    </div>

                    <!-- Strengths and Areas for Improvement -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-lg shadow-md">
                            <h3 class="text-xl font-bold text-green-800 mb-3 flex items-center gap-2">
                                ${MockTestIcons.ThumbsUp.replace(
                                  /width="24" height="24"/g,
                                  'width="24" height="24" class="w-6 h-6 text-green-600"'
                                )} Strengths
                            </h3>
                            <ul class="list-disc pl-5 text-gray-700">
                                ${
                                  strengths.length > 0
                                    ? strengths
                                        .map((s) => `<li>${s}</li>`)
                                        .join("")
                                    : "<li>No specific strengths identified for this test.</li>"
                                }
                            </ul>
                        </div>
                        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg shadow-md">
                            <h3 class="text-xl font-bold text-red-800 mb-3 flex items-center gap-2">
                                ${MockTestIcons.Warning.replace(
                                  /width="24" height="24"/g,
                                  'width="24" height="24" class="w-6 h-6 text-red-600"'
                                )} Areas for Improvement
                            </h3>
                            <ul class="list-disc pl-5 text-gray-700">
                                ${
                                  areasForImprovement.length > 0
                                    ? areasForImprovement
                                        .map((a) => `<li>${a}</li>`)
                                        .join("")
                                    : "<li>Keep up the great work!</li>"
                                }
                            </ul>
                        </div>
                    </div>

                    <!-- Question-by-Question Review -->
                    <div class="mb-8">
                        <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            ${MockTestIcons.Review.replace(
                              /width="24" height="24"/g,
                              'width="24" height="24" class="w-6 h-6 text-gray-600"'
                            )} Question Review
                        </h3>
                        <div class="space-y-6 custom-scrollbar max-h-96 overflow-y-auto pr-2">
                            ${currentTest.sections
                              .map((section) =>
                                section.questionGroups
                                  .map((qGroup) =>
                                    qGroup.questions
                                      .map((question) => {
                                        let userAnswerDisplay = "N/A";
                                        let correctAnswerDisplay = "N/A";
                                        let isCorrect = false;

                                        // Determine user's answer and correct answer for display
                                        if (question.type === "mcq") {
                                          userAnswerDisplay =
                                            userAnswers[question.id] ||
                                            "Unattempted";
                                          correctAnswerDisplay =
                                            question.correctAnswer;
                                          isCorrect =
                                            userAnswerDisplay ===
                                            correctAnswerDisplay;
                                        } else if (
                                          question.type ===
                                            "fill_in_the_blank" ||
                                          question.type === "map_labeling"
                                        ) {
                                          userAnswerDisplay =
                                            userAnswers[question.id] ||
                                            "Unattempted";
                                          correctAnswerDisplay =
                                            question.correctAnswer;
                                          isCorrect =
                                            userAnswerDisplay.toLowerCase() ===
                                            correctAnswerDisplay.toLowerCase();
                                        } else if (
                                          question.type ===
                                          "table_fill_in_the_blank"
                                        ) {
                                          // For table questions, display each sub-question
                                          return Object.keys(
                                            question.correctAnswer
                                          )
                                            .map((subQuestionId) => {
                                              const subUserAnswer =
                                                userAnswers[subQuestionId] ||
                                                "Unattempted";
                                              const subCorrectAnswer =
                                                question.correctAnswer[
                                                  subQuestionId
                                                ];
                                              const subIsCorrect =
                                                subUserAnswer.toLowerCase() ===
                                                subCorrectAnswer.toLowerCase();

                                              return `
                                                <div class="p-4 rounded-lg shadow-sm border ${
                                                  subIsCorrect
                                                    ? "border-green-300 bg-green-50"
                                                    : "border-red-300 bg-red-50"
                                                }">
                                                    <p class="font-semibold text-gray-900 mb-2">
                                                        Question ${subQuestionId.replace(
                                                          "q",
                                                          ""
                                                        )}: (Table Question)
                                                    </p>
                                                    <p class="text-sm text-gray-700">
                                                        Your Answer: <span class="${
                                                          subIsCorrect
                                                            ? "correct-answer"
                                                            : "incorrect-answer"
                                                        }">${subUserAnswer}</span>
                                                    </p>
                                                    <p class="text-sm text-gray-700">
                                                        Correct Answer: <span class="correct-answer">${subCorrectAnswer}</span>
                                                    </p>
                                                    ${
                                                      question.explanation
                                                        ? `<div class="explanation">
                                                            <strong>Explanation:</strong> ${question.explanation}
                                                        </div>`
                                                        : ""
                                                    }
                                                </div>
                                            `;
                                            })
                                            .join("");
                                        }

                                        // Render for non-table questions
                                        return `
                                        <div class="p-4 rounded-lg shadow-sm border ${
                                          isCorrect
                                            ? "border-green-300 bg-green-50"
                                            : "border-red-300 bg-red-50"
                                        }">
                                            <p class="font-semibold text-gray-900 mb-2">
                                                Question ${
                                                  question.questionNumber
                                                }: ${question.text}
                                            </p>
                                            <p class="text-sm text-gray-700">
                                                Your Answer: <span class="${
                                                  isCorrect
                                                    ? "correct-answer"
                                                    : "incorrect-answer"
                                                }">${userAnswerDisplay}</span>
                                            </p>
                                            <p class="text-sm text-gray-700">
                                                Correct Answer: <span class="correct-answer">${correctAnswerDisplay}</span>
                                            </p>
                                            ${
                                              question.explanation
                                                ? `<div class="explanation">
                                                    <strong>Explanation:</strong> ${question.explanation}
                                                </div>`
                                                : ""
                                            }
                                        </div>
                                    `;
                                      })
                                      .join("")
                                  )
                                  .join("")
                              )
                              .join("")}
                        </div>
                    </div>

                    <!-- Leaderboard Section -->
                    <div class="mb-8">
                        <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            ${MockTestIcons.Leaderboard.replace(
                              /width="24" height="24"/g,
                              'width="24" height="24" class="w-6 h-6 text-gray-600"'
                            )} Leaderboard for This Test
                        </h3>
                        <div class="leaderboard-table-container">
                            <table class="leaderboard-table">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Player</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Band Score</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${
                                      testState.leaderboard.length > 0
                                        ? testState.leaderboard
                                            .map(
                                              (entry, index) => `
                                            <tr class="${
                                              authAppState.userId &&
                                              entry.userId ===
                                                authAppState.userId
                                                ? "current-user-row"
                                                : ""
                                            }">
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                    ${
                                                      index === 0
                                                        ? `<span class="rank-badge rank-1">${
                                                            index + 1
                                                          }</span>`
                                                        : index === 1
                                                        ? `<span class="rank-badge rank-2">${
                                                            index + 1
                                                          }</span>`
                                                        : index === 2
                                                        ? `<span class="rank-badge rank-3">${
                                                            index + 1
                                                          }</span>`
                                                        : `<span class="rank-badge rank-common">${
                                                            index + 1
                                                          }</span>` // Applied common badge for ranks 4+
                                                    }
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${
                                                  entry.userName ||
                                                  entry.userEmail.split("@")[0]
                                                }</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${
                                                  entry.bandScore
                                                }</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatTime(
                                                  entry.timeTakenSeconds
                                                )}</td>
                                            </tr>
                                        `
                                            )
                                            .join("")
                                        : `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No results yet. Be the first!</td></tr>`
                                    }
                                    ${
                                      testState.userRank &&
                                      testState.userRank > 10 &&
                                      authAppState.userId
                                        ? `
                                        <tr>
                                            <td colspan="4" class="px-6 py-4 text-center text-gray-600 italic">... Your Rank: ${testState.userRank} ...</td>
                                        </tr>
                                        `
                                        : ""
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="flex justify-center mt-8 gap-3 flex-wrap">
                        <a href="mock-test-home.html" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 font-semibold text-base transform active:scale-95">
                        <i class="fas fa-home w-5 h-5"></i> Back to Mock Tests
                        </a>
                         <a href="daily-leaderboard.html" class="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition-colors duration-200 font-semibold text-base transform active:scale-95">
                         <i class="fas fa-list-ol w-5 h-5"></i> Daily Leaderboard
                         </a>
                    </div>
                </div>
            `;
      }

      /**
       * Renders the main application content for the mock test page.
       */
      async function renderApp() {
        const appDiv = document.getElementById("app");
        if (!appDiv) return;

        if (testState.isLoadingResults) {
          appDiv.innerHTML = `
            <div class="flex justify-center items-center h-full min-h-[50vh]">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
                <p class="ml-4 text-lg text-gray-600">Loading results...</p>
            </div>
          `;
        } else if (testState.testCompleted) {
          renderMockTestFeedbackSection(appDiv);
          // Hide audio player and mobile palette header when results are shown
          document.getElementById("fixed-audio-player-wrapper").style.display =
            "none";
          document.getElementById(
            "mobile-question-palette-wrapper"
          ).style.display = "none";
        } else {
          // Render the test questions
          document.getElementById("fixed-audio-player-wrapper").style.display =
            "flex"; // Show audio player
          // Removed the line that forces mobile palette to display, letting CSS handle it
          // document.getElementById("mobile-question-palette-wrapper").style.display = 'flex'; // REMOVED THIS LINE

          appDiv.innerHTML = `
                <div class="mock-test-layout min-h-[calc(100vh-100px)]">
                    <!-- Main Test Content Area -->
                    <div class="main-test-content">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-3xl font-anton text-gray-800">${
                              currentTest.title
                            }</h2>
                            <!-- Audio player moved outside this div -->
                        </div>

                        <!-- User ID Display (if logged in) -->
                        ${
                          authAppState.isAuthReady && authAppState.userId
                            ? `
                        <p class="mb-6 text-sm sm:text-lg font-mono user-id-display inline-block px-3 py-1 sm:px-4 sm:py-2 rounded-xl animate-fade-in">
                            User ID: <span class="font-semibold text-gray-800">${authAppState.userId}</span>
                        </p>
                        `
                            : ""
                        }

                        <!-- Test Sections and Questions -->
                        <div id="test-questions-container">
                            ${currentTest.sections
                              .map(
                                (section) => `
                                <div class="question-section" id="section-${
                                  section.id
                                }">
                                    <h3 class="text-2xl font-bold text-gray-700 mb-3 font-anton">${
                                      section.title
                                    }</h3>
                                    ${
                                      section.image
                                        ? `<div class="map-image-container">
                                                <img src="${section.image}" alt="Test Section Image" class="rounded-lg">
                                           </div>`
                                        : ""
                                    }
                                    <div class="questions-list">
                                        ${section.questionGroups // Iterate over questionGroups
                                          .map(
                                            (qGroup) => `
                                            ${
                                              qGroup.instructions
                                                ? `<div class="question-group-instructions mb-6 text-gray-600 font-inter">${qGroup.instructions}</div>`
                                                : ""
                                            }
                                            ${qGroup.questions // Iterate over questions within the group
                                              .map((question) => {
                                                let questionHtml = "";
                                                if (question.type === "mcq") {
                                                  questionHtml = `
                                                        <div class="question-item" id="question-${
                                                          question.questionNumber
                                                        }">
                                                            <p class="text-lg font-semibold mb-2">${
                                                              question.questionNumber
                                                            }. ${
                                                    question.text
                                                  }</p>
                                                            ${question.options
                                                              .map(
                                                                (
                                                                  option,
                                                                  index
                                                                ) => `
                                                                <label class="radio-option">
                                                                    <input type="radio" name="q-${
                                                                      question.id
                                                                    }" value="${option}"
                                                                           onchange="handleAnswerInput('${
                                                                             question.id
                                                                           }', this.value)"
                                                                           ${
                                                                             testState
                                                                               .userAnswers[
                                                                               question
                                                                                 .id
                                                                             ] ===
                                                                             option
                                                                               ? "checked"
                                                                               : ""
                                                                           }>
                                                                    <span class="ml-2 text-gray-700">${option}</span>
                                                                </label>
                                                            `
                                                              )
                                                              .join("")}
                                                        </div>
                                                    `;
                                                } else if (
                                                  question.type ===
                                                    "fill_in_the_blank" ||
                                                  question.type ===
                                                    "map_labeling"
                                                ) {
                                                  const inputClass =
                                                    question.inputPlacement ===
                                                    "newline"
                                                      ? "block-input"
                                                      : "inline-input";
                                                  const inputField = `<input type="text" id="q-${
                                                    question.id
                                                  }" placeholder="Answer"
                                                                   oninput="handleAnswerInput('${
                                                                     question.id
                                                                   }', this.value)"
                                                                   value="${
                                                                     testState
                                                                       .userAnswers[
                                                                       question
                                                                         .id
                                                                     ] || ""
                                                                   }" class="${inputClass}">`;

                                                  let questionTextContent = "";
                                                  let inputElementHtml = "";

                                                  if (
                                                    question.inputPlacement ===
                                                    "newline"
                                                  ) {
                                                    // For questions like 4, 5, 6, 7 where input is on a new line
                                                    // The descriptive text is now handled by questionGroup.instructions
                                                    questionTextContent = "";
                                                    inputElementHtml = inputField; // The input field itself is block
                                                  } else {
                                                    // Default inline behavior
                                                    questionTextContent = question.text.includes(
                                                      "[GAP]"
                                                    )
                                                      ? question.text.replace(
                                                          /\[GAP\]/g,
                                                          inputField
                                                        )
                                                      : `${question.text} ${inputField}`;
                                                    inputElementHtml = ""; // Input is part of questionTextContent
                                                  }

                                                  questionHtml = `
                                                    <div class="question-item" id="question-${question.questionNumber}">
                                                        <p class="inline-question-text">
                                                            <span class="font-semibold text-lg text-gray-800">${question.questionNumber}.</span>
                                                            ${questionTextContent}
                                                        </p>
                                                        ${inputElementHtml}
                                                    </div>
                                                  `;
                                                } else if (
                                                  question.type ===
                                                  "table_fill_in_the_blank"
                                                ) {
                                                  // Render a table for this question type
                                                  questionHtml = `
                                                    <div class="question-item" id="question-${
                                                      question.questionNumber
                                                    }">
                                                        <div class="table-responsive-wrapper">
                                                            <table class="w-full text-left border-collapse mt-4">
                                                                <thead>
                                                                    ${
                                                                      question
                                                                        .tableData[0]
                                                                        ? `<tr>${question.tableData[0]
                                                                            .map(
                                                                              (
                                                                                header
                                                                              ) =>
                                                                                `<th class="py-2 px-4 border border-gray-300 bg-gray-100">${header}</th>`
                                                                            )
                                                                            .join(
                                                                              ""
                                                                            )}</tr>`
                                                                        : ""
                                                                    }
                                                                </thead>
                                                                <tbody>
                                                                    ${question.tableData
                                                                      .slice(1)
                                                                      .map(
                                                                        (
                                                                          row
                                                                        ) => `
                                                                        <tr>
                                                                            ${row
                                                                              .map(
                                                                                (
                                                                                  cellContent
                                                                                ) => {
                                                                                  const inputPattern = /(\d+)\.\s*\[INPUT\]/;
                                                                                  let displayContent = cellContent;
                                                                                  let inputId =
                                                                                    "";
                                                                                  const match = cellContent.match(
                                                                                    inputPattern
                                                                                  );

                                                                                  if (
                                                                                    match
                                                                                  ) {
                                                                                    const qNum =
                                                                                      match[1];
                                                                                    inputId = `q${qNum}`; // This is the ID used in userAnswers
                                                                                    const inputFieldHtml = `<input type="text" id="${inputId}" placeholder="Answer"
                                                                                                           oninput="handleAnswerInput('${inputId}', this.value)"
                                                                                                           value="${
                                                                                                             testState
                                                                                                               .userAnswers[
                                                                                                               inputId
                                                                                                             ] ||
                                                                                                             ""
                                                                                                           }"
                                                                                                           class="table-input">`;
                                                                                    displayContent = cellContent.replace(
                                                                                      /\[INPUT\]/,
                                                                                      inputFieldHtml
                                                                                    );
                                                                                  }
                                                                                  return `
                                                                                    <td class="py-2 px-4 border border-gray-300">
                                                                                        ${displayContent}
                                                                                    </td>
                                                                                `;
                                                                                }
                                                                              )
                                                                              .join(
                                                                                ""
                                                                              )}
                                                                        </tr>
                                                                    `
                                                                      )
                                                                      .join("")}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                  `;
                                                }
                                                return questionHtml;
                                              })
                                              .join("")}
                                        `
                                          )
                                          .join("")}
                                    </div>
                                </div>
                            `
                              )
                              .join("")}
                        </div>

                        <div class="flex justify-end mt-8">
                            <button id="submit-test-btn" class="px-8 py-3 bg-blue-600 text-white rounded-full font-semibold text-lg hover:bg-blue-700 transition-colors duration-200 shadow-lg transform active:scale-95">
                                Submit Test
                                <i class="fas fa-paper-plane ml-2"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Sidebar: Question Palette & Timer (for desktop/tablet) -->
                    <div class="sidebar hidden lg:flex">
                        <div class="text-center mb-4">
                            <h3 class="text-2xl font-anton text-white mb-2">Question Palette</h3>
                            <div class="flex items-center justify-center gap-2 text-xl font-bold text-white">
                                <i class="fas fa-clock"></i>
                                <span id="timer-display-desktop">${formatTime(
                                  testState.timeLeft
                                )}</span>
                            </div>
                        </div>

                        <div class="question-palette-grid" id="question-palette-desktop">
                            <!-- Question buttons will be injected here -->
                        </div>

                        <div class="flex flex-col gap-3 mt-6">
                            <div class="flex items-center gap-2">
                                <span class="question-palette-btn answered w-6 h-6 rounded-full text-xs"></span>
                                <span class="text-sm">Answered</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="question-palette-btn unanswered w-6 h-6 rounded-full text-xs"></span>
                                <span class="text-sm">Unanswered</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="question-palette-btn current w-6 h-6 rounded-full text-xs"></span>
                                <span class="text-sm">Current</span>
                            </div>
                        </div>

                        <div class="flex justify-between mt-auto pt-6 border-t border-gray-700">
                            <button id="prev-question-btn-desktop" class="px-5 py-2 bg-gray-600 text-white rounded-full font-semibold hover:bg-gray-700 transition-colors duration-200 transform active:scale-95 flex items-center gap-2">
                                ${MockTestIcons.ChevronLeft} Prev
                            </button>
                            <button id="next-question-btn-desktop" class="px-5 py-2 bg-blue-600 text-white rounded-full font-semibold hover:bg-blue-700 transition-colors duration-200 transform active:scale-95 flex items-center gap-2">
                                Next ${MockTestIcons.ChevronRight}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Attach event listeners for question inputs only if test is not completed
        if (!testState.testCompleted) {
          const testQuestionsContainer = document.getElementById(
            "test-questions-container"
          );
          if (testQuestionsContainer) {
            testQuestionsContainer.addEventListener("input", (event) => {
              // For text inputs (fill-in-the-blank, map labeling, table inputs)
              if (
                event.target.tagName === "INPUT" &&
                event.target.type === "text" &&
                event.target.id.startsWith("q")
              ) {
                const questionId = event.target.id;
                handleAnswerInput(questionId, event.target.value);
              }
            });
            testQuestionsContainer.addEventListener("change", (event) => {
              // For radio buttons (MCQ)
              if (
                event.target.tagName === "INPUT" &&
                event.target.type === "radio" &&
                event.target.name.startsWith("q-")
              ) {
                const questionId = event.target.name.substring(2); // Remove "q-" prefix
                handleAnswerInput(questionId, event.target.value);
              }
            });
          }

          // Populate question palette (both desktop and mobile)
          const questionPaletteDesktop = document.getElementById(
            "question-palette-desktop"
          );
          const questionPaletteMobile = document.getElementById(
            "question-palette-mobile"
          );

          const paletteHtml = questionPaletteItems
            .map((item) => {
              return `<button class="question-palette-btn unanswered" data-palette-number="${item.paletteNumber}">${item.paletteNumber}</button>`;
            })
            .join("");

          if (questionPaletteDesktop) {
            questionPaletteDesktop.innerHTML = paletteHtml;
            questionPaletteDesktop.addEventListener("click", (event) => {
              if (event.target.classList.contains("question-palette-btn")) {
                const paletteNum = parseInt(event.target.dataset.paletteNumber);
                scrollToQuestion(paletteNum);
              }
            });
          }
          if (questionPaletteMobile) {
            questionPaletteMobile.innerHTML = paletteHtml;
            questionPaletteMobile.addEventListener("click", (event) => {
              if (event.target.classList.contains("question-palette-btn")) {
                const paletteNum = parseInt(event.target.dataset.paletteNumber);
                scrollToQuestion(paletteNum);
                // Collapse the palette after clicking a question on mobile
                const mobilePaletteWrapper = document.getElementById(
                  "mobile-question-palette-wrapper"
                );
                const mobilePaletteContent = document.getElementById(
                  "mobile-palette-content"
                );
                const paletteToggleIcon = document.getElementById(
                  "palette-toggle-icon"
                );

                if (mobilePaletteWrapper.classList.contains("expanded")) {
                  mobilePaletteWrapper.classList.remove("expanded");
                  paletteToggleIcon.classList.remove("ph-caret-up");
                  paletteToggleIcon.classList.add("ph-caret-down");
                }
              }
            });
          }

          // Navigation buttons
          const prevBtnDesktop = document.getElementById(
            "prev-question-btn-desktop"
          );
          const nextBtnDesktop = document.getElementById(
            "next-question-btn-desktop"
          );
          const submitBtn = document.getElementById("submit-test-btn");

          if (prevBtnDesktop) {
            prevBtnDesktop.addEventListener("click", () => {
              if (testState.currentQuestionIndex > 0) {
                scrollToQuestion(testState.currentQuestionIndex); // Scroll to previous question (current index is 0-based, paletteNumber is 1-based)
              }
            });
          }
          if (nextBtnDesktop) {
            nextBtnDesktop.addEventListener("click", () => {
              if (testState.currentQuestionIndex < totalQuestions - 1) {
                scrollToQuestion(testState.currentQuestionIndex + 2); // Scroll to next question
              }
            });
          }
          if (submitBtn) {
            submitBtn.addEventListener("click", () => {
              const unansweredCount = questionPaletteItems.filter(
                (item) => !testState.userAnswers[item.questionId]
              ).length;

              showModal(
                "Confirm Submission",
                `Are you sure you want to submit the test? You have ${unansweredCount} unanswered questions.`,
                true,
                () => handleSubmitTest(), // On confirm
                () => hideModal() // On cancel
              );
            });
          }

          // Mobile palette dropdown logic
          const mobilePaletteHeader = document.getElementById(
            "mobile-palette-header"
          );
          const mobilePaletteContent = document.getElementById(
            "mobile-palette-content"
          );
          const mobilePaletteWrapper = document.getElementById(
            "mobile-question-palette-wrapper"
          );
          const paletteToggleIcon = document.getElementById(
            "palette-toggle-icon"
          );

          if (
            mobilePaletteHeader &&
            mobilePaletteContent &&
            paletteToggleIcon &&
            mobilePaletteWrapper
          ) {
            mobilePaletteHeader.addEventListener("click", () => {
              const isExpanded = mobilePaletteWrapper.classList.toggle(
                "expanded"
              ); // Corrected: toggle on wrapper
              if (isExpanded) {
                paletteToggleIcon.classList.remove("ph-caret-down");
                paletteToggleIcon.classList.add("ph-caret-up");
              } else {
                paletteToggleIcon.classList.remove("ph-caret-up");
                paletteToggleIcon.classList.add("ph-caret-down");
              }
            });
          }

          // Start the timer and update palette initially
          startTimer();
          updateQuestionPalette();
          // Scroll to the first question initially
          if (totalQuestions > 0) {
            scrollToQuestion(1);
          }
        }
      }

      // Expose functions to global scope for oninput/onchange attributes
      window.handleAnswerInput = handleAnswerInput;

      // Initialization Logic
      window.onload = async function () {
        // Initialize Firebase Auth and listen for state changes
        initFirebaseAuth(updateAuthUI)
          .then(async ({ db: firestoreDb, auth: firebaseAuth }) => {
            db = firestoreDb;
            auth = firebaseAuth;
            console.log("Firebase initialized in mock-test.html:", {
              db,
              auth,
            });

            // Parse URL parameters for initial load (e.g., if user refreshes results page)
            const urlParams = new URLSearchParams(window.location.search);
            currentModuleId = urlParams.get("module");
            currentTestId = urlParams.get("test");

            if (currentModuleId && currentTestId) {
              currentTest = allMockTests.find(
                (test) =>
                  test.moduleId === currentModuleId && test.id === currentTestId
              );

              if (currentTest) {
                const scoreParam = urlParams.get("score");
                const totalParam = urlParams.get("total");
                const bandParam = urlParams.get("band");
                const timeParam = urlParams.get("time");

                if (
                  scoreParam !== null &&
                  totalParam !== null &&
                  bandParam !== null &&
                  timeParam !== null
                ) {
                  // This means we are loading a completed test's results directly
                  testState.testCompleted = true;
                  testState.isLoadingResults = true; // Set loading state for results
                  // Fetch the actual user result document to get userAnswers
                  auth.onAuthStateChanged(async (user) => {
                    if (authAppState.userId) {
                      testState.userResultDoc = await fetchUserMockTestResult(
                        authAppState.userId,
                        currentTestId
                      );
                    } else {
                      console.warn(
                        "User not authenticated, cannot fetch specific user result for display."
                      );
                      testState.userResultDoc = {
                        testTitle: currentTest.title,
                        correctAnswers: parseInt(scoreParam),
                        totalQuestions: parseInt(totalParam),
                        bandScore: parseFloat(bandParam),
                        timeTakenSeconds: parseInt(timeParam),
                        userAnswers: {}, // Fallback empty answers
                      };
                    }
                    await fetchLeaderboard();
                    testState.isLoadingResults = false;
                    renderApp(); // Render results UI
                  });
                } else {
                  // Not a completed test, initialize for a new test
                  testState.testCompleted = false;
                  // Initialize questionPaletteItems and userAnswers based on the test structure
                  questionPaletteItems = [];
                  testState.userAnswers = {};
                  let currentPaletteNumber = 1;

                  currentTest.sections.forEach((section) => {
                    section.questionGroups.forEach((qGroup) => {
                      qGroup.questions.forEach((question) => {
                        if (question.type === "table_fill_in_the_blank") {
                          for (const subQuestionId in question.correctAnswer) {
                            testState.userAnswers[subQuestionId] = "";
                            questionPaletteItems.push({
                              paletteNumber: currentPaletteNumber,
                              questionId: subQuestionId,
                              htmlElementId: `question-${question.questionNumber}`,
                            });
                            currentPaletteNumber++;
                          }
                        } else {
                          testState.userAnswers[question.id] = "";
                          questionPaletteItems.push({
                            paletteNumber: currentPaletteNumber,
                            questionId: question.id,
                            htmlElementId: `question-${question.questionNumber}`,
                          });
                          currentPaletteNumber++;
                        }
                      });
                    });
                  });
                  totalQuestions = questionPaletteItems.length;
                  testState.timeLeft = currentTest.duration * 60;
                  const audioPlayer = document.getElementById(
                    "test-audio-player"
                  );
                  if (audioPlayer) {
                    audioPlayer.src = currentTest.audioUrl;
                  }
                  renderApp(); // Render test UI
                }
              } else {
                // Test not found
                appDiv.innerHTML = `
                        <div class="text-center text-red-500 text-xl mt-12">
                            Error: Mock test not found.
                            <br><a href="mock-test-home.html" class="text-blue-600 hover:underline mt-4 inline-block">Go back to mock tests</a>
                        </div>
                    `;
              }
            } else {
              // No module or test specified, redirect to home or show error
              appDiv.innerHTML = `
                    <div class="text-center text-red-500 text-xl mt-12">
                        Error: No module or test specified in the URL.
                        <br><a href="mock-test-home.html" class="text-blue-600 hover:underline mt-4 inline-block">Go back to mock tests</a>
                    </div>
                `;
            }
          })
          .catch((error) => {
            console.error(
              "Failed to initialize Firebase in mock-test.html:",
              error
            );
            showToast(
              "Failed to initialize Firebase. Some features may not work.",
              "error"
            );
            // Even if Firebase fails, try to render the app, but features might be limited
            testState.isLoadingResults = false; // Ensure loading is off
            renderApp();
          });
      };
    </script>
  </body>
</html>
