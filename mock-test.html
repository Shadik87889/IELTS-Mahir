<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IELTS Mastery Hub - Mock Tests</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style id="common-styles"></style>
  </head>
  <body
    class="min-h-screen bg-gradient-to-br from-blue-100 to-indigo-200 py-6 px-2 sm:py-8 sm:px-4 lg:py-12 lg:px-8"
  >
    <header
      id="app-header"
      class="py-2 px-3 md:py-4 md:px-8 flex items-center justify-between bg-white border-b border-gray-100 rounded-b-xl transition-colors duration-300 sticky top-0 z-50 shadow-lg"
    >
      <div class="flex items-center gap-2 sm:gap-4">
        <h1 class="font-bold text-xl md:text-3xl text-blue-600">
          IELTS Mastery Hub
        </h1>
        <nav class="hidden md:flex gap-4"></nav>
      </div>
      <!-- Modified auth-buttons-container for stable size and content toggling -->
      <div
        id="auth-buttons-container"
        class="flex items-center justify-end h-10 min-w-[100px] sm:min-w-[150px]"
      >
        <!-- Signed-in state container (initially hidden) -->
        <div id="signed-in-controls" class="relative hidden">
          <button
            id="profile-icon-btn"
            class="flex items-center justify-center w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-blue-500 text-white text-lg sm:text-xl font-bold shadow-md hover:bg-blue-600 transition-colors"
          >
            <!-- Initial character will be set by JS -->
          </button>
          <div
            id="profile-dropdown"
            class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl py-2 z-50 hidden"
          >
            <div
              id="profile-dropdown-user-info"
              class="px-4 py-2 text-sm text-gray-700 border-b border-gray-100"
            ></div>
            <a
              href="dashboard.html"
              class="flex items-center gap-2 px-4 py-2 text-gray-800 hover:bg-gray-100"
              >${Icons.Dashboard} Dashboard</a
            >
            <a
              href="ielts-mahir-community-forum.html"
              class="flex items-center gap-2 px-4 py-2 text-gray-800 hover:bg-gray-100"
              >${Icons.Forum} Forum</a
            >
            <button
              id="sign-out-dropdown-btn"
              class="flex items-center gap-2 w-full text-left px-4 py-2 text-red-600 hover:bg-red-50 rounded-b-lg"
            >
              ${Icons.SignOut} Sign Out
            </button>
          </div>
        </div>

        <!-- Signed-out state container (initially hidden, shown by JS if not signed in) -->
        <div
          id="signed-out-controls"
          class="flex items-center gap-2 sm:gap-4 hidden"
        >
          <a
            href="auth.html"
            id="sign-in-nav-btn"
            class="flex items-center gap-2 px-3 py-2 sm:px-4 sm:py-2.5 bg-blue-600 text-white rounded-xl shadow-md hover:bg-blue-700 transition-all text-xs sm:text-sm font-semibold transform active:scale-95"
          >
            ${Icons.SignIn} <span class="hidden sm:inline">Sign In</span>
          </a>
        </div>

        <!-- Loading placeholder (only shown initially, hidden once auth state is determined) -->
        <div
          id="auth-loading-placeholder"
          class="animate-pulse flex space-x-4 items-center"
        >
          <div class="rounded-full bg-gray-200 h-8 w-8 sm:h-10 sm:w-10"></div>
          <div class="flex-1 space-y-2 py-1 hidden sm:block w-[80px]">
            <div class="h-2 bg-gray-200 rounded"></div>
            <div class="h-2 bg-gray-200 rounded w-2/3"></div>
          </div>
        </div>
      </div>
    </header>

    <div id="app"></div>
    <div id="toast-container"></div>
    <div id="modal-container"></div>

    <script type="module">
      import {
        initFirebaseAuth,
        authAppState,
        signOutUser,
        showToast,
      } from "./auth.js"; // Removed Icons import
      import { allMockTests, commonStyles } from "./mock-test-data.js";

      // Define Icons directly in this file to ensure availability
      const Icons = {
        Headphones: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-headphones"><path d="M3 14h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2Z"/><path d="M21 14h-3a2 2 0 0 1-2 2v3a2 2 0 0 1 2 2h3a2 2 0 0 1 2-2v-3a2 2 0 0 1-2-2Z"/><path d="M7 14V5a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v9"/></svg>`,
        BookOpen: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-book-open"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>`,
        Edit: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2 0 0 1 3 3L12 15l-4 1 1-4Z"/></svg>`,
        Mic: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mic"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>`,
        Activity: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-activity"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>`,
        Dashboard: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layout-dashboard"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>`,
        Forum: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>`,
        SignOut: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="17 16 22 12 17 8"/><line x1="22" x2="10" y1="12" y2="12"/></svg>`,
        SignIn: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-in"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>`,
        ChevronLeft: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>`,
        FileText: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>`,
        Lightbulb: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-lightbulb"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 3c0 1.3.5 2.6 1.5 3.5.8.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/><path d="M11 17h2"/><path d="M12 14v8"/></svg>`,
      };

      let db, auth; // Firestore and Auth instances

      function updateAuthUI(user) {
        const signedInControls = document.getElementById("signed-in-controls");
        const signedOutControls = document.getElementById(
          "signed-out-controls"
        );
        const authLoadingPlaceholder = document.getElementById(
          "auth-loading-placeholder"
        );

        // Hide the loading placeholder once the auth state is determined
        if (authLoadingPlaceholder) {
          authLoadingPlaceholder.classList.add("hidden");
        }

        if (user) {
          // User is signed in: Show profile dropdown
          if (signedInControls) signedInControls.classList.remove("hidden");
          if (signedOutControls) signedOutControls.classList.add("hidden");

          const profileIconBtn = document.getElementById("profile-icon-btn");
          const profileDropdown = document.getElementById("profile-dropdown");
          const signOutDropdownBtn = document.getElementById(
            "sign-out-dropdown-btn"
          );
          const profileDropdownUserInfo = document.getElementById(
            "profile-dropdown-user-info"
          );

          if (profileIconBtn) {
            profileIconBtn.innerHTML = (
              authAppState.userProfile?.name ||
              user.email ||
              user.uid
            )
              .charAt(0)
              .toUpperCase();
          }
          if (profileDropdownUserInfo) {
            profileDropdownUserInfo.textContent = `Hello, ${
              authAppState.userProfile?.name ||
              user.email ||
              user.uid.substring(0, 8)
            }`;
          }

          if (profileIconBtn && profileDropdown) {
            profileIconBtn.onclick = (event) => {
              event.stopPropagation();
              profileDropdown.classList.toggle("hidden");
            };
            // Use document.onclick for closing the dropdown when clicking outside
            document.onclick = (event) => {
              if (
                !profileDropdown.contains(event.target) &&
                !profileIconBtn.contains(event.target)
              ) {
                profileDropdown.classList.add("hidden");
              }
            };
          }

          if (signOutDropdownBtn) {
            signOutDropdownBtn.onclick = async () => {
              await signOutUser();
            };
          }
        } else {
          // User is signed out: Show sign-in button
          if (signedInControls) signedInControls.classList.add("hidden");
          if (signedOutControls) signedOutControls.classList.remove("hidden");
        }
      }

      function renderApp() {
        const appDiv = document.getElementById("app");
        if (!appDiv) return;
        appDiv.innerHTML = `
          <header class="text-center mb-8 sm:mb-12 lg:mb-16">
            <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold text-blue-900 drop-shadow-lg leading-tight">
              <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-700">IELTS Mastery Hub</span>
            </h1>
            <p class="text-lg sm:text-xl lg:text-2xl text-gray-700 mt-2 sm:mt-4 max-w-2xl mx-auto">Your ultimate destination for world-class IELTS preparation.</p>
            ${
              authAppState.isAuthReady && authAppState.userId
                ? `
              <p class="mt-4 sm:mt-6 text-sm sm:text-lg text-gray-600 font-mono bg-white bg-opacity-70 backdrop-blur-sm inline-block px-3 py-1 sm:px-4 sm:py-2 rounded-xl shadow-md border border-gray-200">
                User ID: <span class="font-semibold text-gray-800">${authAppState.userId}</span>
              </p>`
                : ""
            }
          </header>

          <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-8 max-w-6xl mx-auto px-4">
            <!-- Module Card: Listening -->
            <div class="bg-white rounded-3xl shadow-xl p-6 sm:p-8 flex flex-col items-center text-center border border-blue-100 transform hover:scale-105 transition duration-300">
              <div class="text-blue-500 mb-4">${Icons.Headphones.replace(
                /width="24" height="24"/g,
                'width="48" height="48" class="w-12 h-12"'
              )}</div>
              <h2 class="text-2xl sm:text-3xl font-bold text-blue-800 mb-3">Listening</h2>
              <p class="text-gray-600 mb-6 text-sm sm:text-base">Develop your ability to understand spoken English in various contexts.</p>
              <button onclick="window.location.href='listening.html'" class="mt-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-xl shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-300 transform active:scale-95 text-sm sm:text-base">Start Test</button>
            </div>

            <!-- Module Card: Reading -->
            <div class="bg-white rounded-3xl shadow-xl p-6 sm:p-8 flex flex-col items-center text-center border border-green-100 transform hover:scale-105 transition duration-300">
              <div class="text-green-500 mb-4">${Icons.BookOpen.replace(
                /width="24" height="24"/g,
                'width="48" height="48" class="w-12 h-12"'
              )}</div>
              <h2 class="text-2xl sm:text-3xl font-bold text-green-800 mb-3">Reading</h2>
              <p class="text-gray-600 mb-6 text-sm sm:text-base">Enhance your comprehension of academic and general texts.</p>
              <button onclick="window.location.href='reading.html'" class="mt-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-xl shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition duration-300 transform active:scale-95 text-sm sm:text-base">Start Test</button>
            </div>

            <!-- Module Card: Writing -->
            <div class="bg-white rounded-3xl shadow-xl p-6 sm:p-8 flex flex-col items-center text-center border border-purple-100 transform hover:scale-105 transition duration-300">
              <div class="text-purple-500 mb-4">${Icons.Edit.replace(
                /width="24" height="24"/g,
                'width="48" height="48" class="w-12 h-12"'
              )}</div>
              <h2 class="text-2xl sm:text-3xl font-bold text-purple-800 mb-3">Writing</h2>
              <p class="text-gray-600 mb-6 text-sm sm:text-base">Master the art of effective report, letter, and essay writing.</p>
              <button onclick="window.location.href='writing.html'" class="mt-auto bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-xl shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 transition duration-300 transform active:scale-95 text-sm sm:text-base">Start Test</button>
            </div>

            <!-- Module Card: Speaking -->
            <div class="bg-white rounded-3xl shadow-xl p-6 sm:p-8 flex flex-col items-center text-center border border-red-100 transform hover:scale-105 transition duration-300">
              <div class="text-red-500 mb-4">${Icons.Mic.replace(
                /width="24" height="24"/g,
                'width="48" height="48" class="w-12 h-12"'
              )}</div>
              <h2 class="text-2xl sm:text-3xl font-bold text-red-800 mb-3">Speaking</h2>
              <p class="text-gray-600 mb-6 text-sm sm:text-base">Practice your spoken English with interactive AI feedback.</p>
              <button onclick="window.location.href='speaking.html'" class="mt-auto bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-xl shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition duration-300 transform active:scale-95 text-sm sm:text-base">Start Test</button>
            </div>

            <!-- My Progress Card -->
            <div class="md:col-span-2 lg:col-span-3 bg-white rounded-3xl shadow-xl p-6 sm:p-8 flex flex-col items-center text-center border border-gray-200 transform hover:scale-105 transition duration-300">
              <div class="text-gray-500 mb-4">${Icons.Activity.replace(
                /width="24" height="24"/g,
                'width="48" height="48" class="w-12 h-12"'
              )}</div>
              <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-3">My Progress</h2>
              <p class="text-gray-600 mb-6 text-sm sm:text-base">Track your performance, review past tests, and see your improvements over time.</p>
              <button onclick="window.location.href='test-detail.html?view=my-progress'" class="mt-auto bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-xl shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 transition duration-300 transform active:scale-95 text-sm sm:text-base">View Progress</button>
            </div>
          </main>
        `;
      }

      window.onload = async function () {
        initFirebaseAuth(updateAuthUI)
          .then(({ db: firestoreDb, auth: firebaseAuth }) => {
            db = firestoreDb; // Assign to global db
            auth = firebaseAuth; // Assign to global auth
            console.log("Firebase initialized in mock-test.html:", {
              db,
              auth,
            });
          })
          .catch((error) => {
            console.error(
              "Failed to initialize Firebase in mock-test.html:",
              error
            );
            showToast(
              "Failed to initialize Firebase. Some features may not work.",
              "error"
            );
          });

        renderApp();
      };
    </script>
  </body>
</html>
